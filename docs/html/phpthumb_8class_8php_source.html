<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>MitosEHR: C:/wamp/www/MitosEHR/lib/phpThumbs-1.7.9/phpthumb.class.php Source File</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>

</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  <td id="projectlogo"><img alt="Logo" src="logo_medium.png"/></td>
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">MitosEHR
   &#160;<span id="projectnumber">Vega v1.0</span>
   </div>
   <div id="projectbrief">Electronic Health Record</div>
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.7.6.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
</div>
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
  initNavTree('phpthumb_8class_8php.html','');
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">C:/wamp/www/MitosEHR/lib/phpThumbs-1.7.9/phpthumb.class.php</div>  </div>
</div><!--header-->
<div class="contents">
<a href="phpthumb_8class_8php.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 &lt;?php
<a name="l00004"></a>00004 <span class="comment">//        available at http://phpthumb.sourceforge.net     ///</span>
<a name="l00007"></a>00007 <span class="comment"></span><span class="comment">// See: phpthumb.readme.txt for usage instructions          //</span>
<a name="l00008"></a>00008 <span class="comment">//                                                         ///</span>
<a name="l00010"></a>00010 <span class="comment"></span>
<a name="l00011"></a>00011 ob_start();
<a name="l00012"></a>00012 <span class="keywordflow">if</span> (!include_once(dirname(__FILE__).<span class="stringliteral">&#39;/phpthumb.functions.php&#39;</span>)) {
<a name="l00013"></a>00013         ob_end_flush();
<a name="l00014"></a>00014         die(<span class="stringliteral">&#39;failed to include_once(&quot;&#39;</span>.realpath(dirname(__FILE__).<span class="stringliteral">&#39;/phpthumb.functions.php&#39;</span>).<span class="stringliteral">&#39;&quot;)&#39;</span>);
<a name="l00015"></a>00015 }
<a name="l00016"></a>00016 ob_end_clean();
<a name="l00017"></a>00017 
<a name="l00018"></a><a class="code" href="classphpthumb.html">00018</a> <span class="keyword">class </span><a class="code" href="classphpthumb.html">phpthumb</a> {
<a name="l00019"></a>00019 
<a name="l00020"></a>00020         <span class="comment">// public:</span>
<a name="l00021"></a>00021         <span class="comment">// START PARAMETERS (for object mode and phpThumb.php)</span>
<a name="l00022"></a>00022         <span class="comment">// See phpthumb.readme.txt for descriptions of what each of these values are</span>
<a name="l00023"></a><a class="code" href="classphpthumb.html#a973baaba285951225df769fc7a6655bf">00023</a>         var <a class="code" href="classphpthumb.html#a973baaba285951225df769fc7a6655bf">$src</a>  = null;     <span class="comment">// SouRCe filename</span>
<a name="l00024"></a><a class="code" href="classphpthumb.html#a1d995397cf49f53afa5eed45eb5d1b32">00024</a>         var <a class="code" href="classphpthumb.html#a1d995397cf49f53afa5eed45eb5d1b32">$new</a>  = null;     <span class="comment">// NEW image (phpThumb.php only)</span>
<a name="l00025"></a><a class="code" href="classphpthumb.html#ae51391055f5e898dc2625d155b016aaa">00025</a>         var <a class="code" href="classphpthumb.html#ae51391055f5e898dc2625d155b016aaa">$w</a>    = null;     <span class="comment">// Width</span>
<a name="l00026"></a><a class="code" href="classphpthumb.html#ab00da9d5d8bd5b6b944793e093860aff">00026</a>         var <a class="code" href="classphpthumb.html#ab00da9d5d8bd5b6b944793e093860aff">$h</a>    = null;     <span class="comment">// Height</span>
<a name="l00027"></a><a class="code" href="classphpthumb.html#ac3fb337a2f1d0065629c5bc05975a774">00027</a>         var <a class="code" href="classphpthumb.html#ac3fb337a2f1d0065629c5bc05975a774">$wp</a>   = null;     <span class="comment">// Width  (Portrait Images Only)</span>
<a name="l00028"></a><a class="code" href="classphpthumb.html#aef781c6cdc887550b4a09dc47a38a6bd">00028</a>         var <a class="code" href="classphpthumb.html#aef781c6cdc887550b4a09dc47a38a6bd">$hp</a>   = null;     <span class="comment">// Height (Portrait Images Only)</span>
<a name="l00029"></a><a class="code" href="classphpthumb.html#a006aaf3c5e2c3a3d1591897383e674e7">00029</a>         var <a class="code" href="classphpthumb.html#a006aaf3c5e2c3a3d1591897383e674e7">$wl</a>   = null;     <span class="comment">// Width  (Landscape Images Only)</span>
<a name="l00030"></a><a class="code" href="classphpthumb.html#aadc882e4725d8027dd92de87fe7439e8">00030</a>         var <a class="code" href="classphpthumb.html#aadc882e4725d8027dd92de87fe7439e8">$hl</a>   = null;     <span class="comment">// Height (Landscape Images Only)</span>
<a name="l00031"></a><a class="code" href="classphpthumb.html#a311685f250a0c7dbb10444068b95db6d">00031</a>         var <a class="code" href="classphpthumb.html#a311685f250a0c7dbb10444068b95db6d">$ws</a>   = null;     <span class="comment">// Width  (Square Images Only)</span>
<a name="l00032"></a><a class="code" href="classphpthumb.html#a1423daa323035ce36fe4573d2a8b882e">00032</a>         var <a class="code" href="classphpthumb.html#a1423daa323035ce36fe4573d2a8b882e">$hs</a>   = null;     <span class="comment">// Height (Square Images Only)</span>
<a name="l00033"></a><a class="code" href="classphpthumb.html#a23c42e7d231a63025b55e4eb7e3d4c99">00033</a>         var <a class="code" href="classphpthumb.html#a23c42e7d231a63025b55e4eb7e3d4c99">$f</a>    = null;     <span class="comment">// output image Format</span>
<a name="l00034"></a><a class="code" href="classphpthumb.html#abb0f8f809252372e25f48d52b63ef29d">00034</a>         var <a class="code" href="classphpthumb.html#abb0f8f809252372e25f48d52b63ef29d">$q</a>    = 75;       <span class="comment">// jpeg output Quality</span>
<a name="l00035"></a><a class="code" href="classphpthumb.html#a9cbacc06e648e88299a6e8b3a761d2de">00035</a>         var <a class="code" href="classphpthumb.html#a9cbacc06e648e88299a6e8b3a761d2de">$sx</a>   = null;     <span class="comment">// Source crop top-left X position</span>
<a name="l00036"></a><a class="code" href="classphpthumb.html#a4f9a77410a17115884d01e040b0ed2e7">00036</a>         var <a class="code" href="classphpthumb.html#a4f9a77410a17115884d01e040b0ed2e7">$sy</a>   = null;     <span class="comment">// Source crop top-left Y position</span>
<a name="l00037"></a><a class="code" href="classphpthumb.html#aaef5fdbb03de9c835220bb833b29dd89">00037</a>         var <a class="code" href="classphpthumb.html#aaef5fdbb03de9c835220bb833b29dd89">$sw</a>   = null;     <span class="comment">// Source crop Width</span>
<a name="l00038"></a><a class="code" href="classphpthumb.html#aff5d91a7a34e728e0cd5e6451a942016">00038</a>         var <a class="code" href="classphpthumb.html#aff5d91a7a34e728e0cd5e6451a942016">$sh</a>   = null;     <span class="comment">// Source crop Height</span>
<a name="l00039"></a><a class="code" href="classphpthumb.html#a2e2140695db3214fa9033fea939e74a1">00039</a>         var <a class="code" href="classphpthumb.html#a2e2140695db3214fa9033fea939e74a1">$zc</a>   = null;     <span class="comment">// Zoom Crop</span>
<a name="l00040"></a><a class="code" href="classphpthumb.html#a5ccdd3e0fcc877b2a57cceaa5908ca13">00040</a>         var <a class="code" href="classphpthumb.html#a5ccdd3e0fcc877b2a57cceaa5908ca13">$bc</a>   = null;     <span class="comment">// Border Color</span>
<a name="l00041"></a><a class="code" href="classphpthumb.html#abc007d9abf589c9e8acb07d2fe64a06a">00041</a>         var <a class="code" href="classphpthumb.html#abc007d9abf589c9e8acb07d2fe64a06a">$bg</a>   = null;     <span class="comment">// BackGround color</span>
<a name="l00042"></a><a class="code" href="classphpthumb.html#ad30b5df317c42999fc9eb84e7c4dc4bf">00042</a>         var <a class="code" href="classphpthumb.html#ad30b5df317c42999fc9eb84e7c4dc4bf">$fltr</a> = array();  <span class="comment">// FiLTeRs</span>
<a name="l00043"></a><a class="code" href="classphpthumb.html#a4037a8ff7343cce7ab4dadfd490ad3ee">00043</a>         var <a class="code" href="classphpthumb.html#a4037a8ff7343cce7ab4dadfd490ad3ee">$goto</a> = null;     <span class="comment">// GO TO url after processing</span>
<a name="l00044"></a><a class="code" href="classphpthumb.html#acfc00bd4a41804552c630950bf61a51f">00044</a>         var <a class="code" href="classphpthumb.html#acfc00bd4a41804552c630950bf61a51f">$err</a>  = null;     <span class="comment">// default ERRor image filename</span>
<a name="l00045"></a><a class="code" href="classphpthumb.html#ad46224925739775de25b5b835a518527">00045</a>         var <a class="code" href="classphpthumb.html#ad46224925739775de25b5b835a518527">$xto</a>  = null;     <span class="comment">// extract eXif Thumbnail Only</span>
<a name="l00046"></a><a class="code" href="classphpthumb.html#aa5dd9e55bb9d5f2e4b44fe82e1e7befc">00046</a>         var <a class="code" href="classphpthumb.html#aa5dd9e55bb9d5f2e4b44fe82e1e7befc">$ra</a>   = null;     <span class="comment">// Rotate by Angle</span>
<a name="l00047"></a><a class="code" href="classphpthumb.html#ab1f2a01f7454dc9f66e774282d5314f1">00047</a>         var <a class="code" href="classphpthumb.html#ab1f2a01f7454dc9f66e774282d5314f1">$ar</a>   = null;     <span class="comment">// Auto Rotate</span>
<a name="l00048"></a><a class="code" href="classphpthumb.html#a4476fe374c475a1a84e13cb0c928ba38">00048</a>         var <a class="code" href="classphpthumb.html#a4476fe374c475a1a84e13cb0c928ba38">$aoe</a>  = null;     <span class="comment">// Allow Output Enlargement</span>
<a name="l00049"></a><a class="code" href="classphpthumb.html#a35c67a414c00b2d00d2234dd68d78423">00049</a>         var <a class="code" href="classphpthumb.html#a35c67a414c00b2d00d2234dd68d78423">$far</a>  = null;     <span class="comment">// Fixed Aspect Ratio</span>
<a name="l00050"></a><a class="code" href="classphpthumb.html#ab03422788e693d3a93578db94beb4313">00050</a>         var <a class="code" href="classphpthumb.html#ab03422788e693d3a93578db94beb4313">$iar</a>  = null;     <span class="comment">// Ignore Aspect Ratio</span>
<a name="l00051"></a><a class="code" href="classphpthumb.html#ab5b58b6369ce3f4675f63f1cd16a06b1">00051</a>         var <a class="code" href="classphpthumb.html#ab5b58b6369ce3f4675f63f1cd16a06b1">$maxb</a> = null;     <span class="comment">// MAXimum Bytes</span>
<a name="l00052"></a><a class="code" href="classphpthumb.html#a8262ebe7fc165dd3940f4c4b84f0b9e5">00052</a>         var <a class="code" href="classphpthumb.html#a8262ebe7fc165dd3940f4c4b84f0b9e5">$down</a> = null;     <span class="comment">// DOWNload thumbnail filename</span>
<a name="l00053"></a><a class="code" href="classphpthumb.html#a3a51ab7a4aabe4e92a091174a757268e">00053</a>         var <a class="code" href="classphpthumb.html#a3a51ab7a4aabe4e92a091174a757268e">$md5s</a> = null;     <span class="comment">// MD5 hash of Source image</span>
<a name="l00054"></a><a class="code" href="classphpthumb.html#acd4e1d1f7e8aadc3a5449daf2093d822">00054</a>         var <a class="code" href="classphpthumb.html#acd4e1d1f7e8aadc3a5449daf2093d822">$sfn</a>  = 0;        <span class="comment">// Source Frame Number</span>
<a name="l00055"></a><a class="code" href="classphpthumb.html#aa2c42494936d91950c22a1daf900f34b">00055</a>         var <a class="code" href="classphpthumb.html#aa2c42494936d91950c22a1daf900f34b">$dpi</a>  = 150;      <span class="comment">// Dots Per Inch for vector source formats</span>
<a name="l00056"></a><a class="code" href="classphpthumb.html#acc674523b08937b837cca9a86fae417c">00056</a>         var <a class="code" href="classphpthumb.html#acc674523b08937b837cca9a86fae417c">$sia</a>  = null;     <span class="comment">// Save Image As filename</span>
<a name="l00057"></a>00057 
<a name="l00058"></a><a class="code" href="classphpthumb.html#aa1bfbd27060176201b271918dff57e8f">00058</a>         var <a class="code" href="classphpthumb.html#aa1bfbd27060176201b271918dff57e8f">$file</a> = null;     <span class="comment">// &gt;&gt;&gt;deprecated, DO NOT USE, will be removed in future versions&lt;&lt;&lt;</span>
<a name="l00059"></a>00059 
<a name="l00060"></a><a class="code" href="classphpthumb.html#a5ea1b0adce2141323162aa733f3c5724">00060</a>         var <a class="code" href="classphpthumb.html#a5ea1b0adce2141323162aa733f3c5724">$phpThumbDebug</a> = null;
<a name="l00061"></a>00061         <span class="comment">// END PARAMETERS</span>
<a name="l00062"></a>00062 
<a name="l00063"></a>00063 
<a name="l00064"></a>00064         <span class="comment">// public:</span>
<a name="l00065"></a>00065         <span class="comment">// START CONFIGURATION OPTIONS (for object mode only)</span>
<a name="l00066"></a>00066         <span class="comment">// See phpThumb.config.php for descriptions of what each of these settings do</span>
<a name="l00067"></a>00067 
<a name="l00068"></a>00068         <span class="comment">// * Directory Configuration</span>
<a name="l00069"></a><a class="code" href="classphpthumb.html#a6f1ea0e38cc38c6c21bf43e23e7567bd">00069</a>         var <a class="code" href="classphpthumb.html#a6f1ea0e38cc38c6c21bf43e23e7567bd">$config_cache_directory</a>                      = null;
<a name="l00070"></a><a class="code" href="classphpthumb.html#a0fe8e50f4c233b8bcc583647d65d32c1">00070</a>         var <a class="code" href="classphpthumb.html#a0fe8e50f4c233b8bcc583647d65d32c1">$config_cache_directory_depth</a>                = 0;
<a name="l00071"></a><a class="code" href="classphpthumb.html#ae21b800407b216cb9230d3e24905076e">00071</a>         var <a class="code" href="classphpthumb.html#ae21b800407b216cb9230d3e24905076e">$config_cache_disable_warning</a>                = <span class="keyword">true</span>;
<a name="l00072"></a><a class="code" href="classphpthumb.html#ab92f09c51f4abe7888854bd973685ba7">00072</a>         var <a class="code" href="classphpthumb.html#ab92f09c51f4abe7888854bd973685ba7">$config_cache_source_enabled</a>                 = <span class="keyword">false</span>;
<a name="l00073"></a><a class="code" href="classphpthumb.html#a016bc57de61c0cca8f1dab8ef7c914e5">00073</a>         var <a class="code" href="classphpthumb.html#a016bc57de61c0cca8f1dab8ef7c914e5">$config_cache_source_directory</a>               = null;
<a name="l00074"></a><a class="code" href="classphpthumb.html#a75e795ede03dcda9a52eab41c34dd275">00074</a>         var <a class="code" href="classphpthumb.html#a75e795ede03dcda9a52eab41c34dd275">$config_temp_directory</a>                       = null;
<a name="l00075"></a><a class="code" href="classphpthumb.html#a5e7516ab899729ad571b5dce43804136">00075</a>         var <a class="code" href="classphpthumb.html#a5e7516ab899729ad571b5dce43804136">$config_document_root</a>                        = null;
<a name="l00076"></a>00076 
<a name="l00077"></a>00077         <span class="comment">// * Default output configuration:</span>
<a name="l00078"></a><a class="code" href="classphpthumb.html#a45016abd81656e6df5a27b3c6f4063bf">00078</a>         var <a class="code" href="classphpthumb.html#a45016abd81656e6df5a27b3c6f4063bf">$config_output_format</a>                        = <span class="stringliteral">&#39;jpeg&#39;</span>;
<a name="l00079"></a><a class="code" href="classphpthumb.html#a544d8e79c2e0698907b770fec8631906">00079</a>         var <a class="code" href="classphpthumb.html#a544d8e79c2e0698907b770fec8631906">$config_output_maxwidth</a>                      = 0;
<a name="l00080"></a><a class="code" href="classphpthumb.html#ab497fe47f89c2a63b0f0dd2c6c695a7e">00080</a>         var <a class="code" href="classphpthumb.html#ab497fe47f89c2a63b0f0dd2c6c695a7e">$config_output_maxheight</a>                     = 0;
<a name="l00081"></a><a class="code" href="classphpthumb.html#ad53563602343b5e036a42fe5e320062d">00081</a>         var <a class="code" href="classphpthumb.html#ad53563602343b5e036a42fe5e320062d">$config_output_interlace</a>                     = <span class="keyword">true</span>;
<a name="l00082"></a>00082 
<a name="l00083"></a>00083         <span class="comment">// * Error message configuration</span>
<a name="l00084"></a><a class="code" href="classphpthumb.html#a7ad403dcc6087e425a7447797d0e3d87">00084</a>         var <a class="code" href="classphpthumb.html#a7ad403dcc6087e425a7447797d0e3d87">$config_error_image_width</a>                    = 400;
<a name="l00085"></a><a class="code" href="classphpthumb.html#afbb763265b204339e61eca522ccdb790">00085</a>         var <a class="code" href="classphpthumb.html#afbb763265b204339e61eca522ccdb790">$config_error_image_height</a>                   = 100;
<a name="l00086"></a><a class="code" href="classphpthumb.html#a4da86ff95777996dfd1bf82f6c701f68">00086</a>         var <a class="code" href="classphpthumb.html#a4da86ff95777996dfd1bf82f6c701f68">$config_error_message_image_default</a>          = <span class="stringliteral">&#39;&#39;</span>;
<a name="l00087"></a><a class="code" href="classphpthumb.html#aff5e96c934f314ed07c3a19f2871d9ef">00087</a>         var <a class="code" href="classphpthumb.html#aff5e96c934f314ed07c3a19f2871d9ef">$config_error_bgcolor</a>                        = <span class="stringliteral">&#39;CCCCFF&#39;</span>;
<a name="l00088"></a><a class="code" href="classphpthumb.html#a16a400481d689cd1ec16f40c66210853">00088</a>         var <a class="code" href="classphpthumb.html#a16a400481d689cd1ec16f40c66210853">$config_error_textcolor</a>                      = <span class="stringliteral">&#39;FF0000&#39;</span>;
<a name="l00089"></a><a class="code" href="classphpthumb.html#a4044010f89067040a3b03857ba6b967a">00089</a>         var <a class="code" href="classphpthumb.html#a4044010f89067040a3b03857ba6b967a">$config_error_fontsize</a>                       = 1;
<a name="l00090"></a><a class="code" href="classphpthumb.html#af581e427398e5626c2a36b079f61d386">00090</a>         var <a class="code" href="classphpthumb.html#af581e427398e5626c2a36b079f61d386">$config_error_die_on_error</a>                   = <span class="keyword">false</span>;
<a name="l00091"></a><a class="code" href="classphpthumb.html#aba286900da81068252f41bbd13c5e3a8">00091</a>         var <a class="code" href="classphpthumb.html#aba286900da81068252f41bbd13c5e3a8">$config_error_silent_die_on_error</a>            = <span class="keyword">false</span>;
<a name="l00092"></a><a class="code" href="classphpthumb.html#ae0ac10cb48648f8c6237af211c333b7c">00092</a>         var <a class="code" href="classphpthumb.html#ae0ac10cb48648f8c6237af211c333b7c">$config_error_die_on_source_failure</a>          = <span class="keyword">true</span>;
<a name="l00093"></a>00093 
<a name="l00094"></a>00094         <span class="comment">// * Anti-Hotlink Configuration:</span>
<a name="l00095"></a><a class="code" href="classphpthumb.html#ae12197392f78dd74b24e941bd7eebf11">00095</a>         var <a class="code" href="classphpthumb.html#ae12197392f78dd74b24e941bd7eebf11">$config_nohotlink_enabled</a>                    = <span class="keyword">true</span>;
<a name="l00096"></a><a class="code" href="classphpthumb.html#a91eebba1fb6ea8d2ab4cf4fcc33e35d2">00096</a>         var <a class="code" href="classphpthumb.html#a91eebba1fb6ea8d2ab4cf4fcc33e35d2">$config_nohotlink_valid_domains</a>              = array();
<a name="l00097"></a><a class="code" href="classphpthumb.html#ac55e6ecb30656e95e083c24e3e84cbdb">00097</a>         var <a class="code" href="classphpthumb.html#ac55e6ecb30656e95e083c24e3e84cbdb">$config_nohotlink_erase_image</a>                = <span class="keyword">true</span>;
<a name="l00098"></a><a class="code" href="classphpthumb.html#aaf2e68bd1243ec14c1f9b43155248b5f">00098</a>         var <a class="code" href="classphpthumb.html#aaf2e68bd1243ec14c1f9b43155248b5f">$config_nohotlink_text_message</a>               = <span class="stringliteral">&#39;Off-server thumbnailing is not allowed&#39;</span>;
<a name="l00099"></a>00099         <span class="comment">// * Off-server Linking Configuration:</span>
<a name="l00100"></a><a class="code" href="classphpthumb.html#a385b6747e38830f97924b59ff817b685">00100</a>         var <a class="code" href="classphpthumb.html#a385b6747e38830f97924b59ff817b685">$config_nooffsitelink_enabled</a>                = <span class="keyword">false</span>;
<a name="l00101"></a><a class="code" href="classphpthumb.html#a4f16379e498be5d94391f4894f5d5138">00101</a>         var <a class="code" href="classphpthumb.html#a4f16379e498be5d94391f4894f5d5138">$config_nooffsitelink_valid_domains</a>          = array();
<a name="l00102"></a><a class="code" href="classphpthumb.html#a53fb995b81843c6261414d7c8b8f6ff1">00102</a>         var <a class="code" href="classphpthumb.html#a53fb995b81843c6261414d7c8b8f6ff1">$config_nooffsitelink_require_refer</a>          = <span class="keyword">false</span>;
<a name="l00103"></a><a class="code" href="classphpthumb.html#a1afacc2e19a301bdb3d1d1e7c1edab5d">00103</a>         var <a class="code" href="classphpthumb.html#a1afacc2e19a301bdb3d1d1e7c1edab5d">$config_nooffsitelink_erase_image</a>            = <span class="keyword">true</span>;
<a name="l00104"></a><a class="code" href="classphpthumb.html#af0462a5c08bc93550fe64be568fe03bc">00104</a>         var <a class="code" href="classphpthumb.html#af0462a5c08bc93550fe64be568fe03bc">$config_nooffsitelink_watermark_src</a>          = <span class="stringliteral">&#39;&#39;</span>;
<a name="l00105"></a><a class="code" href="classphpthumb.html#a507e283cfd31885b4bfad9b33848c7c4">00105</a>         var <a class="code" href="classphpthumb.html#a507e283cfd31885b4bfad9b33848c7c4">$config_nooffsitelink_text_message</a>           = <span class="stringliteral">&#39;Off-server linking is not allowed&#39;</span>;
<a name="l00106"></a>00106 
<a name="l00107"></a>00107         <span class="comment">// * Border &amp; Background default colors</span>
<a name="l00108"></a><a class="code" href="classphpthumb.html#adf0e2f504c58f2a8cfeb844464f5169a">00108</a>         var <a class="code" href="classphpthumb.html#adf0e2f504c58f2a8cfeb844464f5169a">$config_border_hexcolor</a>                      = <span class="stringliteral">&#39;000000&#39;</span>;
<a name="l00109"></a><a class="code" href="classphpthumb.html#af1e9a05c677f1177c1eca2dddff1ec2b">00109</a>         var <a class="code" href="classphpthumb.html#af1e9a05c677f1177c1eca2dddff1ec2b">$config_background_hexcolor</a>                  = <span class="stringliteral">&#39;FFFFFF&#39;</span>;
<a name="l00110"></a>00110 
<a name="l00111"></a>00111         <span class="comment">// * TrueType Fonts</span>
<a name="l00112"></a><a class="code" href="classphpthumb.html#ae0f14e02e7d51f8070dd02b050a7c4d6">00112</a>         var <a class="code" href="classphpthumb.html#ae0f14e02e7d51f8070dd02b050a7c4d6">$config_ttf_directory</a>                        = <span class="stringliteral">&#39;./fonts&#39;</span>;
<a name="l00113"></a>00113 
<a name="l00114"></a><a class="code" href="classphpthumb.html#ad1c0e1eaceec9ad6415f8ecf5958e00d">00114</a>         var <a class="code" href="classphpthumb.html#ad1c0e1eaceec9ad6415f8ecf5958e00d">$config_max_source_pixels</a>                    = null;
<a name="l00115"></a><a class="code" href="classphpthumb.html#a2260d16825c059c6c03aa516fa2b2b7f">00115</a>         var <a class="code" href="classphpthumb.html#a2260d16825c059c6c03aa516fa2b2b7f">$config_use_exif_thumbnail_for_speed</a>         = <span class="keyword">false</span>;
<a name="l00116"></a><a class="code" href="classphpthumb.html#ae72326930c751f48d898a2179af2638e">00116</a>         var <a class="code" href="classphpthumb.html#ae72326930c751f48d898a2179af2638e">$allow_local_http_src</a>                        = <span class="keyword">false</span>;
<a name="l00117"></a>00117 
<a name="l00118"></a><a class="code" href="classphpthumb.html#ab08e40625923bb6cfabf56a7d05690d2">00118</a>         var <a class="code" href="classphpthumb.html#ab08e40625923bb6cfabf56a7d05690d2">$config_imagemagick_path</a>                     = null;
<a name="l00119"></a><a class="code" href="classphpthumb.html#a7225c3f0f85b5e7896edf77b9d6848d3">00119</a>         var <a class="code" href="classphpthumb.html#a7225c3f0f85b5e7896edf77b9d6848d3">$config_prefer_imagemagick</a>                   = <span class="keyword">true</span>;
<a name="l00120"></a><a class="code" href="classphpthumb.html#a573eb75cf3c126a5564fb99954040ce4">00120</a>         var <a class="code" href="classphpthumb.html#a573eb75cf3c126a5564fb99954040ce4">$config_imagemagick_use_thumbnail</a>            = <span class="keyword">true</span>;
<a name="l00121"></a>00121 
<a name="l00122"></a><a class="code" href="classphpthumb.html#a2fdcaab732a60957cf49c322119099ec">00122</a>         var <a class="code" href="classphpthumb.html#a2fdcaab732a60957cf49c322119099ec">$config_cache_maxage</a>                         = null;
<a name="l00123"></a><a class="code" href="classphpthumb.html#a967ff36542c5b7e9ac496cb564dce93e">00123</a>         var <a class="code" href="classphpthumb.html#a967ff36542c5b7e9ac496cb564dce93e">$config_cache_maxsize</a>                        = null;
<a name="l00124"></a><a class="code" href="classphpthumb.html#afc23922c5c0d63e27dd25f4d37291661">00124</a>         var <a class="code" href="classphpthumb.html#afc23922c5c0d63e27dd25f4d37291661">$config_cache_maxfiles</a>                       = null;
<a name="l00125"></a><a class="code" href="classphpthumb.html#abf770479577f0b9ea4cda6bf3e502ec0">00125</a>         var <a class="code" href="classphpthumb.html#abf770479577f0b9ea4cda6bf3e502ec0">$config_cache_source_filemtime_ignore_local</a>  = <span class="keyword">false</span>;
<a name="l00126"></a><a class="code" href="classphpthumb.html#ad57f6c0985cd137171dfa5858e2ef301">00126</a>         var <a class="code" href="classphpthumb.html#ad57f6c0985cd137171dfa5858e2ef301">$config_cache_source_filemtime_ignore_remote</a> = <span class="keyword">true</span>;
<a name="l00127"></a><a class="code" href="classphpthumb.html#a73b4d9a25c167d0849384abae21106a7">00127</a>         var <a class="code" href="classphpthumb.html#a73b4d9a25c167d0849384abae21106a7">$config_cache_default_only_suffix</a>            = <span class="keyword">false</span>;
<a name="l00128"></a><a class="code" href="classphpthumb.html#aec06fd52425aa29050b5818a9016b747">00128</a>         var <a class="code" href="classphpthumb.html#aec06fd52425aa29050b5818a9016b747">$config_cache_force_passthru</a>                 = <span class="keyword">true</span>;
<a name="l00129"></a><a class="code" href="classphpthumb.html#a7fecda7b314faa0ff10f191c67a87b99">00129</a>         var <a class="code" href="classphpthumb.html#a7fecda7b314faa0ff10f191c67a87b99">$config_cache_prefix</a>                         = <span class="stringliteral">&#39;&#39;</span>;    <span class="comment">// default value set in the constructor below</span>
<a name="l00130"></a>00130 
<a name="l00131"></a>00131         <span class="comment">// * MySQL</span>
<a name="l00132"></a><a class="code" href="classphpthumb.html#a4f9942ef012d88f8bcc4cfab432ce246">00132</a>         var <a class="code" href="classphpthumb.html#a4f9942ef012d88f8bcc4cfab432ce246">$config_mysql_query</a>                          = null;
<a name="l00133"></a><a class="code" href="classphpthumb.html#a9ea89232799f495f8ea0cad0d6b0e26d">00133</a>         var <a class="code" href="classphpthumb.html#a9ea89232799f495f8ea0cad0d6b0e26d">$config_mysql_hostname</a>                       = null;
<a name="l00134"></a><a class="code" href="classphpthumb.html#a60509d8ba9483d1fb03608f75bac5d5f">00134</a>         var <a class="code" href="classphpthumb.html#a60509d8ba9483d1fb03608f75bac5d5f">$config_mysql_username</a>                       = null;
<a name="l00135"></a><a class="code" href="classphpthumb.html#ace7fe07b3a9ecc4e5371d72559fcb152">00135</a>         var <a class="code" href="classphpthumb.html#ace7fe07b3a9ecc4e5371d72559fcb152">$config_mysql_password</a>                       = null;
<a name="l00136"></a><a class="code" href="classphpthumb.html#a2c7815ad10ad704d661c855f55cf937f">00136</a>         var <a class="code" href="classphpthumb.html#a2c7815ad10ad704d661c855f55cf937f">$config_mysql_database</a>                       = null;
<a name="l00137"></a>00137 
<a name="l00138"></a>00138         <span class="comment">// * Security</span>
<a name="l00139"></a><a class="code" href="classphpthumb.html#a7bea175f735e25a150e050ec9362c9af">00139</a>         var <a class="code" href="classphpthumb.html#a7bea175f735e25a150e050ec9362c9af">$config_high_security_enabled</a>                = <span class="keyword">false</span>;
<a name="l00140"></a><a class="code" href="classphpthumb.html#a29d0f3b5d5eb549d3a9b2a325964c663">00140</a>         var <a class="code" href="classphpthumb.html#a29d0f3b5d5eb549d3a9b2a325964c663">$config_high_security_password</a>               = null;
<a name="l00141"></a><a class="code" href="classphpthumb.html#ae2feee5651fb0b684dee782fed1da4d6">00141</a>         var <a class="code" href="classphpthumb.html#ae2feee5651fb0b684dee782fed1da4d6">$config_disable_debug</a>                        = <span class="keyword">false</span>;
<a name="l00142"></a><a class="code" href="classphpthumb.html#a648fed45c7195dd3a3d56495d67ae315">00142</a>         var <a class="code" href="classphpthumb.html#a648fed45c7195dd3a3d56495d67ae315">$config_allow_src_above_docroot</a>              = <span class="keyword">false</span>;
<a name="l00143"></a><a class="code" href="classphpthumb.html#a5fea59037c36e9ea306d2c4508b8922e">00143</a>         var <a class="code" href="classphpthumb.html#a5fea59037c36e9ea306d2c4508b8922e">$config_allow_src_above_phpthumb</a>             = <span class="keyword">true</span>;
<a name="l00144"></a><a class="code" href="classphpthumb.html#a2d0cf087aab9d55c440ad90c9e9fdffe">00144</a>         var <a class="code" href="classphpthumb.html#a2d0cf087aab9d55c440ad90c9e9fdffe">$config_allow_parameter_file</a>                 = <span class="keyword">false</span>;
<a name="l00145"></a><a class="code" href="classphpthumb.html#a657cf335fde0d0236e50624689ac0f0b">00145</a>         var <a class="code" href="classphpthumb.html#a657cf335fde0d0236e50624689ac0f0b">$config_allow_parameter_goto</a>                 = <span class="keyword">false</span>;
<a name="l00146"></a>00146 
<a name="l00147"></a>00147         <span class="comment">// * HTTP fopen</span>
<a name="l00148"></a><a class="code" href="classphpthumb.html#a61206f936265c8a8e80c9cf8374d5a95">00148</a>         var <a class="code" href="classphpthumb.html#a61206f936265c8a8e80c9cf8374d5a95">$config_http_fopen_timeout</a>                   = 10;
<a name="l00149"></a><a class="code" href="classphpthumb.html#a5f1965ab8b435defd7a15d4ee6c25359">00149</a>         var <a class="code" href="classphpthumb.html#a5f1965ab8b435defd7a15d4ee6c25359">$config_http_follow_redirect</a>                 = <span class="keyword">true</span>;
<a name="l00150"></a>00150 
<a name="l00151"></a>00151         <span class="comment">// * Compatability</span>
<a name="l00152"></a><a class="code" href="classphpthumb.html#aacc4e915aa4c3661410259aa7393b209">00152</a>         var <a class="code" href="classphpthumb.html#aacc4e915aa4c3661410259aa7393b209">$config_disable_pathinfo_parsing</a>             = <span class="keyword">false</span>;
<a name="l00153"></a><a class="code" href="classphpthumb.html#aa86c18ebe19e06917cfeefb4c8178eb7">00153</a>         var <a class="code" href="classphpthumb.html#aa86c18ebe19e06917cfeefb4c8178eb7">$config_disable_imagecopyresampled</a>           = <span class="keyword">false</span>;
<a name="l00154"></a><a class="code" href="classphpthumb.html#a53176d328574de015c3125839b05ec95">00154</a>         var <a class="code" href="classphpthumb.html#a53176d328574de015c3125839b05ec95">$config_disable_onlycreateable_passthru</a>      = <span class="keyword">false</span>;
<a name="l00155"></a>00155 
<a name="l00156"></a><a class="code" href="classphpthumb.html#abc56a69dc23d2cde3b0eade8241f9f20">00156</a>         var <a class="code" href="classphpthumb.html#abc56a69dc23d2cde3b0eade8241f9f20">$config_http_user_agent</a>                      = <span class="stringliteral">&#39;Mozilla/5.0 (Windows; U; Windows NT 5.1; en-US; rv:1.7.12) Gecko/20050915 Firefox/1.0.7&#39;</span>;
<a name="l00157"></a>00157 
<a name="l00158"></a>00158         <span class="comment">// END CONFIGURATION OPTIONS</span>
<a name="l00159"></a>00159 
<a name="l00160"></a>00160 
<a name="l00161"></a>00161         <span class="comment">// public: error messages (read-only; persistant)</span>
<a name="l00162"></a><a class="code" href="classphpthumb.html#a9844b0af825178231d04d733616997ff">00162</a>         var <a class="code" href="classphpthumb.html#a9844b0af825178231d04d733616997ff">$debugmessages</a> = array();
<a name="l00163"></a><a class="code" href="classphpthumb.html#aa4aaa412a490113f059a3109dadf9354">00163</a>         var <a class="code" href="classphpthumb.html#aa4aaa412a490113f059a3109dadf9354">$debugtiming</a>   = array();
<a name="l00164"></a><a class="code" href="classphpthumb.html#a5154a7d6e1a356ed560a27d738b9105e">00164</a>         var <a class="code" href="classphpthumb.html#a5154a7d6e1a356ed560a27d738b9105e">$fatalerror</a>    = null;
<a name="l00165"></a>00165 
<a name="l00166"></a>00166 
<a name="l00167"></a>00167         <span class="comment">// private: (should not be modified directly)</span>
<a name="l00168"></a><a class="code" href="classphpthumb.html#a8019fc14623bebdee5fa1f41a9fcec93">00168</a>         var <a class="code" href="classphpthumb.html#a8019fc14623bebdee5fa1f41a9fcec93">$thumbnailQuality</a> = 75;
<a name="l00169"></a><a class="code" href="classphpthumb.html#a094fa227731805ebfaf94491d57ea789">00169</a>         var <a class="code" href="classphpthumb.html#a094fa227731805ebfaf94491d57ea789">$thumbnailFormat</a>  = null;
<a name="l00170"></a>00170 
<a name="l00171"></a><a class="code" href="classphpthumb.html#addc48a9d1402a0d774b55f91e8f183c5">00171</a>         var <a class="code" href="classphpthumb.html#addc48a9d1402a0d774b55f91e8f183c5">$sourceFilename</a>   = null;
<a name="l00172"></a><a class="code" href="classphpthumb.html#a9d227dbccca8246b35282b417cc3c0cd">00172</a>         var <a class="code" href="classphpthumb.html#a9d227dbccca8246b35282b417cc3c0cd">$rawImageData</a>     = null;
<a name="l00173"></a><a class="code" href="classphpthumb.html#a4dd3158b66a650d7ff8b8ee27593ba3d">00173</a>         var <a class="code" href="classphpthumb.html#a4dd3158b66a650d7ff8b8ee27593ba3d">$IMresizedData</a>    = null;
<a name="l00174"></a><a class="code" href="classphpthumb.html#ac4df5ce5a7ea2c3c2bcada7c8199d166">00174</a>         var <a class="code" href="classphpthumb.html#ac4df5ce5a7ea2c3c2bcada7c8199d166">$outputImageData</a>  = null;
<a name="l00175"></a>00175 
<a name="l00176"></a><a class="code" href="classphpthumb.html#af0429b0bf6d89b7981370e9fc836ddd2">00176</a>         var <a class="code" href="classphpthumb.html#af0429b0bf6d89b7981370e9fc836ddd2">$useRawIMoutput</a>   = <span class="keyword">false</span>;
<a name="l00177"></a>00177 
<a name="l00178"></a><a class="code" href="classphpthumb.html#a4aff130a8285cee765b0b7ed131fc99e">00178</a>         var <a class="code" href="classphpthumb.html#a4aff130a8285cee765b0b7ed131fc99e">$gdimg_output</a>     = null;
<a name="l00179"></a><a class="code" href="classphpthumb.html#a71b025ba59af93b30b644fe62f4208cb">00179</a>         var <a class="code" href="classphpthumb.html#a71b025ba59af93b30b644fe62f4208cb">$gdimg_source</a>     = null;
<a name="l00180"></a>00180 
<a name="l00181"></a><a class="code" href="classphpthumb.html#ae792bec090643e366be48e28c3eced54">00181</a>         var <a class="code" href="classphpthumb.html#ae792bec090643e366be48e28c3eced54">$getimagesizeinfo</a> = null;
<a name="l00182"></a>00182 
<a name="l00183"></a><a class="code" href="classphpthumb.html#a47a4d1459c481498e4882768309c76a4">00183</a>         var <a class="code" href="classphpthumb.html#a47a4d1459c481498e4882768309c76a4">$source_width</a>  = null;
<a name="l00184"></a><a class="code" href="classphpthumb.html#aa11513eba4e8415eb5fe851f2a660fce">00184</a>         var <a class="code" href="classphpthumb.html#aa11513eba4e8415eb5fe851f2a660fce">$source_height</a> = null;
<a name="l00185"></a>00185 
<a name="l00186"></a><a class="code" href="classphpthumb.html#a85a4c25e3e8195a2b017eff5e15851c9">00186</a>         var <a class="code" href="classphpthumb.html#a85a4c25e3e8195a2b017eff5e15851c9">$thumbnailCropX</a> = null;
<a name="l00187"></a><a class="code" href="classphpthumb.html#a26191d2a789da72e6f8ca307fef0c80d">00187</a>         var <a class="code" href="classphpthumb.html#a26191d2a789da72e6f8ca307fef0c80d">$thumbnailCropY</a> = null;
<a name="l00188"></a><a class="code" href="classphpthumb.html#a2ad3bd527574e76e96d46da377e623ef">00188</a>         var <a class="code" href="classphpthumb.html#a2ad3bd527574e76e96d46da377e623ef">$thumbnailCropW</a> = null;
<a name="l00189"></a><a class="code" href="classphpthumb.html#a6f3c4136fc533ce985187db708175586">00189</a>         var <a class="code" href="classphpthumb.html#a6f3c4136fc533ce985187db708175586">$thumbnailCropH</a> = null;
<a name="l00190"></a>00190 
<a name="l00191"></a><a class="code" href="classphpthumb.html#a0a1e7abcecf6a4deafe1074405df1121">00191</a>         var <a class="code" href="classphpthumb.html#a0a1e7abcecf6a4deafe1074405df1121">$exif_thumbnail_width</a>  = null;
<a name="l00192"></a><a class="code" href="classphpthumb.html#af10534e62bb0eee76cf8021ed6b50610">00192</a>         var <a class="code" href="classphpthumb.html#af10534e62bb0eee76cf8021ed6b50610">$exif_thumbnail_height</a> = null;
<a name="l00193"></a><a class="code" href="classphpthumb.html#aa1b9fa571dcecc2bf427b2bfe7ec2e63">00193</a>         var <a class="code" href="classphpthumb.html#aa1b9fa571dcecc2bf427b2bfe7ec2e63">$exif_thumbnail_type</a>   = null;
<a name="l00194"></a><a class="code" href="classphpthumb.html#a5388f92cbbde9932ecd041a140c1de6e">00194</a>         var <a class="code" href="classphpthumb.html#a5388f92cbbde9932ecd041a140c1de6e">$exif_thumbnail_data</a>   = null;
<a name="l00195"></a><a class="code" href="classphpthumb.html#a668e140ccbb0ecbab79f9efed3c733f3">00195</a>         var <a class="code" href="classphpthumb.html#a668e140ccbb0ecbab79f9efed3c733f3">$exif_raw_data</a>         = null;
<a name="l00196"></a>00196 
<a name="l00197"></a><a class="code" href="classphpthumb.html#a5f47454ad3ff8c9fb39f4269449ee35d">00197</a>         var <a class="code" href="classphpthumb.html#a5f47454ad3ff8c9fb39f4269449ee35d">$thumbnail_width</a>        = null;
<a name="l00198"></a><a class="code" href="classphpthumb.html#a034dc8d8a0d5f492c31ddc0fedfa074a">00198</a>         var <a class="code" href="classphpthumb.html#a034dc8d8a0d5f492c31ddc0fedfa074a">$thumbnail_height</a>       = null;
<a name="l00199"></a><a class="code" href="classphpthumb.html#aca53c0112f34b2cbb102935b149503f0">00199</a>         var <a class="code" href="classphpthumb.html#aca53c0112f34b2cbb102935b149503f0">$thumbnail_image_width</a>  = null;
<a name="l00200"></a><a class="code" href="classphpthumb.html#ad07606d849cccf8c56a24e7d4ba3bffc">00200</a>         var <a class="code" href="classphpthumb.html#ad07606d849cccf8c56a24e7d4ba3bffc">$thumbnail_image_height</a> = null;
<a name="l00201"></a>00201 
<a name="l00202"></a><a class="code" href="classphpthumb.html#a66b1820d3e1ed3483f8161a1228afdac">00202</a>         var <a class="code" href="classphpthumb.html#a66b1820d3e1ed3483f8161a1228afdac">$cache_filename</a>         = null;
<a name="l00203"></a>00203 
<a name="l00204"></a><a class="code" href="classphpthumb.html#a3f8fc9d90b9f95d19c9a17ca30fac61e">00204</a>         var <a class="code" href="classphpthumb.html#a3f8fc9d90b9f95d19c9a17ca30fac61e">$AlphaCapableFormats</a> = array(<span class="stringliteral">&#39;png&#39;</span>, <span class="stringliteral">&#39;ico&#39;</span>, <span class="stringliteral">&#39;gif&#39;</span>);
<a name="l00205"></a><a class="code" href="classphpthumb.html#ad7121ed18a3b86ea01ef5eda0d95ba09">00205</a>         var <a class="code" href="classphpthumb.html#ad7121ed18a3b86ea01ef5eda0d95ba09">$is_alpha</a> = <span class="keyword">false</span>;
<a name="l00206"></a>00206 
<a name="l00207"></a><a class="code" href="classphpthumb.html#ab329ff4a45e917bcd2ce2759614f471a">00207</a>         var <a class="code" href="classphpthumb.html#ab329ff4a45e917bcd2ce2759614f471a">$iswindows</a> = null;
<a name="l00208"></a>00208 
<a name="l00209"></a><a class="code" href="classphpthumb.html#a3d502eae7449ca1aeb2de542d1c59638">00209</a>         var <a class="code" href="classphpthumb.html#a3d502eae7449ca1aeb2de542d1c59638">$phpthumb_version</a> = <span class="stringliteral">&#39;1.7.9-200805132119&#39;</span>;
<a name="l00210"></a>00210 
<a name="l00212"></a>00212 
<a name="l00213"></a>00213         <span class="comment">// public: constructor</span>
<a name="l00214"></a><a class="code" href="classphpthumb.html#adea410f87d32392cb47f4d5719d01fe5">00214</a>         <span class="keyword">function</span> <a class="code" href="classphpthumb.html#adea410f87d32392cb47f4d5719d01fe5">phpThumb</a>() {
<a name="l00215"></a>00215                 $this-&gt;<a class="code" href="classphpthumb.html#a0c9f92029be66d1dc44672ebc1fa35c0">DebugTimingMessage</a>(<span class="stringliteral">&#39;phpThumb() constructor&#39;</span>, __FILE__, __LINE__);
<a name="l00216"></a>00216                 $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;phpThumb() v&#39;</span>.$this-&gt;phpthumb_version, __FILE__, __LINE__);
<a name="l00217"></a>00217                 $this-&gt;config_max_source_pixels = round(max(intval(ini_get(<span class="stringliteral">&#39;memory_limit&#39;</span>)), intval(get_cfg_var(<span class="stringliteral">&#39;memory_limit&#39;</span>))) * 1048576 * 0.20); <span class="comment">// 20% of memory_limit</span>
<a name="l00218"></a>00218                 $this-&gt;iswindows = (bool) (strtoupper(substr(PHP_OS, 0, 3)) == <span class="stringliteral">&#39;WIN&#39;</span>);
<a name="l00219"></a>00219                 $this-&gt;config_document_root = (@$_SERVER[<span class="stringliteral">&#39;DOCUMENT_ROOT&#39;</span>] ? $_SERVER[<span class="stringliteral">&#39;DOCUMENT_ROOT&#39;</span>] : $this-&gt;config_document_root);
<a name="l00220"></a>00220                 $this-&gt;config_cache_prefix = <span class="stringliteral">&#39;phpThumb_cache_&#39;</span>.@$_SERVER[<span class="stringliteral">&#39;SERVER_NAME&#39;</span>];
<a name="l00221"></a>00221 
<a name="l00222"></a>00222                 <a class="code" href="php_thumb_8demo_8check_8php.html#ad475c14b05e96964a42b4c3859f4aff4">$php_sapi_name</a> = strtolower(function_exists(<span class="stringliteral">&#39;php_sapi_name&#39;</span>) ? php_sapi_name() : <span class="stringliteral">&#39;&#39;</span>);
<a name="l00223"></a>00223                 <span class="keywordflow">if</span> (<a class="code" href="php_thumb_8demo_8check_8php.html#ad475c14b05e96964a42b4c3859f4aff4">$php_sapi_name</a> == <span class="stringliteral">&#39;cli&#39;</span>) {
<a name="l00224"></a>00224                         $this-&gt;config_allow_src_above_docroot = <span class="keyword">true</span>;
<a name="l00225"></a>00225                 }
<a name="l00226"></a>00226         }
<a name="l00227"></a>00227 
<a name="l00228"></a>00228         <span class="comment">// public:</span>
<a name="l00229"></a><a class="code" href="classphpthumb.html#a07f20d87f62fbec6fba18e853ff7565b">00229</a>         <span class="keyword">function</span> <a class="code" href="classphpthumb.html#a07f20d87f62fbec6fba18e853ff7565b">setSourceFilename</a>(<a class="code" href="classphpthumb.html#addc48a9d1402a0d774b55f91e8f183c5">$sourceFilename</a>) {
<a name="l00230"></a>00230                 <span class="comment">//$this-&gt;resetObject();</span>
<a name="l00231"></a>00231                 <span class="comment">//$this-&gt;rawImageData   = null;</span>
<a name="l00232"></a>00232                 $this-&gt;sourceFilename = <a class="code" href="classphpthumb.html#addc48a9d1402a0d774b55f91e8f183c5">$sourceFilename</a>;
<a name="l00233"></a>00233                 $this-&gt;src            = <a class="code" href="classphpthumb.html#addc48a9d1402a0d774b55f91e8f183c5">$sourceFilename</a>;
<a name="l00234"></a>00234                 <span class="keywordflow">if</span> (is_null($this-&gt;config_output_format)) {
<a name="l00235"></a>00235                         $sourceFileExtension = strtolower(substr(strrchr(<a class="code" href="classphpthumb.html#addc48a9d1402a0d774b55f91e8f183c5">$sourceFilename</a>, <span class="charliteral">&#39;.&#39;</span>), 1));
<a name="l00236"></a>00236                         <span class="keywordflow">if</span> (ereg(<span class="stringliteral">&#39;^[a-z]{3,4}$&#39;</span>, $sourceFileExtension)) {
<a name="l00237"></a>00237                                 $this-&gt;config_output_format = $sourceFileExtension;
<a name="l00238"></a>00238                                 $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;setSourceFilename(&#39;</span>.<a class="code" href="classphpthumb.html#addc48a9d1402a0d774b55f91e8f183c5">$sourceFilename</a>.<span class="stringliteral">&#39;) set $this-&gt;config_output_format to &quot;&#39;</span>.$sourceFileExtension.<span class="charliteral">&#39;&quot;&#39;</span>, __FILE__, __LINE__);
<a name="l00239"></a>00239                         } <span class="keywordflow">else</span> {
<a name="l00240"></a>00240                                 $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;setSourceFilename(&#39;</span>.<a class="code" href="classphpthumb.html#addc48a9d1402a0d774b55f91e8f183c5">$sourceFilename</a>.<span class="stringliteral">&#39;) did NOT set $this-&gt;config_output_format to &quot;&#39;</span>.$sourceFileExtension.<span class="stringliteral">&#39;&quot; because it did not seem like an appropriate image format&#39;</span>, __FILE__, __LINE__);
<a name="l00241"></a>00241                         }
<a name="l00242"></a>00242                 }
<a name="l00243"></a>00243                 $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;setSourceFilename(&#39;</span>.<a class="code" href="classphpthumb.html#addc48a9d1402a0d774b55f91e8f183c5">$sourceFilename</a>.<span class="stringliteral">&#39;) set $this-&gt;sourceFilename to &quot;&#39;</span>.$this-&gt;sourceFilename.<span class="charliteral">&#39;&quot;&#39;</span>, __FILE__, __LINE__);
<a name="l00244"></a>00244                 <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00245"></a>00245         }
<a name="l00246"></a>00246 
<a name="l00247"></a>00247         <span class="comment">// public:</span>
<a name="l00248"></a><a class="code" href="classphpthumb.html#a41c532c5ca4af0f701a0051ff5391cd0">00248</a>         <span class="keyword">function</span> <a class="code" href="classphpthumb.html#a41c532c5ca4af0f701a0051ff5391cd0">setSourceData</a>(<a class="code" href="classphpthumb.html#a9d227dbccca8246b35282b417cc3c0cd">$rawImageData</a>, <a class="code" href="classphpthumb.html#addc48a9d1402a0d774b55f91e8f183c5">$sourceFilename</a>=<span class="stringliteral">&#39;&#39;</span>) {
<a name="l00249"></a>00249                 <span class="comment">//$this-&gt;resetObject();</span>
<a name="l00250"></a>00250                 <span class="comment">//$this-&gt;sourceFilename = null;</span>
<a name="l00251"></a>00251                 $this-&gt;<a class="code" href="php_thumb_8demo_8check_8php.html#a863670ff2c90a1dc616ebab121dbb296">rawImageData</a>   = <a class="code" href="classphpthumb.html#a9d227dbccca8246b35282b417cc3c0cd">$rawImageData</a>;
<a name="l00252"></a>00252                 $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;setSourceData() setting $this-&gt;rawImageData (&#39;</span>.strlen($this-&gt;<a class="code" href="php_thumb_8demo_8check_8php.html#a863670ff2c90a1dc616ebab121dbb296">rawImageData</a>).<span class="stringliteral">&#39; bytes; magic=&quot;&#39;</span>.substr($this-&gt;<a class="code" href="php_thumb_8demo_8check_8php.html#a863670ff2c90a1dc616ebab121dbb296">rawImageData</a>, 0, 4).<span class="stringliteral">&#39;&quot; (&#39;</span>.<a class="code" href="classphpthumb__functions.html#a990a73d0fe31b520e04251295aeded25">phpthumb_functions::HexCharDisplay</a>(substr($this-&gt;<a class="code" href="php_thumb_8demo_8check_8php.html#a863670ff2c90a1dc616ebab121dbb296">rawImageData</a>, 0, 4)).<span class="stringliteral">&#39;))&#39;</span>, __FILE__, __LINE__);
<a name="l00253"></a>00253                 <span class="keywordflow">if</span> ($this-&gt;config_cache_source_enabled) {
<a name="l00254"></a>00254                         <a class="code" href="classphpthumb.html#addc48a9d1402a0d774b55f91e8f183c5">$sourceFilename</a> = (<a class="code" href="classphpthumb.html#addc48a9d1402a0d774b55f91e8f183c5">$sourceFilename</a> ? <a class="code" href="classphpthumb.html#addc48a9d1402a0d774b55f91e8f183c5">$sourceFilename</a> : md5(<a class="code" href="classphpthumb.html#a9d227dbccca8246b35282b417cc3c0cd">$rawImageData</a>));
<a name="l00255"></a>00255                         <span class="keywordflow">if</span> (!is_dir($this-&gt;config_cache_source_directory)) {
<a name="l00256"></a>00256                                 $this-&gt;<a class="code" href="classphpthumb.html#a6ff71b425894fd846790cedf9f9cc97d">ErrorImage</a>(<span class="stringliteral">&#39;$this-&gt;config_cache_source_directory (&#39;</span>.$this-&gt;config_cache_source_directory.<span class="stringliteral">&#39;) is not a directory&#39;</span>);
<a name="l00257"></a>00257                         } <a class="code" href="php_thumb_8demo_8check_8php.html#af92779326267616cd7c3cdaaa9484bc9">elseif</a> (!@is_writable($this-&gt;config_cache_source_directory)) {
<a name="l00258"></a>00258                                 $this-&gt;<a class="code" href="classphpthumb.html#a6ff71b425894fd846790cedf9f9cc97d">ErrorImage</a>(<span class="stringliteral">&#39;$this-&gt;config_cache_source_directory (&#39;</span>.$this-&gt;config_cache_source_directory.<span class="stringliteral">&#39;) is not writable&#39;</span>);
<a name="l00259"></a>00259                         }
<a name="l00260"></a>00260                         $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;setSourceData() attempting to save source image to &quot;&#39;</span>.$this-&gt;config_cache_source_directory.DIRECTORY_SEPARATOR.urlencode(<a class="code" href="classphpthumb.html#addc48a9d1402a0d774b55f91e8f183c5">$sourceFilename</a>).<span class="charliteral">&#39;&quot;&#39;</span>, __FILE__, __LINE__);
<a name="l00261"></a>00261                         <span class="keywordflow">if</span> ($fp = @fopen($this-&gt;config_cache_source_directory.DIRECTORY_SEPARATOR.urlencode(<a class="code" href="classphpthumb.html#addc48a9d1402a0d774b55f91e8f183c5">$sourceFilename</a>), <span class="stringliteral">&#39;wb&#39;</span>)) {
<a name="l00262"></a>00262                                 fwrite($fp, <a class="code" href="classphpthumb.html#a9d227dbccca8246b35282b417cc3c0cd">$rawImageData</a>);
<a name="l00263"></a>00263                                 fclose($fp);
<a name="l00264"></a>00264                         } <a class="code" href="php_thumb_8demo_8check_8php.html#af92779326267616cd7c3cdaaa9484bc9">elseif</a> (!$this-&gt;<a class="code" href="classphpthumb.html#a8329c63c143bd310899667d0b130ddcd">phpThumbDebug</a>) {
<a name="l00265"></a>00265                                 $this-&gt;<a class="code" href="classphpthumb.html#a6ff71b425894fd846790cedf9f9cc97d">ErrorImage</a>(<span class="stringliteral">&#39;setSourceData() failed to write to source cache (&#39;</span>.$this-&gt;config_cache_source_directory.DIRECTORY_SEPARATOR.urlencode(<a class="code" href="classphpthumb.html#addc48a9d1402a0d774b55f91e8f183c5">$sourceFilename</a>).<span class="charliteral">&#39;)&#39;</span>);
<a name="l00266"></a>00266                         }
<a name="l00267"></a>00267                 }
<a name="l00268"></a>00268                 <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00269"></a>00269         }
<a name="l00270"></a>00270 
<a name="l00271"></a>00271         <span class="comment">// public:</span>
<a name="l00272"></a><a class="code" href="classphpthumb.html#a1acad5b7b736293aef4b15a045a2beb1">00272</a>         <span class="keyword">function</span> <a class="code" href="classphpthumb.html#a1acad5b7b736293aef4b15a045a2beb1">setSourceImageResource</a>($gdimg) {
<a name="l00273"></a>00273                 <span class="comment">//$this-&gt;resetObject();</span>
<a name="l00274"></a>00274                 $this-&gt;gdimg_source = $gdimg;
<a name="l00275"></a>00275                 <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00276"></a>00276         }
<a name="l00277"></a>00277 
<a name="l00278"></a>00278         <span class="comment">// public:</span>
<a name="l00279"></a><a class="code" href="classphpthumb.html#ac80ddbce5c268e2e3cef41e39f41c9f9">00279</a>         <span class="keyword">function</span> <a class="code" href="classphpthumb.html#ac80ddbce5c268e2e3cef41e39f41c9f9">setParameter</a>($param, $value) {
<a name="l00280"></a>00280                 <span class="keywordflow">if</span> ($param == <span class="stringliteral">&#39;src&#39;</span>) {
<a name="l00281"></a>00281                         $this-&gt;<a class="code" href="classphpthumb.html#a07f20d87f62fbec6fba18e853ff7565b">setSourceFilename</a>($this-&gt;<a class="code" href="classphpthumb.html#a49cc25fd831b2990b8f5743e8d6abe30">ResolveFilenameToAbsolute</a>($value));
<a name="l00282"></a>00282                 } <a class="code" href="php_thumb_8demo_8check_8php.html#af92779326267616cd7c3cdaaa9484bc9">elseif</a> (@is_array($this-&gt;$param)) {
<a name="l00283"></a>00283                         <span class="keywordflow">if</span> (is_array($value)) {
<a name="l00284"></a>00284                                 <span class="keywordflow">foreach</span> ($value as $arraykey =&gt; $arrayvalue) {
<a name="l00285"></a>00285                                         array_push($this-&gt;$param, $arrayvalue);
<a name="l00286"></a>00286                                 }
<a name="l00287"></a>00287                         } <span class="keywordflow">else</span> {
<a name="l00288"></a>00288                                 array_push($this-&gt;$param, $value);
<a name="l00289"></a>00289                         }
<a name="l00290"></a>00290                 } <span class="keywordflow">else</span> {
<a name="l00291"></a>00291                         $this-&gt;$param = $value;
<a name="l00292"></a>00292                 }
<a name="l00293"></a>00293                 <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00294"></a>00294         }
<a name="l00295"></a>00295 
<a name="l00296"></a>00296         <span class="comment">// public:</span>
<a name="l00297"></a><a class="code" href="classphpthumb.html#ada9fdf74cfd46223697a2697259a968f">00297</a>         <span class="keyword">function</span> <a class="code" href="classphpthumb.html#ada9fdf74cfd46223697a2697259a968f">getParameter</a>($param) {
<a name="l00298"></a>00298                 <span class="comment">//if (property_exists(&#39;phpThumb&#39;, $param)) {</span>
<a name="l00299"></a>00299                         <span class="keywordflow">return</span> $this-&gt;$param;
<a name="l00300"></a>00300                 <span class="comment">//}</span>
<a name="l00301"></a>00301                 <span class="comment">//$this-&gt;DebugMessage(&#39;setParameter() attempting to get non-existant parameter &quot;&#39;.$param.&#39;&quot;&#39;, __FILE__, __LINE__);</span>
<a name="l00302"></a>00302                 <span class="comment">//return false;</span>
<a name="l00303"></a>00303         }
<a name="l00304"></a>00304 
<a name="l00305"></a>00305 
<a name="l00306"></a>00306         <span class="comment">// public:</span>
<a name="l00307"></a><a class="code" href="classphpthumb.html#a7932c8fc95aea6838b2f232c8d764cc9">00307</a>         <span class="keyword">function</span> <a class="code" href="classphpthumb.html#a7932c8fc95aea6838b2f232c8d764cc9">GenerateThumbnail</a>() {
<a name="l00308"></a>00308 
<a name="l00309"></a>00309                 $this-&gt;<a class="code" href="classphpthumb.html#a422bcfa5097eee6cd64570424c89a9d1">setOutputFormat</a>();
<a name="l00310"></a>00310                         $this-&gt;<a class="code" href="classphpthumb.html#a8329c63c143bd310899667d0b130ddcd">phpThumbDebug</a>(<span class="stringliteral">&#39;8a&#39;</span>);
<a name="l00311"></a>00311                 $this-&gt;<a class="code" href="classphpthumb.html#a55b58f691d10245443a42b72c782c700">ResolveSource</a>();
<a name="l00312"></a>00312                         $this-&gt;<a class="code" href="classphpthumb.html#a8329c63c143bd310899667d0b130ddcd">phpThumbDebug</a>(<span class="stringliteral">&#39;8b&#39;</span>);
<a name="l00313"></a>00313                 $this-&gt;<a class="code" href="classphpthumb.html#a5a0ad9153330752259ca0e350cc4fa44">SetCacheFilename</a>();
<a name="l00314"></a>00314                         $this-&gt;<a class="code" href="classphpthumb.html#a8329c63c143bd310899667d0b130ddcd">phpThumbDebug</a>(<span class="stringliteral">&#39;8c&#39;</span>);
<a name="l00315"></a>00315                 $this-&gt;<a class="code" href="classphpthumb.html#a49a5e90738a76b0ff5a4d2a5fc61339a">ExtractEXIFgetImageSize</a>();
<a name="l00316"></a>00316                         $this-&gt;<a class="code" href="classphpthumb.html#a8329c63c143bd310899667d0b130ddcd">phpThumbDebug</a>(<span class="stringliteral">&#39;8d&#39;</span>);
<a name="l00317"></a>00317                 <span class="keywordflow">if</span> ($this-&gt;useRawIMoutput) {
<a name="l00318"></a>00318                         $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;Skipping rest of GenerateThumbnail() because ($this-&gt;useRawIMoutput == true)&#39;</span>, __FILE__, __LINE__);
<a name="l00319"></a>00319                         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00320"></a>00320                 }
<a name="l00321"></a>00321                         $this-&gt;<a class="code" href="classphpthumb.html#a8329c63c143bd310899667d0b130ddcd">phpThumbDebug</a>(<span class="stringliteral">&#39;8e&#39;</span>);
<a name="l00322"></a>00322                 <span class="keywordflow">if</span> (!$this-&gt;<a class="code" href="classphpthumb.html#a92f78bcb7f3b0018668b51be60821f9c">SourceImageToGD</a>()) {
<a name="l00323"></a>00323                         $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;SourceImageToGD() failed&#39;</span>, __FILE__, __LINE__);
<a name="l00324"></a>00324                         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00325"></a>00325                 }
<a name="l00326"></a>00326                         $this-&gt;<a class="code" href="classphpthumb.html#a8329c63c143bd310899667d0b130ddcd">phpThumbDebug</a>(<span class="stringliteral">&#39;8f&#39;</span>);
<a name="l00327"></a>00327                 $this-&gt;<a class="code" href="classphpthumb.html#ad799f5f4019f5ca9f5eb3a0f8da091f0">Rotate</a>();
<a name="l00328"></a>00328                         $this-&gt;<a class="code" href="classphpthumb.html#a8329c63c143bd310899667d0b130ddcd">phpThumbDebug</a>(<span class="stringliteral">&#39;8g&#39;</span>);
<a name="l00329"></a>00329                 $this-&gt;<a class="code" href="classphpthumb.html#a83149fb942a8f8508f342f422f115947">CreateGDoutput</a>();
<a name="l00330"></a>00330                         $this-&gt;<a class="code" href="classphpthumb.html#a8329c63c143bd310899667d0b130ddcd">phpThumbDebug</a>(<span class="stringliteral">&#39;8h&#39;</span>);
<a name="l00331"></a>00331 
<a name="l00332"></a>00332                 <span class="keywordflow">switch</span> ($this-&gt;far) {
<a name="l00333"></a>00333                         <span class="keywordflow">case</span> <span class="charliteral">&#39;L&#39;</span>:
<a name="l00334"></a>00334                         <span class="keywordflow">case</span> <span class="stringliteral">&#39;TL&#39;</span>:
<a name="l00335"></a>00335                         <span class="keywordflow">case</span> <span class="stringliteral">&#39;BL&#39;</span>:
<a name="l00336"></a>00336                                 $destination_offset_x = 0;
<a name="l00337"></a>00337                                 $destination_offset_y = round(($this-&gt;thumbnail_height - $this-&gt;thumbnail_image_height) / 2);
<a name="l00338"></a>00338                                 <span class="keywordflow">break</span>;
<a name="l00339"></a>00339                         <span class="keywordflow">case</span> <span class="charliteral">&#39;R&#39;</span>:
<a name="l00340"></a>00340                         <span class="keywordflow">case</span> <span class="stringliteral">&#39;TR&#39;</span>:
<a name="l00341"></a>00341                         <span class="keywordflow">case</span> <span class="stringliteral">&#39;BR&#39;</span>:
<a name="l00342"></a>00342                                 $destination_offset_x =  round($this-&gt;thumbnail_width  - $this-&gt;thumbnail_image_width);
<a name="l00343"></a>00343                                 $destination_offset_y = round(($this-&gt;thumbnail_height - $this-&gt;thumbnail_image_height) / 2);
<a name="l00344"></a>00344                                 <span class="keywordflow">break</span>;
<a name="l00345"></a>00345                         <span class="keywordflow">case</span> <span class="charliteral">&#39;T&#39;</span>:
<a name="l00346"></a>00346                         <span class="keywordflow">case</span> <span class="stringliteral">&#39;TL&#39;</span>:
<a name="l00347"></a>00347                         <span class="keywordflow">case</span> <span class="stringliteral">&#39;TR&#39;</span>:
<a name="l00348"></a>00348                                 $destination_offset_x = round(($this-&gt;thumbnail_width  - $this-&gt;thumbnail_image_width)  / 2);
<a name="l00349"></a>00349                                 $destination_offset_y = 0;
<a name="l00350"></a>00350                                 <span class="keywordflow">break</span>;
<a name="l00351"></a>00351                         <span class="keywordflow">case</span> <span class="charliteral">&#39;B&#39;</span>:
<a name="l00352"></a>00352                         <span class="keywordflow">case</span> <span class="stringliteral">&#39;BL&#39;</span>:
<a name="l00353"></a>00353                         <span class="keywordflow">case</span> <span class="stringliteral">&#39;BR&#39;</span>:
<a name="l00354"></a>00354                                 $destination_offset_x = round(($this-&gt;thumbnail_width  - $this-&gt;thumbnail_image_width)  / 2);
<a name="l00355"></a>00355                                 $destination_offset_y =  round($this-&gt;thumbnail_height - $this-&gt;thumbnail_image_height);
<a name="l00356"></a>00356                                 <span class="keywordflow">break</span>;
<a name="l00357"></a>00357                         <span class="keywordflow">case</span> <span class="charliteral">&#39;C&#39;</span>:
<a name="l00358"></a>00358                         <span class="keywordflow">default</span>:
<a name="l00359"></a>00359                                 $destination_offset_x = round(($this-&gt;thumbnail_width  - $this-&gt;thumbnail_image_width)  / 2);
<a name="l00360"></a>00360                                 $destination_offset_y = round(($this-&gt;thumbnail_height - $this-&gt;thumbnail_image_height) / 2);
<a name="l00361"></a>00361                 }
<a name="l00362"></a>00362 
<a name="l00363"></a>00363 <span class="comment">//              // copy/resize image to appropriate dimensions</span>
<a name="l00364"></a>00364 <span class="comment">//              $borderThickness = 0;</span>
<a name="l00365"></a>00365 <span class="comment">//              if (!empty($this-&gt;fltr)) {</span>
<a name="l00366"></a>00366 <span class="comment">//                      foreach ($this-&gt;fltr as $key =&gt; $value) {</span>
<a name="l00367"></a>00367 <span class="comment">//                              if (ereg(&#39;^bord\|([0-9]+)&#39;, $value, $matches)) {</span>
<a name="l00368"></a>00368 <span class="comment">//                                      $borderThickness = $matches[1];</span>
<a name="l00369"></a>00369 <span class="comment">//                                      break;</span>
<a name="l00370"></a>00370 <span class="comment">//                              }</span>
<a name="l00371"></a>00371 <span class="comment">//                      }</span>
<a name="l00372"></a>00372 <span class="comment">//              }</span>
<a name="l00373"></a>00373 <span class="comment">//              if ($borderThickness &gt; 0) {</span>
<a name="l00374"></a>00374 <span class="comment">//                      //$this-&gt;DebugMessage(&#39;Skipping ImageResizeFunction() because BorderThickness=&quot;&#39;.$borderThickness.&#39;&quot;&#39;, __FILE__, __LINE__);</span>
<a name="l00375"></a>00375 <span class="comment">//                      $this-&gt;thumbnail_image_height /= 2;</span>
<a name="l00376"></a>00376 <span class="comment">//              }</span>
<a name="l00377"></a>00377                 $this-&gt;<a class="code" href="classphpthumb.html#a4282192b16e760c7a6f12036081e8c82">ImageResizeFunction</a>(
<a name="l00378"></a>00378                         $this-&gt;gdimg_output,
<a name="l00379"></a>00379                         $this-&gt;gdimg_source,
<a name="l00380"></a>00380                         $destination_offset_x,
<a name="l00381"></a>00381                         $destination_offset_y,
<a name="l00382"></a>00382                         $this-&gt;thumbnailCropX,
<a name="l00383"></a>00383                         $this-&gt;thumbnailCropY,
<a name="l00384"></a>00384                         $this-&gt;thumbnail_image_width,
<a name="l00385"></a>00385                         $this-&gt;thumbnail_image_height,
<a name="l00386"></a>00386                         $this-&gt;thumbnailCropW,
<a name="l00387"></a>00387                         $this-&gt;thumbnailCropH
<a name="l00388"></a>00388                 );
<a name="l00389"></a>00389 
<a name="l00390"></a>00390                 $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;memory_get_usage() after copy-resize = &#39;</span>.(function_exists(<span class="stringliteral">&#39;memory_get_usage&#39;</span>) ? @memory_get_usage() : <span class="stringliteral">&#39;n/a&#39;</span>), __FILE__, __LINE__);
<a name="l00391"></a>00391                 ImageDestroy($this-&gt;gdimg_source);
<a name="l00392"></a>00392                 $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;memory_get_usage() after ImageDestroy = &#39;</span>.(function_exists(<span class="stringliteral">&#39;memory_get_usage&#39;</span>) ? @memory_get_usage() : <span class="stringliteral">&#39;n/a&#39;</span>), __FILE__, __LINE__);
<a name="l00393"></a>00393 
<a name="l00394"></a>00394                         $this-&gt;<a class="code" href="classphpthumb.html#a8329c63c143bd310899667d0b130ddcd">phpThumbDebug</a>(<span class="stringliteral">&#39;8i&#39;</span>);
<a name="l00395"></a>00395                 $this-&gt;<a class="code" href="classphpthumb.html#a1ffe44d7b342017608ce694cb875cbf4">AntiOffsiteLinking</a>();
<a name="l00396"></a>00396                         $this-&gt;<a class="code" href="classphpthumb.html#a8329c63c143bd310899667d0b130ddcd">phpThumbDebug</a>(<span class="stringliteral">&#39;8j&#39;</span>);
<a name="l00397"></a>00397                 $this-&gt;<a class="code" href="classphpthumb.html#ae5888b30377b0c4cedc8953ea9958a87">ApplyFilters</a>();
<a name="l00398"></a>00398                         $this-&gt;<a class="code" href="classphpthumb.html#a8329c63c143bd310899667d0b130ddcd">phpThumbDebug</a>(<span class="stringliteral">&#39;8k&#39;</span>);
<a name="l00399"></a>00399                 $this-&gt;<a class="code" href="classphpthumb.html#affcf07b54508c9914d0eb280b7ae91c0">AlphaChannelFlatten</a>();
<a name="l00400"></a>00400                         $this-&gt;<a class="code" href="classphpthumb.html#a8329c63c143bd310899667d0b130ddcd">phpThumbDebug</a>(<span class="stringliteral">&#39;8l&#39;</span>);
<a name="l00401"></a>00401                 $this-&gt;<a class="code" href="classphpthumb.html#a97ff8a6aa5afe83ac1fcf0fae0cb03d3">MaxFileSize</a>();
<a name="l00402"></a>00402                         $this-&gt;<a class="code" href="classphpthumb.html#a8329c63c143bd310899667d0b130ddcd">phpThumbDebug</a>(<span class="stringliteral">&#39;8m&#39;</span>);
<a name="l00403"></a>00403 
<a name="l00404"></a>00404                 $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;GenerateThumbnail() completed successfully&#39;</span>, __FILE__, __LINE__);
<a name="l00405"></a>00405                 <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00406"></a>00406         }
<a name="l00407"></a>00407 
<a name="l00408"></a>00408 
<a name="l00409"></a>00409         <span class="comment">// public:</span>
<a name="l00410"></a><a class="code" href="classphpthumb.html#a91f8339fc5ba66e15a1ea92720c0afbc">00410</a>         <span class="keyword">function</span> <a class="code" href="classphpthumb.html#a91f8339fc5ba66e15a1ea92720c0afbc">RenderOutput</a>() {
<a name="l00411"></a>00411                 <span class="keywordflow">if</span> (!$this-&gt;useRawIMoutput &amp;&amp; !is_resource($this-&gt;gdimg_output)) {
<a name="l00412"></a>00412                         $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;RenderOutput() failed because !is_resource($this-&gt;gdimg_output)&#39;</span>, __FILE__, __LINE__);
<a name="l00413"></a>00413                         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00414"></a>00414                 }
<a name="l00415"></a>00415                 <span class="keywordflow">if</span> (!$this-&gt;thumbnailFormat) {
<a name="l00416"></a>00416                         $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;RenderOutput() failed because $this-&gt;thumbnailFormat is empty&#39;</span>, __FILE__, __LINE__);
<a name="l00417"></a>00417                         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00418"></a>00418                 }
<a name="l00419"></a>00419                 <span class="keywordflow">if</span> ($this-&gt;useRawIMoutput) {
<a name="l00420"></a>00420                         $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;RenderOutput copying $this-&gt;IMresizedData (&#39;</span>.strlen($this-&gt;IMresizedData).<span class="stringliteral">&#39; bytes) to $this-&gt;outputImage&#39;</span>, __FILE__, __LINE__);
<a name="l00421"></a>00421                         $this-&gt;outputImageData = $this-&gt;IMresizedData;
<a name="l00422"></a>00422                         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00423"></a>00423                 }
<a name="l00424"></a>00424 
<a name="l00425"></a>00425                 $builtin_formats = array();
<a name="l00426"></a>00426                 <span class="keywordflow">if</span> (function_exists(<span class="stringliteral">&#39;ImageTypes&#39;</span>)) {
<a name="l00427"></a>00427                         $imagetypes = ImageTypes();
<a name="l00428"></a>00428                         $builtin_formats[<span class="stringliteral">&#39;wbmp&#39;</span>] = (bool) ($imagetypes &amp; IMG_WBMP);
<a name="l00429"></a>00429                         $builtin_formats[<span class="stringliteral">&#39;jpg&#39;</span>]  = (bool) ($imagetypes &amp; IMG_JPG);
<a name="l00430"></a>00430                         $builtin_formats[<span class="stringliteral">&#39;gif&#39;</span>]  = (bool) ($imagetypes &amp; IMG_GIF);
<a name="l00431"></a>00431                         $builtin_formats[<span class="stringliteral">&#39;png&#39;</span>]  = (bool) ($imagetypes &amp; IMG_PNG);
<a name="l00432"></a>00432                 }
<a name="l00433"></a>00433                 $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;RenderOutput() attempting Image&#39;</span>.strtoupper(@$this-&gt;thumbnailFormat).<span class="stringliteral">&#39;($this-&gt;gdimg_output)&#39;</span>, __FILE__, __LINE__);
<a name="l00434"></a>00434                 ob_start();
<a name="l00435"></a>00435                 <span class="keywordflow">switch</span> ($this-&gt;thumbnailFormat) {
<a name="l00436"></a>00436                         <span class="keywordflow">case</span> <span class="stringliteral">&#39;wbmp&#39;</span>:
<a name="l00437"></a>00437                                 <span class="keywordflow">if</span> (!@$builtin_formats[<span class="stringliteral">&#39;wbmp&#39;</span>]) {
<a name="l00438"></a>00438                                         $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;GD does not have required built-in support for WBMP output&#39;</span>, __FILE__, __LINE__);
<a name="l00439"></a>00439                                         ob_end_clean();
<a name="l00440"></a>00440                                         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00441"></a>00441                                 }
<a name="l00442"></a>00442                                 ImageJPEG($this-&gt;gdimg_output, null, $this-&gt;thumbnailQuality);
<a name="l00443"></a>00443                                 $this-&gt;outputImageData = ob_get_contents();
<a name="l00444"></a>00444                                 <span class="keywordflow">break</span>;
<a name="l00445"></a>00445 
<a name="l00446"></a>00446                         <span class="keywordflow">case</span> <span class="stringliteral">&#39;jpeg&#39;</span>:
<a name="l00447"></a>00447                         <span class="keywordflow">case</span> <span class="stringliteral">&#39;jpg&#39;</span>:  <span class="comment">// should be &quot;jpeg&quot; not &quot;jpg&quot; but just in case...</span>
<a name="l00448"></a>00448                                 <span class="keywordflow">if</span> (!@$builtin_formats[<span class="stringliteral">&#39;jpg&#39;</span>]) {
<a name="l00449"></a>00449                                         $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;GD does not have required built-in support for JPEG output&#39;</span>, __FILE__, __LINE__);
<a name="l00450"></a>00450                                         ob_end_clean();
<a name="l00451"></a>00451                                         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00452"></a>00452                                 }
<a name="l00453"></a>00453                                 ImageJPEG($this-&gt;gdimg_output, null, $this-&gt;thumbnailQuality);
<a name="l00454"></a>00454                                 $this-&gt;outputImageData = ob_get_contents();
<a name="l00455"></a>00455                                 <span class="keywordflow">break</span>;
<a name="l00456"></a>00456 
<a name="l00457"></a>00457                         <span class="keywordflow">case</span> <span class="stringliteral">&#39;png&#39;</span>:
<a name="l00458"></a>00458                                 <span class="keywordflow">if</span> (!@$builtin_formats[<span class="stringliteral">&#39;png&#39;</span>]) {
<a name="l00459"></a>00459                                         $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;GD does not have required built-in support for PNG output&#39;</span>, __FILE__, __LINE__);
<a name="l00460"></a>00460                                         ob_end_clean();
<a name="l00461"></a>00461                                         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00462"></a>00462                                 }
<a name="l00463"></a>00463                                 ImagePNG($this-&gt;gdimg_output);
<a name="l00464"></a>00464                                 $this-&gt;outputImageData = ob_get_contents();
<a name="l00465"></a>00465                                 <span class="keywordflow">break</span>;
<a name="l00466"></a>00466 
<a name="l00467"></a>00467                         <span class="keywordflow">case</span> <span class="stringliteral">&#39;gif&#39;</span>:
<a name="l00468"></a>00468                                 <span class="keywordflow">if</span> (!@$builtin_formats[<span class="stringliteral">&#39;gif&#39;</span>]) {
<a name="l00469"></a>00469                                         $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;GD does not have required built-in support for GIF output&#39;</span>, __FILE__, __LINE__);
<a name="l00470"></a>00470                                         ob_end_clean();
<a name="l00471"></a>00471                                         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00472"></a>00472                                 }
<a name="l00473"></a>00473                                 ImageGIF($this-&gt;gdimg_output);
<a name="l00474"></a>00474                                 $this-&gt;outputImageData = ob_get_contents();
<a name="l00475"></a>00475                                 <span class="keywordflow">break</span>;
<a name="l00476"></a>00476 
<a name="l00477"></a>00477                         <span class="keywordflow">case</span> <span class="stringliteral">&#39;bmp&#39;</span>:
<a name="l00478"></a>00478                                 $ImageOutFunction = <span class="stringliteral">&#39;&quot;builtin BMP output&quot;&#39;</span>;
<a name="l00479"></a>00479                                 <span class="keywordflow">if</span> (!@include_once(dirname(__FILE__).<span class="stringliteral">&#39;/phpthumb.bmp.php&#39;</span>)) {
<a name="l00480"></a>00480                                         $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;Error including &quot;&#39;</span>.dirname(__FILE__).<span class="stringliteral">&#39;/phpthumb.bmp.php&quot; which is required for BMP format output&#39;</span>, __FILE__, __LINE__);
<a name="l00481"></a>00481                                         ob_end_clean();
<a name="l00482"></a>00482                                         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00483"></a>00483                                 }
<a name="l00484"></a>00484                                 $phpthumb_bmp = <span class="keyword">new</span> <a class="code" href="classphpthumb__bmp.html">phpthumb_bmp</a>();
<a name="l00485"></a>00485                                 $this-&gt;outputImageData = $phpthumb_bmp-&gt;GD2BMPstring($this-&gt;gdimg_output);
<a name="l00486"></a>00486                                 unset($phpthumb_bmp);
<a name="l00487"></a>00487                                 <span class="keywordflow">break</span>;
<a name="l00488"></a>00488 
<a name="l00489"></a>00489                         <span class="keywordflow">case</span> <span class="stringliteral">&#39;ico&#39;</span>:
<a name="l00490"></a>00490                                 $ImageOutFunction = <span class="stringliteral">&#39;&quot;builtin ICO output&quot;&#39;</span>;
<a name="l00491"></a>00491                                 <span class="keywordflow">if</span> (!@include_once(dirname(__FILE__).<span class="stringliteral">&#39;/phpthumb.ico.php&#39;</span>)) {
<a name="l00492"></a>00492                                         $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;Error including &quot;&#39;</span>.dirname(__FILE__).<span class="stringliteral">&#39;/phpthumb.ico.php&quot; which is required for ICO format output&#39;</span>, __FILE__, __LINE__);
<a name="l00493"></a>00493                                         ob_end_clean();
<a name="l00494"></a>00494                                         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00495"></a>00495                                 }
<a name="l00496"></a>00496                                 $phpthumb_ico = <span class="keyword">new</span> <a class="code" href="classphpthumb__ico.html">phpthumb_ico</a>();
<a name="l00497"></a>00497                                 $arrayOfOutputImages = array($this-&gt;gdimg_output);
<a name="l00498"></a>00498                                 $this-&gt;outputImageData = $phpthumb_ico-&gt;GD2ICOstring($arrayOfOutputImages);
<a name="l00499"></a>00499                                 unset($phpthumb_ico);
<a name="l00500"></a>00500                                 <span class="keywordflow">break</span>;
<a name="l00501"></a>00501 
<a name="l00502"></a>00502                         <span class="keywordflow">default</span>:
<a name="l00503"></a>00503                                 $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;RenderOutput failed because $this-&gt;thumbnailFormat &quot;&#39;</span>.$this-&gt;thumbnailFormat.<span class="stringliteral">&#39;&quot; is not valid&#39;</span>, __FILE__, __LINE__);
<a name="l00504"></a>00504                                 ob_end_clean();
<a name="l00505"></a>00505                                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00506"></a>00506                 }
<a name="l00507"></a>00507                 ob_end_clean();
<a name="l00508"></a>00508                 <span class="keywordflow">if</span> (!$this-&gt;outputImageData) {
<a name="l00509"></a>00509                         $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;RenderOutput() for &quot;&#39;</span>.$this-&gt;thumbnailFormat.<span class="stringliteral">&#39;&quot; failed&#39;</span>, __FILE__, __LINE__);
<a name="l00510"></a>00510                         ob_end_clean();
<a name="l00511"></a>00511                         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00512"></a>00512                 }
<a name="l00513"></a>00513                 $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;RenderOutput() completing with $this-&gt;outputImageData = &#39;</span>.strlen($this-&gt;outputImageData).<span class="stringliteral">&#39; bytes&#39;</span>, __FILE__, __LINE__);
<a name="l00514"></a>00514                 <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00515"></a>00515         }
<a name="l00516"></a>00516 
<a name="l00517"></a>00517 
<a name="l00518"></a>00518         <span class="comment">// public:</span>
<a name="l00519"></a><a class="code" href="classphpthumb.html#a20510602dc63d77baea988c68365a032">00519</a>         <span class="keyword">function</span> <a class="code" href="classphpthumb.html#a20510602dc63d77baea988c68365a032">RenderToFile</a>(<a class="code" href="actions_8php.html#a6b7de8d10c540db2f1631e68b2aa0538">$filename</a>) {
<a name="l00520"></a>00520                 <span class="keywordflow">if</span> (eregi(<span class="stringliteral">&#39;^(f|ht)tps?\://&#39;</span>, <a class="code" href="actions_8php.html#a6b7de8d10c540db2f1631e68b2aa0538">$filename</a>)) {
<a name="l00521"></a>00521                         $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;RenderToFile() failed because $filename (&#39;</span>.<a class="code" href="actions_8php.html#a6b7de8d10c540db2f1631e68b2aa0538">$filename</a>.<span class="stringliteral">&#39;) is a URL&#39;</span>, __FILE__, __LINE__);
<a name="l00522"></a>00522                         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00523"></a>00523                 }
<a name="l00524"></a>00524                 <span class="comment">// render thumbnail to this file only, do not cache, do not output to browser</span>
<a name="l00525"></a>00525                 <span class="comment">//$renderfilename = $this-&gt;ResolveFilenameToAbsolute(dirname($filename)).DIRECTORY_SEPARATOR.basename($filename);</span>
<a name="l00526"></a>00526                 $renderfilename = <a class="code" href="actions_8php.html#a6b7de8d10c540db2f1631e68b2aa0538">$filename</a>;
<a name="l00527"></a>00527                 <span class="keywordflow">if</span> ((<a class="code" href="actions_8php.html#a6b7de8d10c540db2f1631e68b2aa0538">$filename</a>{0} != <span class="charliteral">&#39;/&#39;</span>) &amp;&amp; (<a class="code" href="actions_8php.html#a6b7de8d10c540db2f1631e68b2aa0538">$filename</a>{0} != <span class="charliteral">&#39;\\&#39;</span>) &amp;&amp; (<a class="code" href="actions_8php.html#a6b7de8d10c540db2f1631e68b2aa0538">$filename</a>{1} != <span class="charliteral">&#39;:&#39;</span>)) {
<a name="l00528"></a>00528                         $renderfilename = $this-&gt;<a class="code" href="classphpthumb.html#a49cc25fd831b2990b8f5743e8d6abe30">ResolveFilenameToAbsolute</a>($renderfilename);
<a name="l00529"></a>00529                 }
<a name="l00530"></a>00530                 <span class="keywordflow">if</span> (!@is_writable(dirname($renderfilename))) {
<a name="l00531"></a>00531                         $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;RenderToFile() failed because &quot;&#39;</span>.dirname($renderfilename).<span class="stringliteral">&#39;/&quot; is not writable&#39;</span>, __FILE__, __LINE__);
<a name="l00532"></a>00532                         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00533"></a>00533                 }
<a name="l00534"></a>00534                 <span class="keywordflow">if</span> (@is_file($renderfilename) &amp;&amp; !@is_writable($renderfilename)) {
<a name="l00535"></a>00535                         $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;RenderToFile() failed because &quot;&#39;</span>.$renderfilename.<span class="stringliteral">&#39;&quot; is not writable&#39;</span>, __FILE__, __LINE__);
<a name="l00536"></a>00536                         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00537"></a>00537                 }
<a name="l00538"></a>00538 
<a name="l00539"></a>00539                 <span class="keywordflow">if</span> ($this-&gt;<a class="code" href="classphpthumb.html#a91f8339fc5ba66e15a1ea92720c0afbc">RenderOutput</a>()) {
<a name="l00540"></a>00540                         <span class="keywordflow">if</span> (file_put_contents($renderfilename, $this-&gt;outputImageData)) {
<a name="l00541"></a>00541                                 $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;RenderToFile(&#39;</span>.$renderfilename.<span class="stringliteral">&#39;) succeeded&#39;</span>, __FILE__, __LINE__);
<a name="l00542"></a>00542                                 <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00543"></a>00543                         }
<a name="l00544"></a>00544                         <span class="keywordflow">if</span> (!@file_exists($renderfilename)) {
<a name="l00545"></a>00545                                 $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;RenderOutput [&#39;</span>.$this-&gt;thumbnailFormat.<span class="charliteral">&#39;(&#39;</span>.$renderfilename.<span class="stringliteral">&#39;)] did not appear to fail, but the output image does not exist either...&#39;</span>, __FILE__, __LINE__);
<a name="l00546"></a>00546                         }
<a name="l00547"></a>00547                 } <span class="keywordflow">else</span> {
<a name="l00548"></a>00548                         $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;RenderOutput [&#39;</span>.$this-&gt;thumbnailFormat.<span class="charliteral">&#39;(&#39;</span>.$renderfilename.<span class="stringliteral">&#39;)] failed&#39;</span>, __FILE__, __LINE__);
<a name="l00549"></a>00549                 }
<a name="l00550"></a>00550                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00551"></a>00551         }
<a name="l00552"></a>00552 
<a name="l00553"></a>00553 
<a name="l00554"></a>00554         <span class="comment">// public:</span>
<a name="l00555"></a><a class="code" href="classphpthumb.html#a8c6d14a9a5b8f6be2255cc0ac6b91373">00555</a>         <span class="keyword">function</span> <a class="code" href="classphpthumb.html#a8c6d14a9a5b8f6be2255cc0ac6b91373">OutputThumbnail</a>() {
<a name="l00556"></a>00556                 <span class="keywordflow">if</span> (!$this-&gt;useRawIMoutput &amp;&amp; !is_resource($this-&gt;gdimg_output)) {
<a name="l00557"></a>00557                         $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;OutputThumbnail() failed because !is_resource($this-&gt;gdimg_output)&#39;</span>, __FILE__, __LINE__);
<a name="l00558"></a>00558                         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00559"></a>00559                 }
<a name="l00560"></a>00560                 <span class="keywordflow">if</span> (headers_sent()) {
<a name="l00561"></a>00561                         <span class="keywordflow">return</span> $this-&gt;<a class="code" href="classphpthumb.html#a6ff71b425894fd846790cedf9f9cc97d">ErrorImage</a>(<span class="stringliteral">&#39;OutputThumbnail() failed - headers already sent&#39;</span>);
<a name="l00562"></a>00562                         <a class="code" href="lib_2php_thumbs-1_87_89_2cache_2index_8php.html#a6733eb5f605d09eaede9845835d71c4e">exit</a>;
<a name="l00563"></a>00563                 }
<a name="l00564"></a>00564 
<a name="l00565"></a>00565                 $downloadfilename = <a class="code" href="classphpthumb__functions.html#a110676c86529253850f744796baeb62d">phpthumb_functions::SanitizeFilename</a>(is_string($this-&gt;sia) ? $this-&gt;sia : ($this-&gt;down ? $this-&gt;down : <span class="stringliteral">&#39;phpThumb_generated_thumbnail&#39;</span>.<span class="charliteral">&#39;.&#39;</span>.$this-&gt;thumbnailFormat));
<a name="l00566"></a>00566                 $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;Content-Disposition header filename set to &quot;&#39;</span>.$downloadfilename.<span class="charliteral">&#39;&quot;&#39;</span>, __FILE__, __LINE__);
<a name="l00567"></a>00567                 <span class="keywordflow">if</span> ($downloadfilename) {
<a name="l00568"></a>00568                         header(<span class="stringliteral">&#39;Content-Disposition: &#39;</span>.($this-&gt;down ? <span class="stringliteral">&#39;attachment&#39;</span> : <span class="stringliteral">&#39;inline&#39;</span>).<span class="stringliteral">&#39;; filename=&quot;&#39;</span>.$downloadfilename.<span class="charliteral">&#39;&quot;&#39;</span>);
<a name="l00569"></a>00569                 } <span class="keywordflow">else</span> {
<a name="l00570"></a>00570                         $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;failed to send Content-Disposition header because $downloadfilename is empty&#39;</span>, __FILE__, __LINE__);
<a name="l00571"></a>00571                 }
<a name="l00572"></a>00572 
<a name="l00573"></a>00573                 <span class="keywordflow">if</span> ($this-&gt;useRawIMoutput) {
<a name="l00574"></a>00574 
<a name="l00575"></a>00575                         header(<span class="stringliteral">&#39;Content-Type: &#39;</span>.<a class="code" href="classphpthumb__functions.html#af58958c94226ace6fd0facaf44a3cd6d">phpthumb_functions::ImageTypeToMIMEtype</a>($this-&gt;thumbnailFormat));
<a name="l00576"></a>00576                         <a class="code" href="bug-eofquotes_8php.html#ac4fd59c9ee95bff469a7cd55e16f0449">echo</a> $this-&gt;IMresizedData;
<a name="l00577"></a>00577 
<a name="l00578"></a>00578                 } <span class="keywordflow">else</span> {
<a name="l00579"></a>00579 
<a name="l00580"></a>00580                         $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;ImageInterlace($this-&gt;gdimg_output, &#39;</span>.intval($this-&gt;config_output_interlace).<span class="charliteral">&#39;)&#39;</span>, __FILE__, __LINE__);
<a name="l00581"></a>00581                         ImageInterlace($this-&gt;gdimg_output, intval($this-&gt;config_output_interlace));
<a name="l00582"></a>00582                         <span class="keywordflow">switch</span> ($this-&gt;thumbnailFormat) {
<a name="l00583"></a>00583                                 <span class="keywordflow">case</span> <span class="stringliteral">&#39;jpeg&#39;</span>:
<a name="l00584"></a>00584                                         header(<span class="stringliteral">&#39;Content-Type: &#39;</span>.<a class="code" href="classphpthumb__functions.html#af58958c94226ace6fd0facaf44a3cd6d">phpthumb_functions::ImageTypeToMIMEtype</a>($this-&gt;thumbnailFormat));
<a name="l00585"></a>00585                                         $ImageOutFunction = <span class="stringliteral">&#39;image&#39;</span>.$this-&gt;thumbnailFormat;
<a name="l00586"></a>00586                                         @$ImageOutFunction($this-&gt;gdimg_output, <span class="stringliteral">&#39;&#39;</span>, $this-&gt;thumbnailQuality);
<a name="l00587"></a>00587                                         <span class="keywordflow">break</span>;
<a name="l00588"></a>00588 
<a name="l00589"></a>00589                                 <span class="keywordflow">case</span> <span class="stringliteral">&#39;png&#39;</span>:
<a name="l00590"></a>00590                                 <span class="keywordflow">case</span> <span class="stringliteral">&#39;gif&#39;</span>:
<a name="l00591"></a>00591                                         header(<span class="stringliteral">&#39;Content-Type: &#39;</span>.<a class="code" href="classphpthumb__functions.html#af58958c94226ace6fd0facaf44a3cd6d">phpthumb_functions::ImageTypeToMIMEtype</a>($this-&gt;thumbnailFormat));
<a name="l00592"></a>00592                                         $ImageOutFunction = <span class="stringliteral">&#39;image&#39;</span>.$this-&gt;thumbnailFormat;
<a name="l00593"></a>00593                                         @$ImageOutFunction($this-&gt;gdimg_output);
<a name="l00594"></a>00594                                         <span class="keywordflow">break</span>;
<a name="l00595"></a>00595 
<a name="l00596"></a>00596                                 <span class="keywordflow">case</span> <span class="stringliteral">&#39;bmp&#39;</span>:
<a name="l00597"></a>00597                                         <span class="keywordflow">if</span> (!@include_once(dirname(__FILE__).<span class="stringliteral">&#39;/phpthumb.bmp.php&#39;</span>)) {
<a name="l00598"></a>00598                                                 $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;Error including &quot;&#39;</span>.dirname(__FILE__).<span class="stringliteral">&#39;/phpthumb.bmp.php&quot; which is required for BMP format output&#39;</span>, __FILE__, __LINE__);
<a name="l00599"></a>00599                                                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00600"></a>00600                                         }
<a name="l00601"></a>00601                                         $phpthumb_bmp = <span class="keyword">new</span> <a class="code" href="classphpthumb__bmp.html">phpthumb_bmp</a>();
<a name="l00602"></a>00602                                         <span class="keywordflow">if</span> (is_object($phpthumb_bmp)) {
<a name="l00603"></a>00603                                                 $bmp_data = $phpthumb_bmp-&gt;GD2BMPstring($this-&gt;gdimg_output);
<a name="l00604"></a>00604                                                 unset($phpthumb_bmp);
<a name="l00605"></a>00605                                                 <span class="keywordflow">if</span> (!$bmp_data) {
<a name="l00606"></a>00606                                                         $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;$phpthumb_bmp-&gt;GD2BMPstring() failed&#39;</span>, __FILE__, __LINE__);
<a name="l00607"></a>00607                                                         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00608"></a>00608                                                 }
<a name="l00609"></a>00609                                                 header(<span class="stringliteral">&#39;Content-Type: &#39;</span>.<a class="code" href="classphpthumb__functions.html#af58958c94226ace6fd0facaf44a3cd6d">phpthumb_functions::ImageTypeToMIMEtype</a>($this-&gt;thumbnailFormat));
<a name="l00610"></a>00610                                                 <a class="code" href="bug-eofquotes_8php.html#ac4fd59c9ee95bff469a7cd55e16f0449">echo</a> $bmp_data;
<a name="l00611"></a>00611                                         } <span class="keywordflow">else</span> {
<a name="l00612"></a>00612                                                 $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;new phpthumb_bmp() failed&#39;</span>, __FILE__, __LINE__);
<a name="l00613"></a>00613                                                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00614"></a>00614                                         }
<a name="l00615"></a>00615                                         <span class="keywordflow">break</span>;
<a name="l00616"></a>00616 
<a name="l00617"></a>00617                                 <span class="keywordflow">case</span> <span class="stringliteral">&#39;ico&#39;</span>:
<a name="l00618"></a>00618                                         <span class="keywordflow">if</span> (!@include_once(dirname(__FILE__).<span class="stringliteral">&#39;/phpthumb.ico.php&#39;</span>)) {
<a name="l00619"></a>00619                                                 $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;Error including &quot;&#39;</span>.dirname(__FILE__).<span class="stringliteral">&#39;/phpthumb.ico.php&quot; which is required for ICO format output&#39;</span>, __FILE__, __LINE__);
<a name="l00620"></a>00620                                                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00621"></a>00621                                         }
<a name="l00622"></a>00622                                         $phpthumb_ico = <span class="keyword">new</span> <a class="code" href="classphpthumb__ico.html">phpthumb_ico</a>();
<a name="l00623"></a>00623                                         <span class="keywordflow">if</span> (is_object($phpthumb_ico)) {
<a name="l00624"></a>00624                                                 $arrayOfOutputImages = array($this-&gt;gdimg_output);
<a name="l00625"></a>00625                                                 $ico_data = $phpthumb_ico-&gt;GD2ICOstring($arrayOfOutputImages);
<a name="l00626"></a>00626                                                 unset($phpthumb_ico);
<a name="l00627"></a>00627                                                 <span class="keywordflow">if</span> (!$ico_data) {
<a name="l00628"></a>00628                                                         $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;$phpthumb_ico-&gt;GD2ICOstring() failed&#39;</span>, __FILE__, __LINE__);
<a name="l00629"></a>00629                                                         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00630"></a>00630                                                 }
<a name="l00631"></a>00631                                                 header(<span class="stringliteral">&#39;Content-Type: &#39;</span>.<a class="code" href="classphpthumb__functions.html#af58958c94226ace6fd0facaf44a3cd6d">phpthumb_functions::ImageTypeToMIMEtype</a>($this-&gt;thumbnailFormat));
<a name="l00632"></a>00632                                                 <a class="code" href="bug-eofquotes_8php.html#ac4fd59c9ee95bff469a7cd55e16f0449">echo</a> $ico_data;
<a name="l00633"></a>00633                                         } <span class="keywordflow">else</span> {
<a name="l00634"></a>00634                                                 $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;new phpthumb_ico() failed&#39;</span>, __FILE__, __LINE__);
<a name="l00635"></a>00635                                                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00636"></a>00636                                         }
<a name="l00637"></a>00637                                         <span class="keywordflow">break</span>;
<a name="l00638"></a>00638 
<a name="l00639"></a>00639                                 <span class="keywordflow">default</span>:
<a name="l00640"></a>00640                                         $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;OutputThumbnail failed because $this-&gt;thumbnailFormat &quot;&#39;</span>.$this-&gt;thumbnailFormat.<span class="stringliteral">&#39;&quot; is not valid&#39;</span>, __FILE__, __LINE__);
<a name="l00641"></a>00641                                         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00642"></a>00642                                         <span class="keywordflow">break</span>;
<a name="l00643"></a>00643                         }
<a name="l00644"></a>00644 
<a name="l00645"></a>00645                 }
<a name="l00646"></a>00646                 <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00647"></a>00647         }
<a name="l00648"></a>00648 
<a name="l00649"></a>00649 
<a name="l00650"></a>00650         <span class="comment">// public:</span>
<a name="l00651"></a><a class="code" href="classphpthumb.html#ac0f2cb8ffb6073b83cdcea5c25b10cbb">00651</a>         <span class="keyword">function</span> <a class="code" href="classphpthumb.html#ac0f2cb8ffb6073b83cdcea5c25b10cbb">CleanUpCacheDirectory</a>() {
<a name="l00652"></a>00652                 $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;skipping CleanUpCacheDirectory() set to purge (&#39;</span>.number_format($this-&gt;config_cache_maxage / 86400, 1).<span class="stringliteral">&#39; days; &#39;</span>.number_format($this-&gt;config_cache_maxsize / 1048576, 2).<span class="stringliteral">&#39;MB; &#39;</span>.number_format($this-&gt;config_cache_maxfiles).<span class="stringliteral">&#39; files)&#39;</span>, __FILE__, __LINE__);
<a name="l00653"></a>00653                 $DeletedKeys = array();
<a name="l00654"></a>00654                 $AllFilesInCacheDirectory = array();
<a name="l00655"></a>00655                 <span class="keywordflow">if</span> (($this-&gt;config_cache_maxage &gt; 0) || ($this-&gt;config_cache_maxsize &gt; 0) || ($this-&gt;config_cache_maxfiles &gt; 0)) {
<a name="l00656"></a>00656                         $CacheDirOldFilesAge  = array();
<a name="l00657"></a>00657                         $CacheDirOldFilesSize = array();
<a name="l00658"></a>00658                         $AllFilesInCacheDirectory = <a class="code" href="classphpthumb__functions.html#a6334e519682ebb7db2d1201f4682edc4">phpthumb_functions::GetAllFilesInSubfolders</a>($this-&gt;config_cache_directory);
<a name="l00659"></a>00659                         <span class="keywordflow">foreach</span> ($AllFilesInCacheDirectory as $fullfilename) {
<a name="l00660"></a>00660                                 <span class="keywordflow">if</span> (eregi(<span class="stringliteral">&#39;^phpThumb_cache_&#39;</span>, basename($fullfilename)) &amp;&amp; file_exists($fullfilename)) {
<a name="l00661"></a>00661                                         $CacheDirOldFilesAge[$fullfilename] = @fileatime($fullfilename);
<a name="l00662"></a>00662                                         <span class="keywordflow">if</span> ($CacheDirOldFilesAge[$fullfilename] == 0) {
<a name="l00663"></a>00663                                                 $CacheDirOldFilesAge[$fullfilename] = @filemtime($fullfilename);
<a name="l00664"></a>00664                                         }
<a name="l00665"></a>00665                                         $CacheDirOldFilesSize[$fullfilename] = @filesize($fullfilename);
<a name="l00666"></a>00666                                 }
<a name="l00667"></a>00667                         }
<a name="l00668"></a>00668                         <span class="keywordflow">if</span> (empty($CacheDirOldFilesSize)) {
<a name="l00669"></a>00669                                 <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00670"></a>00670                         }
<a name="l00671"></a>00671                         $DeletedKeys[<span class="stringliteral">&#39;zerobyte&#39;</span>] = array();
<a name="l00672"></a>00672                         <span class="keywordflow">foreach</span> ($CacheDirOldFilesSize as $fullfilename =&gt; $filesize) {
<a name="l00673"></a>00673                                 <span class="comment">// purge all zero-size files more than an hour old (to prevent trying to delete just-created and/or in-use files)</span>
<a name="l00674"></a>00674                                 $cutofftime = time() - 3600;
<a name="l00675"></a>00675                                 <span class="keywordflow">if</span> (($filesize == 0) &amp;&amp; ($CacheDirOldFilesAge[$fullfilename] &lt; $cutofftime)) {
<a name="l00676"></a>00676                                         $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;deleting &quot;&#39;</span>.$fullfilename.<span class="charliteral">&#39;&quot;&#39;</span>, __FILE__, __LINE__);
<a name="l00677"></a>00677                                         <span class="keywordflow">if</span> (@unlink($fullfilename)) {
<a name="l00678"></a>00678                                                 $DeletedKeys[<span class="stringliteral">&#39;zerobyte&#39;</span>][] = $fullfilename;
<a name="l00679"></a>00679                                                 unset($CacheDirOldFilesSize[$fullfilename]);
<a name="l00680"></a>00680                                                 unset($CacheDirOldFilesAge[$fullfilename]);
<a name="l00681"></a>00681                                         }
<a name="l00682"></a>00682                                 }
<a name="l00683"></a>00683                         }
<a name="l00684"></a>00684                         $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;CleanUpCacheDirectory() purged &#39;</span>.count($DeletedKeys[<span class="stringliteral">&#39;zerobyte&#39;</span>]).<span class="stringliteral">&#39; zero-byte files&#39;</span>, __FILE__, __LINE__);
<a name="l00685"></a>00685                         asort($CacheDirOldFilesAge);
<a name="l00686"></a>00686 
<a name="l00687"></a>00687                         <span class="keywordflow">if</span> ($this-&gt;config_cache_maxfiles &gt; 0) {
<a name="l00688"></a>00688                                 $TotalCachedFiles = count($CacheDirOldFilesAge);
<a name="l00689"></a>00689                                 $DeletedKeys[<span class="stringliteral">&#39;maxfiles&#39;</span>] = array();
<a name="l00690"></a>00690                                 <span class="keywordflow">foreach</span> ($CacheDirOldFilesAge as $fullfilename =&gt; $filedate) {
<a name="l00691"></a>00691                                         <span class="keywordflow">if</span> ($TotalCachedFiles &gt; $this-&gt;config_cache_maxfiles) {
<a name="l00692"></a>00692                                                 $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;deleting &quot;&#39;</span>.$fullfilename.<span class="charliteral">&#39;&quot;&#39;</span>, __FILE__, __LINE__);
<a name="l00693"></a>00693                                                 <span class="keywordflow">if</span> (@unlink($fullfilename)) {
<a name="l00694"></a>00694                                                         $TotalCachedFiles--;
<a name="l00695"></a>00695                                                         $DeletedKeys[<span class="stringliteral">&#39;maxfiles&#39;</span>][] = $fullfilename;
<a name="l00696"></a>00696                                                 }
<a name="l00697"></a>00697                                         } <span class="keywordflow">else</span> {
<a name="l00698"></a>00698                                                 <span class="comment">// there are few enough files to keep the rest</span>
<a name="l00699"></a>00699                                                 <span class="keywordflow">break</span>;
<a name="l00700"></a>00700                                         }
<a name="l00701"></a>00701                                 }
<a name="l00702"></a>00702                                 $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;CleanUpCacheDirectory() purged &#39;</span>.count($DeletedKeys[<span class="stringliteral">&#39;maxfiles&#39;</span>]).<span class="stringliteral">&#39; files based on (config_cache_maxfiles=&#39;</span>.$this-&gt;config_cache_maxfiles.<span class="charliteral">&#39;)&#39;</span>, __FILE__, __LINE__);
<a name="l00703"></a>00703                                 <span class="keywordflow">foreach</span> ($DeletedKeys[<span class="stringliteral">&#39;maxfiles&#39;</span>] as $fullfilename) {
<a name="l00704"></a>00704                                         unset($CacheDirOldFilesAge[$fullfilename]);
<a name="l00705"></a>00705                                         unset($CacheDirOldFilesSize[$fullfilename]);
<a name="l00706"></a>00706                                 }
<a name="l00707"></a>00707                         }
<a name="l00708"></a>00708 
<a name="l00709"></a>00709                         <span class="keywordflow">if</span> ($this-&gt;config_cache_maxage &gt; 0) {
<a name="l00710"></a>00710                                 $mindate = time() - $this-&gt;config_cache_maxage;
<a name="l00711"></a>00711                                 $DeletedKeys[<span class="stringliteral">&#39;maxage&#39;</span>] = array();
<a name="l00712"></a>00712                                 <span class="keywordflow">foreach</span> ($CacheDirOldFilesAge as $fullfilename =&gt; $filedate) {
<a name="l00713"></a>00713                                         <span class="keywordflow">if</span> ($filedate &gt; 0) {
<a name="l00714"></a>00714                                                 <span class="keywordflow">if</span> ($filedate &lt; $mindate) {
<a name="l00715"></a>00715                                                         $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;deleting &quot;&#39;</span>.$fullfilename.<span class="charliteral">&#39;&quot;&#39;</span>, __FILE__, __LINE__);
<a name="l00716"></a>00716                                                         <span class="keywordflow">if</span> (@unlink($fullfilename)) {
<a name="l00717"></a>00717                                                                 $DeletedKeys[<span class="stringliteral">&#39;maxage&#39;</span>][] = $fullfilename;
<a name="l00718"></a>00718                                                         }
<a name="l00719"></a>00719                                                 } <span class="keywordflow">else</span> {
<a name="l00720"></a>00720                                                         <span class="comment">// the rest of the files are new enough to keep</span>
<a name="l00721"></a>00721                                                         <span class="keywordflow">break</span>;
<a name="l00722"></a>00722                                                 }
<a name="l00723"></a>00723                                         }
<a name="l00724"></a>00724                                 }
<a name="l00725"></a>00725                                 $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;CleanUpCacheDirectory() purged &#39;</span>.count($DeletedKeys[<span class="stringliteral">&#39;maxage&#39;</span>]).<span class="stringliteral">&#39; files based on (config_cache_maxage=&#39;</span>.$this-&gt;config_cache_maxage.<span class="charliteral">&#39;)&#39;</span>, __FILE__, __LINE__);
<a name="l00726"></a>00726                                 <span class="keywordflow">foreach</span> ($DeletedKeys[<span class="stringliteral">&#39;maxage&#39;</span>] as $fullfilename) {
<a name="l00727"></a>00727                                         unset($CacheDirOldFilesAge[$fullfilename]);
<a name="l00728"></a>00728                                         unset($CacheDirOldFilesSize[$fullfilename]);
<a name="l00729"></a>00729                                 }
<a name="l00730"></a>00730                         }
<a name="l00731"></a>00731 
<a name="l00732"></a>00732                         <span class="keywordflow">if</span> ($this-&gt;config_cache_maxsize &gt; 0) {
<a name="l00733"></a>00733                                 $TotalCachedFileSize = array_sum($CacheDirOldFilesSize);
<a name="l00734"></a>00734                                 $DeletedKeys[<span class="stringliteral">&#39;maxsize&#39;</span>] = array();
<a name="l00735"></a>00735                                 <span class="keywordflow">foreach</span> ($CacheDirOldFilesAge as $fullfilename =&gt; $filedate) {
<a name="l00736"></a>00736                                         <span class="keywordflow">if</span> ($TotalCachedFileSize &gt; $this-&gt;config_cache_maxsize) {
<a name="l00737"></a>00737                                                 $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;deleting &quot;&#39;</span>.$fullfilename.<span class="charliteral">&#39;&quot;&#39;</span>, __FILE__, __LINE__);
<a name="l00738"></a>00738                                                 <span class="keywordflow">if</span> (@unlink($fullfilename)) {
<a name="l00739"></a>00739                                                         $TotalCachedFileSize -= $CacheDirOldFilesSize[$fullfilename];
<a name="l00740"></a>00740                                                         $DeletedKeys[<span class="stringliteral">&#39;maxsize&#39;</span>][] = $fullfilename;
<a name="l00741"></a>00741                                                 }
<a name="l00742"></a>00742                                         } <span class="keywordflow">else</span> {
<a name="l00743"></a>00743                                                 <span class="comment">// the total filesizes are small enough to keep the rest of the files</span>
<a name="l00744"></a>00744                                                 <span class="keywordflow">break</span>;
<a name="l00745"></a>00745                                         }
<a name="l00746"></a>00746                                 }
<a name="l00747"></a>00747                                 $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;CleanUpCacheDirectory() purged &#39;</span>.count($DeletedKeys[<span class="stringliteral">&#39;maxsize&#39;</span>]).<span class="stringliteral">&#39; files based on (config_cache_maxsize=&#39;</span>.$this-&gt;config_cache_maxsize.<span class="charliteral">&#39;)&#39;</span>, __FILE__, __LINE__);
<a name="l00748"></a>00748                                 <span class="keywordflow">foreach</span> ($DeletedKeys[<span class="stringliteral">&#39;maxsize&#39;</span>] as $fullfilename) {
<a name="l00749"></a>00749                                         unset($CacheDirOldFilesAge[$fullfilename]);
<a name="l00750"></a>00750                                         unset($CacheDirOldFilesSize[$fullfilename]);
<a name="l00751"></a>00751                                 }
<a name="l00752"></a>00752                         }
<a name="l00753"></a>00753 
<a name="l00754"></a>00754                 } <span class="keywordflow">else</span> {
<a name="l00755"></a>00755                         $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;skipping CleanUpCacheDirectory() because config set to not use it&#39;</span>, __FILE__, __LINE__);
<a name="l00756"></a>00756                 }
<a name="l00757"></a>00757                 $totalpurged = 0;
<a name="l00758"></a>00758                 <span class="keywordflow">foreach</span> ($DeletedKeys as $key =&gt; $value) {
<a name="l00759"></a>00759                         $totalpurged += count($value);
<a name="l00760"></a>00760                 }
<a name="l00761"></a>00761                 $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;CleanUpCacheDirectory() purged &#39;</span>.$totalpurged.<span class="stringliteral">&#39; files (from &#39;</span>.count($AllFilesInCacheDirectory).<span class="stringliteral">&#39;) based on config settings&#39;</span>, __FILE__, __LINE__);
<a name="l00762"></a>00762                 <span class="keywordflow">if</span> ($totalpurged &gt; 0) {
<a name="l00763"></a>00763                         $empty_dirs = array();
<a name="l00764"></a>00764                         <span class="keywordflow">foreach</span> ($AllFilesInCacheDirectory as $fullfilename) {
<a name="l00765"></a>00765                                 <span class="keywordflow">if</span> (is_dir($fullfilename)) {
<a name="l00766"></a>00766                                         $empty_dirs[realpath($fullfilename)] = 1;
<a name="l00767"></a>00767                                 } <span class="keywordflow">else</span> {
<a name="l00768"></a>00768                                         unset($empty_dirs[realpath(dirname($fullfilename))]);
<a name="l00769"></a>00769                                 }
<a name="l00770"></a>00770                         }
<a name="l00771"></a>00771                         krsort($empty_dirs);
<a name="l00772"></a>00772                         $totalpurgeddirs = 0;
<a name="l00773"></a>00773                         <span class="keywordflow">foreach</span> ($empty_dirs as $empty_dir =&gt; $dummy) {
<a name="l00774"></a>00774                                 <span class="keywordflow">if</span> ($empty_dir == $this-&gt;config_cache_directory) {
<a name="l00775"></a>00775                                         <span class="comment">// shouldn&#39;t happen, but just in case, don&#39;t let it delete actual cache directory</span>
<a name="l00776"></a>00776                                         <span class="keywordflow">continue</span>;
<a name="l00777"></a>00777                                 } <a class="code" href="php_thumb_8demo_8check_8php.html#af92779326267616cd7c3cdaaa9484bc9">elseif</a> (@rmdir($empty_dir)) {
<a name="l00778"></a>00778                                         $totalpurgeddirs++;
<a name="l00779"></a>00779                                 } <span class="keywordflow">else</span> {
<a name="l00780"></a>00780                                         $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;failed to rmdir(&#39;</span>.$empty_dir.<span class="charliteral">&#39;)&#39;</span>, __FILE__, __LINE__);
<a name="l00781"></a>00781                                 }
<a name="l00782"></a>00782                         }
<a name="l00783"></a>00783                         $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;purged &#39;</span>.$totalpurgeddirs.<span class="stringliteral">&#39; empty directories&#39;</span>, __FILE__, __LINE__);
<a name="l00784"></a>00784                 }
<a name="l00785"></a>00785                 <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00786"></a>00786         }
<a name="l00787"></a>00787 
<a name="l00789"></a>00789 
<a name="l00790"></a>00790         <span class="comment">// private: re-initializator (call between rendering multiple images with one object)</span>
<a name="l00791"></a><a class="code" href="classphpthumb.html#a19cd9cf20ea447908a1d47afe9b7a276">00791</a>         <span class="keyword">function</span> <a class="code" href="classphpthumb.html#a19cd9cf20ea447908a1d47afe9b7a276">resetObject</a>() {
<a name="l00792"></a>00792                 $class_vars = get_class_vars(get_class($this));
<a name="l00793"></a>00793                 <span class="keywordflow">foreach</span> ($class_vars as $key =&gt; $value) {
<a name="l00794"></a>00794                         <span class="comment">// do not clobber debug or config info</span>
<a name="l00795"></a>00795                         <span class="keywordflow">if</span> (!eregi(<span class="stringliteral">&#39;^(config_|debug|fatalerror)&#39;</span>, $key)) {
<a name="l00796"></a>00796                                 $this-&gt;$key = $value;
<a name="l00797"></a>00797                         }
<a name="l00798"></a>00798                 }
<a name="l00799"></a>00799                 $this-&gt;<a class="code" href="classphpthumb.html#adea410f87d32392cb47f4d5719d01fe5">phpThumb</a>(); <span class="comment">// re-initialize some class variables</span>
<a name="l00800"></a>00800                 <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00801"></a>00801         }
<a name="l00802"></a>00802 
<a name="l00804"></a>00804 
<a name="l00805"></a><a class="code" href="classphpthumb.html#a55b58f691d10245443a42b72c782c700">00805</a>         <span class="keyword">function</span> <a class="code" href="classphpthumb.html#a55b58f691d10245443a42b72c782c700">ResolveSource</a>() {
<a name="l00806"></a>00806                 <span class="keywordflow">if</span> (is_resource($this-&gt;gdimg_source)) {
<a name="l00807"></a>00807                         $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;ResolveSource() exiting because is_resource($this-&gt;gdimg_source)&#39;</span>, __FILE__, __LINE__);
<a name="l00808"></a>00808                         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00809"></a>00809                 }
<a name="l00810"></a>00810                 <span class="keywordflow">if</span> ($this-&gt;<a class="code" href="php_thumb_8demo_8check_8php.html#a863670ff2c90a1dc616ebab121dbb296">rawImageData</a>) {
<a name="l00811"></a>00811                         $this-&gt;sourceFilename = null;
<a name="l00812"></a>00812                         $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;ResolveSource() exiting because $this-&gt;rawImageData is set (&#39;</span>.number_format(strlen($this-&gt;<a class="code" href="php_thumb_8demo_8check_8php.html#a863670ff2c90a1dc616ebab121dbb296">rawImageData</a>)).<span class="stringliteral">&#39; bytes)&#39;</span>, __FILE__, __LINE__);
<a name="l00813"></a>00813                         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00814"></a>00814                 }
<a name="l00815"></a>00815                 <span class="keywordflow">if</span> ($this-&gt;sourceFilename) {
<a name="l00816"></a>00816                         $this-&gt;sourceFilename = $this-&gt;<a class="code" href="classphpthumb.html#a49cc25fd831b2990b8f5743e8d6abe30">ResolveFilenameToAbsolute</a>($this-&gt;sourceFilename);
<a name="l00817"></a>00817                         $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;$this-&gt;sourceFilename set to &quot;&#39;</span>.$this-&gt;sourceFilename.<span class="charliteral">&#39;&quot;&#39;</span>, __FILE__, __LINE__);
<a name="l00818"></a>00818                 } <a class="code" href="php_thumb_8demo_8check_8php.html#af92779326267616cd7c3cdaaa9484bc9">elseif</a> ($this-&gt;src) {
<a name="l00819"></a>00819                         $this-&gt;sourceFilename = $this-&gt;<a class="code" href="classphpthumb.html#a49cc25fd831b2990b8f5743e8d6abe30">ResolveFilenameToAbsolute</a>($this-&gt;src);
<a name="l00820"></a>00820                         $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;$this-&gt;sourceFilename set to &quot;&#39;</span>.$this-&gt;sourceFilename.<span class="stringliteral">&#39;&quot; from $this-&gt;src (&#39;</span>.$this-&gt;src.<span class="charliteral">&#39;)&#39;</span>, __FILE__, __LINE__);
<a name="l00821"></a>00821                 } <span class="keywordflow">else</span> {
<a name="l00822"></a>00822                         <span class="keywordflow">return</span> $this-&gt;<a class="code" href="classphpthumb.html#a6ff71b425894fd846790cedf9f9cc97d">ErrorImage</a>(<span class="stringliteral">&#39;$this-&gt;sourceFilename and $this-&gt;src are both empty&#39;</span>);
<a name="l00823"></a>00823                 }
<a name="l00824"></a>00824                 <span class="keywordflow">if</span> ($this-&gt;iswindows &amp;&amp; ((substr($this-&gt;sourceFilename, 0, 2) == <span class="stringliteral">&#39;//&#39;</span>) || (substr($this-&gt;sourceFilename, 0, 2) == <span class="stringliteral">&#39;\\\\&#39;</span>))) {
<a name="l00825"></a>00825                         <span class="comment">// Windows \\share\filename.ext</span>
<a name="l00826"></a>00826                 } <a class="code" href="php_thumb_8demo_8check_8php.html#af92779326267616cd7c3cdaaa9484bc9">elseif</a> (eregi(<span class="stringliteral">&#39;^(f|ht)tps?\://&#39;</span>, $this-&gt;sourceFilename)) {
<a name="l00827"></a>00827                         <span class="comment">// URL</span>
<a name="l00828"></a>00828                         <span class="keywordflow">if</span> ($this-&gt;config_http_user_agent) {
<a name="l00829"></a>00829                                 ini_set(<span class="stringliteral">&#39;user_agent&#39;</span>, $this-&gt;config_http_user_agent);
<a name="l00830"></a>00830                         }
<a name="l00831"></a>00831                 } <a class="code" href="php_thumb_8demo_8check_8php.html#af92779326267616cd7c3cdaaa9484bc9">elseif</a> (!@file_exists($this-&gt;sourceFilename)) {
<a name="l00832"></a>00832                         <span class="keywordflow">return</span> $this-&gt;<a class="code" href="classphpthumb.html#a6ff71b425894fd846790cedf9f9cc97d">ErrorImage</a>(<span class="charliteral">&#39;&quot;&#39;</span>.$this-&gt;sourceFilename.<span class="stringliteral">&#39;&quot; does not exist&#39;</span>);
<a name="l00833"></a>00833                 } <a class="code" href="php_thumb_8demo_8check_8php.html#af92779326267616cd7c3cdaaa9484bc9">elseif</a> (!@is_file($this-&gt;sourceFilename)) {
<a name="l00834"></a>00834                         <span class="keywordflow">return</span> $this-&gt;<a class="code" href="classphpthumb.html#a6ff71b425894fd846790cedf9f9cc97d">ErrorImage</a>(<span class="charliteral">&#39;&quot;&#39;</span>.$this-&gt;sourceFilename.<span class="stringliteral">&#39;&quot; is not a file&#39;</span>);
<a name="l00835"></a>00835                 }
<a name="l00836"></a>00836                 <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00837"></a>00837         }
<a name="l00838"></a>00838 
<a name="l00839"></a><a class="code" href="classphpthumb.html#a422bcfa5097eee6cd64570424c89a9d1">00839</a>         <span class="keyword">function</span> <a class="code" href="classphpthumb.html#a422bcfa5097eee6cd64570424c89a9d1">setOutputFormat</a>() {
<a name="l00840"></a>00840                 <span class="keyword">static</span> $alreadyCalled = <span class="keyword">false</span>;
<a name="l00841"></a>00841                 <span class="keywordflow">if</span> ($this-&gt;thumbnailFormat &amp;&amp; $alreadyCalled) {
<a name="l00842"></a>00842                         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00843"></a>00843                 }
<a name="l00844"></a>00844                 $alreadyCalled = <span class="keyword">true</span>;
<a name="l00845"></a>00845 
<a name="l00846"></a>00846                 $AvailableImageOutputFormats = array();
<a name="l00847"></a>00847                 $AvailableImageOutputFormats[] = <span class="stringliteral">&#39;text&#39;</span>;
<a name="l00848"></a>00848                 <span class="keywordflow">if</span> (@is_readable(dirname(__FILE__).<span class="stringliteral">&#39;/phpthumb.ico.php&#39;</span>)) {
<a name="l00849"></a>00849                         $AvailableImageOutputFormats[] = <span class="stringliteral">&#39;ico&#39;</span>;
<a name="l00850"></a>00850                 }
<a name="l00851"></a>00851                 <span class="keywordflow">if</span> (@is_readable(dirname(__FILE__).<span class="stringliteral">&#39;/phpthumb.bmp.php&#39;</span>)) {
<a name="l00852"></a>00852                         $AvailableImageOutputFormats[] = <span class="stringliteral">&#39;bmp&#39;</span>;
<a name="l00853"></a>00853                 }
<a name="l00854"></a>00854 
<a name="l00855"></a>00855                 $this-&gt;thumbnailFormat = <span class="stringliteral">&#39;ico&#39;</span>;
<a name="l00856"></a>00856 
<a name="l00857"></a>00857                 <span class="comment">// Set default output format based on what image types are available</span>
<a name="l00858"></a>00858                 <span class="keywordflow">if</span> (function_exists(<span class="stringliteral">&#39;ImageTypes&#39;</span>)) {
<a name="l00859"></a>00859                         $imagetypes = ImageTypes();
<a name="l00860"></a>00860                         <span class="keywordflow">if</span> ($imagetypes &amp; IMG_WBMP) {
<a name="l00861"></a>00861                                 $this-&gt;thumbnailFormat         = <span class="stringliteral">&#39;wbmp&#39;</span>;
<a name="l00862"></a>00862                                 $AvailableImageOutputFormats[] = <span class="stringliteral">&#39;wbmp&#39;</span>;
<a name="l00863"></a>00863                         }
<a name="l00864"></a>00864                         <span class="keywordflow">if</span> ($imagetypes &amp; IMG_GIF) {
<a name="l00865"></a>00865                                 $this-&gt;thumbnailFormat         = <span class="stringliteral">&#39;gif&#39;</span>;
<a name="l00866"></a>00866                                 $AvailableImageOutputFormats[] = <span class="stringliteral">&#39;gif&#39;</span>;
<a name="l00867"></a>00867                         }
<a name="l00868"></a>00868                         <span class="keywordflow">if</span> ($imagetypes &amp; IMG_PNG) {
<a name="l00869"></a>00869                                 $this-&gt;thumbnailFormat         = <span class="stringliteral">&#39;png&#39;</span>;
<a name="l00870"></a>00870                                 $AvailableImageOutputFormats[] = <span class="stringliteral">&#39;png&#39;</span>;
<a name="l00871"></a>00871                         }
<a name="l00872"></a>00872                         <span class="keywordflow">if</span> ($imagetypes &amp; IMG_JPG) {
<a name="l00873"></a>00873                                 $this-&gt;thumbnailFormat         = <span class="stringliteral">&#39;jpeg&#39;</span>;
<a name="l00874"></a>00874                                 $AvailableImageOutputFormats[] = <span class="stringliteral">&#39;jpeg&#39;</span>;
<a name="l00875"></a>00875                         }
<a name="l00876"></a>00876                 } <span class="keywordflow">else</span> {
<a name="l00877"></a>00877                         <span class="comment">//return $this-&gt;ErrorImage(&#39;ImageTypes() does not exist - GD support might not be enabled?&#39;);</span>
<a name="l00878"></a>00878                         $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;ImageTypes() does not exist - GD support might not be enabled?&#39;</span>,  __FILE__, __LINE__);
<a name="l00879"></a>00879                 }
<a name="l00880"></a>00880                 <span class="keywordflow">if</span> ($this-&gt;<a class="code" href="classphpthumb.html#a62b9ce7ae0bbe8bdef4820ba9f60c289">ImageMagickVersion</a>()) {
<a name="l00881"></a>00881                         $IMformats = array(<span class="stringliteral">&#39;jpeg&#39;</span>, <span class="stringliteral">&#39;png&#39;</span>, <span class="stringliteral">&#39;gif&#39;</span>, <span class="stringliteral">&#39;bmp&#39;</span>, <span class="stringliteral">&#39;ico&#39;</span>, <span class="stringliteral">&#39;wbmp&#39;</span>);
<a name="l00882"></a>00882                         $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;Addding ImageMagick formats to $AvailableImageOutputFormats (&#39;</span>.implode(<span class="charliteral">&#39;;&#39;</span>, $AvailableImageOutputFormats).<span class="charliteral">&#39;)&#39;</span>, __FILE__, __LINE__);
<a name="l00883"></a>00883                         <span class="keywordflow">foreach</span> ($IMformats as $key =&gt; $format) {
<a name="l00884"></a>00884                                 $AvailableImageOutputFormats[] = $format;
<a name="l00885"></a>00885                         }
<a name="l00886"></a>00886                 }
<a name="l00887"></a>00887                 $AvailableImageOutputFormats = array_unique($AvailableImageOutputFormats);
<a name="l00888"></a>00888                 $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;$AvailableImageOutputFormats = array(&#39;</span>.implode(<span class="charliteral">&#39;;&#39;</span>, $AvailableImageOutputFormats).<span class="charliteral">&#39;)&#39;</span>, __FILE__, __LINE__);
<a name="l00889"></a>00889 
<a name="l00890"></a>00890                 $this-&gt;f = ereg_replace(<span class="stringliteral">&#39;[^a-z]&#39;</span>, <span class="stringliteral">&#39;&#39;</span>, strtolower($this-&gt;f));
<a name="l00891"></a>00891                 <span class="keywordflow">if</span> (strtolower($this-&gt;config_output_format) == <span class="stringliteral">&#39;jpg&#39;</span>) {
<a name="l00892"></a>00892                         $this-&gt;config_output_format = <span class="stringliteral">&#39;jpeg&#39;</span>;
<a name="l00893"></a>00893                 }
<a name="l00894"></a>00894                 <span class="keywordflow">if</span> (strtolower($this-&gt;f) == <span class="stringliteral">&#39;jpg&#39;</span>) {
<a name="l00895"></a>00895                         $this-&gt;f = <span class="stringliteral">&#39;jpeg&#39;</span>;
<a name="l00896"></a>00896                 }
<a name="l00897"></a>00897                 <span class="keywordflow">if</span> (<a class="code" href="classphpthumb__functions.html#ad364cc6286f8223df18cc27695c8db4b">phpthumb_functions::CaseInsensitiveInArray</a>($this-&gt;config_output_format, $AvailableImageOutputFormats)) {
<a name="l00898"></a>00898                         <span class="comment">// set output format to config default if that format is available</span>
<a name="l00899"></a>00899                         $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;$this-&gt;thumbnailFormat set to $this-&gt;config_output_format &quot;&#39;</span>.strtolower($this-&gt;config_output_format).<span class="charliteral">&#39;&quot;&#39;</span>, __FILE__, __LINE__);
<a name="l00900"></a>00900                         $this-&gt;thumbnailFormat = strtolower($this-&gt;config_output_format);
<a name="l00901"></a>00901                 } <a class="code" href="php_thumb_8demo_8check_8php.html#af92779326267616cd7c3cdaaa9484bc9">elseif</a> ($this-&gt;config_output_format) {
<a name="l00902"></a>00902                         $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;$this-&gt;thumbnailFormat staying as &quot;&#39;</span>.$this-&gt;thumbnailFormat.<span class="stringliteral">&#39;&quot; because $this-&gt;config_output_format (&#39;</span>.strtolower($this-&gt;config_output_format).<span class="stringliteral">&#39;) is not in $AvailableImageOutputFormats&#39;</span>, __FILE__, __LINE__);
<a name="l00903"></a>00903                 }
<a name="l00904"></a>00904                 <span class="keywordflow">if</span> ($this-&gt;f &amp;&amp; (<a class="code" href="classphpthumb__functions.html#ad364cc6286f8223df18cc27695c8db4b">phpthumb_functions::CaseInsensitiveInArray</a>($this-&gt;f, $AvailableImageOutputFormats))) {
<a name="l00905"></a>00905                         <span class="comment">// override output format if $this-&gt;f is set and that format is available</span>
<a name="l00906"></a>00906                         $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;$this-&gt;thumbnailFormat set to $this-&gt;f &quot;&#39;</span>.strtolower($this-&gt;f).<span class="charliteral">&#39;&quot;&#39;</span>, __FILE__, __LINE__);
<a name="l00907"></a>00907                         $this-&gt;thumbnailFormat = strtolower($this-&gt;f);
<a name="l00908"></a>00908                 } <a class="code" href="php_thumb_8demo_8check_8php.html#af92779326267616cd7c3cdaaa9484bc9">elseif</a> ($this-&gt;f) {
<a name="l00909"></a>00909                         $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;$this-&gt;thumbnailFormat staying as &quot;&#39;</span>.$this-&gt;thumbnailFormat.<span class="stringliteral">&#39;&quot; because $this-&gt;f (&#39;</span>.strtolower($this-&gt;f).<span class="stringliteral">&#39;) is not in $AvailableImageOutputFormats&#39;</span>, __FILE__, __LINE__);
<a name="l00910"></a>00910                 }
<a name="l00911"></a>00911 
<a name="l00912"></a>00912                 <span class="comment">// for JPEG images, quality 1 (worst) to 99 (best)</span>
<a name="l00913"></a>00913                 <span class="comment">// quality &lt; 25 is nasty, with not much size savings - not recommended</span>
<a name="l00914"></a>00914                 <span class="comment">// problems with 100 - invalid JPEG?</span>
<a name="l00915"></a>00915                 $this-&gt;thumbnailQuality = max(1, min(99, ($this-&gt;q ? $this-&gt;q : 75)));
<a name="l00916"></a>00916                 $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;$this-&gt;thumbnailQuality set to &quot;&#39;</span>.$this-&gt;thumbnailQuality.<span class="charliteral">&#39;&quot;&#39;</span>, __FILE__, __LINE__);
<a name="l00917"></a>00917 
<a name="l00918"></a>00918                 <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00919"></a>00919         }
<a name="l00920"></a>00920 
<a name="l00921"></a><a class="code" href="classphpthumb.html#aabeb053ae1be8517687e11f68955affd">00921</a>         <span class="keyword">function</span> <a class="code" href="classphpthumb.html#aabeb053ae1be8517687e11f68955affd">setCacheDirectory</a>() {
<a name="l00922"></a>00922                 <span class="comment">// resolve cache directory to absolute pathname</span>
<a name="l00923"></a>00923                 $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;setCacheDirectory() starting with config_cache_directory = &quot;&#39;</span>.$this-&gt;config_cache_directory.<span class="charliteral">&#39;&quot;&#39;</span>, __FILE__, __LINE__);
<a name="l00924"></a>00924                 <span class="keywordflow">if</span> (substr($this-&gt;config_cache_directory, 0, 1) == <span class="charliteral">&#39;.&#39;</span>) {
<a name="l00925"></a>00925                         <span class="keywordflow">if</span> (eregi(<span class="stringliteral">&#39;^(f|ht)tps?\://&#39;</span>, $this-&gt;src)) {
<a name="l00926"></a>00926                                 <span class="keywordflow">if</span> (!$this-&gt;config_cache_disable_warning) {
<a name="l00927"></a>00927                                         $this-&gt;<a class="code" href="classphpthumb.html#a6ff71b425894fd846790cedf9f9cc97d">ErrorImage</a>(<span class="stringliteral">&#39;$this-&gt;config_cache_directory (&#39;</span>.$this-&gt;config_cache_directory.<span class="stringliteral">&#39;) cannot be used for remote images. Adjust &quot;cache_directory&quot; or &quot;cache_disable_warning&quot; in phpThumb.config.php&#39;</span>);
<a name="l00928"></a>00928                                 }
<a name="l00929"></a>00929                         } <a class="code" href="php_thumb_8demo_8check_8php.html#af92779326267616cd7c3cdaaa9484bc9">elseif</a> ($this-&gt;src) {
<a name="l00930"></a>00930                                 <span class="comment">// resolve relative cache directory to source image</span>
<a name="l00931"></a>00931                                 $this-&gt;config_cache_directory = dirname($this-&gt;<a class="code" href="classphpthumb.html#a49cc25fd831b2990b8f5743e8d6abe30">ResolveFilenameToAbsolute</a>($this-&gt;src)).DIRECTORY_SEPARATOR.$this-&gt;config_cache_directory;
<a name="l00932"></a>00932                         } <span class="keywordflow">else</span> {
<a name="l00933"></a>00933                                 <span class="comment">// $this-&gt;new is probably set</span>
<a name="l00934"></a>00934                         }
<a name="l00935"></a>00935                 }
<a name="l00936"></a>00936                 <span class="keywordflow">if</span> (substr($this-&gt;config_cache_directory, -1) == <span class="charliteral">&#39;/&#39;</span>) {
<a name="l00937"></a>00937                         $this-&gt;config_cache_directory = substr($this-&gt;config_cache_directory, 0, -1);
<a name="l00938"></a>00938                 }
<a name="l00939"></a>00939                 <span class="keywordflow">if</span> ($this-&gt;iswindows) {
<a name="l00940"></a>00940                         $this-&gt;config_cache_directory = str_replace(<span class="charliteral">&#39;/&#39;</span>, DIRECTORY_SEPARATOR, $this-&gt;config_cache_directory);
<a name="l00941"></a>00941                 }
<a name="l00942"></a>00942                 <span class="keywordflow">if</span> ($this-&gt;config_cache_directory) {
<a name="l00943"></a>00943                         $real_cache_path = realpath($this-&gt;config_cache_directory);
<a name="l00944"></a>00944                         <span class="keywordflow">if</span> (!$real_cache_path) {
<a name="l00945"></a>00945                                 $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;realpath($this-&gt;config_cache_directory) failed for &quot;&#39;</span>.$this-&gt;config_cache_directory.<span class="charliteral">&#39;&quot;&#39;</span>, __FILE__, __LINE__);
<a name="l00946"></a>00946                                 <span class="keywordflow">if</span> (!is_dir($this-&gt;config_cache_directory)) {
<a name="l00947"></a>00947                                         $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;!is_dir(&#39;</span>.$this-&gt;config_cache_directory.<span class="charliteral">&#39;)&#39;</span>, __FILE__, __LINE__);
<a name="l00948"></a>00948                                 }
<a name="l00949"></a>00949                         }
<a name="l00950"></a>00950                         <span class="keywordflow">if</span> ($real_cache_path) {
<a name="l00951"></a>00951                                 $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;setting config_cache_directory to realpath(&#39;</span>.$this-&gt;config_cache_directory.<span class="stringliteral">&#39;) = &quot;&#39;</span>.$real_cache_path.<span class="charliteral">&#39;&quot;&#39;</span>, __FILE__, __LINE__);
<a name="l00952"></a>00952                                 $this-&gt;config_cache_directory = $real_cache_path;
<a name="l00953"></a>00953                         }
<a name="l00954"></a>00954                 }
<a name="l00955"></a>00955                 <span class="keywordflow">if</span> (!is_dir($this-&gt;config_cache_directory)) {
<a name="l00956"></a>00956                         <span class="keywordflow">if</span> (!$this-&gt;config_cache_disable_warning) {
<a name="l00957"></a>00957                                 $this-&gt;<a class="code" href="classphpthumb.html#a6ff71b425894fd846790cedf9f9cc97d">ErrorImage</a>(<span class="stringliteral">&#39;$this-&gt;config_cache_directory (&#39;</span>.$this-&gt;config_cache_directory.<span class="stringliteral">&#39;) does not exist. Adjust &quot;cache_directory&quot; or &quot;cache_disable_warning&quot; in phpThumb.config.php&#39;</span>);
<a name="l00958"></a>00958                         }
<a name="l00959"></a>00959                         $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;$this-&gt;config_cache_directory (&#39;</span>.$this-&gt;config_cache_directory.<span class="stringliteral">&#39;) is not a directory&#39;</span>, __FILE__, __LINE__);
<a name="l00960"></a>00960                         $this-&gt;config_cache_directory = null;
<a name="l00961"></a>00961                 } <a class="code" href="php_thumb_8demo_8check_8php.html#af92779326267616cd7c3cdaaa9484bc9">elseif</a> (!@is_writable($this-&gt;config_cache_directory)) {
<a name="l00962"></a>00962                         $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;$this-&gt;config_cache_directory is not writable (&#39;</span>.$this-&gt;config_cache_directory.<span class="charliteral">&#39;)&#39;</span>, __FILE__, __LINE__);
<a name="l00963"></a>00963                 }
<a name="l00964"></a>00964 
<a name="l00965"></a>00965                 $this-&gt;<a class="code" href="classphpthumb.html#aea3eff175aef32d43f196e043ee98802">InitializeTempDirSetting</a>();
<a name="l00966"></a>00966                 <span class="keywordflow">if</span> (!@is_dir($this-&gt;config_temp_directory) &amp;&amp; !@is_writable($this-&gt;config_temp_directory) &amp;&amp; @is_dir($this-&gt;config_cache_directory) &amp;&amp; @is_writable($this-&gt;config_cache_directory)) {
<a name="l00967"></a>00967                         $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;setting $this-&gt;config_temp_directory = $this-&gt;config_cache_directory (&#39;</span>.$this-&gt;config_cache_directory.<span class="charliteral">&#39;)&#39;</span>, __FILE__, __LINE__);
<a name="l00968"></a>00968                         $this-&gt;config_temp_directory = $this-&gt;config_cache_directory;
<a name="l00969"></a>00969                 }
<a name="l00970"></a>00970                 <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00971"></a>00971         }
<a name="l00972"></a>00972 
<a name="l00973"></a>00973 
<a name="l00974"></a><a class="code" href="classphpthumb.html#a49cc25fd831b2990b8f5743e8d6abe30">00974</a>         <span class="keyword">function</span> <a class="code" href="classphpthumb.html#a49cc25fd831b2990b8f5743e8d6abe30">ResolveFilenameToAbsolute</a>(<a class="code" href="actions_8php.html#a6b7de8d10c540db2f1631e68b2aa0538">$filename</a>) {
<a name="l00975"></a>00975                 <span class="keywordflow">if</span> (!<a class="code" href="actions_8php.html#a6b7de8d10c540db2f1631e68b2aa0538">$filename</a>) {
<a name="l00976"></a>00976                         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00977"></a>00977                 }
<a name="l00978"></a>00978 
<a name="l00979"></a>00979                 <span class="comment">//if (eregi(&#39;^(f|ht)tps?\://&#39;, $filename)) {</span>
<a name="l00980"></a>00980                 <span class="keywordflow">if</span> (eregi(<span class="stringliteral">&#39;^[a-z0-9]+\:/{1,2}&#39;</span>, <a class="code" href="actions_8php.html#a6b7de8d10c540db2f1631e68b2aa0538">$filename</a>)) {
<a name="l00981"></a>00981                         <span class="comment">// eg: http://host/path/file.jpg (HTTP URL)</span>
<a name="l00982"></a>00982                         <span class="comment">// eg: ftp://host/path/file.jpg  (FTP URL)</span>
<a name="l00983"></a>00983                         <span class="comment">// eg: data1:/path/file.jpg      (Netware path)</span>
<a name="l00984"></a>00984 
<a name="l00985"></a>00985                         <span class="comment">//$AbsoluteFilename = $filename;</span>
<a name="l00986"></a>00986                         <span class="keywordflow">return</span> <a class="code" href="actions_8php.html#a6b7de8d10c540db2f1631e68b2aa0538">$filename</a>;
<a name="l00987"></a>00987 
<a name="l00988"></a>00988                 } <a class="code" href="php_thumb_8demo_8check_8php.html#af92779326267616cd7c3cdaaa9484bc9">elseif</a> ($this-&gt;iswindows &amp;&amp; (<a class="code" href="actions_8php.html#a6b7de8d10c540db2f1631e68b2aa0538">$filename</a>{1} == <span class="charliteral">&#39;:&#39;</span>)) {
<a name="l00989"></a>00989 
<a name="l00990"></a>00990                         <span class="comment">// absolute pathname (Windows)</span>
<a name="l00991"></a>00991                         $AbsoluteFilename = <a class="code" href="actions_8php.html#a6b7de8d10c540db2f1631e68b2aa0538">$filename</a>;
<a name="l00992"></a>00992 
<a name="l00993"></a>00993                 } <a class="code" href="php_thumb_8demo_8check_8php.html#af92779326267616cd7c3cdaaa9484bc9">elseif</a> ($this-&gt;iswindows &amp;&amp; ((substr(<a class="code" href="actions_8php.html#a6b7de8d10c540db2f1631e68b2aa0538">$filename</a>, 0, 2) == <span class="stringliteral">&#39;//&#39;</span>) || (substr(<a class="code" href="actions_8php.html#a6b7de8d10c540db2f1631e68b2aa0538">$filename</a>, 0, 2) == <span class="stringliteral">&#39;\\\\&#39;</span>))) {
<a name="l00994"></a>00994 
<a name="l00995"></a>00995                         <span class="comment">// absolute pathname (Windows)</span>
<a name="l00996"></a>00996                         $AbsoluteFilename = <a class="code" href="actions_8php.html#a6b7de8d10c540db2f1631e68b2aa0538">$filename</a>;
<a name="l00997"></a>00997 
<a name="l00998"></a>00998                 } <a class="code" href="php_thumb_8demo_8check_8php.html#af92779326267616cd7c3cdaaa9484bc9">elseif</a> (<a class="code" href="actions_8php.html#a6b7de8d10c540db2f1631e68b2aa0538">$filename</a>{0} == <span class="charliteral">&#39;/&#39;</span>) {
<a name="l00999"></a>00999 
<a name="l01000"></a>01000                         <span class="keywordflow">if</span> (@is_readable(<a class="code" href="actions_8php.html#a6b7de8d10c540db2f1631e68b2aa0538">$filename</a>) &amp;&amp; !@is_readable($this-&gt;config_document_root.$filename)) {
<a name="l01001"></a>01001 
<a name="l01002"></a>01002                                 <span class="comment">// absolute filename (*nix)</span>
<a name="l01003"></a>01003                                 $AbsoluteFilename = <a class="code" href="actions_8php.html#a6b7de8d10c540db2f1631e68b2aa0538">$filename</a>;
<a name="l01004"></a>01004 
<a name="l01005"></a>01005                         } <a class="code" href="php_thumb_8demo_8check_8php.html#af92779326267616cd7c3cdaaa9484bc9">elseif</a> (<a class="code" href="actions_8php.html#a6b7de8d10c540db2f1631e68b2aa0538">$filename</a>{1} == <span class="charliteral">&#39;~&#39;</span>) {
<a name="l01006"></a>01006 
<a name="l01007"></a>01007                                 <span class="comment">// /~user/path</span>
<a name="l01008"></a>01008                                 <span class="keywordflow">if</span> ($ApacheLookupURIarray = <a class="code" href="classphpthumb__functions.html#acb4fb35a3540b66f2543550e25197a74">phpthumb_functions::ApacheLookupURIarray</a>(<a class="code" href="actions_8php.html#a6b7de8d10c540db2f1631e68b2aa0538">$filename</a>)) {
<a name="l01009"></a>01009                                         $AbsoluteFilename = $ApacheLookupURIarray[<span class="stringliteral">&#39;filename&#39;</span>];
<a name="l01010"></a>01010                                 } <span class="keywordflow">else</span> {
<a name="l01011"></a>01011                                         $AbsoluteFilename = realpath(<a class="code" href="actions_8php.html#a6b7de8d10c540db2f1631e68b2aa0538">$filename</a>);
<a name="l01012"></a>01012                                         <span class="keywordflow">if</span> (@is_readable($AbsoluteFilename)) {
<a name="l01013"></a>01013                                                 $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;phpthumb_functions::ApacheLookupURIarray() failed for &quot;&#39;</span>.<a class="code" href="actions_8php.html#a6b7de8d10c540db2f1631e68b2aa0538">$filename</a>.<span class="stringliteral">&#39;&quot;, but the correct filename (&#39;</span>.$AbsoluteFilename.<span class="stringliteral">&#39;) seems to have been resolved with realpath($filename)&#39;</span>, __FILE__, __LINE__);
<a name="l01014"></a>01014                                         } <a class="code" href="php_thumb_8demo_8check_8php.html#af92779326267616cd7c3cdaaa9484bc9">elseif</a> (is_dir(dirname($AbsoluteFilename))) {
<a name="l01015"></a>01015                                                 $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;phpthumb_functions::ApacheLookupURIarray() failed for &quot;&#39;</span>.dirname(<a class="code" href="actions_8php.html#a6b7de8d10c540db2f1631e68b2aa0538">$filename</a>).<span class="stringliteral">&#39;&quot;, but the correct directory (&#39;</span>.dirname($AbsoluteFilename).<span class="stringliteral">&#39;) seems to have been resolved with realpath(.)&#39;</span>, __FILE__, __LINE__);
<a name="l01016"></a>01016                                         } <span class="keywordflow">else</span> {
<a name="l01017"></a>01017                                                 <span class="keywordflow">return</span> $this-&gt;<a class="code" href="classphpthumb.html#a6ff71b425894fd846790cedf9f9cc97d">ErrorImage</a>(<span class="stringliteral">&#39;phpthumb_functions::ApacheLookupURIarray() failed for &quot;&#39;</span>.<a class="code" href="actions_8php.html#a6b7de8d10c540db2f1631e68b2aa0538">$filename</a>.<span class="stringliteral">&#39;&quot;. This has been known to fail on Apache2 - try using the absolute filename for the source image (ex: &quot;/home/user/httpdocs/image.jpg&quot; instead of &quot;/~user/image.jpg&quot;)&#39;</span>);
<a name="l01018"></a>01018                                         }
<a name="l01019"></a>01019                                 }
<a name="l01020"></a>01020 
<a name="l01021"></a>01021                         } <span class="keywordflow">else</span> {
<a name="l01022"></a>01022 
<a name="l01023"></a>01023                                 <span class="comment">// relative filename (any OS)</span>
<a name="l01024"></a>01024                                 <span class="keywordflow">if</span> (ereg(<span class="charliteral">&#39;^&#39;</span>.preg_quote($this-&gt;config_document_root), <a class="code" href="actions_8php.html#a6b7de8d10c540db2f1631e68b2aa0538">$filename</a>)) {
<a name="l01025"></a>01025                                         $AbsoluteFilename = <a class="code" href="actions_8php.html#a6b7de8d10c540db2f1631e68b2aa0538">$filename</a>;
<a name="l01026"></a>01026                                         $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;ResolveFilenameToAbsolute() NOT prepending $this-&gt;config_document_root (&#39;</span>.$this-&gt;config_document_root.<span class="stringliteral">&#39;) to $filename (&#39;</span>.<a class="code" href="actions_8php.html#a6b7de8d10c540db2f1631e68b2aa0538">$filename</a>.<span class="stringliteral">&#39;) resulting in ($AbsoluteFilename = &quot;&#39;</span>.$AbsoluteFilename.<span class="stringliteral">&#39;&quot;)&#39;</span>, __FILE__, __LINE__);
<a name="l01027"></a>01027                                 } <span class="keywordflow">else</span> {
<a name="l01028"></a>01028                                         $AbsoluteFilename = $this-&gt;config_document_root.$filename;
<a name="l01029"></a>01029                                         $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;ResolveFilenameToAbsolute() prepending $this-&gt;config_document_root (&#39;</span>.$this-&gt;config_document_root.<span class="stringliteral">&#39;) to $filename (&#39;</span>.<a class="code" href="actions_8php.html#a6b7de8d10c540db2f1631e68b2aa0538">$filename</a>.<span class="stringliteral">&#39;) resulting in ($AbsoluteFilename = &quot;&#39;</span>.$AbsoluteFilename.<span class="stringliteral">&#39;&quot;)&#39;</span>, __FILE__, __LINE__);
<a name="l01030"></a>01030                                 }
<a name="l01031"></a>01031 
<a name="l01032"></a>01032                         }
<a name="l01033"></a>01033 
<a name="l01034"></a>01034                 } <span class="keywordflow">else</span> {
<a name="l01035"></a>01035 
<a name="l01036"></a>01036                         <span class="comment">// relative to current directory (any OS)</span>
<a name="l01037"></a>01037                         $AbsoluteFilename = $this-&gt;config_document_root.dirname(@$_SERVER[<span class="stringliteral">&#39;PHP_SELF&#39;</span>]).DIRECTORY_SEPARATOR.$filename;
<a name="l01038"></a>01038                         <span class="comment">//if (!@file_exists($AbsoluteFilename) &amp;&amp; @file_exists(realpath($this-&gt;DotPadRelativeDirectoryPath($filename)))) {</span>
<a name="l01039"></a>01039                         <span class="comment">//      $AbsoluteFilename = realpath($this-&gt;DotPadRelativeDirectoryPath($filename));</span>
<a name="l01040"></a>01040                         <span class="comment">//}</span>
<a name="l01041"></a>01041 
<a name="l01042"></a>01042                         <span class="keywordflow">if</span> (substr(dirname(@$_SERVER[<span class="stringliteral">&#39;PHP_SELF&#39;</span>]), 0, 2) == <span class="stringliteral">&#39;/~&#39;</span>) {
<a name="l01043"></a>01043                                 <span class="keywordflow">if</span> ($ApacheLookupURIarray = <a class="code" href="classphpthumb__functions.html#acb4fb35a3540b66f2543550e25197a74">phpthumb_functions::ApacheLookupURIarray</a>(dirname(@$_SERVER[<span class="stringliteral">&#39;PHP_SELF&#39;</span>]))) {
<a name="l01044"></a>01044                                         $AbsoluteFilename = $ApacheLookupURIarray[<span class="stringliteral">&#39;filename&#39;</span>].DIRECTORY_SEPARATOR.$filename;
<a name="l01045"></a>01045                                 } <span class="keywordflow">else</span> {
<a name="l01046"></a>01046                                         $AbsoluteFilename = realpath(<span class="charliteral">&#39;.&#39;</span>).DIRECTORY_SEPARATOR.$filename;
<a name="l01047"></a>01047                                         <span class="keywordflow">if</span> (@is_readable($AbsoluteFilename)) {
<a name="l01048"></a>01048                                                 $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;phpthumb_functions::ApacheLookupURIarray() failed for &quot;&#39;</span>.dirname(@$_SERVER[<span class="stringliteral">&#39;PHP_SELF&#39;</span>]).<span class="stringliteral">&#39;&quot;, but the correct filename (&#39;</span>.$AbsoluteFilename.<span class="stringliteral">&#39;) seems to have been resolved with realpath(.)/$filename&#39;</span>, __FILE__, __LINE__);
<a name="l01049"></a>01049                                         } <a class="code" href="php_thumb_8demo_8check_8php.html#af92779326267616cd7c3cdaaa9484bc9">elseif</a> (is_dir(dirname($AbsoluteFilename))) {
<a name="l01050"></a>01050                                                 $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;phpthumb_functions::ApacheLookupURIarray() failed for &quot;&#39;</span>.dirname(@$_SERVER[<span class="stringliteral">&#39;PHP_SELF&#39;</span>]).<span class="stringliteral">&#39;&quot;, but the correct directory (&#39;</span>.dirname($AbsoluteFilename).<span class="stringliteral">&#39;) seems to have been resolved with realpath(.)&#39;</span>, __FILE__, __LINE__);
<a name="l01051"></a>01051                                         } <span class="keywordflow">else</span> {
<a name="l01052"></a>01052                                                 <span class="keywordflow">return</span> $this-&gt;<a class="code" href="classphpthumb.html#a6ff71b425894fd846790cedf9f9cc97d">ErrorImage</a>(<span class="stringliteral">&#39;phpthumb_functions::ApacheLookupURIarray() failed for &quot;&#39;</span>.dirname(@$_SERVER[<span class="stringliteral">&#39;PHP_SELF&#39;</span>]).<span class="stringliteral">&#39;&quot;. This has been known to fail on Apache2 - try using the absolute filename for the source image&#39;</span>);
<a name="l01053"></a>01053                                         }
<a name="l01054"></a>01054                                 }
<a name="l01055"></a>01055                         }
<a name="l01056"></a>01056 
<a name="l01057"></a>01057                 }
<a name="l01058"></a>01058                 <span class="keywordflow">if</span> (is_link($AbsoluteFilename)) {
<a name="l01059"></a>01059                         $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;is_link()==true, changing &quot;&#39;</span>.$AbsoluteFilename.<span class="stringliteral">&#39;&quot; to &quot;&#39;</span>.readlink($AbsoluteFilename).<span class="charliteral">&#39;&quot;&#39;</span>, __FILE__, __LINE__);
<a name="l01060"></a>01060                         $AbsoluteFilename = readlink($AbsoluteFilename);
<a name="l01061"></a>01061                 }
<a name="l01062"></a>01062                 <span class="keywordflow">if</span> (realpath($AbsoluteFilename)) {
<a name="l01063"></a>01063                         $AbsoluteFilename = realpath($AbsoluteFilename);
<a name="l01064"></a>01064                 }
<a name="l01065"></a>01065                 <span class="keywordflow">if</span> ($this-&gt;iswindows) {
<a name="l01066"></a>01066                         $AbsoluteFilename = eregi_replace(<span class="charliteral">&#39;^&#39;</span>.preg_quote(realpath($this-&gt;config_document_root)), realpath($this-&gt;config_document_root), $AbsoluteFilename);
<a name="l01067"></a>01067                         $AbsoluteFilename = str_replace(DIRECTORY_SEPARATOR, <span class="charliteral">&#39;/&#39;</span>, $AbsoluteFilename);
<a name="l01068"></a>01068                 }
<a name="l01069"></a>01069                 <span class="keywordflow">if</span> (!$this-&gt;config_allow_src_above_docroot &amp;&amp; !ereg(<span class="charliteral">&#39;^&#39;</span>.preg_quote(str_replace(DIRECTORY_SEPARATOR, <span class="charliteral">&#39;/&#39;</span>, realpath($this-&gt;config_document_root))), $AbsoluteFilename)) {
<a name="l01070"></a>01070                         $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;!$this-&gt;config_allow_src_above_docroot therefore setting &quot;&#39;</span>.$AbsoluteFilename.<span class="stringliteral">&#39;&quot; (outside &quot;&#39;</span>.realpath($this-&gt;config_document_root).<span class="stringliteral">&#39;&quot;) to null&#39;</span>, __FILE__, __LINE__);
<a name="l01071"></a>01071                         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01072"></a>01072                 }
<a name="l01073"></a>01073                 <span class="keywordflow">if</span> (!$this-&gt;config_allow_src_above_phpthumb &amp;&amp; !ereg(<span class="charliteral">&#39;^&#39;</span>.preg_quote(str_replace(DIRECTORY_SEPARATOR, <span class="charliteral">&#39;/&#39;</span>, dirname(__FILE__))), $AbsoluteFilename)) {
<a name="l01074"></a>01074                         $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;!$this-&gt;config_allow_src_above_phpthumb therefore setting &quot;&#39;</span>.$AbsoluteFilename.<span class="stringliteral">&#39;&quot; (outside &quot;&#39;</span>.dirname(__FILE__).<span class="stringliteral">&#39;&quot;) to null&#39;</span>, __FILE__, __LINE__);
<a name="l01075"></a>01075                         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01076"></a>01076                 }
<a name="l01077"></a>01077                 <span class="keywordflow">return</span> $AbsoluteFilename;
<a name="l01078"></a>01078         }
<a name="l01079"></a>01079 
<a name="l01080"></a><a class="code" href="classphpthumb.html#aabd06eff0633253ae0660306a3e5cb8e">01080</a>         <span class="keyword">function</span> <a class="code" href="classphpthumb.html#aabd06eff0633253ae0660306a3e5cb8e">ImageMagickWhichConvert</a>() {
<a name="l01081"></a>01081                 <span class="keyword">static</span> $WhichConvert = null;
<a name="l01082"></a>01082                 <span class="keywordflow">if</span> (is_null($WhichConvert)) {
<a name="l01083"></a>01083                         <span class="keywordflow">if</span> ($this-&gt;iswindows) {
<a name="l01084"></a>01084                                 $WhichConvert = <span class="keyword">false</span>;
<a name="l01085"></a>01085                         } <span class="keywordflow">else</span> {
<a name="l01086"></a>01086                                 $WhichConvert = trim(<a class="code" href="classphpthumb__functions.html#a32ab9bd049bb6b7e0352329726a0ab51">phpthumb_functions::SafeExec</a>(<span class="stringliteral">&#39;which convert&#39;</span>));
<a name="l01087"></a>01087                         }
<a name="l01088"></a>01088                 }
<a name="l01089"></a>01089                 <span class="keywordflow">return</span> $WhichConvert;
<a name="l01090"></a>01090         }
<a name="l01091"></a>01091 
<a name="l01092"></a><a class="code" href="classphpthumb.html#a91b6f226a6cecb13d3084fe066277fcd">01092</a>         <span class="keyword">function</span> <a class="code" href="classphpthumb.html#a91b6f226a6cecb13d3084fe066277fcd">ImageMagickCommandlineBase</a>() {
<a name="l01093"></a>01093                 <span class="keyword">static</span> $commandline = null;
<a name="l01094"></a>01094                 <span class="keywordflow">if</span> (is_null($commandline)) {
<a name="l01095"></a>01095                         $commandline = (!is_null($this-&gt;config_imagemagick_path) ? $this-&gt;config_imagemagick_path : <span class="stringliteral">&#39;&#39;</span>);
<a name="l01096"></a>01096 
<a name="l01097"></a>01097                         <span class="keywordflow">if</span> ($this-&gt;config_imagemagick_path &amp;&amp; ($this-&gt;config_imagemagick_path != realpath($this-&gt;config_imagemagick_path))) {
<a name="l01098"></a>01098                                 <span class="keywordflow">if</span> (@is_executable(realpath($this-&gt;config_imagemagick_path))) {
<a name="l01099"></a>01099                                         $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;Changing $this-&gt;config_imagemagick_path (&#39;</span>.$this-&gt;config_imagemagick_path.<span class="stringliteral">&#39;) to realpath($this-&gt;config_imagemagick_path) (&#39;</span>.realpath($this-&gt;config_imagemagick_path).<span class="charliteral">&#39;)&#39;</span>, __FILE__, __LINE__);
<a name="l01100"></a>01100                                         $this-&gt;config_imagemagick_path = realpath($this-&gt;config_imagemagick_path);
<a name="l01101"></a>01101                                 } <span class="keywordflow">else</span> {
<a name="l01102"></a>01102                                         $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;Leaving $this-&gt;config_imagemagick_path as (&#39;</span>.$this-&gt;config_imagemagick_path.<span class="stringliteral">&#39;) because !is_execuatable(realpath($this-&gt;config_imagemagick_path)) (&#39;</span>.realpath($this-&gt;config_imagemagick_path).<span class="charliteral">&#39;)&#39;</span>, __FILE__, __LINE__);
<a name="l01103"></a>01103                                 }
<a name="l01104"></a>01104                         }
<a name="l01105"></a>01105                         $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;  file_exists(&#39;</span>.$this-&gt;config_imagemagick_path.<span class="stringliteral">&#39;) = &#39;</span>.intval(  @file_exists($this-&gt;config_imagemagick_path)), __FILE__, __LINE__);
<a name="l01106"></a>01106                         $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;is_executable(&#39;</span>.$this-&gt;config_imagemagick_path.<span class="stringliteral">&#39;) = &#39;</span>.intval(@is_executable($this-&gt;config_imagemagick_path)), __FILE__, __LINE__);
<a name="l01107"></a>01107                         <span class="keywordflow">if</span> (@file_exists($this-&gt;config_imagemagick_path)) {
<a name="l01108"></a>01108                                 $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;using ImageMagick path from $this-&gt;config_imagemagick_path (&#39;</span>.$this-&gt;config_imagemagick_path.<span class="charliteral">&#39;)&#39;</span>, __FILE__, __LINE__);
<a name="l01109"></a>01109                                 <span class="keywordflow">if</span> ($this-&gt;iswindows) {
<a name="l01110"></a>01110                                         $commandline = substr($this-&gt;config_imagemagick_path, 0, 2).<span class="stringliteral">&#39; &amp;&amp; cd &quot;&#39;</span>.str_replace(<span class="charliteral">&#39;/&#39;</span>, DIRECTORY_SEPARATOR, substr(dirname($this-&gt;config_imagemagick_path), 2)).<span class="stringliteral">&#39;&quot; &amp;&amp; &#39;</span>.basename($this-&gt;config_imagemagick_path);
<a name="l01111"></a>01111                                 } <span class="keywordflow">else</span> {
<a name="l01112"></a>01112                                         $commandline = <span class="charliteral">&#39;&quot;&#39;</span>.$this-&gt;config_imagemagick_path.<span class="charliteral">&#39;&quot;&#39;</span>;
<a name="l01113"></a>01113                                 }
<a name="l01114"></a>01114                                 <span class="keywordflow">return</span> $commandline;
<a name="l01115"></a>01115                         }
<a name="l01116"></a>01116 
<a name="l01117"></a>01117                         $which_convert = $this-&gt;<a class="code" href="classphpthumb.html#aabd06eff0633253ae0660306a3e5cb8e">ImageMagickWhichConvert</a>();
<a name="l01118"></a>01118                         $IMversion     = $this-&gt;<a class="code" href="classphpthumb.html#a62b9ce7ae0bbe8bdef4820ba9f60c289">ImageMagickVersion</a>();
<a name="l01119"></a>01119 
<a name="l01120"></a>01120                         <span class="keywordflow">if</span> ($which_convert &amp;&amp; ($which_convert{0} == <span class="charliteral">&#39;/&#39;</span>) &amp;&amp; @file_exists($which_convert)) {
<a name="l01121"></a>01121 
<a name="l01122"></a>01122                                 <span class="comment">// `which convert` *should* return the path if &quot;convert&quot; exist, or nothing if it doesn&#39;t</span>
<a name="l01123"></a>01123                                 <span class="comment">// other things *may* get returned, like &quot;sh: convert: not found&quot; or &quot;no convert in /usr/local/bin /usr/sbin /usr/bin /usr/ccs/bin&quot;</span>
<a name="l01124"></a>01124                                 <span class="comment">// so only do this if the value returned exists as a file</span>
<a name="l01125"></a>01125                                 $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;using ImageMagick path from `which convert` (&#39;</span>.$which_convert.<span class="charliteral">&#39;)&#39;</span>, __FILE__, __LINE__);
<a name="l01126"></a>01126                                 $commandline = <span class="stringliteral">&#39;convert&#39;</span>;
<a name="l01127"></a>01127 
<a name="l01128"></a>01128                         } <a class="code" href="php_thumb_8demo_8check_8php.html#af92779326267616cd7c3cdaaa9484bc9">elseif</a> ($IMversion) {
<a name="l01129"></a>01129 
<a name="l01130"></a>01130                                 $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;setting ImageMagick path to $this-&gt;config_imagemagick_path (&#39;</span>.$this-&gt;config_imagemagick_path.<span class="stringliteral">&#39;) [&#39;</span>.$IMversion.<span class="charliteral">&#39;]&#39;</span>, __FILE__, __LINE__);
<a name="l01131"></a>01131                                 $commandline = $this-&gt;config_imagemagick_path;
<a name="l01132"></a>01132 
<a name="l01133"></a>01133                         } <span class="keywordflow">else</span> {
<a name="l01134"></a>01134 
<a name="l01135"></a>01135                                 $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;ImageMagickThumbnailToGD() aborting because cannot find convert in $this-&gt;config_imagemagick_path (&#39;</span>.$this-&gt;config_imagemagick_path.<span class="stringliteral">&#39;), and `which convert` returned (&#39;</span>.$which_convert.<span class="charliteral">&#39;)&#39;</span>, __FILE__, __LINE__);
<a name="l01136"></a>01136                                 $commandline = <span class="stringliteral">&#39;&#39;</span>;
<a name="l01137"></a>01137 
<a name="l01138"></a>01138                         }
<a name="l01139"></a>01139                 }
<a name="l01140"></a>01140                 <span class="keywordflow">return</span> $commandline;
<a name="l01141"></a>01141         }
<a name="l01142"></a>01142 
<a name="l01143"></a><a class="code" href="classphpthumb.html#a62b9ce7ae0bbe8bdef4820ba9f60c289">01143</a>         <span class="keyword">function</span> <a class="code" href="classphpthumb.html#a62b9ce7ae0bbe8bdef4820ba9f60c289">ImageMagickVersion</a>($returnRAW=<span class="keyword">false</span>) {
<a name="l01144"></a>01144                 <span class="keyword">static</span> $versionstring = null;
<a name="l01145"></a>01145                 <span class="keywordflow">if</span> (is_null($versionstring)) {
<a name="l01146"></a>01146                         $commandline = $this-&gt;<a class="code" href="classphpthumb.html#a91b6f226a6cecb13d3084fe066277fcd">ImageMagickCommandlineBase</a>();
<a name="l01147"></a>01147                         $commandline = (!is_null($commandline) ? $commandline : <span class="stringliteral">&#39;&#39;</span>);
<a name="l01148"></a>01148 
<a name="l01149"></a>01149                         $versionstring = array(0=&gt;<span class="stringliteral">&#39;&#39;</span>, 1=&gt;<span class="stringliteral">&#39;&#39;</span>);
<a name="l01150"></a>01150                         <span class="keywordflow">if</span> ($commandline) {
<a name="l01151"></a>01151                                 $commandline .= <span class="stringliteral">&#39; --version&#39;</span>;
<a name="l01152"></a>01152                                 $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;ImageMagick version checked with &quot;&#39;</span>.$commandline.<span class="charliteral">&#39;&quot;&#39;</span>, __FILE__, __LINE__);
<a name="l01153"></a>01153                                 $versionstring[1] = trim(<a class="code" href="classphpthumb__functions.html#a32ab9bd049bb6b7e0352329726a0ab51">phpthumb_functions::SafeExec</a>($commandline));
<a name="l01154"></a>01154                                 <span class="keywordflow">if</span> (eregi(<span class="stringliteral">&#39;^Version: [^0-9]*([ 0-9\\.\\:Q/]+) (http|file)\:&#39;</span>, $versionstring[1], $matches)) {
<a name="l01155"></a>01155                                         $versionstring[0] = $matches[1];
<a name="l01156"></a>01156                                 } <span class="keywordflow">else</span> {
<a name="l01157"></a>01157                                         $versionstring[0] = <span class="keyword">false</span>;
<a name="l01158"></a>01158                                         $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;ImageMagick did not return recognized version string (&#39;</span>.$versionstring[1].<span class="charliteral">&#39;)&#39;</span>, __FILE__, __LINE__);
<a name="l01159"></a>01159                                 }
<a name="l01160"></a>01160                                 $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;ImageMagick convert --version says &quot;&#39;</span>.$matches[0].<span class="charliteral">&#39;&quot;&#39;</span>, __FILE__, __LINE__);
<a name="l01161"></a>01161                         }
<a name="l01162"></a>01162                 }
<a name="l01163"></a>01163                 <span class="keywordflow">return</span> @$versionstring[intval($returnRAW)];
<a name="l01164"></a>01164         }
<a name="l01165"></a>01165 
<a name="l01166"></a><a class="code" href="classphpthumb.html#a1f5c8fccd6c88c41d3978a7e5ba1f02f">01166</a>         <span class="keyword">function</span> <a class="code" href="classphpthumb.html#a1f5c8fccd6c88c41d3978a7e5ba1f02f">ImageMagickSwitchAvailable</a>($switchname) {
<a name="l01167"></a>01167                 <span class="keyword">static</span> $IMoptions = null;
<a name="l01168"></a>01168                 <span class="keywordflow">if</span> (is_null($IMoptions)) {
<a name="l01169"></a>01169                         $IMoptions = array();
<a name="l01170"></a>01170                         $commandline = $this-&gt;<a class="code" href="classphpthumb.html#a91b6f226a6cecb13d3084fe066277fcd">ImageMagickCommandlineBase</a>();
<a name="l01171"></a>01171                         <span class="keywordflow">if</span> (!is_null($commandline)) {
<a name="l01172"></a>01172                                 $commandline .= <span class="stringliteral">&#39; -help&#39;</span>;
<a name="l01173"></a>01173                                 $IMhelp_lines = explode(<span class="stringliteral">&quot;\n&quot;</span>, <a class="code" href="classphpthumb__functions.html#a32ab9bd049bb6b7e0352329726a0ab51">phpthumb_functions::SafeExec</a>($commandline));
<a name="l01174"></a>01174                                 <span class="keywordflow">foreach</span> ($IMhelp_lines as <a class="code" href="tokenizer__test_8php.html#a52f469b0182d9abac2d0f20548680c9c">$line</a>) {
<a name="l01175"></a>01175                                         <span class="keywordflow">if</span> (ereg(<span class="stringliteral">&#39;^[\+\-]([a-z\-]+) &#39;</span>, trim($line), $matches)) {
<a name="l01176"></a>01176                                                 $IMoptions[$matches[1]] = <span class="keyword">true</span>;
<a name="l01177"></a>01177                                         }
<a name="l01178"></a>01178                                 }
<a name="l01179"></a>01179                         }
<a name="l01180"></a>01180                 }
<a name="l01181"></a>01181                 <span class="keywordflow">if</span> (is_array($switchname)) {
<a name="l01182"></a>01182                         $allOK = <span class="keyword">true</span>;
<a name="l01183"></a>01183                         <span class="keywordflow">foreach</span> ($switchname as $key =&gt; $value) {
<a name="l01184"></a>01184                                 <span class="keywordflow">if</span> (!isset($IMoptions[$value])) {
<a name="l01185"></a>01185                                         $allOK = <span class="keyword">false</span>;
<a name="l01186"></a>01186                                         <span class="keywordflow">break</span>;
<a name="l01187"></a>01187                                 }
<a name="l01188"></a>01188                         }
<a name="l01189"></a>01189                         $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;ImageMagickSwitchAvailable(&#39;</span>.implode(<span class="charliteral">&#39;;&#39;</span>, $switchname).<span class="stringliteral">&#39;) = &#39;</span>.intval($allOK).<span class="stringliteral">&#39;&#39;</span>, __FILE__, __LINE__);
<a name="l01190"></a>01190                 } <span class="keywordflow">else</span> {
<a name="l01191"></a>01191                         $allOK = isset($IMoptions[$switchname]);
<a name="l01192"></a>01192                         $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;ImageMagickSwitchAvailable(&#39;</span>.$switchname.<span class="stringliteral">&#39;) = &#39;</span>.intval($allOK).<span class="stringliteral">&#39;&#39;</span>, __FILE__, __LINE__);
<a name="l01193"></a>01193                 }
<a name="l01194"></a>01194                 <span class="keywordflow">return</span> $allOK;
<a name="l01195"></a>01195         }
<a name="l01196"></a>01196 
<a name="l01197"></a><a class="code" href="classphpthumb.html#a67d822f0863cd93a7df4fa1c4b2daecd">01197</a>         <span class="keyword">function</span> <a class="code" href="classphpthumb.html#a67d822f0863cd93a7df4fa1c4b2daecd">ImageMagickFormatsList</a>() {
<a name="l01198"></a>01198                 <span class="keyword">static</span> $IMformatsList = null;
<a name="l01199"></a>01199                 <span class="keywordflow">if</span> (is_null($IMformatsList)) {
<a name="l01200"></a>01200                         $IMformatsList = <span class="stringliteral">&#39;&#39;</span>;
<a name="l01201"></a>01201                         $commandline = $this-&gt;<a class="code" href="classphpthumb.html#a91b6f226a6cecb13d3084fe066277fcd">ImageMagickCommandlineBase</a>();
<a name="l01202"></a>01202                         <span class="keywordflow">if</span> (!is_null($commandline)) {
<a name="l01203"></a>01203                                 $commandline = dirname($commandline).DIRECTORY_SEPARATOR.str_replace(<span class="stringliteral">&#39;convert&#39;</span>, <span class="stringliteral">&#39;identify&#39;</span>, basename($commandline));
<a name="l01204"></a>01204                                 $commandline .= <span class="stringliteral">&#39; -list format&#39;</span>;
<a name="l01205"></a>01205                                 $IMformatsList = <a class="code" href="classphpthumb__functions.html#a32ab9bd049bb6b7e0352329726a0ab51">phpthumb_functions::SafeExec</a>($commandline);
<a name="l01206"></a>01206                         }
<a name="l01207"></a>01207                 }
<a name="l01208"></a>01208                 <span class="keywordflow">return</span> $IMformatsList;
<a name="l01209"></a>01209         }
<a name="l01210"></a>01210 
<a name="l01211"></a><a class="code" href="classphpthumb.html#a09b35415a9d4a96970b13e5c29c841f0">01211</a>         <span class="keyword">function</span> <a class="code" href="classphpthumb.html#a09b35415a9d4a96970b13e5c29c841f0">SourceDataToTempFile</a>() {
<a name="l01212"></a>01212                 <span class="keywordflow">if</span> ($IMtempSourceFilename = $this-&gt;<a class="code" href="classphpthumb.html#ad1351cd5e7f10718ff06ae752d23349c">phpThumb_tempnam</a>()) {
<a name="l01213"></a>01213                         $IMtempSourceFilename = realpath($IMtempSourceFilename);
<a name="l01214"></a>01214                         ob_start();
<a name="l01215"></a>01215                         $fp_tempfile = fopen($IMtempSourceFilename, <span class="stringliteral">&#39;wb&#39;</span>);
<a name="l01216"></a>01216                         $tempfile_open_error  = ob_get_contents();
<a name="l01217"></a>01217                         ob_end_clean();
<a name="l01218"></a>01218                         <span class="keywordflow">if</span> ($fp_tempfile) {
<a name="l01219"></a>01219                                 fwrite($fp_tempfile, $this-&gt;<a class="code" href="php_thumb_8demo_8check_8php.html#a863670ff2c90a1dc616ebab121dbb296">rawImageData</a>);
<a name="l01220"></a>01220                                 fclose($fp_tempfile);
<a name="l01221"></a>01221                                 $this-&gt;sourceFilename = $IMtempSourceFilename;
<a name="l01222"></a>01222                                 $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;ImageMagickThumbnailToGD() setting $this-&gt;sourceFilename to &quot;&#39;</span>.$IMtempSourceFilename.<span class="stringliteral">&#39;&quot; from $this-&gt;rawImageData (&#39;</span>.strlen($this-&gt;<a class="code" href="php_thumb_8demo_8check_8php.html#a863670ff2c90a1dc616ebab121dbb296">rawImageData</a>).<span class="stringliteral">&#39; bytes)&#39;</span>, __FILE__, __LINE__);
<a name="l01223"></a>01223                         } <span class="keywordflow">else</span> {
<a name="l01224"></a>01224                                 $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;ImageMagickThumbnailToGD() FAILED setting $this-&gt;sourceFilename to &quot;&#39;</span>.$IMtempSourceFilename.<span class="stringliteral">&#39;&quot; (failed to open for writing: &quot;&#39;</span>.$tempfile_open_error.<span class="stringliteral">&#39;&quot;)&#39;</span>, __FILE__, __LINE__);
<a name="l01225"></a>01225                         }
<a name="l01226"></a>01226                         unset($tempfile_open_error, $IMtempSourceFilename);
<a name="l01227"></a>01227                         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l01228"></a>01228                 }
<a name="l01229"></a>01229                 $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;SourceDataToTempFile() FAILED because $this-&gt;phpThumb_tempnam() failed&#39;</span>, __FILE__, __LINE__);
<a name="l01230"></a>01230                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01231"></a>01231         }
<a name="l01232"></a>01232 
<a name="l01233"></a><a class="code" href="classphpthumb.html#a98b7a1c7536cc9dce401ae3d86ac26fc">01233</a>         <span class="keyword">function</span> <a class="code" href="classphpthumb.html#a98b7a1c7536cc9dce401ae3d86ac26fc">ImageMagickThumbnailToGD</a>() {
<a name="l01234"></a>01234                 <span class="comment">// http://www.imagemagick.org/script/command-line-options.php</span>
<a name="l01235"></a>01235 
<a name="l01236"></a>01236                 $this-&gt;useRawIMoutput = <span class="keyword">true</span>;
<a name="l01237"></a>01237                 <span class="keywordflow">if</span> (<a class="code" href="classphpthumb__functions.html#aaaad487d4c5a61befc88ae061f8a64fe">phpthumb_functions::gd_version</a>()) {
<a name="l01238"></a>01238                         <span class="comment">// if GD is not available, must use whatever ImageMagick can output</span>
<a name="l01239"></a>01239 
<a name="l01240"></a>01240                         <span class="comment">// $UnAllowedParameters contains options that can only be processed in GD, not ImageMagick</span>
<a name="l01241"></a>01241                         <span class="comment">// note: &#39;fltr&#39; *may* need to be processed by GD, but we&#39;ll check that in more detail below</span>
<a name="l01242"></a>01242                         $UnAllowedParameters = array(<span class="stringliteral">&#39;xto&#39;</span>, <span class="stringliteral">&#39;ar&#39;</span>, <span class="stringliteral">&#39;bg&#39;</span>, <span class="stringliteral">&#39;bc&#39;</span>);
<a name="l01243"></a>01243                         <span class="comment">// &#39;ra&#39; may be part of this list, if not a multiple of 90</span>
<a name="l01244"></a>01244                         <span class="keywordflow">foreach</span> ($UnAllowedParameters as $parameter) {
<a name="l01245"></a>01245                                 <span class="keywordflow">if</span> (isset($this-&gt;$parameter)) {
<a name="l01246"></a>01246                                         $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;$this-&gt;useRawIMoutput=false because &quot;&#39;</span>.$parameter.<span class="stringliteral">&#39;&quot; is set&#39;</span>, __FILE__, __LINE__);
<a name="l01247"></a>01247                                         $this-&gt;useRawIMoutput = <span class="keyword">false</span>;
<a name="l01248"></a>01248                                         <span class="keywordflow">break</span>;
<a name="l01249"></a>01249                                 }
<a name="l01250"></a>01250                         }
<a name="l01251"></a>01251                 }
<a name="l01252"></a>01252                 $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;$this-&gt;useRawIMoutput=&#39;</span>.($this-&gt;useRawIMoutput ? <span class="stringliteral">&#39;true&#39;</span> : <span class="stringliteral">&#39;false&#39;</span>).<span class="stringliteral">&#39; after checking $UnAllowedParameters&#39;</span>, __FILE__, __LINE__);
<a name="l01253"></a>01253                 $outputFormat = $this-&gt;thumbnailFormat;
<a name="l01254"></a>01254                 <span class="keywordflow">if</span> (<a class="code" href="classphpthumb__functions.html#aaaad487d4c5a61befc88ae061f8a64fe">phpthumb_functions::gd_version</a>()) {
<a name="l01255"></a>01255                         <span class="keywordflow">if</span> ($this-&gt;useRawIMoutput) {
<a name="l01256"></a>01256                                 <span class="keywordflow">switch</span> ($this-&gt;thumbnailFormat) {
<a name="l01257"></a>01257                                         <span class="keywordflow">case</span> <span class="stringliteral">&#39;gif&#39;</span>:
<a name="l01258"></a>01258                                                 $ImageCreateFunction = <span class="stringliteral">&#39;ImageCreateFromGIF&#39;</span>;
<a name="l01259"></a>01259                                                 $this-&gt;is_alpha = <span class="keyword">true</span>;
<a name="l01260"></a>01260                                                 <span class="keywordflow">break</span>;
<a name="l01261"></a>01261                                         <span class="keywordflow">case</span> <span class="stringliteral">&#39;png&#39;</span>:
<a name="l01262"></a>01262                                                 $ImageCreateFunction = <span class="stringliteral">&#39;ImageCreateFromPNG&#39;</span>;
<a name="l01263"></a>01263                                                 $this-&gt;is_alpha = <span class="keyword">true</span>;
<a name="l01264"></a>01264                                                 <span class="keywordflow">break</span>;
<a name="l01265"></a>01265                                         <span class="keywordflow">case</span> <span class="stringliteral">&#39;jpg&#39;</span>:
<a name="l01266"></a>01266                                         <span class="keywordflow">case</span> <span class="stringliteral">&#39;jpeg&#39;</span>:
<a name="l01267"></a>01267                                                 $ImageCreateFunction = <span class="stringliteral">&#39;ImageCreateFromJPEG&#39;</span>;
<a name="l01268"></a>01268                                                 <span class="keywordflow">break</span>;
<a name="l01269"></a>01269                                         <span class="keywordflow">default</span>:
<a name="l01270"></a>01270                                                 $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;Forcing output to PNG because $this-&gt;thumbnailFormat (&#39;</span>.$this-&gt;thumbnailFormat.<span class="stringliteral">&#39; is not a GD-supported format)&#39;</span>, __FILE__, __LINE__);
<a name="l01271"></a>01271                                                 $outputFormat = <span class="stringliteral">&#39;png&#39;</span>;
<a name="l01272"></a>01272                                                 $ImageCreateFunction = <span class="stringliteral">&#39;ImageCreateFromPNG&#39;</span>;
<a name="l01273"></a>01273                                                 $this-&gt;is_alpha = <span class="keyword">true</span>;
<a name="l01274"></a>01274                                                 $this-&gt;useRawIMoutput = <span class="keyword">false</span>;
<a name="l01275"></a>01275                                                 <span class="keywordflow">break</span>;
<a name="l01276"></a>01276                                 }
<a name="l01277"></a>01277                                 <span class="keywordflow">if</span> (!function_exists(@$ImageCreateFunction)) {
<a name="l01278"></a>01278                                         <span class="comment">// ImageMagickThumbnailToGD() depends on ImageCreateFromPNG/ImageCreateFromGIF</span>
<a name="l01279"></a>01279                                         <span class="comment">//$this-&gt;DebugMessage(&#39;ImageMagickThumbnailToGD() aborting because &#39;.@$ImageCreateFunction.&#39;() is not available&#39;, __FILE__, __LINE__);</span>
<a name="l01280"></a>01280                                         $this-&gt;useRawIMoutput = <span class="keyword">true</span>;
<a name="l01281"></a>01281                                         <span class="comment">//return false;</span>
<a name="l01282"></a>01282                                 }
<a name="l01283"></a>01283                         } <span class="keywordflow">else</span> {
<a name="l01284"></a>01284                                 $outputFormat = <span class="stringliteral">&#39;png&#39;</span>;
<a name="l01285"></a>01285                                 $ImageCreateFunction = <span class="stringliteral">&#39;ImageCreateFromPNG&#39;</span>;
<a name="l01286"></a>01286                                 $this-&gt;is_alpha = <span class="keyword">true</span>;
<a name="l01287"></a>01287                                 $this-&gt;useRawIMoutput = <span class="keyword">false</span>;
<a name="l01288"></a>01288                         }
<a name="l01289"></a>01289                 }
<a name="l01290"></a>01290 
<a name="l01291"></a>01291                 <span class="keywordflow">if</span> (!$this-&gt;sourceFilename &amp;&amp; $this-&gt;<a class="code" href="php_thumb_8demo_8check_8php.html#a863670ff2c90a1dc616ebab121dbb296">rawImageData</a>) {
<a name="l01292"></a>01292                         !$this-&gt;<a class="code" href="classphpthumb.html#a09b35415a9d4a96970b13e5c29c841f0">SourceDataToTempFile</a>();
<a name="l01293"></a>01293                 }
<a name="l01294"></a>01294                 <span class="keywordflow">if</span> (!$this-&gt;sourceFilename) {
<a name="l01295"></a>01295                         $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;ImageMagickThumbnailToGD() aborting because $this-&gt;sourceFilename is empty&#39;</span>, __FILE__, __LINE__);
<a name="l01296"></a>01296                         $this-&gt;useRawIMoutput = <span class="keyword">false</span>;
<a name="l01297"></a>01297                         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01298"></a>01298                 }
<a name="l01299"></a>01299 
<a name="l01300"></a>01300                 $commandline = $this-&gt;<a class="code" href="classphpthumb.html#a91b6f226a6cecb13d3084fe066277fcd">ImageMagickCommandlineBase</a>();
<a name="l01301"></a>01301                 <span class="keywordflow">if</span> ($commandline) {
<a name="l01302"></a>01302                         <span class="keywordflow">if</span> ($IMtempfilename = $this-&gt;<a class="code" href="classphpthumb.html#ad1351cd5e7f10718ff06ae752d23349c">phpThumb_tempnam</a>()) {
<a name="l01303"></a>01303                                 $IMtempfilename = realpath($IMtempfilename);
<a name="l01304"></a>01304 
<a name="l01305"></a>01305                                 $IMuseExplicitImageOutputDimensions = <span class="keyword">false</span>;
<a name="l01306"></a>01306                                 <span class="keywordflow">if</span> ($this-&gt;<a class="code" href="classphpthumb.html#a1f5c8fccd6c88c41d3978a7e5ba1f02f">ImageMagickSwitchAvailable</a>(<span class="stringliteral">&#39;thumbnail&#39;</span>) &amp;&amp; $this-&gt;config_imagemagick_use_thumbnail) {
<a name="l01307"></a>01307                                         $IMresizeParameter = <span class="stringliteral">&#39;thumbnail&#39;</span>;
<a name="l01308"></a>01308                                 } <span class="keywordflow">else</span> {
<a name="l01309"></a>01309                                         $IMresizeParameter = <span class="stringliteral">&#39;resize&#39;</span>;
<a name="l01310"></a>01310 
<a name="l01311"></a>01311                                         <span class="comment">// some (older? around 2002) versions of IM won&#39;t accept &quot;-resize 100x&quot; but require &quot;-resize 100x100&quot;</span>
<a name="l01312"></a>01312                                         $commandline_test = $this-&gt;<a class="code" href="classphpthumb.html#a91b6f226a6cecb13d3084fe066277fcd">ImageMagickCommandlineBase</a>().<span class="stringliteral">&#39; logo: -resize 1x &quot;&#39;</span>.$IMtempfilename.<span class="stringliteral">&#39;&quot; 2&gt;&amp;1&#39;</span>;
<a name="l01313"></a>01313                                         $IMresult_test = <a class="code" href="classphpthumb__functions.html#a32ab9bd049bb6b7e0352329726a0ab51">phpthumb_functions::SafeExec</a>($commandline_test);
<a name="l01314"></a>01314                                         $IMuseExplicitImageOutputDimensions = eregi(<span class="stringliteral">&#39;image dimensions are zero&#39;</span>, $IMresult_test);
<a name="l01315"></a>01315                                         $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;IMuseExplicitImageOutputDimensions = &#39;</span>.intval($IMuseExplicitImageOutputDimensions), __FILE__, __LINE__);
<a name="l01316"></a>01316                                         <span class="keywordflow">if</span> ($fp_im_temp = @fopen($IMtempfilename, <span class="stringliteral">&#39;wb&#39;</span>)) {
<a name="l01317"></a>01317                                                 <span class="comment">// erase temp image so ImageMagick logo doesn&#39;t get output if other processing fails</span>
<a name="l01318"></a>01318                                                 fclose($fp_im_temp);
<a name="l01319"></a>01319                                         }
<a name="l01320"></a>01320                                 }
<a name="l01321"></a>01321 
<a name="l01322"></a>01322 
<a name="l01323"></a>01323                                 <span class="keywordflow">if</span> (!is_null($this-&gt;dpi) &amp;&amp; $this-&gt;<a class="code" href="classphpthumb.html#a1f5c8fccd6c88c41d3978a7e5ba1f02f">ImageMagickSwitchAvailable</a>(<span class="stringliteral">&#39;density&#39;</span>)) {
<a name="l01324"></a>01324                                         <span class="comment">// for raster source formats only (WMF, PDF, etc)</span>
<a name="l01325"></a>01325                                         $commandline .= <span class="stringliteral">&#39; -density &#39;</span>.$this-&gt;dpi;
<a name="l01326"></a>01326                                 }
<a name="l01327"></a>01327                                 ob_start();
<a name="l01328"></a>01328                                 $getimagesize = GetImageSize($this-&gt;sourceFilename);
<a name="l01329"></a>01329                                 $GetImageSizeError = ob_get_contents();
<a name="l01330"></a>01330                                 ob_end_clean();
<a name="l01331"></a>01331                                 <span class="keywordflow">if</span> (is_array($getimagesize)) {
<a name="l01332"></a>01332                                         $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;GetImageSize(&#39;</span>.$this-&gt;sourceFilename.<span class="stringliteral">&#39;) SUCCEEDED: &#39;</span>.print_r($getimagesize, <span class="keyword">true</span>), __FILE__, __LINE__);
<a name="l01333"></a>01333                                 } <span class="keywordflow">else</span> {
<a name="l01334"></a>01334                                         $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;GetImageSize(&#39;</span>.$this-&gt;sourceFilename.<span class="stringliteral">&#39;) FAILED with error &quot;&#39;</span>.$GetImageSizeError.<span class="charliteral">&#39;&quot;&#39;</span>, __FILE__, __LINE__);
<a name="l01335"></a>01335                                 }
<a name="l01336"></a>01336                                 <span class="keywordflow">if</span> (is_array($getimagesize)) {
<a name="l01337"></a>01337                                         $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;GetImageSize(&#39;</span>.$this-&gt;sourceFilename.<span class="stringliteral">&#39;) returned [w=&#39;</span>.$getimagesize[0].<span class="stringliteral">&#39;;h=&#39;</span>.$getimagesize[1].<span class="stringliteral">&#39;;f=&#39;</span>.$getimagesize[2].<span class="charliteral">&#39;]&#39;</span>, __FILE__, __LINE__);
<a name="l01338"></a>01338                                         $this-&gt;source_width  = $getimagesize[0];
<a name="l01339"></a>01339                                         $this-&gt;source_height = $getimagesize[1];
<a name="l01340"></a>01340                                         $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;source dimensions set to &#39;</span>.$this-&gt;source_width.<span class="charliteral">&#39;x&#39;</span>.$this-&gt;source_height, __FILE__, __LINE__);
<a name="l01341"></a>01341                                         $this-&gt;<a class="code" href="classphpthumb.html#aad0ac1ff143b9d6bb26210c98d94a2ac">SetOrientationDependantWidthHeight</a>();
<a name="l01342"></a>01342 
<a name="l01343"></a>01343                                         <span class="keywordflow">if</span> (!eregi(<span class="charliteral">&#39;(&#39;</span>.implode(<span class="charliteral">&#39;|&#39;</span>, $this-&gt;AlphaCapableFormats).<span class="charliteral">&#39;)&#39;</span>, $outputFormat)) {
<a name="l01344"></a>01344                                                 <span class="comment">// not a transparency-capable format</span>
<a name="l01345"></a>01345                                                 $commandline .= <span class="stringliteral">&#39; -background &quot;#&#39;</span>.($this-&gt;bg ? $this-&gt;bg : <span class="stringliteral">&#39;FFFFFF&#39;</span>).<span class="charliteral">&#39;&quot;&#39;</span>;
<a name="l01346"></a>01346                                                 <span class="keywordflow">if</span> ($getimagesize[2] == 1) {
<a name="l01347"></a>01347                                                         <span class="comment">// GIF</span>
<a name="l01348"></a>01348                                                         $commandline .= <span class="stringliteral">&#39; -flatten&#39;</span>;
<a name="l01349"></a>01349                                                 }
<a name="l01350"></a>01350                                         }
<a name="l01351"></a>01351                                         <span class="keywordflow">if</span> ($getimagesize[2] == 1) {
<a name="l01352"></a>01352                                                 <span class="comment">// GIF</span>
<a name="l01353"></a>01353                                                 $commandline .= <span class="stringliteral">&#39; -coalesce&#39;</span>; <span class="comment">// may be needed for animated GIFs</span>
<a name="l01354"></a>01354                                         }
<a name="l01355"></a>01355                                         <span class="keywordflow">if</span> ($this-&gt;source_width || $this-&gt;source_height) {
<a name="l01356"></a>01356                                                 <span class="keywordflow">if</span> ($this-&gt;zc) {
<a name="l01357"></a>01357 
<a name="l01358"></a>01358                                                         $borderThickness = 0;
<a name="l01359"></a>01359                                                         <span class="keywordflow">if</span> (!empty($this-&gt;fltr)) {
<a name="l01360"></a>01360                                                                 <span class="keywordflow">foreach</span> ($this-&gt;fltr as $key =&gt; $value) {
<a name="l01361"></a>01361                                                                         <span class="keywordflow">if</span> (ereg(<span class="stringliteral">&#39;^bord\|([0-9]+)&#39;</span>, $value, $matches)) {
<a name="l01362"></a>01362                                                                                 $borderThickness = $matches[1];
<a name="l01363"></a>01363                                                                                 <span class="keywordflow">break</span>;
<a name="l01364"></a>01364                                                                         }
<a name="l01365"></a>01365                                                                 }
<a name="l01366"></a>01366                                                         }
<a name="l01367"></a>01367                                                         $wAll = intval(max($this-&gt;w, $this-&gt;wp, $this-&gt;wl, $this-&gt;ws)) - (2 * $borderThickness);
<a name="l01368"></a>01368                                                         $hAll = intval(max($this-&gt;h, $this-&gt;hp, $this-&gt;hl, $this-&gt;hs)) - (2 * $borderThickness);
<a name="l01369"></a>01369                                                         $imAR = $this-&gt;source_width / $this-&gt;source_height;
<a name="l01370"></a>01370                                                         $zcAR = (($wAll &amp;&amp; $hAll) ? $wAll / $hAll : 1);
<a name="l01371"></a>01371                                                         $side  = <a class="code" href="classphpthumb__functions.html#a0c2feb0df02b7a87435be3645fee8224">phpthumb_functions::nonempty_min</a>($this-&gt;source_width, $this-&gt;source_height, max($wAll, $hAll));
<a name="l01372"></a>01372                                                         $sideX = <a class="code" href="classphpthumb__functions.html#a0c2feb0df02b7a87435be3645fee8224">phpthumb_functions::nonempty_min</a>($this-&gt;source_width,                       $wAll, round($hAll * $zcAR));
<a name="l01373"></a>01373                                                         $sideY = <a class="code" href="classphpthumb__functions.html#a0c2feb0df02b7a87435be3645fee8224">phpthumb_functions::nonempty_min</a>(                     $this-&gt;source_height, $hAll, round($wAll / $zcAR));
<a name="l01374"></a>01374 
<a name="l01375"></a>01375                                                         $thumbnailH = round(max($sideY, ($sideY * $zcAR) / $imAR));
<a name="l01376"></a>01376                                                         <span class="keywordflow">if</span> ($IMuseExplicitImageOutputDimensions) {
<a name="l01377"></a>01377                                                                 $commandline .= <span class="stringliteral">&#39; -&#39;</span>.$IMresizeParameter.<span class="charliteral">&#39; &#39;</span>.$thumbnailH.<span class="charliteral">&#39;x&#39;</span>.$thumbnailH;
<a name="l01378"></a>01378                                                         } <span class="keywordflow">else</span> {
<a name="l01379"></a>01379                                                                 $commandline .= <span class="stringliteral">&#39; -&#39;</span>.$IMresizeParameter.<span class="stringliteral">&#39; x&#39;</span>.$thumbnailH;
<a name="l01380"></a>01380                                                         }
<a name="l01381"></a>01381 
<a name="l01382"></a>01382                                                         <span class="keywordflow">switch</span> (strtoupper($this-&gt;zc)) {
<a name="l01383"></a>01383                                                                 <span class="keywordflow">case</span> <span class="charliteral">&#39;T&#39;</span>:
<a name="l01384"></a>01384                                                                         $commandline .= <span class="stringliteral">&#39; -gravity north&#39;</span>;
<a name="l01385"></a>01385                                                                         <span class="keywordflow">break</span>;
<a name="l01386"></a>01386                                                                 <span class="keywordflow">case</span> <span class="charliteral">&#39;B&#39;</span>:
<a name="l01387"></a>01387                                                                         $commandline .= <span class="stringliteral">&#39; -gravity south&#39;</span>;
<a name="l01388"></a>01388                                                                         <span class="keywordflow">break</span>;
<a name="l01389"></a>01389                                                                 <span class="keywordflow">case</span> <span class="charliteral">&#39;L&#39;</span>:
<a name="l01390"></a>01390                                                                         $commandline .= <span class="stringliteral">&#39; -gravity west&#39;</span>;
<a name="l01391"></a>01391                                                                         <span class="keywordflow">break</span>;
<a name="l01392"></a>01392                                                                 <span class="keywordflow">case</span> <span class="charliteral">&#39;R&#39;</span>:
<a name="l01393"></a>01393                                                                         $commandline .= <span class="stringliteral">&#39; -gravity east&#39;</span>;
<a name="l01394"></a>01394                                                                         <span class="keywordflow">break</span>;
<a name="l01395"></a>01395                                                                 <span class="keywordflow">case</span> <span class="stringliteral">&#39;TL&#39;</span>:
<a name="l01396"></a>01396                                                                         $commandline .= <span class="stringliteral">&#39; -gravity northwest&#39;</span>;
<a name="l01397"></a>01397                                                                         <span class="keywordflow">break</span>;
<a name="l01398"></a>01398                                                                 <span class="keywordflow">case</span> <span class="stringliteral">&#39;TR&#39;</span>:
<a name="l01399"></a>01399                                                                         $commandline .= <span class="stringliteral">&#39; -gravity northeast&#39;</span>;
<a name="l01400"></a>01400                                                                         <span class="keywordflow">break</span>;
<a name="l01401"></a>01401                                                                 <span class="keywordflow">case</span> <span class="stringliteral">&#39;BL&#39;</span>:
<a name="l01402"></a>01402                                                                         $commandline .= <span class="stringliteral">&#39; -gravity southwest&#39;</span>;
<a name="l01403"></a>01403                                                                         <span class="keywordflow">break</span>;
<a name="l01404"></a>01404                                                                 <span class="keywordflow">case</span> <span class="stringliteral">&#39;BR&#39;</span>:
<a name="l01405"></a>01405                                                                         $commandline .= <span class="stringliteral">&#39; -gravity southeast&#39;</span>;
<a name="l01406"></a>01406                                                                         <span class="keywordflow">break</span>;
<a name="l01407"></a>01407                                                                 <span class="keywordflow">case</span> <span class="charliteral">&#39;1&#39;</span>:
<a name="l01408"></a>01408                                                                 <span class="keywordflow">case</span> <span class="charliteral">&#39;C&#39;</span>:
<a name="l01409"></a>01409                                                                 <span class="keywordflow">default</span>:
<a name="l01410"></a>01410                                                                         $commandline .= <span class="stringliteral">&#39; -gravity center&#39;</span>;
<a name="l01411"></a>01411                                                                         <span class="keywordflow">break</span>;
<a name="l01412"></a>01412                                                         }
<a name="l01413"></a>01413 
<a name="l01414"></a>01414                                                         <span class="keywordflow">if</span> (($wAll &gt; 0) &amp;&amp; ($hAll &gt; 0)) {
<a name="l01415"></a>01415                                                                 $commandline .= <span class="stringliteral">&#39; -crop &#39;</span>.$wAll.<span class="charliteral">&#39;x&#39;</span>.$hAll.<span class="stringliteral">&#39;+0+0&#39;</span>;
<a name="l01416"></a>01416                                                         } <span class="keywordflow">else</span> {
<a name="l01417"></a>01417                                                                 $commandline .= <span class="stringliteral">&#39; -crop &#39;</span>.$side.<span class="charliteral">&#39;x&#39;</span>.$side.<span class="stringliteral">&#39;+0+0&#39;</span>;
<a name="l01418"></a>01418                                                         }
<a name="l01419"></a>01419                                                         <span class="keywordflow">if</span> ($this-&gt;<a class="code" href="classphpthumb.html#a1f5c8fccd6c88c41d3978a7e5ba1f02f">ImageMagickSwitchAvailable</a>(<span class="stringliteral">&#39;repage&#39;</span>)) {
<a name="l01420"></a>01420                                                                 $commandline .= <span class="stringliteral">&#39; +repage&#39;</span>;
<a name="l01421"></a>01421                                                         } <span class="keywordflow">else</span> {
<a name="l01422"></a>01422                                                                 $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;Skipping &quot;+repage&quot; because ImageMagick (v&#39;</span>.$this-&gt;<a class="code" href="classphpthumb.html#a62b9ce7ae0bbe8bdef4820ba9f60c289">ImageMagickVersion</a>().<span class="stringliteral">&#39;) does not support it&#39;</span>, __FILE__, __LINE__);
<a name="l01423"></a>01423                                                         }
<a name="l01424"></a>01424 
<a name="l01425"></a>01425                                                 } <a class="code" href="php_thumb_8demo_8check_8php.html#af92779326267616cd7c3cdaaa9484bc9">elseif</a> ($this-&gt;sw || $this-&gt;sh || $this-&gt;sx || $this-&gt;sy) {
<a name="l01426"></a>01426 
<a name="l01427"></a>01427                                                         $commandline .= <span class="stringliteral">&#39; -crop &#39;</span>.($this-&gt;sw ? $this-&gt;sw : $this-&gt;source_width).<span class="charliteral">&#39;x&#39;</span>.($this-&gt;sh ? $this-&gt;sh : $this-&gt;source_height).<span class="charliteral">&#39;+&#39;</span>.$this-&gt;sx.<span class="charliteral">&#39;+&#39;</span>.$this-&gt;sy;
<a name="l01428"></a>01428                                                         <span class="comment">// this is broken for aoe=1, but unsure how to fix. Send advice to info@silisoftware.com</span>
<a name="l01429"></a>01429                                                         <span class="keywordflow">if</span> ($this-&gt;w || $this-&gt;h) {
<a name="l01430"></a>01430                                                                 <span class="keywordflow">if</span> ($this-&gt;<a class="code" href="classphpthumb.html#a1f5c8fccd6c88c41d3978a7e5ba1f02f">ImageMagickSwitchAvailable</a>(<span class="stringliteral">&#39;repage&#39;</span>)) {
<a name="l01431"></a>01431                                                                         $commandline .= <span class="stringliteral">&#39; -repage&#39;</span>;
<a name="l01432"></a>01432                                                                 } <span class="keywordflow">else</span> {
<a name="l01433"></a>01433                                                                         $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;Skipping &quot;-repage&quot; because ImageMagick (v&#39;</span>.$this-&gt;<a class="code" href="classphpthumb.html#a62b9ce7ae0bbe8bdef4820ba9f60c289">ImageMagickVersion</a>().<span class="stringliteral">&#39;) does not support it&#39;</span>, __FILE__, __LINE__);
<a name="l01434"></a>01434                                                                 }
<a name="l01435"></a>01435                                                                 <span class="keywordflow">if</span> ($IMuseExplicitImageOutputDimensions) {
<a name="l01436"></a>01436                                                                         <span class="keywordflow">if</span> ($this-&gt;w &amp;&amp; !$this-&gt;h) {
<a name="l01437"></a>01437                                                                                 $this-&gt;h = ceil($this-&gt;w / ($this-&gt;source_width / $this-&gt;source_height));
<a name="l01438"></a>01438                                                                         } <a class="code" href="php_thumb_8demo_8check_8php.html#af92779326267616cd7c3cdaaa9484bc9">elseif</a> ($this-&gt;h &amp;&amp; !$this-&gt;w) {
<a name="l01439"></a>01439                                                                                 $this-&gt;w = ceil($this-&gt;h * ($this-&gt;source_width / $this-&gt;source_height));
<a name="l01440"></a>01440                                                                         }
<a name="l01441"></a>01441                                                                 }
<a name="l01442"></a>01442                                                                 $commandline .= <span class="stringliteral">&#39; -&#39;</span>.$IMresizeParameter.<span class="charliteral">&#39; &#39;</span>.$this-&gt;w.<span class="charliteral">&#39;x&#39;</span>.$this-&gt;h;
<a name="l01443"></a>01443                                                         }
<a name="l01444"></a>01444 
<a name="l01445"></a>01445                                                 } <span class="keywordflow">else</span> {
<a name="l01446"></a>01446 
<a name="l01447"></a>01447                                                         <span class="keywordflow">if</span> ($this-&gt;iar &amp;&amp; (intval($this-&gt;w) &gt; 0) &amp;&amp; (intval($this-&gt;h) &gt; 0)) {
<a name="l01448"></a>01448                                                                 <span class="comment">//$commandline .= &#39; -&#39;.$IMresizeParameter.&#39; &#39;.$this-&gt;w.&#39;x&#39;.$this-&gt;h.&#39;!&#39;;</span>
<a name="l01449"></a>01449                                                                 list($nw, $nh) = <a class="code" href="classphpthumb__functions.html#a9fdbba8c153ac6c99299545f0109dd70">phpthumb_functions::TranslateWHbyAngle</a>($this-&gt;w, $this-&gt;h, $this-&gt;ra);
<a name="l01450"></a>01450                                                                 $nw = ((round($nw) != 0) ? round($nw) : <span class="stringliteral">&#39;&#39;</span>);
<a name="l01451"></a>01451                                                                 $nh = ((round($nh) != 0) ? round($nh) : <span class="stringliteral">&#39;&#39;</span>);
<a name="l01452"></a>01452                                                                 $commandline .= <span class="stringliteral">&#39; -&#39;</span>.$IMresizeParameter.<span class="charliteral">&#39; &#39;</span>.$nw.<span class="charliteral">&#39;x&#39;</span>.$nh.<span class="charliteral">&#39;!&#39;</span>;
<a name="l01453"></a>01453                                                         } <span class="keywordflow">else</span> {
<a name="l01454"></a>01454                                                                 $this-&gt;w = ((($this-&gt;aoe || $this-&gt;far) &amp;&amp; $this-&gt;w) ? $this-&gt;w : ($this-&gt;w ? <a class="code" href="classphpthumb__functions.html#a0c2feb0df02b7a87435be3645fee8224">phpthumb_functions::nonempty_min</a>($this-&gt;w, $getimagesize[0]) : <span class="stringliteral">&#39;&#39;</span>));
<a name="l01455"></a>01455                                                                 $this-&gt;h = ((($this-&gt;aoe || $this-&gt;far) &amp;&amp; $this-&gt;h) ? $this-&gt;h : ($this-&gt;h ? phpthumb_functions::nonempty_min($this-&gt;h, $getimagesize[1]) : <span class="stringliteral">&#39;&#39;</span>));
<a name="l01456"></a>01456                                                                 <span class="keywordflow">if</span> ($this-&gt;w || $this-&gt;h) {
<a name="l01457"></a>01457                                                                         <span class="keywordflow">if</span> ($IMuseExplicitImageOutputDimensions) {
<a name="l01458"></a>01458                                                                                 <span class="keywordflow">if</span> ($this-&gt;w &amp;&amp; !$this-&gt;h) {
<a name="l01459"></a>01459                                                                                         $this-&gt;h = ceil($this-&gt;w / ($this-&gt;source_width / $this-&gt;source_height));
<a name="l01460"></a>01460                                                                                 } <a class="code" href="php_thumb_8demo_8check_8php.html#af92779326267616cd7c3cdaaa9484bc9">elseif</a> ($this-&gt;h &amp;&amp; !$this-&gt;w) {
<a name="l01461"></a>01461                                                                                         $this-&gt;w = ceil($this-&gt;h * ($this-&gt;source_width / $this-&gt;source_height));
<a name="l01462"></a>01462                                                                                 }
<a name="l01463"></a>01463                                                                         }
<a name="l01464"></a>01464                                                                         <span class="comment">//$commandline .= &#39; -&#39;.$IMresizeParameter.&#39; &#39;.$this-&gt;w.&#39;x&#39;.$this-&gt;h;</span>
<a name="l01465"></a>01465                                                                         list($nw, $nh) = <a class="code" href="classphpthumb__functions.html#a9fdbba8c153ac6c99299545f0109dd70">phpthumb_functions::TranslateWHbyAngle</a>($this-&gt;w, $this-&gt;h, $this-&gt;ra);
<a name="l01466"></a>01466                                                                         $nw = ((round($nw) != 0) ? round($nw) : <span class="stringliteral">&#39;&#39;</span>);
<a name="l01467"></a>01467                                                                         $nh = ((round($nh) != 0) ? round($nh) : <span class="stringliteral">&#39;&#39;</span>);
<a name="l01468"></a>01468                                                                         $commandline .= <span class="stringliteral">&#39; -&#39;</span>.$IMresizeParameter.<span class="charliteral">&#39; &#39;</span>.$nw.<span class="charliteral">&#39;x&#39;</span>.$nh;
<a name="l01469"></a>01469                                                                 }
<a name="l01470"></a>01470                                                         }
<a name="l01471"></a>01471                                                 }
<a name="l01472"></a>01472                                         }
<a name="l01473"></a>01473 
<a name="l01474"></a>01474                                 } <span class="keywordflow">else</span> {
<a name="l01475"></a>01475 
<a name="l01476"></a>01476                                         $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;GetImageSize(&#39;</span>.$this-&gt;sourceFilename.<span class="stringliteral">&#39;) failed&#39;</span>, __FILE__, __LINE__);
<a name="l01477"></a>01477                                         <span class="keywordflow">if</span> ($this-&gt;w || $this-&gt;h) {
<a name="l01478"></a>01478                                                 <span class="keywordflow">if</span> ($IMuseExplicitImageOutputDimensions) {
<a name="l01479"></a>01479                                                         <span class="comment">// unknown source aspect ration, just put large number and hope IM figures it out</span>
<a name="l01480"></a>01480                                                         $commandline .= <span class="stringliteral">&#39; -&#39;</span>.$IMresizeParameter.<span class="charliteral">&#39; &#39;</span>.($this-&gt;w ? $this-&gt;w : <span class="stringliteral">&#39;9999&#39;</span>).<span class="charliteral">&#39;x&#39;</span>.($this-&gt;h ? $this-&gt;h : <span class="stringliteral">&#39;9999&#39;</span>);
<a name="l01481"></a>01481                                                 } <span class="keywordflow">else</span> {
<a name="l01482"></a>01482                                                         $commandline .= <span class="stringliteral">&#39; -&#39;</span>.$IMresizeParameter.<span class="charliteral">&#39; &#39;</span>.$this-&gt;w.<span class="charliteral">&#39;x&#39;</span>.$this-&gt;h;
<a name="l01483"></a>01483                                                 }
<a name="l01484"></a>01484                                                 <span class="keywordflow">if</span> ($this-&gt;iar &amp;&amp; (intval($this-&gt;w) &gt; 0) &amp;&amp; (intval($this-&gt;h) &gt; 0)) {
<a name="l01485"></a>01485                                                         $commandline .= <span class="charliteral">&#39;!&#39;</span>;
<a name="l01486"></a>01486                                                 }
<a name="l01487"></a>01487                                         }
<a name="l01488"></a>01488 
<a name="l01489"></a>01489                                 }
<a name="l01490"></a>01490 
<a name="l01491"></a>01491                                 <span class="keywordflow">if</span> ($this-&gt;ra) {
<a name="l01492"></a>01492                                         $this-&gt;ra = intval($this-&gt;ra);
<a name="l01493"></a>01493                                         <span class="keywordflow">if</span> ($this-&gt;<a class="code" href="classphpthumb.html#a1f5c8fccd6c88c41d3978a7e5ba1f02f">ImageMagickSwitchAvailable</a>(<span class="stringliteral">&#39;rotate&#39;</span>)) {
<a name="l01494"></a>01494                                                 <span class="keywordflow">if</span> (!eregi(<span class="charliteral">&#39;(&#39;</span>.implode(<span class="charliteral">&#39;|&#39;</span>, $this-&gt;AlphaCapableFormats).<span class="charliteral">&#39;)&#39;</span>, $outputFormat) || <a class="code" href="classphpthumb__functions.html#af53f41b3482e6bed2082daa0ebfd96c0">phpthumb_functions::version_compare_replacement</a>($this-&gt;<a class="code" href="classphpthumb.html#a62b9ce7ae0bbe8bdef4820ba9f60c289">ImageMagickVersion</a>(), <span class="stringliteral">&#39;6.3.7&#39;</span>, <span class="stringliteral">&#39;&gt;=&#39;</span>)) {
<a name="l01495"></a>01495                                                         $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;Using ImageMagick rotate&#39;</span>, __FILE__, __LINE__);
<a name="l01496"></a>01496                                                         $commandline .= <span class="stringliteral">&#39; -rotate &#39;</span>.$this-&gt;ra;
<a name="l01497"></a>01497                                                         <span class="keywordflow">if</span> (($this-&gt;ra % 90) != 0) {
<a name="l01498"></a>01498                                                                 <span class="keywordflow">if</span> (eregi(<span class="charliteral">&#39;(&#39;</span>.implode(<span class="charliteral">&#39;|&#39;</span>, $this-&gt;AlphaCapableFormats).<span class="charliteral">&#39;)&#39;</span>, $outputFormat)) {
<a name="l01499"></a>01499                                                                         <span class="comment">// alpha-capable format</span>
<a name="l01500"></a>01500                                                                         $commandline .= <span class="stringliteral">&#39; -background rgba(255,255,255,0)&#39;</span>;
<a name="l01501"></a>01501                                                                 } <span class="keywordflow">else</span> {
<a name="l01502"></a>01502                                                                         $commandline .= <span class="stringliteral">&#39; -background &quot;#&#39;</span>.($this-&gt;bg ? $this-&gt;bg : <span class="stringliteral">&#39;FFFFFF&#39;</span>).<span class="charliteral">&#39;&quot;&#39;</span>;
<a name="l01503"></a>01503                                                                 }
<a name="l01504"></a>01504                                                         }
<a name="l01505"></a>01505                                                         $this-&gt;ra = 0;
<a name="l01506"></a>01506                                                 } <span class="keywordflow">else</span> {
<a name="l01507"></a>01507                                                         $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;Not using ImageMagick rotate because alpha background buggy before v6.3.7&#39;</span>, __FILE__, __LINE__);
<a name="l01508"></a>01508                                                 }
<a name="l01509"></a>01509                                         } <span class="keywordflow">else</span> {
<a name="l01510"></a>01510                                                 $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;Not using ImageMagick rotate because not supported&#39;</span>, __FILE__, __LINE__);
<a name="l01511"></a>01511                                         }
<a name="l01512"></a>01512                                 }
<a name="l01513"></a>01513 
<a name="l01514"></a>01514                                 $successfullyProcessedFilters = array();
<a name="l01515"></a>01515                                 <span class="keywordflow">foreach</span> ($this-&gt;fltr as $filterkey =&gt; $filtercommand) {
<a name="l01516"></a>01516                                         @list($command, $parameter) = explode(<span class="charliteral">&#39;|&#39;</span>, $filtercommand, 2);
<a name="l01517"></a>01517                                         <span class="keywordflow">switch</span> ($command) {
<a name="l01518"></a>01518                                                 <span class="keywordflow">case</span> <span class="stringliteral">&#39;brit&#39;</span>:
<a name="l01519"></a>01519                                                         <span class="keywordflow">if</span> ($this-&gt;<a class="code" href="classphpthumb.html#a1f5c8fccd6c88c41d3978a7e5ba1f02f">ImageMagickSwitchAvailable</a>(<span class="stringliteral">&#39;modulate&#39;</span>)) {
<a name="l01520"></a>01520                                                                 $commandline .= <span class="stringliteral">&#39; -modulate &#39;</span>.(100 + $parameter).<span class="stringliteral">&#39;,100,100&#39;</span>;
<a name="l01521"></a>01521                                                                 $successfullyProcessedFilters[] = $filterkey;
<a name="l01522"></a>01522                                                         }
<a name="l01523"></a>01523                                                         <span class="keywordflow">break</span>;
<a name="l01524"></a>01524 
<a name="l01525"></a>01525                                                 <span class="keywordflow">case</span> <span class="stringliteral">&#39;cont&#39;</span>:
<a name="l01526"></a>01526                                                         <span class="keywordflow">if</span> ($this-&gt;<a class="code" href="classphpthumb.html#a1f5c8fccd6c88c41d3978a7e5ba1f02f">ImageMagickSwitchAvailable</a>(<span class="stringliteral">&#39;contrast&#39;</span>)) {
<a name="l01527"></a>01527                                                                 $contDiv10 = round($parameter / 10);
<a name="l01528"></a>01528                                                                 <span class="keywordflow">if</span> ($contDiv10 &gt; 0) {
<a name="l01529"></a>01529                                                                         <span class="keywordflow">for</span> ($i = 0; $i &lt; $contDiv10; $i++) {
<a name="l01530"></a>01530                                                                                 $commandline .= <span class="stringliteral">&#39; -contrast&#39;</span>; <span class="comment">// increase contrast by 10%</span>
<a name="l01531"></a>01531                                                                         }
<a name="l01532"></a>01532                                                                 } <a class="code" href="php_thumb_8demo_8check_8php.html#af92779326267616cd7c3cdaaa9484bc9">elseif</a> ($contDiv10 &lt; 0) {
<a name="l01533"></a>01533                                                                         <span class="keywordflow">for</span> ($i = $contDiv10; $i &lt; 0; $i++) {
<a name="l01534"></a>01534                                                                                 $commandline .= <span class="stringliteral">&#39; +contrast&#39;</span>; <span class="comment">// decrease contrast by 10%</span>
<a name="l01535"></a>01535                                                                         }
<a name="l01536"></a>01536                                                                 } <span class="keywordflow">else</span> {
<a name="l01537"></a>01537                                                                         <span class="comment">// do nothing</span>
<a name="l01538"></a>01538                                                                 }
<a name="l01539"></a>01539                                                                 $successfullyProcessedFilters[] = $filterkey;
<a name="l01540"></a>01540                                                         }
<a name="l01541"></a>01541                                                         <span class="keywordflow">break</span>;
<a name="l01542"></a>01542 
<a name="l01543"></a>01543                                                 <span class="keywordflow">case</span> <span class="stringliteral">&#39;ds&#39;</span>:
<a name="l01544"></a>01544                                                         <span class="keywordflow">if</span> ($this-&gt;<a class="code" href="classphpthumb.html#a1f5c8fccd6c88c41d3978a7e5ba1f02f">ImageMagickSwitchAvailable</a>(array(<span class="stringliteral">&#39;colorspace&#39;</span>, <span class="stringliteral">&#39;modulate&#39;</span>))) {
<a name="l01545"></a>01545                                                                 <span class="keywordflow">if</span> ($parameter == 100) {
<a name="l01546"></a>01546                                                                         $commandline .= <span class="stringliteral">&#39; -colorspace GRAY -modulate 100,0,100&#39;</span>;
<a name="l01547"></a>01547                                                                 } <span class="keywordflow">else</span> {
<a name="l01548"></a>01548                                                                         $commandline .= <span class="stringliteral">&#39; -modulate 100,&#39;</span>.(100 - $parameter).<span class="stringliteral">&#39;,100&#39;</span>;
<a name="l01549"></a>01549                                                                 }
<a name="l01550"></a>01550                                                                 $successfullyProcessedFilters[] = $filterkey;
<a name="l01551"></a>01551                                                         }
<a name="l01552"></a>01552                                                         <span class="keywordflow">break</span>;
<a name="l01553"></a>01553 
<a name="l01554"></a>01554                                                 <span class="keywordflow">case</span> <span class="stringliteral">&#39;sat&#39;</span>:
<a name="l01555"></a>01555                                                         <span class="keywordflow">if</span> ($this-&gt;<a class="code" href="classphpthumb.html#a1f5c8fccd6c88c41d3978a7e5ba1f02f">ImageMagickSwitchAvailable</a>(array(<span class="stringliteral">&#39;colorspace&#39;</span>, <span class="stringliteral">&#39;modulate&#39;</span>))) {
<a name="l01556"></a>01556                                                                 <span class="keywordflow">if</span> ($parameter == -100) {
<a name="l01557"></a>01557                                                                         $commandline .= <span class="stringliteral">&#39; -colorspace GRAY -modulate 100,0,100&#39;</span>;
<a name="l01558"></a>01558                                                                 } <span class="keywordflow">else</span> {
<a name="l01559"></a>01559                                                                         $commandline .= <span class="stringliteral">&#39; -modulate 100,&#39;</span>.(100 + $parameter).<span class="stringliteral">&#39;,100&#39;</span>;
<a name="l01560"></a>01560                                                                 }
<a name="l01561"></a>01561                                                                 $successfullyProcessedFilters[] = $filterkey;
<a name="l01562"></a>01562                                                         }
<a name="l01563"></a>01563                                                         <span class="keywordflow">break</span>;
<a name="l01564"></a>01564 
<a name="l01565"></a>01565                                                 <span class="keywordflow">case</span> <span class="stringliteral">&#39;gray&#39;</span>:
<a name="l01566"></a>01566                                                         <span class="keywordflow">if</span> ($this-&gt;<a class="code" href="classphpthumb.html#a1f5c8fccd6c88c41d3978a7e5ba1f02f">ImageMagickSwitchAvailable</a>(array(<span class="stringliteral">&#39;colorspace&#39;</span>, <span class="stringliteral">&#39;modulate&#39;</span>))) {
<a name="l01567"></a>01567                                                                 $commandline .= <span class="stringliteral">&#39; -colorspace GRAY -modulate 100,0,100&#39;</span>;
<a name="l01568"></a>01568                                                                 <span class="comment">//$commandline .= &#39; -colorspace GRAY&#39;;</span>
<a name="l01569"></a>01569                                                                 $successfullyProcessedFilters[] = $filterkey;
<a name="l01570"></a>01570                                                         }
<a name="l01571"></a>01571                                                         <span class="keywordflow">break</span>;
<a name="l01572"></a>01572 
<a name="l01573"></a>01573                                                 <span class="keywordflow">case</span> <span class="stringliteral">&#39;clr&#39;</span>:
<a name="l01574"></a>01574                                                         <span class="keywordflow">if</span> ($this-&gt;<a class="code" href="classphpthumb.html#a1f5c8fccd6c88c41d3978a7e5ba1f02f">ImageMagickSwitchAvailable</a>(array(<span class="stringliteral">&#39;fill&#39;</span>, <span class="stringliteral">&#39;colorize&#39;</span>))) {
<a name="l01575"></a>01575                                                                 @list($amount, $color) = explode(<span class="charliteral">&#39;|&#39;</span>, $parameter);
<a name="l01576"></a>01576                                                                 $commandline .= <span class="stringliteral">&#39; -fill &quot;#&#39;</span>.$color.<span class="stringliteral">&#39;&quot; -colorize &#39;</span>.$amount;
<a name="l01577"></a>01577                                                         }
<a name="l01578"></a>01578                                                         <span class="keywordflow">break</span>;
<a name="l01579"></a>01579 
<a name="l01580"></a>01580                                                 <span class="keywordflow">case</span> <span class="stringliteral">&#39;sep&#39;</span>:
<a name="l01581"></a>01581                                                         <span class="keywordflow">if</span> ($this-&gt;<a class="code" href="classphpthumb.html#a1f5c8fccd6c88c41d3978a7e5ba1f02f">ImageMagickSwitchAvailable</a>(<span class="stringliteral">&#39;sepia-tone&#39;</span>)) {
<a name="l01582"></a>01582                                                                 @list($amount, $color) = explode(<span class="charliteral">&#39;|&#39;</span>, $parameter);
<a name="l01583"></a>01583                                                                 $amount = ($amount ? $amount : 80);
<a name="l01584"></a>01584                                                                 <span class="keywordflow">if</span> (!$color) {
<a name="l01585"></a>01585                                                                         $commandline .= <span class="stringliteral">&#39; -sepia-tone &#39;</span>.$amount.<span class="charliteral">&#39;%&#39;</span>;
<a name="l01586"></a>01586                                                                         $successfullyProcessedFilters[] = $filterkey;
<a name="l01587"></a>01587                                                                 }
<a name="l01588"></a>01588                                                         }
<a name="l01589"></a>01589                                                         <span class="keywordflow">break</span>;
<a name="l01590"></a>01590 
<a name="l01591"></a>01591                                                 <span class="keywordflow">case</span> <span class="stringliteral">&#39;gam&#39;</span>:
<a name="l01592"></a>01592                                                         <span class="keywordflow">if</span> ($this-&gt;<a class="code" href="classphpthumb.html#a1f5c8fccd6c88c41d3978a7e5ba1f02f">ImageMagickSwitchAvailable</a>(<span class="stringliteral">&#39;gamma&#39;</span>)) {
<a name="l01593"></a>01593                                                                 $commandline .= <span class="stringliteral">&#39; -gamma &#39;</span>.$parameter;
<a name="l01594"></a>01594                                                                 $successfullyProcessedFilters[] = $filterkey;
<a name="l01595"></a>01595                                                         }
<a name="l01596"></a>01596                                                         <span class="keywordflow">break</span>;
<a name="l01597"></a>01597 
<a name="l01598"></a>01598                                                 <span class="keywordflow">case</span> <span class="stringliteral">&#39;neg&#39;</span>:
<a name="l01599"></a>01599                                                         <span class="keywordflow">if</span> ($this-&gt;<a class="code" href="classphpthumb.html#a1f5c8fccd6c88c41d3978a7e5ba1f02f">ImageMagickSwitchAvailable</a>(<span class="stringliteral">&#39;negate&#39;</span>)) {
<a name="l01600"></a>01600                                                                 $commandline .= <span class="stringliteral">&#39; -negate&#39;</span>;
<a name="l01601"></a>01601                                                                 $successfullyProcessedFilters[] = $filterkey;
<a name="l01602"></a>01602                                                         }
<a name="l01603"></a>01603                                                         <span class="keywordflow">break</span>;
<a name="l01604"></a>01604 
<a name="l01605"></a>01605                                                 <span class="keywordflow">case</span> <span class="stringliteral">&#39;th&#39;</span>:
<a name="l01606"></a>01606                                                         <span class="keywordflow">if</span> ($this-&gt;<a class="code" href="classphpthumb.html#a1f5c8fccd6c88c41d3978a7e5ba1f02f">ImageMagickSwitchAvailable</a>(array(<span class="stringliteral">&#39;threshold&#39;</span>, <span class="stringliteral">&#39;dither&#39;</span>, <span class="stringliteral">&#39;monochrome&#39;</span>))) {
<a name="l01607"></a>01607                                                                 $commandline .= <span class="stringliteral">&#39; -threshold &#39;</span>.round($parameter / 2.55).<span class="stringliteral">&#39;% -dither -monochrome&#39;</span>;
<a name="l01608"></a>01608                                                                 $successfullyProcessedFilters[] = $filterkey;
<a name="l01609"></a>01609                                                         }
<a name="l01610"></a>01610                                                         <span class="keywordflow">break</span>;
<a name="l01611"></a>01611 
<a name="l01612"></a>01612                                                 <span class="keywordflow">case</span> <span class="stringliteral">&#39;rcd&#39;</span>:
<a name="l01613"></a>01613                                                         <span class="keywordflow">if</span> ($this-&gt;<a class="code" href="classphpthumb.html#a1f5c8fccd6c88c41d3978a7e5ba1f02f">ImageMagickSwitchAvailable</a>(array(<span class="stringliteral">&#39;colors&#39;</span>, <span class="stringliteral">&#39;dither&#39;</span>))) {
<a name="l01614"></a>01614                                                                 @list($colors, $dither) = explode(<span class="charliteral">&#39;|&#39;</span>, $parameter);
<a name="l01615"></a>01615                                                                 $colors = ($colors                ?  (int) $colors : 256);
<a name="l01616"></a>01616                                                                 $dither  = ((strlen($dither) &gt; 0) ? (<span class="keywordtype">bool</span>) $dither : <span class="keyword">true</span>);
<a name="l01617"></a>01617                                                                 $commandline .= <span class="stringliteral">&#39; -colors &#39;</span>.max($colors, 8); <span class="comment">// ImageMagick will otherwise fail with &quot;cannot quantize to fewer than 8 colors&quot;</span>
<a name="l01618"></a>01618                                                                 $commandline .= ($dither ? <span class="stringliteral">&#39; -dither&#39;</span> : <span class="stringliteral">&#39; +dither&#39;</span>);
<a name="l01619"></a>01619                                                                 $successfullyProcessedFilters[] = $filterkey;
<a name="l01620"></a>01620                                                         }
<a name="l01621"></a>01621                                                         <span class="keywordflow">break</span>;
<a name="l01622"></a>01622 
<a name="l01623"></a>01623                                                 <span class="keywordflow">case</span> <span class="stringliteral">&#39;flip&#39;</span>:
<a name="l01624"></a>01624                                                         <span class="keywordflow">if</span> ($this-&gt;<a class="code" href="classphpthumb.html#a1f5c8fccd6c88c41d3978a7e5ba1f02f">ImageMagickSwitchAvailable</a>(array(<span class="stringliteral">&#39;flip&#39;</span>, <span class="stringliteral">&#39;flop&#39;</span>))) {
<a name="l01625"></a>01625                                                                 <span class="keywordflow">if</span> (strpos(strtolower($parameter), <span class="charliteral">&#39;x&#39;</span>) !== <span class="keyword">false</span>) {
<a name="l01626"></a>01626                                                                         $commandline .= <span class="stringliteral">&#39; -flop&#39;</span>;
<a name="l01627"></a>01627                                                                 }
<a name="l01628"></a>01628                                                                 <span class="keywordflow">if</span> (strpos(strtolower($parameter), <span class="charliteral">&#39;y&#39;</span>) !== <span class="keyword">false</span>) {
<a name="l01629"></a>01629                                                                         $commandline .= <span class="stringliteral">&#39; -flip&#39;</span>;
<a name="l01630"></a>01630                                                                 }
<a name="l01631"></a>01631                                                                 $successfullyProcessedFilters[] = $filterkey;
<a name="l01632"></a>01632                                                         }
<a name="l01633"></a>01633                                                         <span class="keywordflow">break</span>;
<a name="l01634"></a>01634 
<a name="l01635"></a>01635                                                 <span class="keywordflow">case</span> <span class="stringliteral">&#39;edge&#39;</span>:
<a name="l01636"></a>01636                                                         <span class="keywordflow">if</span> ($this-&gt;<a class="code" href="classphpthumb.html#a1f5c8fccd6c88c41d3978a7e5ba1f02f">ImageMagickSwitchAvailable</a>(<span class="stringliteral">&#39;edge&#39;</span>)) {
<a name="l01637"></a>01637                                                                 $parameter = ($parameter ? $parameter : 2);
<a name="l01638"></a>01638                                                                 $commandline .= <span class="stringliteral">&#39; -edge &#39;</span>.($parameter ? $parameter : 1);
<a name="l01639"></a>01639                                                                 $successfullyProcessedFilters[] = $filterkey;
<a name="l01640"></a>01640                                                         }
<a name="l01641"></a>01641                                                         <span class="keywordflow">break</span>;
<a name="l01642"></a>01642 
<a name="l01643"></a>01643                                                 <span class="keywordflow">case</span> <span class="stringliteral">&#39;emb&#39;</span>:
<a name="l01644"></a>01644                                                         <span class="keywordflow">if</span> ($this-&gt;<a class="code" href="classphpthumb.html#a1f5c8fccd6c88c41d3978a7e5ba1f02f">ImageMagickSwitchAvailable</a>(array(<span class="stringliteral">&#39;emboss&#39;</span>, <span class="stringliteral">&#39;negate&#39;</span>))) {
<a name="l01645"></a>01645                                                                 $parameter = ($parameter ? $parameter : 2);
<a name="l01646"></a>01646                                                                 $commandline .= <span class="stringliteral">&#39; -emboss &#39;</span>.$parameter;
<a name="l01647"></a>01647                                                                 <span class="keywordflow">if</span> ($parameter &lt; 2) {
<a name="l01648"></a>01648                                                                         $commandline .= <span class="stringliteral">&#39; -negate&#39;</span>; <span class="comment">// ImageMagick negates the image for some reason with &#39;-emboss 1&#39;;</span>
<a name="l01649"></a>01649                                                                 }
<a name="l01650"></a>01650                                                                 $successfullyProcessedFilters[] = $filterkey;
<a name="l01651"></a>01651                                                         }
<a name="l01652"></a>01652                                                         <span class="keywordflow">break</span>;
<a name="l01653"></a>01653 
<a name="l01654"></a>01654                                                 <span class="keywordflow">case</span> <span class="stringliteral">&#39;lvl&#39;</span>:
<a name="l01655"></a>01655                                                         @list($band, $method, $threshold) = explode(<span class="charliteral">&#39;|&#39;</span>, $parameter);
<a name="l01656"></a>01656                                                         $band      = ($band ? ereg_replace(<span class="stringliteral">&#39;[^RGBA\\*]&#39;</span>, <span class="stringliteral">&#39;&#39;</span>, strtoupper($band)) : <span class="charliteral">&#39;*&#39;</span>);
<a name="l01657"></a>01657                                                         $method    = ((strlen($method) &gt; 0)    ? intval($method)                :   2);
<a name="l01658"></a>01658                                                         $threshold = ((strlen($threshold) &gt; 0) ? floatval($threshold)           : 0.1);
<a name="l01659"></a>01659 
<a name="l01660"></a>01660                                                         $band = ereg_replace(<span class="stringliteral">&#39;[^RGBA\\*]&#39;</span>, <span class="stringliteral">&#39;&#39;</span>, strtoupper($band));
<a name="l01661"></a>01661 
<a name="l01662"></a>01662                                                         <span class="keywordflow">if</span> (($method &gt; 1) &amp;&amp; !$this-&gt;<a class="code" href="classphpthumb.html#a1f5c8fccd6c88c41d3978a7e5ba1f02f">ImageMagickSwitchAvailable</a>(array(<span class="stringliteral">&#39;channel&#39;</span>, <span class="stringliteral">&#39;contrast-stretch&#39;</span>))) {
<a name="l01663"></a>01663                                                                 <span class="comment">// Because ImageMagick processing happens before PHP-GD filters, and because some</span>
<a name="l01664"></a>01664                                                                 <span class="comment">// clipping is involved in the &quot;lvl&quot; filter, if &quot;lvl&quot; happens before &quot;wb&quot; then the</span>
<a name="l01665"></a>01665                                                                 <span class="comment">// &quot;wb&quot; filter will have (almost) no effect. Therefore, if &quot;wb&quot; is enabled then</span>
<a name="l01666"></a>01666                                                                 <span class="comment">// force the &quot;lvl&quot; filter to be processed by GD, not ImageMagick.</span>
<a name="l01667"></a>01667                                                                 <span class="keywordflow">foreach</span> ($this-&gt;fltr as $fltr_key =&gt; $fltr_value) {
<a name="l01668"></a>01668                                                                         list($fltr_cmd) = explode(<span class="charliteral">&#39;|&#39;</span>, $fltr_value);
<a name="l01669"></a>01669                                                                         <span class="keywordflow">if</span> ($fltr_cmd == <span class="stringliteral">&#39;wb&#39;</span>) {
<a name="l01670"></a>01670                                                                                 $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;Setting &quot;lvl&quot; filter method to &quot;0&quot; (from &quot;&#39;</span>.$method.<span class="stringliteral">&#39;&quot;) because white-balance filter also enabled&#39;</span>, __FILE__, __LINE__);
<a name="l01671"></a>01671                                                                                 $method = 0;
<a name="l01672"></a>01672                                                                         }
<a name="l01673"></a>01673                                                                 }
<a name="l01674"></a>01674                                                         }
<a name="l01675"></a>01675 
<a name="l01676"></a>01676                                                         <span class="keywordflow">switch</span> ($method) {
<a name="l01677"></a>01677                                                                 <span class="keywordflow">case</span> 0: <span class="comment">// internal RGB</span>
<a name="l01678"></a>01678                                                                 <span class="keywordflow">case</span> 1: <span class="comment">// internal grayscale</span>
<a name="l01679"></a>01679                                                                         <span class="keywordflow">break</span>;
<a name="l01680"></a>01680                                                                 <span class="keywordflow">case</span> 2: <span class="comment">// ImageMagick &quot;contrast-stretch&quot;</span>
<a name="l01681"></a>01681                                                                         <span class="keywordflow">if</span> ($this-&gt;<a class="code" href="classphpthumb.html#a1f5c8fccd6c88c41d3978a7e5ba1f02f">ImageMagickSwitchAvailable</a>(<span class="stringliteral">&#39;contrast-stretch&#39;</span>)) {
<a name="l01682"></a>01682                                                                                 $thiscommand = <span class="stringliteral">&#39; -contrast-stretch &#39;</span>.$threshold.<span class="charliteral">&#39;%&#39;</span>;
<a name="l01683"></a>01683                                                                                 $commandline .= (($band == <span class="charliteral">&#39;*&#39;</span>) ? $thiscommand : <span class="stringliteral">&#39; -channel &#39;</span>.strtoupper($band).$thiscommand.<span class="stringliteral">&#39; +channel&#39;</span>);
<a name="l01684"></a>01684                                                                                 $successfullyProcessedFilters[] = $filterkey;
<a name="l01685"></a>01685                                                                         }
<a name="l01686"></a>01686                                                                         <span class="keywordflow">break</span>;
<a name="l01687"></a>01687                                                                 <span class="keywordflow">case</span> 3: <span class="comment">// ImageMagick &quot;normalize&quot;</span>
<a name="l01688"></a>01688                                                                         <span class="keywordflow">if</span> ($this-&gt;<a class="code" href="classphpthumb.html#a1f5c8fccd6c88c41d3978a7e5ba1f02f">ImageMagickSwitchAvailable</a>(<span class="stringliteral">&#39;normalize&#39;</span>)) {
<a name="l01689"></a>01689                                                                                 $thiscommand = <span class="stringliteral">&#39; -normalize&#39;</span>;
<a name="l01690"></a>01690                                                                                 $commandline .= (($band == <span class="charliteral">&#39;*&#39;</span>) ? $thiscommand : <span class="stringliteral">&#39; -channel &#39;</span>.strtoupper($band).$thiscommand.<span class="stringliteral">&#39; +channel&#39;</span>);
<a name="l01691"></a>01691                                                                                 $successfullyProcessedFilters[] = $filterkey;
<a name="l01692"></a>01692                                                                         }
<a name="l01693"></a>01693                                                                         <span class="keywordflow">break</span>;
<a name="l01694"></a>01694                                                                 <span class="keywordflow">default</span>:
<a name="l01695"></a>01695                                                                         $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;unsupported method (&#39;</span>.$method.<span class="stringliteral">&#39;) for &quot;lvl&quot; filter&#39;</span>, __FILE__, __LINE__);
<a name="l01696"></a>01696                                                                         <span class="keywordflow">break</span>;
<a name="l01697"></a>01697                                                         }
<a name="l01698"></a>01698                                                         <span class="keywordflow">if</span> (isset($this-&gt;fltr[$filterkey]) &amp;&amp; ($method &gt; 1)) {
<a name="l01699"></a>01699                                                                 $this-&gt;fltr[$filterkey] = $command.<span class="charliteral">&#39;|&#39;</span>.$band.<span class="stringliteral">&#39;|0|&#39;</span>.$threshold;
<a name="l01700"></a>01700                                                                 $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;filter &quot;lvl&quot; remapped from method &quot;&#39;</span>.$method.<span class="stringliteral">&#39;&quot; to method &quot;0&quot; because ImageMagick support is missing&#39;</span>, __FILE__, __LINE__);
<a name="l01701"></a>01701                                                         }
<a name="l01702"></a>01702                                                         <span class="keywordflow">break</span>;
<a name="l01703"></a>01703 
<a name="l01704"></a>01704                                                 <span class="keywordflow">case</span> <span class="stringliteral">&#39;wb&#39;</span>:
<a name="l01705"></a>01705                                                         <span class="keywordflow">if</span> ($this-&gt;<a class="code" href="classphpthumb.html#a1f5c8fccd6c88c41d3978a7e5ba1f02f">ImageMagickSwitchAvailable</a>(array(<span class="stringliteral">&#39;channel&#39;</span>, <span class="stringliteral">&#39;contrast-stretch&#39;</span>))) {
<a name="l01706"></a>01706                                                                 @list($threshold) = explode(<span class="charliteral">&#39;|&#39;</span>, $parameter);
<a name="l01707"></a>01707                                                                 $threshold = (is_float($threshold) ? $threshold : 0.1);
<a name="l01708"></a>01708                                                                 $commandline .= <span class="stringliteral">&#39; -channel R -contrast-stretch &#39;</span>.$threshold.<span class="charliteral">&#39;%&#39;</span>;
<a name="l01709"></a>01709                                                                 $commandline .= <span class="stringliteral">&#39; -channel G -contrast-stretch &#39;</span>.$threshold.<span class="charliteral">&#39;%&#39;</span>;
<a name="l01710"></a>01710                                                                 $commandline .= <span class="stringliteral">&#39; -channel B -contrast-stretch &#39;</span>.$threshold.<span class="charliteral">&#39;%&#39;</span>;
<a name="l01711"></a>01711                                                                 $commandline .= <span class="stringliteral">&#39; +channel&#39;</span>;
<a name="l01712"></a>01712                                                                 $successfullyProcessedFilters[] = $filterkey;
<a name="l01713"></a>01713                                                         }
<a name="l01714"></a>01714                                                         <span class="keywordflow">break</span>;
<a name="l01715"></a>01715 
<a name="l01716"></a>01716                                                 <span class="keywordflow">case</span> <span class="stringliteral">&#39;blur&#39;</span>:
<a name="l01717"></a>01717                                                         <span class="keywordflow">if</span> ($this-&gt;<a class="code" href="classphpthumb.html#a1f5c8fccd6c88c41d3978a7e5ba1f02f">ImageMagickSwitchAvailable</a>(<span class="stringliteral">&#39;blur&#39;</span>)) {
<a name="l01718"></a>01718                                                                 @list($radius) = explode(<span class="charliteral">&#39;|&#39;</span>, $parameter);
<a name="l01719"></a>01719                                                                 $radius = ($radius ? $radius : 1);
<a name="l01720"></a>01720                                                                 $commandline .= <span class="stringliteral">&#39; -blur &#39;</span>.$radius;
<a name="l01721"></a>01721                                                                 $successfullyProcessedFilters[] = $filterkey;
<a name="l01722"></a>01722                                                         }
<a name="l01723"></a>01723                                                         <span class="keywordflow">break</span>;
<a name="l01724"></a>01724 
<a name="l01725"></a>01725                                                 <span class="keywordflow">case</span> <span class="stringliteral">&#39;gblr&#39;</span>:
<a name="l01726"></a>01726                                                         <span class="keywordflow">if</span> ($this-&gt;<a class="code" href="classphpthumb.html#a1f5c8fccd6c88c41d3978a7e5ba1f02f">ImageMagickSwitchAvailable</a>(<span class="stringliteral">&#39;gaussian&#39;</span>)) {
<a name="l01727"></a>01727                                                                 @list($radius) = explode(<span class="charliteral">&#39;|&#39;</span>, $parameter);
<a name="l01728"></a>01728                                                                 $radius = ($radius ? $radius : 1);
<a name="l01729"></a>01729                                                                 $commandline .= <span class="stringliteral">&#39; -gaussian &#39;</span>.$radius;
<a name="l01730"></a>01730                                                                 $successfullyProcessedFilters[] = $filterkey;
<a name="l01731"></a>01731                                                         }
<a name="l01732"></a>01732                                                         <span class="keywordflow">break</span>;
<a name="l01733"></a>01733 
<a name="l01734"></a>01734                                                 <span class="keywordflow">case</span> <span class="stringliteral">&#39;usm&#39;</span>:
<a name="l01735"></a>01735                                                         <span class="keywordflow">if</span> ($this-&gt;<a class="code" href="classphpthumb.html#a1f5c8fccd6c88c41d3978a7e5ba1f02f">ImageMagickSwitchAvailable</a>(<span class="stringliteral">&#39;unsharp&#39;</span>)) {
<a name="l01736"></a>01736                                                                 @list($amount, $radius, $threshold) = explode(<span class="charliteral">&#39;|&#39;</span>, $parameter);
<a name="l01737"></a>01737                                                                 $amount    = ($amount            ? $amount    : 80);
<a name="l01738"></a>01738                                                                 $radius    = ($radius            ? $radius    : 0.5);
<a name="l01739"></a>01739                                                                 $threshold = (strlen($threshold) ? $threshold : 3);
<a name="l01740"></a>01740                                                                 $commandline .= <span class="stringliteral">&#39; -unsharp &#39;</span>.number_format(($radius * 2) - 1, 2).<span class="stringliteral">&#39;x1+&#39;</span>.number_format($amount / 100, 2).<span class="charliteral">&#39;+&#39;</span>.number_format($threshold / 100, 2);
<a name="l01741"></a>01741                                                                 $successfullyProcessedFilters[] = $filterkey;
<a name="l01742"></a>01742                                                         }
<a name="l01743"></a>01743                                                         <span class="keywordflow">break</span>;
<a name="l01744"></a>01744 
<a name="l01745"></a>01745                                                 <span class="keywordflow">case</span> <span class="stringliteral">&#39;bord&#39;</span>:
<a name="l01746"></a>01746                                                         <span class="keywordflow">if</span> ($this-&gt;<a class="code" href="classphpthumb.html#a1f5c8fccd6c88c41d3978a7e5ba1f02f">ImageMagickSwitchAvailable</a>(array(<span class="stringliteral">&#39;border&#39;</span>, <span class="stringliteral">&#39;bordercolor&#39;</span>, <span class="stringliteral">&#39;thumbnail&#39;</span>, <span class="stringliteral">&#39;crop&#39;</span>))) {
<a name="l01747"></a>01747                                                                 <span class="keywordflow">if</span> (!$this-&gt;zc) {
<a name="l01748"></a>01748                                                                         @list($width, $rX, $rY, $color) = explode(<span class="charliteral">&#39;|&#39;</span>, $parameter);
<a name="l01749"></a>01749                                                                         <span class="keywordflow">if</span> ($width &amp;&amp; !$rX &amp;&amp; !$rY) {
<a name="l01750"></a>01750                                                                                 <span class="keywordflow">if</span> (!<a class="code" href="classphpthumb__functions.html#aa88047663adfed917d5fb0bece3913b8">phpthumb_functions::IsHexColor</a>($color)) {
<a name="l01751"></a>01751                                                                                         $color = ($this-&gt;bc ? $this-&gt;bc : <span class="stringliteral">&#39;000000&#39;</span>);
<a name="l01752"></a>01752                                                                                 }
<a name="l01753"></a>01753                                                                                 $commandline .= <span class="stringliteral">&#39; -border &#39;</span>.$width.<span class="stringliteral">&#39; -bordercolor &quot;#&#39;</span>.$color.<span class="charliteral">&#39;&quot;&#39;</span>;
<a name="l01754"></a>01754                                                                                 <span class="keywordflow">if</span> (ereg(<span class="stringliteral">&#39; \-crop ([0-9]+)x([0-9]+)\+0\+0 &#39;</span>, $commandline, $matches)) {
<a name="l01755"></a>01755                                                                                         $commandline = str_replace(<span class="stringliteral">&#39; -crop &#39;</span>.$matches[1].<span class="charliteral">&#39;x&#39;</span>.$matches[2].<span class="stringliteral">&#39;+0+0 &#39;</span>, <span class="stringliteral">&#39; -crop &#39;</span>.($matches[1] - (2 * $width)).<span class="charliteral">&#39;x&#39;</span>.($matches[2] - (2 * $width)).<span class="stringliteral">&#39;+0+0 &#39;</span>, $commandline);
<a name="l01756"></a>01756                                                                                 } <a class="code" href="php_thumb_8demo_8check_8php.html#af92779326267616cd7c3cdaaa9484bc9">elseif</a> (ereg(<span class="stringliteral">&#39; \-&#39;</span>.$IMresizeParameter.<span class="stringliteral">&#39; ([0-9]+)x([0-9]+) &#39;</span>, $commandline, $matches)) {
<a name="l01757"></a>01757                                                                                         $commandline = str_replace(<span class="stringliteral">&#39; -&#39;</span>.$IMresizeParameter.<span class="charliteral">&#39; &#39;</span>.$matches[1].<span class="charliteral">&#39;x&#39;</span>.$matches[2].<span class="charliteral">&#39; &#39;</span>, <span class="stringliteral">&#39; -&#39;</span>.$IMresizeParameter.<span class="charliteral">&#39; &#39;</span>.($matches[1] - (2 * $width)).<span class="charliteral">&#39;x&#39;</span>.($matches[2] - (2 * $width)).<span class="charliteral">&#39; &#39;</span>, $commandline);
<a name="l01758"></a>01758                                                                                 }
<a name="l01759"></a>01759                                                                                 $successfullyProcessedFilters[] = $filterkey;
<a name="l01760"></a>01760                                                                         }
<a name="l01761"></a>01761                                                                 }
<a name="l01762"></a>01762                                                         }
<a name="l01763"></a>01763                                                         <span class="keywordflow">break</span>;
<a name="l01764"></a>01764 
<a name="l01765"></a>01765                                                 <span class="keywordflow">case</span> <span class="stringliteral">&#39;crop&#39;</span>:
<a name="l01766"></a>01766                                                         <span class="keywordflow">break</span>;
<a name="l01767"></a>01767 
<a name="l01768"></a>01768                                                 <span class="keywordflow">case</span> <span class="stringliteral">&#39;sblr&#39;</span>:
<a name="l01769"></a>01769                                                         <span class="keywordflow">break</span>;
<a name="l01770"></a>01770 
<a name="l01771"></a>01771                                                 <span class="keywordflow">case</span> <span class="stringliteral">&#39;mean&#39;</span>:
<a name="l01772"></a>01772                                                         <span class="keywordflow">break</span>;
<a name="l01773"></a>01773 
<a name="l01774"></a>01774                                                 <span class="keywordflow">case</span> <span class="stringliteral">&#39;smth&#39;</span>:
<a name="l01775"></a>01775                                                         <span class="keywordflow">break</span>;
<a name="l01776"></a>01776 
<a name="l01777"></a>01777                                                 <span class="keywordflow">case</span> <span class="stringliteral">&#39;bvl&#39;</span>:
<a name="l01778"></a>01778                                                         <span class="keywordflow">break</span>;
<a name="l01779"></a>01779 
<a name="l01780"></a>01780                                                 <span class="keywordflow">case</span> <span class="stringliteral">&#39;wmi&#39;</span>:
<a name="l01781"></a>01781                                                         <span class="keywordflow">break</span>;
<a name="l01782"></a>01782 
<a name="l01783"></a>01783                                                 <span class="keywordflow">case</span> <span class="stringliteral">&#39;wmt&#39;</span>:
<a name="l01784"></a>01784                                                         <span class="keywordflow">break</span>;
<a name="l01785"></a>01785 
<a name="l01786"></a>01786                                                 <span class="keywordflow">case</span> <span class="stringliteral">&#39;over&#39;</span>:
<a name="l01787"></a>01787                                                         <span class="keywordflow">break</span>;
<a name="l01788"></a>01788 
<a name="l01789"></a>01789                                                 <span class="keywordflow">case</span> <span class="stringliteral">&#39;hist&#39;</span>:
<a name="l01790"></a>01790                                                         <span class="keywordflow">break</span>;
<a name="l01791"></a>01791 
<a name="l01792"></a>01792                                                 <span class="keywordflow">case</span> <span class="stringliteral">&#39;fram&#39;</span>:
<a name="l01793"></a>01793                                                         <span class="keywordflow">break</span>;
<a name="l01794"></a>01794 
<a name="l01795"></a>01795                                                 <span class="keywordflow">case</span> <span class="stringliteral">&#39;drop&#39;</span>:
<a name="l01796"></a>01796                                                         <span class="keywordflow">break</span>;
<a name="l01797"></a>01797 
<a name="l01798"></a>01798                                                 <span class="keywordflow">case</span> <span class="stringliteral">&#39;mask&#39;</span>:
<a name="l01799"></a>01799                                                         <span class="keywordflow">break</span>;
<a name="l01800"></a>01800 
<a name="l01801"></a>01801                                                 <span class="keywordflow">case</span> <span class="stringliteral">&#39;elip&#39;</span>:
<a name="l01802"></a>01802                                                         <span class="keywordflow">break</span>;
<a name="l01803"></a>01803 
<a name="l01804"></a>01804                                                 <span class="keywordflow">case</span> <span class="stringliteral">&#39;ric&#39;</span>:
<a name="l01805"></a>01805                                                         <span class="keywordflow">break</span>;
<a name="l01806"></a>01806 
<a name="l01807"></a>01807                                                 <span class="keywordflow">case</span> <span class="stringliteral">&#39;stc&#39;</span>:
<a name="l01808"></a>01808                                                         <span class="keywordflow">break</span>;
<a name="l01809"></a>01809 
<a name="l01810"></a>01810                                                 <span class="keywordflow">case</span> <span class="stringliteral">&#39;size&#39;</span>:
<a name="l01811"></a>01811                                                         <span class="keywordflow">break</span>;
<a name="l01812"></a>01812 
<a name="l01813"></a>01813                                                 <span class="keywordflow">default</span>:
<a name="l01814"></a>01814                                                         $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;Unknown $this-&gt;fltr[&#39;</span>.$filterkey.<span class="stringliteral">&#39;] (&#39;</span>.$filtercommand.<span class="stringliteral">&#39;) -- deleting filter command&#39;</span>, __FILE__, __LINE__);
<a name="l01815"></a>01815                                                         $successfullyProcessedFilters[] = $filterkey;
<a name="l01816"></a>01816                                                         <span class="keywordflow">break</span>;
<a name="l01817"></a>01817                                         }
<a name="l01818"></a>01818                                         <span class="keywordflow">if</span> (!isset($this-&gt;fltr[$filterkey])) {
<a name="l01819"></a>01819                                                 $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;Processed $this-&gt;fltr[&#39;</span>.$filterkey.<span class="stringliteral">&#39;] (&#39;</span>.$filtercommand.<span class="stringliteral">&#39;) with ImageMagick&#39;</span>, __FILE__, __LINE__);
<a name="l01820"></a>01820                                         } <span class="keywordflow">else</span> {
<a name="l01821"></a>01821                                                 $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;Skipping $this-&gt;fltr[&#39;</span>.$filterkey.<span class="stringliteral">&#39;] (&#39;</span>.$filtercommand.<span class="stringliteral">&#39;) with ImageMagick&#39;</span>, __FILE__, __LINE__);
<a name="l01822"></a>01822                                         }
<a name="l01823"></a>01823                                 }
<a name="l01824"></a>01824                                 $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;Remaining $this-&gt;fltr after ImageMagick: (&#39;</span>.$this-&gt;<a class="code" href="classphpthumb.html#ac6144c2648d4394fba9a1d3d75d442fc">phpThumbDebugVarDump</a>($this-&gt;fltr).<span class="charliteral">&#39;)&#39;</span>, __FILE__, __LINE__);
<a name="l01825"></a>01825                                 <span class="keywordflow">if</span> (count($this-&gt;fltr) &gt; 0) {
<a name="l01826"></a>01826                                         $this-&gt;useRawIMoutput = <span class="keyword">false</span>;
<a name="l01827"></a>01827                                 }
<a name="l01828"></a>01828 
<a name="l01829"></a>01829                                 <span class="keywordflow">if</span> (eregi(<span class="stringliteral">&#39;jpe?g&#39;</span>, $outputFormat) &amp;&amp; $this-&gt;q) {
<a name="l01830"></a>01830                                         <span class="keywordflow">if</span> ($this-&gt;<a class="code" href="classphpthumb.html#a1f5c8fccd6c88c41d3978a7e5ba1f02f">ImageMagickSwitchAvailable</a>(array(<span class="stringliteral">&#39;quality&#39;</span>, <span class="stringliteral">&#39;interlace&#39;</span>))) {
<a name="l01831"></a>01831                                                 $commandline .= <span class="stringliteral">&#39; -quality &#39;</span>.$this-&gt;thumbnailQuality;
<a name="l01832"></a>01832                                                 <span class="keywordflow">if</span> ($this-&gt;config_output_interlace) {
<a name="l01833"></a>01833                                                         <span class="comment">// causes weird things with animated GIF... leave for JPEG only</span>
<a name="l01834"></a>01834                                                         $commandline .= <span class="stringliteral">&#39; -interlace line &#39;</span>; <span class="comment">// Use Line or Plane to create an interlaced PNG or GIF or progressive JPEG image</span>
<a name="l01835"></a>01835                                                 }
<a name="l01836"></a>01836                                         }
<a name="l01837"></a>01837                                 }
<a name="l01838"></a>01838                                 $commandline .= <span class="stringliteral">&#39; &quot;&#39;</span>.str_replace(<span class="charliteral">&#39;/&#39;</span>, DIRECTORY_SEPARATOR, $this-&gt;sourceFilename).(($outputFormat == <span class="stringliteral">&#39;gif&#39;</span>) ? <span class="stringliteral">&#39;&#39;</span> : <span class="charliteral">&#39;[&#39;</span>.intval($this-&gt;sfn).<span class="charliteral">&#39;]&#39;</span>).<span class="charliteral">&#39;&quot;&#39;</span>; <span class="comment">// [0] means first frame of (GIF) animation, can be ignored</span>
<a name="l01839"></a>01839                                 $commandline .= <span class="charliteral">&#39; &#39;</span>.$outputFormat.<span class="stringliteral">&#39;:&quot;&#39;</span>.$IMtempfilename.<span class="charliteral">&#39;&quot;&#39;</span>;
<a name="l01840"></a>01840                                 <span class="keywordflow">if</span> (!$this-&gt;iswindows) {
<a name="l01841"></a>01841                                         $commandline .= <span class="stringliteral">&#39; 2&gt;&amp;1&#39;</span>;
<a name="l01842"></a>01842                                 }
<a name="l01843"></a>01843                                 $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;ImageMagick called as (&#39;</span>.$commandline.<span class="charliteral">&#39;)&#39;</span>, __FILE__, __LINE__);
<a name="l01844"></a>01844                                 $IMresult = <a class="code" href="classphpthumb__functions.html#a32ab9bd049bb6b7e0352329726a0ab51">phpthumb_functions::SafeExec</a>($commandline);
<a name="l01845"></a>01845                                 clearstatcache();
<a name="l01846"></a>01846                                 <span class="keywordflow">if</span> (@$IMtempSourceFilename &amp;&amp; file_exists($IMtempSourceFilename)) {
<a name="l01847"></a>01847                                         $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;deleting &quot;&#39;</span>.$IMtempSourceFilename.<span class="charliteral">&#39;&quot;&#39;</span>, __FILE__, __LINE__);
<a name="l01848"></a>01848                                         @unlink($IMtempSourceFilename);
<a name="l01849"></a>01849                                 }
<a name="l01850"></a>01850                                 <span class="keywordflow">if</span> (!@file_exists($IMtempfilename) || !@filesize($IMtempfilename)) {
<a name="l01851"></a>01851                                         $this-&gt;<a class="code" href="classphpthumb.html#a884659e333b8e276d254035228d04050">FatalError</a>(<span class="stringliteral">&#39;ImageMagick failed with message (&#39;</span>.trim($IMresult).<span class="charliteral">&#39;)&#39;</span>);
<a name="l01852"></a>01852                                         $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;ImageMagick failed with message (&#39;</span>.trim($IMresult).<span class="charliteral">&#39;)&#39;</span>, __FILE__, __LINE__);
<a name="l01853"></a>01853                                         <span class="keywordflow">if</span> ($this-&gt;iswindows &amp;&amp; !$IMresult) {
<a name="l01854"></a>01854                                                 $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;Check to make sure that PHP has read+write permissions to &quot;&#39;</span>.dirname($IMtempfilename).<span class="charliteral">&#39;&quot;&#39;</span>, __FILE__, __LINE__);
<a name="l01855"></a>01855                                         }
<a name="l01856"></a>01856 
<a name="l01857"></a>01857                                 } <span class="keywordflow">else</span> {
<a name="l01858"></a>01858 
<a name="l01859"></a>01859                                         <span class="keywordflow">foreach</span> ($successfullyProcessedFilters as $dummy =&gt; $filterkey) {
<a name="l01860"></a>01860                                                 unset($this-&gt;fltr[$filterkey]);
<a name="l01861"></a>01861                                         }
<a name="l01862"></a>01862                                         $this-&gt;IMresizedData = file_get_contents($IMtempfilename);
<a name="l01863"></a>01863                                         $getimagesize_imresized = @GetImageSize($IMtempfilename);
<a name="l01864"></a>01864                                         $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;GetImageSize(&#39;</span>.$IMtempfilename.<span class="stringliteral">&#39;) returned [w=&#39;</span>.$getimagesize_imresized[0].<span class="stringliteral">&#39;;h=&#39;</span>.$getimagesize_imresized[1].<span class="stringliteral">&#39;;f=&#39;</span>.$getimagesize_imresized[2].<span class="charliteral">&#39;]&#39;</span>, __FILE__, __LINE__);
<a name="l01865"></a>01865                                         <span class="keywordflow">if</span> (($this-&gt;config_max_source_pixels &gt; 0) &amp;&amp; (($getimagesize_imresized[0] * $getimagesize_imresized[1]) &gt; $this-&gt;config_max_source_pixels)) {
<a name="l01866"></a>01866                                                 $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;skipping ImageMagickThumbnailToGD::&#39;</span>.$ImageCreateFunction.<span class="stringliteral">&#39;() because IM output is too large (&#39;</span>.$getimagesize_imresized[0].<span class="charliteral">&#39;x&#39;</span>.$getimagesize_imresized[0].<span class="stringliteral">&#39; = &#39;</span>.($getimagesize_imresized[0] * $getimagesize_imresized[1]).<span class="stringliteral">&#39; &gt; &#39;</span>.$this-&gt;config_max_source_pixels.<span class="charliteral">&#39;)&#39;</span>, __FILE__, __LINE__);
<a name="l01867"></a>01867                                         } <a class="code" href="php_thumb_8demo_8check_8php.html#af92779326267616cd7c3cdaaa9484bc9">elseif</a> (function_exists(@$ImageCreateFunction) &amp;&amp; ($this-&gt;gdimg_source = @$ImageCreateFunction($IMtempfilename))) {
<a name="l01868"></a>01868                                                 $this-&gt;source_width  = ImageSX($this-&gt;gdimg_source);
<a name="l01869"></a>01869                                                 $this-&gt;source_height = ImageSY($this-&gt;gdimg_source);
<a name="l01870"></a>01870                                                 $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;ImageMagickThumbnailToGD::&#39;</span>.$ImageCreateFunction.<span class="stringliteral">&#39;() succeeded, $this-&gt;gdimg_source is now (&#39;</span>.$this-&gt;source_width.<span class="charliteral">&#39;x&#39;</span>.$this-&gt;source_height.<span class="charliteral">&#39;)&#39;</span>, __FILE__, __LINE__);
<a name="l01871"></a>01871                                                 $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;ImageMagickThumbnailToGD() returning $this-&gt;IMresizedData (&#39;</span>.strlen($this-&gt;IMresizedData).<span class="stringliteral">&#39; bytes)&#39;</span>, __FILE__, __LINE__);
<a name="l01872"></a>01872                                         } <span class="keywordflow">else</span> {
<a name="l01873"></a>01873                                                 $this-&gt;useRawIMoutput = <span class="keyword">true</span>;
<a name="l01874"></a>01874                                                 $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;$this-&gt;useRawIMoutput set to TRUE because &#39;</span>.@$ImageCreateFunction.<span class="charliteral">&#39;(&#39;</span>.$IMtempfilename.<span class="stringliteral">&#39;) failed&#39;</span>, __FILE__, __LINE__);
<a name="l01875"></a>01875                                         }
<a name="l01876"></a>01876                                         $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;deleting &quot;&#39;</span>.$IMtempfilename.<span class="charliteral">&#39;&quot;&#39;</span>, __FILE__, __LINE__);
<a name="l01877"></a>01877                                         @unlink($IMtempfilename);
<a name="l01878"></a>01878                                         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l01879"></a>01879 
<a name="l01880"></a>01880                                 }
<a name="l01881"></a>01881                                 $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;deleting &quot;&#39;</span>.$IMtempfilename.<span class="charliteral">&#39;&quot;&#39;</span>, __FILE__, __LINE__);
<a name="l01882"></a>01882                                 unlink($IMtempfilename);
<a name="l01883"></a>01883 
<a name="l01884"></a>01884                         } <a class="code" href="php_thumb_8demo_8check_8php.html#af92779326267616cd7c3cdaaa9484bc9">elseif</a> (ini_get(<span class="stringliteral">&#39;safe_mode&#39;</span>)) {
<a name="l01885"></a>01885                                 $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;ImageMagickThumbnailToGD() aborting because PHP safe_mode is enabled and phpThumb_tempnam() failed&#39;</span>, __FILE__, __LINE__);
<a name="l01886"></a>01886                                 $this-&gt;useRawIMoutput = <span class="keyword">false</span>;
<a name="l01887"></a>01887                         } <span class="keywordflow">else</span> {
<a name="l01888"></a>01888                                 $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;ImageMagickThumbnailToGD() aborting, phpThumb_tempnam() failed&#39;</span>, __FILE__, __LINE__);
<a name="l01889"></a>01889                         }
<a name="l01890"></a>01890                 } <span class="keywordflow">else</span> {
<a name="l01891"></a>01891                         $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;ImageMagickThumbnailToGD() aborting because ImageMagickCommandlineBase() failed&#39;</span>, __FILE__, __LINE__);
<a name="l01892"></a>01892                 }
<a name="l01893"></a>01893                 $this-&gt;useRawIMoutput = <span class="keyword">false</span>;
<a name="l01894"></a>01894                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01895"></a>01895         }
<a name="l01896"></a>01896 
<a name="l01897"></a>01897 
<a name="l01898"></a><a class="code" href="classphpthumb.html#ad799f5f4019f5ca9f5eb3a0f8da091f0">01898</a>         <span class="keyword">function</span> <a class="code" href="classphpthumb.html#ad799f5f4019f5ca9f5eb3a0f8da091f0">Rotate</a>() {
<a name="l01899"></a>01899                 <span class="keywordflow">if</span> ($this-&gt;ra || $this-&gt;ar) {
<a name="l01900"></a>01900                         <span class="keywordflow">if</span> (!function_exists(<span class="stringliteral">&#39;ImageRotate&#39;</span>)) {
<a name="l01901"></a>01901                                 $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;!function_exists(ImageRotate)&#39;</span>, __FILE__, __LINE__);
<a name="l01902"></a>01902                                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01903"></a>01903                         }
<a name="l01904"></a>01904                         <span class="keywordflow">if</span> (!include_once(dirname(__FILE__).<span class="stringliteral">&#39;/phpthumb.filters.php&#39;</span>)) {
<a name="l01905"></a>01905                                 $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;Error including &quot;&#39;</span>.dirname(__FILE__).<span class="stringliteral">&#39;/phpthumb.filters.php&quot; which is required for applying filters (&#39;</span>.implode(<span class="charliteral">&#39;;&#39;</span>, $this-&gt;fltr).<span class="charliteral">&#39;)&#39;</span>, __FILE__, __LINE__);
<a name="l01906"></a>01906                                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01907"></a>01907                         }
<a name="l01908"></a>01908 
<a name="l01909"></a>01909                         $this-&gt;config_background_hexcolor = ($this-&gt;bg ? $this-&gt;bg : $this-&gt;config_background_hexcolor);
<a name="l01910"></a>01910                         <span class="keywordflow">if</span> (!<a class="code" href="classphpthumb__functions.html#aa88047663adfed917d5fb0bece3913b8">phpthumb_functions::IsHexColor</a>($this-&gt;config_background_hexcolor)) {
<a name="l01911"></a>01911                                 <span class="keywordflow">return</span> $this-&gt;<a class="code" href="classphpthumb.html#a6ff71b425894fd846790cedf9f9cc97d">ErrorImage</a>(<span class="stringliteral">&#39;Invalid hex color string &quot;&#39;</span>.$this-&gt;config_background_hexcolor.<span class="stringliteral">&#39;&quot; for parameter &quot;bg&quot;&#39;</span>);
<a name="l01912"></a>01912                         }
<a name="l01913"></a>01913 
<a name="l01914"></a>01914                         $rotate_angle = 0;
<a name="l01915"></a>01915                         <span class="keywordflow">if</span> ($this-&gt;ra) {
<a name="l01916"></a>01916 
<a name="l01917"></a>01917                                 $rotate_angle = floatval($this-&gt;ra);
<a name="l01918"></a>01918 
<a name="l01919"></a>01919                         } <span class="keywordflow">else</span> {
<a name="l01920"></a>01920 
<a name="l01921"></a>01921                                 <span class="keywordflow">if</span> ($this-&gt;ar == <span class="charliteral">&#39;x&#39;</span>) {
<a name="l01922"></a>01922                                         <span class="keywordflow">if</span> (<a class="code" href="classphpthumb__functions.html#af53f41b3482e6bed2082daa0ebfd96c0">phpthumb_functions::version_compare_replacement</a>(phpversion(), <span class="stringliteral">&#39;4.2.0&#39;</span>, <span class="stringliteral">&#39;&gt;=&#39;</span>)) {
<a name="l01923"></a>01923                                                 <span class="keywordflow">if</span> ($this-&gt;sourceFilename) {
<a name="l01924"></a>01924                                                         <span class="keywordflow">if</span> (function_exists(<span class="stringliteral">&#39;exif_read_data&#39;</span>)) {
<a name="l01925"></a>01925                                                                 <span class="keywordflow">if</span> ($exif_data = @exif_read_data($this-&gt;sourceFilename, <span class="stringliteral">&#39;IFD0&#39;</span>)) {
<a name="l01926"></a>01926                                                                         <span class="comment">// http://sylvana.net/jpegcrop/exif_orientation.html</span>
<a name="l01927"></a>01927                                                                         <span class="keywordflow">switch</span> (@$exif_data[<span class="stringliteral">&#39;Orientation&#39;</span>]) {
<a name="l01928"></a>01928                                                                                 <span class="keywordflow">case</span> 1:
<a name="l01929"></a>01929                                                                                         $rotate_angle = 0;
<a name="l01930"></a>01930                                                                                         <span class="keywordflow">break</span>;
<a name="l01931"></a>01931                                                                                 <span class="keywordflow">case</span> 3:
<a name="l01932"></a>01932                                                                                         $rotate_angle = 180;
<a name="l01933"></a>01933                                                                                         <span class="keywordflow">break</span>;
<a name="l01934"></a>01934                                                                                 <span class="keywordflow">case</span> 6:
<a name="l01935"></a>01935                                                                                         $rotate_angle = 270;
<a name="l01936"></a>01936                                                                                         <span class="keywordflow">break</span>;
<a name="l01937"></a>01937                                                                                 <span class="keywordflow">case</span> 8:
<a name="l01938"></a>01938                                                                                         $rotate_angle = 90;
<a name="l01939"></a>01939                                                                                         <span class="keywordflow">break</span>;
<a name="l01940"></a>01940 
<a name="l01941"></a>01941                                                                                 <span class="keywordflow">default</span>:
<a name="l01942"></a>01942                                                                                         $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;EXIF auto-rotate failed because unknown $exif_data[Orientation] &quot;&#39;</span>.@$exif_data[<span class="stringliteral">&#39;Orientation&#39;</span>].<span class="charliteral">&#39;&quot;&#39;</span>, __FILE__, __LINE__);
<a name="l01943"></a>01943                                                                                         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01944"></a>01944                                                                                         <span class="keywordflow">break</span>;
<a name="l01945"></a>01945                                                                         }
<a name="l01946"></a>01946                                                                         $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;EXIF auto-rotate set to &#39;</span>.$rotate_angle.<span class="stringliteral">&#39; degrees ($exif_data[Orientation] = &quot;&#39;</span>.@$exif_data[<span class="stringliteral">&#39;Orientation&#39;</span>].<span class="stringliteral">&#39;&quot;)&#39;</span>, __FILE__, __LINE__);
<a name="l01947"></a>01947                                                                 } <span class="keywordflow">else</span> {
<a name="l01948"></a>01948                                                                         $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;failed: exif_read_data(&#39;</span>.$this-&gt;sourceFilename.<span class="charliteral">&#39;)&#39;</span>, __FILE__, __LINE__);
<a name="l01949"></a>01949                                                                         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01950"></a>01950                                                                 }
<a name="l01951"></a>01951                                                         } <span class="keywordflow">else</span> {
<a name="l01952"></a>01952                                                                 $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;!function_exists(exif_read_data)&#39;</span>, __FILE__, __LINE__);
<a name="l01953"></a>01953                                                                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01954"></a>01954                                                         }
<a name="l01955"></a>01955                                                 } <span class="keywordflow">else</span> {
<a name="l01956"></a>01956                                                         $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;Cannot auto-rotate from EXIF data because $this-&gt;sourceFilename is empty&#39;</span>, __FILE__, __LINE__);
<a name="l01957"></a>01957                                                         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01958"></a>01958                                                 }
<a name="l01959"></a>01959                                         } <span class="keywordflow">else</span> {
<a name="l01960"></a>01960                                                 $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;Cannot auto-rotate from EXIF data because PHP is less than v4.2.0 (&#39;</span>.phpversion().<span class="charliteral">&#39;)&#39;</span>, __FILE__, __LINE__);
<a name="l01961"></a>01961                                                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01962"></a>01962                                         }
<a name="l01963"></a>01963                                 } <a class="code" href="php_thumb_8demo_8check_8php.html#af92779326267616cd7c3cdaaa9484bc9">elseif</a> (($this-&gt;ar == <span class="charliteral">&#39;l&#39;</span>) &amp;&amp; ($this-&gt;source_height &gt; $this-&gt;source_width)) {
<a name="l01964"></a>01964                                         $rotate_angle = 270;
<a name="l01965"></a>01965                                 } <a class="code" href="php_thumb_8demo_8check_8php.html#af92779326267616cd7c3cdaaa9484bc9">elseif</a> (($this-&gt;ar == <span class="charliteral">&#39;L&#39;</span>) &amp;&amp; ($this-&gt;source_height &gt; $this-&gt;source_width)) {
<a name="l01966"></a>01966                                         $rotate_angle = 90;
<a name="l01967"></a>01967                                 } <a class="code" href="php_thumb_8demo_8check_8php.html#af92779326267616cd7c3cdaaa9484bc9">elseif</a> (($this-&gt;ar == <span class="charliteral">&#39;p&#39;</span>) &amp;&amp; ($this-&gt;source_width &gt; $this-&gt;source_height)) {
<a name="l01968"></a>01968                                         $rotate_angle = 90;
<a name="l01969"></a>01969                                 } <a class="code" href="php_thumb_8demo_8check_8php.html#af92779326267616cd7c3cdaaa9484bc9">elseif</a> (($this-&gt;ar == <span class="charliteral">&#39;P&#39;</span>) &amp;&amp; ($this-&gt;source_width &gt; $this-&gt;source_height)) {
<a name="l01970"></a>01970                                         $rotate_angle = 270;
<a name="l01971"></a>01971                                 }
<a name="l01972"></a>01972 
<a name="l01973"></a>01973                         }
<a name="l01974"></a>01974                         <span class="keywordflow">if</span> ($rotate_angle % 90) {
<a name="l01975"></a>01975                                 $this-&gt;is_alpha = <span class="keyword">true</span>;
<a name="l01976"></a>01976                         }
<a name="l01977"></a>01977                         <a class="code" href="classphpthumb__filters.html#aa3a158b5772eeb4fb28f13973a9e82f5">phpthumb_filters::ImprovedImageRotate</a>($this-&gt;gdimg_source, $rotate_angle, $this-&gt;config_background_hexcolor, $this-&gt;bg);
<a name="l01978"></a>01978                         $this-&gt;source_width  = ImageSX($this-&gt;gdimg_source);
<a name="l01979"></a>01979                         $this-&gt;source_height = ImageSY($this-&gt;gdimg_source);
<a name="l01980"></a>01980                 }
<a name="l01981"></a>01981                 <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l01982"></a>01982         }
<a name="l01983"></a>01983 
<a name="l01984"></a>01984 
<a name="l01985"></a><a class="code" href="classphpthumb.html#ad3682c3cf7d9119200d8a358a5907f68">01985</a>         <span class="keyword">function</span> <a class="code" href="classphpthumb.html#ad3682c3cf7d9119200d8a358a5907f68">FixedAspectRatio</a>() {
<a name="l01986"></a>01986                 <span class="comment">// optional fixed-dimension images (regardless of aspect ratio)</span>
<a name="l01987"></a>01987 
<a name="l01988"></a>01988                 <span class="keywordflow">if</span> (!$this-&gt;far) {
<a name="l01989"></a>01989                         <span class="comment">// do nothing</span>
<a name="l01990"></a>01990                         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l01991"></a>01991                 }
<a name="l01992"></a>01992 
<a name="l01993"></a>01993                 <span class="keywordflow">if</span> (!$this-&gt;w || !$this-&gt;h) {
<a name="l01994"></a>01994                         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01995"></a>01995                 }
<a name="l01996"></a>01996                 $this-&gt;thumbnail_width  = $this-&gt;w;
<a name="l01997"></a>01997                 $this-&gt;thumbnail_height = $this-&gt;h;
<a name="l01998"></a>01998                 $this-&gt;is_alpha = <span class="keyword">true</span>;
<a name="l01999"></a>01999                 <span class="keywordflow">if</span> ($this-&gt;thumbnail_image_width &gt;= $this-&gt;thumbnail_width) {
<a name="l02000"></a>02000 
<a name="l02001"></a>02001                         <span class="keywordflow">if</span> ($this-&gt;w) {
<a name="l02002"></a>02002                                 $aspectratio = $this-&gt;thumbnail_image_height / $this-&gt;thumbnail_image_width;
<a name="l02003"></a>02003                                 $this-&gt;thumbnail_image_height = round($this-&gt;thumbnail_image_width * $aspectratio);
<a name="l02004"></a>02004                                 $this-&gt;thumbnail_height = ($this-&gt;h ? $this-&gt;h : $this-&gt;thumbnail_image_height);
<a name="l02005"></a>02005                         } <a class="code" href="php_thumb_8demo_8check_8php.html#af92779326267616cd7c3cdaaa9484bc9">elseif</a> ($this-&gt;thumbnail_image_height &lt; $this-&gt;thumbnail_height) {
<a name="l02006"></a>02006                                 $this-&gt;thumbnail_image_height = $this-&gt;thumbnail_height;
<a name="l02007"></a>02007                                 $this-&gt;thumbnail_image_width  = round($this-&gt;thumbnail_image_height / $aspectratio);
<a name="l02008"></a>02008                         }
<a name="l02009"></a>02009 
<a name="l02010"></a>02010                 } <span class="keywordflow">else</span> {
<a name="l02011"></a>02011                         <span class="keywordflow">if</span> ($this-&gt;h) {
<a name="l02012"></a>02012                                 $aspectratio = $this-&gt;thumbnail_image_width / $this-&gt;thumbnail_image_height;
<a name="l02013"></a>02013                                 $this-&gt;thumbnail_image_width = round($this-&gt;thumbnail_image_height * $aspectratio);
<a name="l02014"></a>02014                         } <a class="code" href="php_thumb_8demo_8check_8php.html#af92779326267616cd7c3cdaaa9484bc9">elseif</a> ($this-&gt;thumbnail_image_width &lt; $this-&gt;thumbnail_width) {
<a name="l02015"></a>02015                                 $this-&gt;thumbnail_image_width = $this-&gt;thumbnail_width;
<a name="l02016"></a>02016                                 $this-&gt;thumbnail_image_height  = round($this-&gt;thumbnail_image_width / $aspectratio);
<a name="l02017"></a>02017                         }
<a name="l02018"></a>02018 
<a name="l02019"></a>02019                 }
<a name="l02020"></a>02020                 <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l02021"></a>02021         }
<a name="l02022"></a>02022 
<a name="l02023"></a>02023 
<a name="l02024"></a><a class="code" href="classphpthumb.html#a836ad805d02f542e0b33222879dcdabf">02024</a>         <span class="keyword">function</span> <a class="code" href="classphpthumb.html#a836ad805d02f542e0b33222879dcdabf">OffsiteDomainIsAllowed</a>($hostname, $allowed_domains) {
<a name="l02025"></a>02025                 <span class="keyword">static</span> $domain_is_allowed = array();
<a name="l02026"></a>02026                 $hostname = strtolower($hostname);
<a name="l02027"></a>02027                 <span class="keywordflow">if</span> (!isset($domain_is_allowed[$hostname])) {
<a name="l02028"></a>02028                         $domain_is_allowed[$hostname] = <span class="keyword">false</span>;
<a name="l02029"></a>02029                         <span class="keywordflow">foreach</span> ($allowed_domains as $valid_domain) {
<a name="l02030"></a>02030                                 $starpos = strpos($valid_domain, <span class="charliteral">&#39;*&#39;</span>);
<a name="l02031"></a>02031                                 <span class="keywordflow">if</span> ($starpos !== <span class="keyword">false</span>) {
<a name="l02032"></a>02032                                         $valid_domain = substr($valid_domain, $starpos + 1);
<a name="l02033"></a>02033                                         <span class="keywordflow">if</span> (eregi($valid_domain.<span class="charliteral">&#39;$&#39;</span>, $hostname)) {
<a name="l02034"></a>02034                                                 $domain_is_allowed[$hostname] = <span class="keyword">true</span>;
<a name="l02035"></a>02035                                                 <span class="keywordflow">break</span>;
<a name="l02036"></a>02036                                         }
<a name="l02037"></a>02037                                 } <span class="keywordflow">else</span> {
<a name="l02038"></a>02038                                         <span class="keywordflow">if</span> (strtolower($valid_domain) === $hostname) {
<a name="l02039"></a>02039                                                 $domain_is_allowed[$hostname] = <span class="keyword">true</span>;
<a name="l02040"></a>02040                                                 <span class="keywordflow">break</span>;
<a name="l02041"></a>02041                                         }
<a name="l02042"></a>02042                                 }
<a name="l02043"></a>02043                         }
<a name="l02044"></a>02044                 }
<a name="l02045"></a>02045                 <span class="keywordflow">return</span> $domain_is_allowed[$hostname];
<a name="l02046"></a>02046         }
<a name="l02047"></a>02047 
<a name="l02048"></a>02048 
<a name="l02049"></a><a class="code" href="classphpthumb.html#a1ffe44d7b342017608ce694cb875cbf4">02049</a>         <span class="keyword">function</span> <a class="code" href="classphpthumb.html#a1ffe44d7b342017608ce694cb875cbf4">AntiOffsiteLinking</a>() {
<a name="l02050"></a>02050                 <span class="comment">// Optional anti-offsite hijacking of the thumbnail script</span>
<a name="l02051"></a>02051                 $allow = <span class="keyword">true</span>;
<a name="l02052"></a>02052                 <span class="keywordflow">if</span> ($allow &amp;&amp; $this-&gt;config_nooffsitelink_enabled &amp;&amp; (@$_SERVER[<span class="stringliteral">&#39;HTTP_REFERER&#39;</span>] || $this-&gt;config_nooffsitelink_require_refer)) {
<a name="l02053"></a>02053                         $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;AntiOffsiteLinking() checking $_SERVER[HTTP_REFERER] &quot;&#39;</span>.@$_SERVER[<span class="stringliteral">&#39;HTTP_REFERER&#39;</span>].<span class="charliteral">&#39;&quot;&#39;</span>, __FILE__, __LINE__);
<a name="l02054"></a>02054                         <span class="keywordflow">foreach</span> ($this-&gt;config_nooffsitelink_valid_domains as $key =&gt; $valid_domain) {
<a name="l02055"></a>02055                                 <span class="comment">// $_SERVER[&#39;HTTP_HOST&#39;] contains the port number, so strip it out here to make default configuration work</span>
<a name="l02056"></a>02056                                 list($clean_domain) = explode(<span class="charliteral">&#39;:&#39;</span>, $valid_domain);
<a name="l02057"></a>02057                                 $this-&gt;config_nooffsitelink_valid_domains[$key] = $clean_domain;
<a name="l02058"></a>02058                         }
<a name="l02059"></a>02059                         $parsed_url = <a class="code" href="classphpthumb__functions.html#ad7ede725cfcb053c5dbd50308deca6cd">phpthumb_functions::ParseURLbetter</a>(@$_SERVER[<span class="stringliteral">&#39;HTTP_REFERER&#39;</span>]);
<a name="l02060"></a>02060                         <span class="keywordflow">if</span> (!$this-&gt;<a class="code" href="classphpthumb.html#a836ad805d02f542e0b33222879dcdabf">OffsiteDomainIsAllowed</a>(@$parsed_url[<span class="stringliteral">&#39;host&#39;</span>], $this-&gt;config_nooffsitelink_valid_domains)) {
<a name="l02061"></a>02061                                 $allow = <span class="keyword">false</span>;
<a name="l02062"></a>02062                                 $erase   = $this-&gt;config_nooffsitelink_erase_image;
<a name="l02063"></a>02063                                 $message = $this-&gt;config_nooffsitelink_text_message;
<a name="l02064"></a>02064 $this-&gt;<a class="code" href="classphpthumb.html#a6ff71b425894fd846790cedf9f9cc97d">ErrorImage</a>(<span class="stringliteral">&#39;AntiOffsiteLinking() - &quot;&#39;</span>.@$parsed_url[<span class="stringliteral">&#39;host&#39;</span>].<span class="stringliteral">&#39;&quot; is NOT in $this-&gt;config_nooffsitelink_valid_domains (&#39;</span>.implode(<span class="charliteral">&#39;;&#39;</span>, $this-&gt;config_nooffsitelink_valid_domains).<span class="charliteral">&#39;)&#39;</span>);
<a name="l02065"></a>02065 <a class="code" href="lib_2php_thumbs-1_87_89_2cache_2index_8php.html#a6733eb5f605d09eaede9845835d71c4e">exit</a>;
<a name="l02066"></a>02066                                 $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;AntiOffsiteLinking() - &quot;&#39;</span>.@$parsed_url[<span class="stringliteral">&#39;host&#39;</span>].<span class="stringliteral">&#39;&quot; is NOT in $this-&gt;config_nooffsitelink_valid_domains (&#39;</span>.implode(<span class="charliteral">&#39;;&#39;</span>, $this-&gt;config_nooffsitelink_valid_domains).<span class="charliteral">&#39;)&#39;</span>, __FILE__, __LINE__);
<a name="l02067"></a>02067                         } <span class="keywordflow">else</span> {
<a name="l02068"></a>02068                                 $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;AntiOffsiteLinking() - &quot;&#39;</span>.@$parsed_url[<span class="stringliteral">&#39;host&#39;</span>].<span class="stringliteral">&#39;&quot; is in $this-&gt;config_nooffsitelink_valid_domains (&#39;</span>.implode(<span class="charliteral">&#39;;&#39;</span>, $this-&gt;config_nooffsitelink_valid_domains).<span class="charliteral">&#39;)&#39;</span>, __FILE__, __LINE__);
<a name="l02069"></a>02069                         }
<a name="l02070"></a>02070                 }
<a name="l02071"></a>02071 
<a name="l02072"></a>02072                 <span class="keywordflow">if</span> ($allow &amp;&amp; $this-&gt;config_nohotlink_enabled &amp;&amp; eregi(<span class="stringliteral">&#39;^(f|ht)tps?\://&#39;</span>, $this-&gt;src)) {
<a name="l02073"></a>02073                         $parsed_url = <a class="code" href="classphpthumb__functions.html#ad7ede725cfcb053c5dbd50308deca6cd">phpthumb_functions::ParseURLbetter</a>($this-&gt;src);
<a name="l02074"></a>02074                         <span class="comment">//if (!phpthumb_functions::CaseInsensitiveInArray(@$parsed_url[&#39;host&#39;], $this-&gt;config_nohotlink_valid_domains)) {</span>
<a name="l02075"></a>02075                         <span class="keywordflow">if</span> ($this-&gt;<a class="code" href="classphpthumb.html#a836ad805d02f542e0b33222879dcdabf">OffsiteDomainIsAllowed</a>(@$parsed_url[<span class="stringliteral">&#39;host&#39;</span>], $this-&gt;config_nohotlink_valid_domains)) {
<a name="l02076"></a>02076                                 <span class="comment">// This domain is not allowed</span>
<a name="l02077"></a>02077                                 $allow = <span class="keyword">false</span>;
<a name="l02078"></a>02078                                 $erase   = $this-&gt;config_nohotlink_erase_image;
<a name="l02079"></a>02079                                 $message = $this-&gt;config_nohotlink_text_message;
<a name="l02080"></a>02080                                 $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;AntiOffsiteLinking() - &quot;&#39;</span>.$parsed_url[<span class="stringliteral">&#39;host&#39;</span>].<span class="stringliteral">&#39;&quot; is NOT in $this-&gt;config_nohotlink_valid_domains (&#39;</span>.implode(<span class="charliteral">&#39;;&#39;</span>, $this-&gt;config_nohotlink_valid_domains).<span class="charliteral">&#39;)&#39;</span>, __FILE__, __LINE__);
<a name="l02081"></a>02081                         } <span class="keywordflow">else</span> {
<a name="l02082"></a>02082                                 $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;AntiOffsiteLinking() - &quot;&#39;</span>.$parsed_url[<span class="stringliteral">&#39;host&#39;</span>].<span class="stringliteral">&#39;&quot; is in $this-&gt;config_nohotlink_valid_domains (&#39;</span>.implode(<span class="charliteral">&#39;;&#39;</span>, $this-&gt;config_nohotlink_valid_domains).<span class="charliteral">&#39;)&#39;</span>, __FILE__, __LINE__);
<a name="l02083"></a>02083                         }
<a name="l02084"></a>02084                 }
<a name="l02085"></a>02085 
<a name="l02086"></a>02086                 <span class="keywordflow">if</span> ($allow) {
<a name="l02087"></a>02087                         $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;AntiOffsiteLinking() says this is allowed&#39;</span>, __FILE__, __LINE__);
<a name="l02088"></a>02088                         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l02089"></a>02089                 }
<a name="l02090"></a>02090 
<a name="l02091"></a>02091                 <span class="keywordflow">if</span> (!<a class="code" href="classphpthumb__functions.html#aa88047663adfed917d5fb0bece3913b8">phpthumb_functions::IsHexColor</a>($this-&gt;config_error_bgcolor)) {
<a name="l02092"></a>02092                         <span class="keywordflow">return</span> $this-&gt;<a class="code" href="classphpthumb.html#a6ff71b425894fd846790cedf9f9cc97d">ErrorImage</a>(<span class="stringliteral">&#39;Invalid hex color string &quot;&#39;</span>.$this-&gt;config_error_bgcolor.<span class="stringliteral">&#39;&quot; for $this-&gt;config_error_bgcolor&#39;</span>);
<a name="l02093"></a>02093                 }
<a name="l02094"></a>02094                 <span class="keywordflow">if</span> (!<a class="code" href="classphpthumb__functions.html#aa88047663adfed917d5fb0bece3913b8">phpthumb_functions::IsHexColor</a>($this-&gt;config_error_textcolor)) {
<a name="l02095"></a>02095                         <span class="keywordflow">return</span> $this-&gt;<a class="code" href="classphpthumb.html#a6ff71b425894fd846790cedf9f9cc97d">ErrorImage</a>(<span class="stringliteral">&#39;Invalid hex color string &quot;&#39;</span>.$this-&gt;config_error_textcolor.<span class="stringliteral">&#39;&quot; for $this-&gt;config_error_textcolor&#39;</span>);
<a name="l02096"></a>02096                 }
<a name="l02097"></a>02097                 <span class="keywordflow">if</span> ($erase) {
<a name="l02098"></a>02098 
<a name="l02099"></a>02099                         <span class="keywordflow">return</span> $this-&gt;<a class="code" href="classphpthumb.html#a6ff71b425894fd846790cedf9f9cc97d">ErrorImage</a>($message, $this-&gt;thumbnail_width, $this-&gt;thumbnail_height, $this-&gt;config_error_bgcolor, $this-&gt;config_error_textcolor, $this-&gt;config_error_fontsize);
<a name="l02100"></a>02100 
<a name="l02101"></a>02101                 } <span class="keywordflow">else</span> {
<a name="l02102"></a>02102 
<a name="l02103"></a>02103                         $this-&gt;config_nooffsitelink_watermark_src = $this-&gt;<a class="code" href="classphpthumb.html#a49cc25fd831b2990b8f5743e8d6abe30">ResolveFilenameToAbsolute</a>($this-&gt;config_nooffsitelink_watermark_src);
<a name="l02104"></a>02104                         <span class="keywordflow">if</span> (is_file($this-&gt;config_nooffsitelink_watermark_src)) {
<a name="l02105"></a>02105 
<a name="l02106"></a>02106                                 <span class="keywordflow">if</span> (!include_once(dirname(__FILE__).<span class="stringliteral">&#39;/phpthumb.filters.php&#39;</span>)) {
<a name="l02107"></a>02107                                         $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;Error including &quot;&#39;</span>.dirname(__FILE__).<span class="stringliteral">&#39;/phpthumb.filters.php&quot; which is required for applying watermark&#39;</span>, __FILE__, __LINE__);
<a name="l02108"></a>02108                                         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02109"></a>02109                                 }
<a name="l02110"></a>02110                                 $watermark_img = $this-&gt;<a class="code" href="classphpthumb.html#a7a2d5f7e31c08dd71b834391cb7b1520">ImageCreateFromStringReplacement</a>(file_get_contents($this-&gt;config_nooffsitelink_watermark_src));
<a name="l02111"></a>02111                                 $phpthumbFilters = <span class="keyword">new</span> <a class="code" href="classphpthumb__filters.html">phpthumb_filters</a>();
<a name="l02112"></a>02112                                 $phpthumbFilters-&gt;phpThumbObject = &amp;$this;
<a name="l02113"></a>02113                                 $opacity = 50;
<a name="l02114"></a>02114                                 $margin  = 5;
<a name="l02115"></a>02115                                 $phpthumbFilters-&gt;WatermarkOverlay($this-&gt;gdimg_output, $watermark_img, <span class="charliteral">&#39;*&#39;</span>, $opacity, $margin);
<a name="l02116"></a>02116                                 ImageDestroy($watermark_img);
<a name="l02117"></a>02117                                 unset($phpthumbFilters);
<a name="l02118"></a>02118 
<a name="l02119"></a>02119                         } <span class="keywordflow">else</span> {
<a name="l02120"></a>02120 
<a name="l02121"></a>02121                                 $nohotlink_text_array = explode(<span class="stringliteral">&quot;\n&quot;</span>, wordwrap($message, floor($this-&gt;thumbnail_width / ImageFontWidth($this-&gt;config_error_fontsize)), <span class="stringliteral">&quot;\n&quot;</span>));
<a name="l02122"></a>02122                                 $nohotlink_text_color = <a class="code" href="classphpthumb__functions.html#a9a63d0b70df4136de64ab0cd351e7ff3">phpthumb_functions::ImageHexColorAllocate</a>($this-&gt;gdimg_output, $this-&gt;config_error_textcolor);
<a name="l02123"></a>02123 
<a name="l02124"></a>02124                                 $topoffset = round(($this-&gt;thumbnail_height - (count($nohotlink_text_array) * ImageFontHeight($this-&gt;config_error_fontsize))) / 2);
<a name="l02125"></a>02125 
<a name="l02126"></a>02126                                 $rowcounter = 0;
<a name="l02127"></a>02127                                 $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;AntiOffsiteLinking() writing &#39;</span>.count($nohotlink_text_array).<span class="stringliteral">&#39; lines of text &quot;&#39;</span>.$message.<span class="stringliteral">&#39;&quot; (in #&#39;</span>.$this-&gt;config_error_textcolor.<span class="stringliteral">&#39;) on top of image&#39;</span>, __FILE__, __LINE__);
<a name="l02128"></a>02128                                 <span class="keywordflow">foreach</span> ($nohotlink_text_array as $textline) {
<a name="l02129"></a>02129                                         $leftoffset = max(0, round(($this-&gt;thumbnail_width - (strlen($textline) * ImageFontWidth($this-&gt;config_error_fontsize))) / 2));
<a name="l02130"></a>02130                                         ImageString($this-&gt;gdimg_output, $this-&gt;config_error_fontsize, $leftoffset, $topoffset + ($rowcounter++ * ImageFontHeight($this-&gt;config_error_fontsize)), $textline, $nohotlink_text_color);
<a name="l02131"></a>02131                                 }
<a name="l02132"></a>02132 
<a name="l02133"></a>02133                         }
<a name="l02134"></a>02134 
<a name="l02135"></a>02135                 }
<a name="l02136"></a>02136                 <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l02137"></a>02137         }
<a name="l02138"></a>02138 
<a name="l02139"></a>02139 
<a name="l02140"></a><a class="code" href="classphpthumb.html#affcf07b54508c9914d0eb280b7ae91c0">02140</a>         <span class="keyword">function</span> <a class="code" href="classphpthumb.html#affcf07b54508c9914d0eb280b7ae91c0">AlphaChannelFlatten</a>() {
<a name="l02141"></a>02141                 <span class="keywordflow">if</span> (!$this-&gt;is_alpha) {
<a name="l02142"></a>02142                         <span class="comment">// image doesn&#39;t have alpha transparency, no need to flatten</span>
<a name="l02143"></a>02143                         $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;skipping AlphaChannelFlatten() because !$this-&gt;is_alpha&#39;</span>, __FILE__, __LINE__);
<a name="l02144"></a>02144                         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02145"></a>02145                 }
<a name="l02146"></a>02146                 <span class="keywordflow">switch</span> ($this-&gt;thumbnailFormat) {
<a name="l02147"></a>02147                         <span class="keywordflow">case</span> <span class="stringliteral">&#39;png&#39;</span>:
<a name="l02148"></a>02148                         <span class="keywordflow">case</span> <span class="stringliteral">&#39;ico&#39;</span>:
<a name="l02149"></a>02149                                 <span class="comment">// image has alpha transparency, but output as PNG or ICO which can handle it</span>
<a name="l02150"></a>02150                                 $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;skipping AlphaChannelFlatten() because ($this-&gt;thumbnailFormat == &quot;&#39;</span>.$this-&gt;thumbnailFormat.<span class="stringliteral">&#39;&quot;)&#39;</span>, __FILE__, __LINE__);
<a name="l02151"></a>02151                                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02152"></a>02152                                 <span class="keywordflow">break</span>;
<a name="l02153"></a>02153 
<a name="l02154"></a>02154                         <span class="keywordflow">case</span> <span class="stringliteral">&#39;gif&#39;</span>:
<a name="l02155"></a>02155                                 <span class="comment">// image has alpha transparency, but output as GIF which can handle only single-color transparency</span>
<a name="l02156"></a>02156                                 $CurrentImageColorTransparent = ImageColorTransparent($this-&gt;gdimg_output);
<a name="l02157"></a>02157                                 <span class="keywordflow">if</span> ($CurrentImageColorTransparent == -1) {
<a name="l02158"></a>02158                                         <span class="comment">// no transparent color defined</span>
<a name="l02159"></a>02159 
<a name="l02160"></a>02160                                         <span class="keywordflow">if</span> (<a class="code" href="classphpthumb__functions.html#aaaad487d4c5a61befc88ae061f8a64fe">phpthumb_functions::gd_version</a>() &lt; 2.0) {
<a name="l02161"></a>02161                                                 $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;AlphaChannelFlatten() failed because GD version is &quot;&#39;</span>.<a class="code" href="classphpthumb__functions.html#aaaad487d4c5a61befc88ae061f8a64fe">phpthumb_functions::gd_version</a>().<span class="charliteral">&#39;&quot;&#39;</span>, __FILE__, __LINE__);
<a name="l02162"></a>02162                                                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02163"></a>02163                                         }
<a name="l02164"></a>02164 
<a name="l02165"></a>02165                                         <span class="keywordflow">if</span> ($img_alpha_mixdown_dither = @ImageCreateTrueColor(ImageSX($this-&gt;gdimg_output), ImageSY($this-&gt;gdimg_output))) {
<a name="l02166"></a>02166 
<a name="l02167"></a>02167                                                 <span class="keywordflow">for</span> ($i = 0; $i &lt;= 255; $i++) {
<a name="l02168"></a>02168                                                         $dither_color[$i] = ImageColorAllocate($img_alpha_mixdown_dither, $i, $i, $i);
<a name="l02169"></a>02169                                                 }
<a name="l02170"></a>02170 
<a name="l02171"></a>02171                                                 <span class="comment">// scan through current truecolor image copy alpha channel to temp image as grayscale</span>
<a name="l02172"></a>02172                                                 <span class="keywordflow">for</span> ($x = 0; $x &lt; $this-&gt;thumbnail_width; $x++) {
<a name="l02173"></a>02173                                                         <span class="keywordflow">for</span> ($y = 0; $y &lt; $this-&gt;thumbnail_height; $y++) {
<a name="l02174"></a>02174                                                                 $PixelColor = <a class="code" href="classphpthumb__functions.html#ac73caf77553f599f9bdb88c03281b33b">phpthumb_functions::GetPixelColor</a>($this-&gt;gdimg_output, $x, $y);
<a name="l02175"></a>02175                                                                 ImageSetPixel($img_alpha_mixdown_dither, $x, $y, $dither_color[($PixelColor[<span class="stringliteral">&#39;alpha&#39;</span>] * 2)]);
<a name="l02176"></a>02176                                                         }
<a name="l02177"></a>02177                                                 }
<a name="l02178"></a>02178 
<a name="l02179"></a>02179                                                 <span class="comment">// dither alpha channel grayscale version down to 2 colors</span>
<a name="l02180"></a>02180                                                 ImageTrueColorToPalette($img_alpha_mixdown_dither, <span class="keyword">true</span>, 2);
<a name="l02181"></a>02181 
<a name="l02182"></a>02182                                                 <span class="comment">// reduce color palette to 256-1 colors (leave one palette position for transparent color)</span>
<a name="l02183"></a>02183                                                 ImageTrueColorToPalette($this-&gt;gdimg_output, <span class="keyword">true</span>, 255);
<a name="l02184"></a>02184 
<a name="l02185"></a>02185                                                 <span class="comment">// allocate a new color for transparent color index</span>
<a name="l02186"></a>02186                                                 $TransparentColor = ImageColorAllocate($this-&gt;gdimg_output, 1, 254, 253);
<a name="l02187"></a>02187                                                 ImageColorTransparent($this-&gt;gdimg_output, $TransparentColor);
<a name="l02188"></a>02188 
<a name="l02189"></a>02189                                                 <span class="comment">// scan through alpha channel image and note pixels with &gt;50% transparency</span>
<a name="l02190"></a>02190                                                 $TransparentPixels = array();
<a name="l02191"></a>02191                                                 <span class="keywordflow">for</span> ($x = 0; $x &lt; $this-&gt;thumbnail_width; $x++) {
<a name="l02192"></a>02192                                                         <span class="keywordflow">for</span> ($y = 0; $y &lt; $this-&gt;thumbnail_height; $y++) {
<a name="l02193"></a>02193                                                                 $AlphaChannelPixel = <a class="code" href="classphpthumb__functions.html#ac73caf77553f599f9bdb88c03281b33b">phpthumb_functions::GetPixelColor</a>($img_alpha_mixdown_dither, $x, $y);
<a name="l02194"></a>02194                                                                 <span class="keywordflow">if</span> ($AlphaChannelPixel[<span class="stringliteral">&#39;red&#39;</span>] &gt; 127) {
<a name="l02195"></a>02195                                                                         ImageSetPixel($this-&gt;gdimg_output, $x, $y, $TransparentColor);
<a name="l02196"></a>02196                                                                 }
<a name="l02197"></a>02197                                                         }
<a name="l02198"></a>02198                                                 }
<a name="l02199"></a>02199                                                 ImageDestroy($img_alpha_mixdown_dither);
<a name="l02200"></a>02200 
<a name="l02201"></a>02201                                                 $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;AlphaChannelFlatten() set image to 255+1 colors with transparency for GIF output&#39;</span>, __FILE__, __LINE__);
<a name="l02202"></a>02202                                                 <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l02203"></a>02203 
<a name="l02204"></a>02204                                         } <span class="keywordflow">else</span> {
<a name="l02205"></a>02205                                                 $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;AlphaChannelFlatten() failed ImageCreate(&#39;</span>.ImageSX($this-&gt;gdimg_output).<span class="stringliteral">&#39;, &#39;</span>.ImageSY($this-&gt;gdimg_output).<span class="charliteral">&#39;)&#39;</span>, __FILE__, __LINE__);
<a name="l02206"></a>02206                                                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02207"></a>02207                                         }
<a name="l02208"></a>02208 
<a name="l02209"></a>02209                                 } <span class="keywordflow">else</span> {
<a name="l02210"></a>02210                                         <span class="comment">// a single transparent color already defined, leave as-is</span>
<a name="l02211"></a>02211                                         $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;skipping AlphaChannelFlatten() because ($this-&gt;thumbnailFormat == &quot;&#39;</span>.$this-&gt;thumbnailFormat.<span class="stringliteral">&#39;&quot;) and ImageColorTransparent returned &quot;&#39;</span>.$CurrentImageColorTransparent.<span class="charliteral">&#39;&quot;&#39;</span>, __FILE__, __LINE__);
<a name="l02212"></a>02212                                         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l02213"></a>02213                                 }
<a name="l02214"></a>02214                                 <span class="keywordflow">break</span>;
<a name="l02215"></a>02215                 }
<a name="l02216"></a>02216                 $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;continuing AlphaChannelFlatten() for output format &quot;&#39;</span>.$this-&gt;thumbnailFormat.<span class="charliteral">&#39;&quot;&#39;</span>, __FILE__, __LINE__);
<a name="l02217"></a>02217                 <span class="comment">// image has alpha transparency, and is being output in a format that doesn&#39;t support it -- flatten</span>
<a name="l02218"></a>02218                 <span class="keywordflow">if</span> ($gdimg_flatten_temp = <a class="code" href="classphpthumb__functions.html#a02caac9e703a9c106e3fea3a6215130d">phpthumb_functions::ImageCreateFunction</a>($this-&gt;thumbnail_width, $this-&gt;thumbnail_height)) {
<a name="l02219"></a>02219 
<a name="l02220"></a>02220                         $this-&gt;config_background_hexcolor = ($this-&gt;bg ? $this-&gt;bg : $this-&gt;config_background_hexcolor);
<a name="l02221"></a>02221                         <span class="keywordflow">if</span> (!<a class="code" href="classphpthumb__functions.html#aa88047663adfed917d5fb0bece3913b8">phpthumb_functions::IsHexColor</a>($this-&gt;config_background_hexcolor)) {
<a name="l02222"></a>02222                                 <span class="keywordflow">return</span> $this-&gt;<a class="code" href="classphpthumb.html#a6ff71b425894fd846790cedf9f9cc97d">ErrorImage</a>(<span class="stringliteral">&#39;Invalid hex color string &quot;&#39;</span>.$this-&gt;config_background_hexcolor.<span class="stringliteral">&#39;&quot; for parameter &quot;bg&quot;&#39;</span>);
<a name="l02223"></a>02223                         }
<a name="l02224"></a>02224                         $background_color = <a class="code" href="classphpthumb__functions.html#a9a63d0b70df4136de64ab0cd351e7ff3">phpthumb_functions::ImageHexColorAllocate</a>($this-&gt;gdimg_output, $this-&gt;config_background_hexcolor);
<a name="l02225"></a>02225                         ImageFilledRectangle($gdimg_flatten_temp, 0, 0, $this-&gt;thumbnail_width, $this-&gt;thumbnail_height, $background_color);
<a name="l02226"></a>02226                         ImageCopy($gdimg_flatten_temp, $this-&gt;gdimg_output, 0, 0, 0, 0, $this-&gt;thumbnail_width, $this-&gt;thumbnail_height);
<a name="l02227"></a>02227 
<a name="l02228"></a>02228                         ImageAlphaBlending($this-&gt;gdimg_output, <span class="keyword">true</span>);
<a name="l02229"></a>02229                         ImageSaveAlpha($this-&gt;gdimg_output, <span class="keyword">false</span>);
<a name="l02230"></a>02230                         ImageColorTransparent($this-&gt;gdimg_output, -1);
<a name="l02231"></a>02231                         ImageCopy($this-&gt;gdimg_output, $gdimg_flatten_temp, 0, 0, 0, 0, $this-&gt;thumbnail_width, $this-&gt;thumbnail_height);
<a name="l02232"></a>02232 
<a name="l02233"></a>02233                         ImageDestroy($gdimg_flatten_temp);
<a name="l02234"></a>02234                         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l02235"></a>02235 
<a name="l02236"></a>02236                 } <span class="keywordflow">else</span> {
<a name="l02237"></a>02237                         $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;ImageCreateFunction() failed&#39;</span>, __FILE__, __LINE__);
<a name="l02238"></a>02238                 }
<a name="l02239"></a>02239                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02240"></a>02240         }
<a name="l02241"></a>02241 
<a name="l02242"></a>02242 
<a name="l02243"></a><a class="code" href="classphpthumb.html#ae5888b30377b0c4cedc8953ea9958a87">02243</a>         <span class="keyword">function</span> <a class="code" href="classphpthumb.html#ae5888b30377b0c4cedc8953ea9958a87">ApplyFilters</a>() {
<a name="l02244"></a>02244                 <span class="keywordflow">if</span> ($this-&gt;fltr &amp;&amp; is_array($this-&gt;fltr)) {
<a name="l02245"></a>02245                         <span class="keywordflow">if</span> (!include_once(dirname(__FILE__).<span class="stringliteral">&#39;/phpthumb.filters.php&#39;</span>)) {
<a name="l02246"></a>02246                                 $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;Error including &quot;&#39;</span>.dirname(__FILE__).<span class="stringliteral">&#39;/phpthumb.filters.php&quot; which is required for applying filters (&#39;</span>.implode(<span class="charliteral">&#39;;&#39;</span>, $this-&gt;fltr).<span class="charliteral">&#39;)&#39;</span>, __FILE__, __LINE__);
<a name="l02247"></a>02247                                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02248"></a>02248                         }
<a name="l02249"></a>02249                         $phpthumbFilters = <span class="keyword">new</span> <a class="code" href="classphpthumb__filters.html">phpthumb_filters</a>();
<a name="l02250"></a>02250                         $phpthumbFilters-&gt;phpThumbObject = &amp;$this;
<a name="l02251"></a>02251                         <span class="keywordflow">foreach</span> ($this-&gt;fltr as $filtercommand) {
<a name="l02252"></a>02252                                 @list($command, $parameter) = explode(<span class="charliteral">&#39;|&#39;</span>, $filtercommand, 2);
<a name="l02253"></a>02253                                 $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;Attempting to process filter command &quot;&#39;</span>.$command.<span class="charliteral">&#39;(&#39;</span>.$parameter.<span class="stringliteral">&#39;)&quot;&#39;</span>, __FILE__, __LINE__);
<a name="l02254"></a>02254                                 <span class="keywordflow">switch</span> ($command) {
<a name="l02255"></a>02255                                         <span class="keywordflow">case</span> <span class="stringliteral">&#39;brit&#39;</span>: <span class="comment">// Brightness</span>
<a name="l02256"></a>02256                                                 $phpthumbFilters-&gt;Brightness($this-&gt;gdimg_output, $parameter);
<a name="l02257"></a>02257                                                 <span class="keywordflow">break</span>;
<a name="l02258"></a>02258 
<a name="l02259"></a>02259                                         <span class="keywordflow">case</span> <span class="stringliteral">&#39;cont&#39;</span>: <span class="comment">// Contrast</span>
<a name="l02260"></a>02260                                                 $phpthumbFilters-&gt;Contrast($this-&gt;gdimg_output, $parameter);
<a name="l02261"></a>02261                                                 <span class="keywordflow">break</span>;
<a name="l02262"></a>02262 
<a name="l02263"></a>02263                                         <span class="keywordflow">case</span> <span class="stringliteral">&#39;ds&#39;</span>: <span class="comment">// Desaturation</span>
<a name="l02264"></a>02264                                                 $phpthumbFilters-&gt;Desaturate($this-&gt;gdimg_output, $parameter, <span class="stringliteral">&#39;&#39;</span>);
<a name="l02265"></a>02265                                                 <span class="keywordflow">break</span>;
<a name="l02266"></a>02266 
<a name="l02267"></a>02267                                         <span class="keywordflow">case</span> <span class="stringliteral">&#39;sat&#39;</span>: <span class="comment">// Saturation</span>
<a name="l02268"></a>02268                                                 $phpthumbFilters-&gt;Saturation($this-&gt;gdimg_output, $parameter, <span class="stringliteral">&#39;&#39;</span>);
<a name="l02269"></a>02269                                                 <span class="keywordflow">break</span>;
<a name="l02270"></a>02270 
<a name="l02271"></a>02271                                         <span class="keywordflow">case</span> <span class="stringliteral">&#39;gray&#39;</span>: <span class="comment">// Grayscale</span>
<a name="l02272"></a>02272                                                 $phpthumbFilters-&gt;Grayscale($this-&gt;gdimg_output);
<a name="l02273"></a>02273                                                 <span class="keywordflow">break</span>;
<a name="l02274"></a>02274 
<a name="l02275"></a>02275                                         <span class="keywordflow">case</span> <span class="stringliteral">&#39;clr&#39;</span>: <span class="comment">// Colorize</span>
<a name="l02276"></a>02276                                                 <span class="keywordflow">if</span> (<a class="code" href="classphpthumb__functions.html#aaaad487d4c5a61befc88ae061f8a64fe">phpthumb_functions::gd_version</a>() &lt; 2) {
<a name="l02277"></a>02277                                                         $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;Skipping Colorize() because gd_version is &quot;&#39;</span>.<a class="code" href="classphpthumb__functions.html#aaaad487d4c5a61befc88ae061f8a64fe">phpthumb_functions::gd_version</a>().<span class="charliteral">&#39;&quot;&#39;</span>, __FILE__, __LINE__);
<a name="l02278"></a>02278                                                         <span class="keywordflow">break</span>;
<a name="l02279"></a>02279                                                 }
<a name="l02280"></a>02280                                                 @list($amount, $color) = explode(<span class="charliteral">&#39;|&#39;</span>, $parameter);
<a name="l02281"></a>02281                                                 $phpthumbFilters-&gt;Colorize($this-&gt;gdimg_output, $amount, $color);
<a name="l02282"></a>02282                                                 <span class="keywordflow">break</span>;
<a name="l02283"></a>02283 
<a name="l02284"></a>02284                                         <span class="keywordflow">case</span> <span class="stringliteral">&#39;sep&#39;</span>: <span class="comment">// Sepia</span>
<a name="l02285"></a>02285                                                 <span class="keywordflow">if</span> (<a class="code" href="classphpthumb__functions.html#aaaad487d4c5a61befc88ae061f8a64fe">phpthumb_functions::gd_version</a>() &lt; 2) {
<a name="l02286"></a>02286                                                         $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;Skipping Sepia() because gd_version is &quot;&#39;</span>.<a class="code" href="classphpthumb__functions.html#aaaad487d4c5a61befc88ae061f8a64fe">phpthumb_functions::gd_version</a>().<span class="charliteral">&#39;&quot;&#39;</span>, __FILE__, __LINE__);
<a name="l02287"></a>02287                                                         <span class="keywordflow">break</span>;
<a name="l02288"></a>02288                                                 }
<a name="l02289"></a>02289                                                 @list($amount, $color) = explode(<span class="charliteral">&#39;|&#39;</span>, $parameter);
<a name="l02290"></a>02290                                                 $phpthumbFilters-&gt;Sepia($this-&gt;gdimg_output, $amount, $color);
<a name="l02291"></a>02291                                                 <span class="keywordflow">break</span>;
<a name="l02292"></a>02292 
<a name="l02293"></a>02293                                         <span class="keywordflow">case</span> <span class="stringliteral">&#39;gam&#39;</span>: <span class="comment">// Gamma correction</span>
<a name="l02294"></a>02294                                                 $phpthumbFilters-&gt;Gamma($this-&gt;gdimg_output, $parameter);
<a name="l02295"></a>02295                                                 <span class="keywordflow">break</span>;
<a name="l02296"></a>02296 
<a name="l02297"></a>02297                                         <span class="keywordflow">case</span> <span class="stringliteral">&#39;neg&#39;</span>: <span class="comment">// Negative colors</span>
<a name="l02298"></a>02298                                                 $phpthumbFilters-&gt;Negative($this-&gt;gdimg_output);
<a name="l02299"></a>02299                                                 <span class="keywordflow">break</span>;
<a name="l02300"></a>02300 
<a name="l02301"></a>02301                                         <span class="keywordflow">case</span> <span class="stringliteral">&#39;th&#39;</span>: <span class="comment">// Threshold</span>
<a name="l02302"></a>02302                                                 $phpthumbFilters-&gt;Threshold($this-&gt;gdimg_output, $parameter);
<a name="l02303"></a>02303                                                 <span class="keywordflow">break</span>;
<a name="l02304"></a>02304 
<a name="l02305"></a>02305                                         <span class="keywordflow">case</span> <span class="stringliteral">&#39;rcd&#39;</span>: <span class="comment">// ReduceColorDepth</span>
<a name="l02306"></a>02306                                                 <span class="keywordflow">if</span> (<a class="code" href="classphpthumb__functions.html#aaaad487d4c5a61befc88ae061f8a64fe">phpthumb_functions::gd_version</a>() &lt; 2) {
<a name="l02307"></a>02307                                                         $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;Skipping ReduceColorDepth() because gd_version is &quot;&#39;</span>.<a class="code" href="classphpthumb__functions.html#aaaad487d4c5a61befc88ae061f8a64fe">phpthumb_functions::gd_version</a>().<span class="charliteral">&#39;&quot;&#39;</span>, __FILE__, __LINE__);
<a name="l02308"></a>02308                                                         <span class="keywordflow">break</span>;
<a name="l02309"></a>02309                                                 }
<a name="l02310"></a>02310                                                 @list($colors, $dither) = explode(<span class="charliteral">&#39;|&#39;</span>, $parameter);
<a name="l02311"></a>02311                                                 $colors = ($colors                ?  (int) $colors : 256);
<a name="l02312"></a>02312                                                 $dither  = ((strlen($dither) &gt; 0) ? (<span class="keywordtype">bool</span>) $dither : <span class="keyword">true</span>);
<a name="l02313"></a>02313                                                 $phpthumbFilters-&gt;ReduceColorDepth($this-&gt;gdimg_output, $colors, $dither);
<a name="l02314"></a>02314                                                 <span class="keywordflow">break</span>;
<a name="l02315"></a>02315 
<a name="l02316"></a>02316                                         <span class="keywordflow">case</span> <span class="stringliteral">&#39;flip&#39;</span>: <span class="comment">// Flip</span>
<a name="l02317"></a>02317                                                 $phpthumbFilters-&gt;Flip($this-&gt;gdimg_output, (strpos(strtolower($parameter), <span class="charliteral">&#39;x&#39;</span>) !== <span class="keyword">false</span>), (strpos(strtolower($parameter), <span class="charliteral">&#39;y&#39;</span>) !== <span class="keyword">false</span>));
<a name="l02318"></a>02318                                                 <span class="keywordflow">break</span>;
<a name="l02319"></a>02319 
<a name="l02320"></a>02320                                         <span class="keywordflow">case</span> <span class="stringliteral">&#39;edge&#39;</span>: <span class="comment">// EdgeDetect</span>
<a name="l02321"></a>02321                                                 $phpthumbFilters-&gt;EdgeDetect($this-&gt;gdimg_output);
<a name="l02322"></a>02322                                                 <span class="keywordflow">break</span>;
<a name="l02323"></a>02323 
<a name="l02324"></a>02324                                         <span class="keywordflow">case</span> <span class="stringliteral">&#39;emb&#39;</span>: <span class="comment">// Emboss</span>
<a name="l02325"></a>02325                                                 $phpthumbFilters-&gt;Emboss($this-&gt;gdimg_output);
<a name="l02326"></a>02326                                                 <span class="keywordflow">break</span>;
<a name="l02327"></a>02327 
<a name="l02328"></a>02328                                         <span class="keywordflow">case</span> <span class="stringliteral">&#39;bvl&#39;</span>: <span class="comment">// Bevel</span>
<a name="l02329"></a>02329                                                 @list($width, $color1, $color2) = explode(<span class="charliteral">&#39;|&#39;</span>, $parameter);
<a name="l02330"></a>02330                                                 $phpthumbFilters-&gt;Bevel($this-&gt;gdimg_output, $width, $color1, $color2);
<a name="l02331"></a>02331                                                 <span class="keywordflow">break</span>;
<a name="l02332"></a>02332 
<a name="l02333"></a>02333                                         <span class="keywordflow">case</span> <span class="stringliteral">&#39;lvl&#39;</span>: <span class="comment">// autoLevels</span>
<a name="l02334"></a>02334                                                 @list($band, $method, $threshold) = explode(<span class="charliteral">&#39;|&#39;</span>, $parameter);
<a name="l02335"></a>02335                                                 $band      = ($band ? ereg_replace(<span class="stringliteral">&#39;[^RGBA\\*]&#39;</span>, <span class="stringliteral">&#39;&#39;</span>, strtoupper($band)) : <span class="charliteral">&#39;*&#39;</span>);
<a name="l02336"></a>02336                                                 $method    = ((strlen($method) &gt; 0)    ? intval($method)                :   2);
<a name="l02337"></a>02337                                                 $threshold = ((strlen($threshold) &gt; 0) ? floatval($threshold)           : 0.1);
<a name="l02338"></a>02338 
<a name="l02339"></a>02339                                                 $phpthumbFilters-&gt;HistogramStretch($this-&gt;gdimg_output, $band, $method, $threshold);
<a name="l02340"></a>02340                                                 <span class="keywordflow">break</span>;
<a name="l02341"></a>02341 
<a name="l02342"></a>02342                                         <span class="keywordflow">case</span> <span class="stringliteral">&#39;wb&#39;</span>: <span class="comment">// WhiteBalance</span>
<a name="l02343"></a>02343                                                 $phpthumbFilters-&gt;WhiteBalance($this-&gt;gdimg_output, $parameter);
<a name="l02344"></a>02344                                                 <span class="keywordflow">break</span>;
<a name="l02345"></a>02345 
<a name="l02346"></a>02346                                         <span class="keywordflow">case</span> <span class="stringliteral">&#39;hist&#39;</span>: <span class="comment">// Histogram overlay</span>
<a name="l02347"></a>02347                                                 <span class="keywordflow">if</span> (<a class="code" href="classphpthumb__functions.html#aaaad487d4c5a61befc88ae061f8a64fe">phpthumb_functions::gd_version</a>() &lt; 2) {
<a name="l02348"></a>02348                                                         $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;Skipping HistogramOverlay() because gd_version is &quot;&#39;</span>.<a class="code" href="classphpthumb__functions.html#aaaad487d4c5a61befc88ae061f8a64fe">phpthumb_functions::gd_version</a>().<span class="charliteral">&#39;&quot;&#39;</span>, __FILE__, __LINE__);
<a name="l02349"></a>02349                                                         <span class="keywordflow">break</span>;
<a name="l02350"></a>02350                                                 }
<a name="l02351"></a>02351                                                 @list($bands, $colors, $width, $height, $alignment, $opacity, $margin_x, $margin_y) = explode(<span class="charliteral">&#39;|&#39;</span>, $parameter);
<a name="l02352"></a>02352                                                 $bands     = ($bands     ? $bands     :  <span class="charliteral">&#39;*&#39;</span>);
<a name="l02353"></a>02353                                                 $colors    = ($colors    ? $colors    :   <span class="stringliteral">&#39;&#39;</span>);
<a name="l02354"></a>02354                                                 $width     = ($width     ? $width     : 0.25);
<a name="l02355"></a>02355                                                 $height    = ($height    ? $height    : 0.25);
<a name="l02356"></a>02356                                                 $alignment = ($alignment ? $alignment : <span class="stringliteral">&#39;BR&#39;</span>);
<a name="l02357"></a>02357                                                 $opacity   = ($opacity   ? $opacity   :   50);
<a name="l02358"></a>02358                                                 $margin_x  = ($margin_x  ? $margin_x  :    5);
<a name="l02359"></a>02359                                                 $margin_y  = $margin_y; <span class="comment">// just to note it wasn&#39;t forgotten, but let the value always pass unchanged</span>
<a name="l02360"></a>02360                                                 $phpthumbFilters-&gt;HistogramOverlay($this-&gt;gdimg_output, $bands, $colors, $width, $height, $alignment, $opacity, $margin_x, $margin_y);
<a name="l02361"></a>02361                                                 <span class="keywordflow">break</span>;
<a name="l02362"></a>02362 
<a name="l02363"></a>02363                                         <span class="keywordflow">case</span> <span class="stringliteral">&#39;fram&#39;</span>: <span class="comment">// Frame</span>
<a name="l02364"></a>02364                                                 @list($frame_width, $edge_width, $color_frame, $color1, $color2) = explode(<span class="charliteral">&#39;|&#39;</span>, $parameter);
<a name="l02365"></a>02365                                                 $phpthumbFilters-&gt;Frame($this-&gt;gdimg_output, $frame_width, $edge_width, $color_frame, $color1, $color2);
<a name="l02366"></a>02366                                                 <span class="keywordflow">break</span>;
<a name="l02367"></a>02367 
<a name="l02368"></a>02368                                         <span class="keywordflow">case</span> <span class="stringliteral">&#39;drop&#39;</span>: <span class="comment">// DropShadow</span>
<a name="l02369"></a>02369                                                 <span class="keywordflow">if</span> (<a class="code" href="classphpthumb__functions.html#aaaad487d4c5a61befc88ae061f8a64fe">phpthumb_functions::gd_version</a>() &lt; 2) {
<a name="l02370"></a>02370                                                         $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;Skipping DropShadow() because gd_version is &quot;&#39;</span>.<a class="code" href="classphpthumb__functions.html#aaaad487d4c5a61befc88ae061f8a64fe">phpthumb_functions::gd_version</a>().<span class="charliteral">&#39;&quot;&#39;</span>, __FILE__, __LINE__);
<a name="l02371"></a>02371                                                         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02372"></a>02372                                                 }
<a name="l02373"></a>02373                                                 $this-&gt;is_alpha = <span class="keyword">true</span>;
<a name="l02374"></a>02374                                                 @list($distance, $width, $color, $angle, $fade) = explode(<span class="charliteral">&#39;|&#39;</span>, $parameter);
<a name="l02375"></a>02375                                                 $phpthumbFilters-&gt;DropShadow($this-&gt;gdimg_output, $distance, $width, $color, $angle, $fade);
<a name="l02376"></a>02376                                                 <span class="keywordflow">break</span>;
<a name="l02377"></a>02377 
<a name="l02378"></a>02378                                         <span class="keywordflow">case</span> <span class="stringliteral">&#39;mask&#39;</span>: <span class="comment">// Mask cropping</span>
<a name="l02379"></a>02379                                                 <span class="keywordflow">if</span> (<a class="code" href="classphpthumb__functions.html#aaaad487d4c5a61befc88ae061f8a64fe">phpthumb_functions::gd_version</a>() &lt; 2) {
<a name="l02380"></a>02380                                                         $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;Skipping Mask() because gd_version is &quot;&#39;</span>.<a class="code" href="classphpthumb__functions.html#aaaad487d4c5a61befc88ae061f8a64fe">phpthumb_functions::gd_version</a>().<span class="charliteral">&#39;&quot;&#39;</span>, __FILE__, __LINE__);
<a name="l02381"></a>02381                                                         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02382"></a>02382                                                 }
<a name="l02383"></a>02383                                                 $mask_filename = $this-&gt;<a class="code" href="classphpthumb.html#a49cc25fd831b2990b8f5743e8d6abe30">ResolveFilenameToAbsolute</a>($parameter);
<a name="l02384"></a>02384                                                 <span class="keywordflow">if</span> (@is_readable($mask_filename) &amp;&amp; ($fp_mask = @fopen($mask_filename, <span class="stringliteral">&#39;rb&#39;</span>))) {
<a name="l02385"></a>02385                                                         $MaskImageData = <span class="stringliteral">&#39;&#39;</span>;
<a name="l02386"></a>02386                                                         <span class="keywordflow">do</span> {
<a name="l02387"></a>02387                                                                 $buffer = fread($fp_mask, 8192);
<a name="l02388"></a>02388                                                                 $MaskImageData .= $buffer;
<a name="l02389"></a>02389                                                         } <span class="keywordflow">while</span> (strlen($buffer) &gt; 0);
<a name="l02390"></a>02390                                                         fclose($fp_mask);
<a name="l02391"></a>02391                                                         <span class="keywordflow">if</span> ($gdimg_mask = $this-&gt;<a class="code" href="classphpthumb.html#a7a2d5f7e31c08dd71b834391cb7b1520">ImageCreateFromStringReplacement</a>($MaskImageData)) {
<a name="l02392"></a>02392                                                                 $this-&gt;is_alpha = <span class="keyword">true</span>;
<a name="l02393"></a>02393                                                                 $phpthumbFilters-&gt;ApplyMask($gdimg_mask, $this-&gt;gdimg_output);
<a name="l02394"></a>02394                                                                 ImageDestroy($gdimg_mask);
<a name="l02395"></a>02395                                                         } <span class="keywordflow">else</span> {
<a name="l02396"></a>02396                                                                 $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;ImageCreateFromStringReplacement() failed for &quot;&#39;</span>.$mask_filename.<span class="charliteral">&#39;&quot;&#39;</span>, __FILE__, __LINE__);
<a name="l02397"></a>02397                                                         }
<a name="l02398"></a>02398                                                 } <span class="keywordflow">else</span> {
<a name="l02399"></a>02399                                                         $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;Cannot open mask file &quot;&#39;</span>.$mask_filename.<span class="charliteral">&#39;&quot;&#39;</span>, __FILE__, __LINE__);
<a name="l02400"></a>02400                                                 }
<a name="l02401"></a>02401                                                 <span class="keywordflow">break</span>;
<a name="l02402"></a>02402 
<a name="l02403"></a>02403                                         <span class="keywordflow">case</span> <span class="stringliteral">&#39;elip&#39;</span>: <span class="comment">// Elipse cropping</span>
<a name="l02404"></a>02404                                                 <span class="keywordflow">if</span> (<a class="code" href="classphpthumb__functions.html#aaaad487d4c5a61befc88ae061f8a64fe">phpthumb_functions::gd_version</a>() &lt; 2) {
<a name="l02405"></a>02405                                                         $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;Skipping Elipse() because gd_version is &quot;&#39;</span>.<a class="code" href="classphpthumb__functions.html#aaaad487d4c5a61befc88ae061f8a64fe">phpthumb_functions::gd_version</a>().<span class="charliteral">&#39;&quot;&#39;</span>, __FILE__, __LINE__);
<a name="l02406"></a>02406                                                         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02407"></a>02407                                                 }
<a name="l02408"></a>02408                                                 $this-&gt;is_alpha = <span class="keyword">true</span>;
<a name="l02409"></a>02409                                                 $phpthumbFilters-&gt;Elipse($this-&gt;gdimg_output);
<a name="l02410"></a>02410                                                 <span class="keywordflow">break</span>;
<a name="l02411"></a>02411 
<a name="l02412"></a>02412                                         <span class="keywordflow">case</span> <span class="stringliteral">&#39;ric&#39;</span>: <span class="comment">// RoundedImageCorners</span>
<a name="l02413"></a>02413                                                 <span class="keywordflow">if</span> (<a class="code" href="classphpthumb__functions.html#aaaad487d4c5a61befc88ae061f8a64fe">phpthumb_functions::gd_version</a>() &lt; 2) {
<a name="l02414"></a>02414                                                         $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;Skipping RoundedImageCorners() because gd_version is &quot;&#39;</span>.<a class="code" href="classphpthumb__functions.html#aaaad487d4c5a61befc88ae061f8a64fe">phpthumb_functions::gd_version</a>().<span class="charliteral">&#39;&quot;&#39;</span>, __FILE__, __LINE__);
<a name="l02415"></a>02415                                                         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02416"></a>02416                                                 }
<a name="l02417"></a>02417                                                 @list($radius_x, $radius_y) = explode(<span class="charliteral">&#39;|&#39;</span>, $parameter);
<a name="l02418"></a>02418                                                 <span class="keywordflow">if</span> (($radius_x &lt; 1) || ($radius_y &lt; 1)) {
<a name="l02419"></a>02419                                                         $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;Skipping RoundedImageCorners(&#39;</span>.$radius_x.<span class="stringliteral">&#39;, &#39;</span>.$radius_y.<span class="stringliteral">&#39;) because x/y radius is less than 1&#39;</span>, __FILE__, __LINE__);
<a name="l02420"></a>02420                                                         <span class="keywordflow">break</span>;
<a name="l02421"></a>02421                                                 }
<a name="l02422"></a>02422                                                 $this-&gt;is_alpha = <span class="keyword">true</span>;
<a name="l02423"></a>02423                                                 $phpthumbFilters-&gt;RoundedImageCorners($this-&gt;gdimg_output, $radius_x, $radius_y);
<a name="l02424"></a>02424                                                 <span class="keywordflow">break</span>;
<a name="l02425"></a>02425 
<a name="l02426"></a>02426                                         <span class="keywordflow">case</span> <span class="stringliteral">&#39;crop&#39;</span>: <span class="comment">// Crop</span>
<a name="l02427"></a>02427                                                 @list($left, $right, $top, $bottom) = explode(<span class="charliteral">&#39;|&#39;</span>, $parameter);
<a name="l02428"></a>02428                                                 $phpthumbFilters-&gt;Crop($this-&gt;gdimg_output, $left, $right, $top, $bottom);
<a name="l02429"></a>02429                                                 <span class="keywordflow">break</span>;
<a name="l02430"></a>02430 
<a name="l02431"></a>02431                                         <span class="keywordflow">case</span> <span class="stringliteral">&#39;bord&#39;</span>: <span class="comment">// Border</span>
<a name="l02432"></a>02432                                                 @list($border_width, $radius_x, $radius_y, $hexcolor_border) = explode(<span class="charliteral">&#39;|&#39;</span>, $parameter);
<a name="l02433"></a>02433                                                 $this-&gt;is_alpha = <span class="keyword">true</span>;
<a name="l02434"></a>02434                                                 $phpthumbFilters-&gt;ImageBorder($this-&gt;gdimg_output, $border_width, $radius_x, $radius_y, $hexcolor_border);
<a name="l02435"></a>02435                                                 <span class="keywordflow">break</span>;
<a name="l02436"></a>02436 
<a name="l02437"></a>02437                                         <span class="keywordflow">case</span> <span class="stringliteral">&#39;over&#39;</span>: <span class="comment">// Overlay</span>
<a name="l02438"></a>02438                                                 @list(<a class="code" href="actions_8php.html#a6b7de8d10c540db2f1631e68b2aa0538">$filename</a>, $underlay, $margin, $opacity) = explode(<span class="charliteral">&#39;|&#39;</span>, $parameter);
<a name="l02439"></a>02439                                                 $underlay = (bool) ($underlay              ? $underlay : <span class="keyword">false</span>);
<a name="l02440"></a>02440                                                 $margin   =        ((strlen($margin)  &gt; 0) ? $margin   : ($underlay ? 0.1 : 0.0));
<a name="l02441"></a>02441                                                 $opacity  =        ((strlen($opacity) &gt; 0) ? $opacity  : 100);
<a name="l02442"></a>02442                                                 <span class="keywordflow">if</span> (($margin &gt; 0) &amp;&amp; ($margin &lt; 1)) {
<a name="l02443"></a>02443                                                         $margin = min(0.499, $margin);
<a name="l02444"></a>02444                                                 } <a class="code" href="php_thumb_8demo_8check_8php.html#af92779326267616cd7c3cdaaa9484bc9">elseif</a> (($margin &gt; -1) &amp;&amp; ($margin &lt; 0)) {
<a name="l02445"></a>02445                                                         $margin = max(-0.499, $margin);
<a name="l02446"></a>02446                                                 }
<a name="l02447"></a>02447 
<a name="l02448"></a>02448                                                 <a class="code" href="actions_8php.html#a6b7de8d10c540db2f1631e68b2aa0538">$filename</a> = $this-&gt;<a class="code" href="classphpthumb.html#a49cc25fd831b2990b8f5743e8d6abe30">ResolveFilenameToAbsolute</a>(<a class="code" href="actions_8php.html#a6b7de8d10c540db2f1631e68b2aa0538">$filename</a>);
<a name="l02449"></a>02449                                                 <span class="keywordflow">if</span> (@is_readable(<a class="code" href="actions_8php.html#a6b7de8d10c540db2f1631e68b2aa0538">$filename</a>) &amp;&amp; ($fp_watermark = @fopen(<a class="code" href="actions_8php.html#a6b7de8d10c540db2f1631e68b2aa0538">$filename</a>, <span class="stringliteral">&#39;rb&#39;</span>))) {
<a name="l02450"></a>02450                                                         $WatermarkImageData = <span class="stringliteral">&#39;&#39;</span>;
<a name="l02451"></a>02451                                                         <span class="keywordflow">do</span> {
<a name="l02452"></a>02452                                                                 $buffer = fread($fp_watermark, 8192);
<a name="l02453"></a>02453                                                                 $WatermarkImageData .= $buffer;
<a name="l02454"></a>02454                                                         } <span class="keywordflow">while</span> (strlen($buffer) &gt; 0);
<a name="l02455"></a>02455                                                         fclose($fp_watermark);
<a name="l02456"></a>02456                                                         <span class="keywordflow">if</span> ($img_watermark = $this-&gt;<a class="code" href="classphpthumb.html#a7a2d5f7e31c08dd71b834391cb7b1520">ImageCreateFromStringReplacement</a>($WatermarkImageData)) {
<a name="l02457"></a>02457                                                                 <span class="keywordflow">if</span> ($margin &lt; 1) {
<a name="l02458"></a>02458                                                                         $resized_x = max(1, ImageSX($this-&gt;gdimg_output) - round(2 * (ImageSX($this-&gt;gdimg_output) * $margin)));
<a name="l02459"></a>02459                                                                         $resized_y = max(1, ImageSY($this-&gt;gdimg_output) - round(2 * (ImageSY($this-&gt;gdimg_output) * $margin)));
<a name="l02460"></a>02460                                                                 } <span class="keywordflow">else</span> {
<a name="l02461"></a>02461                                                                         $resized_x = max(1, ImageSX($this-&gt;gdimg_output) - round(2 * $margin));
<a name="l02462"></a>02462                                                                         $resized_y = max(1, ImageSY($this-&gt;gdimg_output) - round(2 * $margin));
<a name="l02463"></a>02463                                                                 }
<a name="l02464"></a>02464 
<a name="l02465"></a>02465                                                                 <span class="keywordflow">if</span> ($underlay) {
<a name="l02466"></a>02466 
<a name="l02467"></a>02467                                                                         <span class="keywordflow">if</span> ($img_watermark_resized = <a class="code" href="classphpthumb__functions.html#a02caac9e703a9c106e3fea3a6215130d">phpthumb_functions::ImageCreateFunction</a>(ImageSX($this-&gt;gdimg_output), ImageSY($this-&gt;gdimg_output))) {
<a name="l02468"></a>02468                                                                                 ImageAlphaBlending($img_watermark_resized, <span class="keyword">false</span>);
<a name="l02469"></a>02469                                                                                 ImageSaveAlpha($img_watermark_resized, <span class="keyword">true</span>);
<a name="l02470"></a>02470                                                                                 $this-&gt;<a class="code" href="classphpthumb.html#a4282192b16e760c7a6f12036081e8c82">ImageResizeFunction</a>($img_watermark_resized, $img_watermark, 0, 0, 0, 0, ImageSX($img_watermark_resized), ImageSY($img_watermark_resized), ImageSX($img_watermark), ImageSY($img_watermark));
<a name="l02471"></a>02471                                                                                 <span class="keywordflow">if</span> ($img_source_resized = <a class="code" href="classphpthumb__functions.html#a02caac9e703a9c106e3fea3a6215130d">phpthumb_functions::ImageCreateFunction</a>($resized_x, $resized_y)) {
<a name="l02472"></a>02472                                                                                         ImageAlphaBlending($img_source_resized, <span class="keyword">false</span>);
<a name="l02473"></a>02473                                                                                         ImageSaveAlpha($img_source_resized, <span class="keyword">true</span>);
<a name="l02474"></a>02474                                                                                         $this-&gt;<a class="code" href="classphpthumb.html#a4282192b16e760c7a6f12036081e8c82">ImageResizeFunction</a>($img_source_resized, $this-&gt;gdimg_output, 0, 0, 0, 0, ImageSX($img_source_resized), ImageSY($img_source_resized), ImageSX($this-&gt;gdimg_output), ImageSY($this-&gt;gdimg_output));
<a name="l02475"></a>02475                                                                                         $phpthumbFilters-&gt;WatermarkOverlay($img_watermark_resized, $img_source_resized, <span class="charliteral">&#39;C&#39;</span>, $opacity, $margin);
<a name="l02476"></a>02476                                                                                         ImageCopy($this-&gt;gdimg_output, $img_watermark_resized, 0, 0, 0, 0, ImageSX($this-&gt;gdimg_output), ImageSY($this-&gt;gdimg_output));
<a name="l02477"></a>02477                                                                                 } <span class="keywordflow">else</span> {
<a name="l02478"></a>02478                                                                                         $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;phpthumb_functions::ImageCreateFunction(&#39;</span>.$resized_x.<span class="stringliteral">&#39;, &#39;</span>.$resized_y.<span class="charliteral">&#39;)&#39;</span>, __FILE__, __LINE__);
<a name="l02479"></a>02479                                                                                 }
<a name="l02480"></a>02480                                                                                 ImageDestroy($img_watermark_resized);
<a name="l02481"></a>02481                                                                         } <span class="keywordflow">else</span> {
<a name="l02482"></a>02482                                                                                 $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;phpthumb_functions::ImageCreateFunction(&#39;</span>.ImageSX($this-&gt;gdimg_output).<span class="stringliteral">&#39;, &#39;</span>.ImageSY($this-&gt;gdimg_output).<span class="charliteral">&#39;)&#39;</span>, __FILE__, __LINE__);
<a name="l02483"></a>02483                                                                         }
<a name="l02484"></a>02484 
<a name="l02485"></a>02485                                                                 } <span class="keywordflow">else</span> { <span class="comment">// overlay</span>
<a name="l02486"></a>02486 
<a name="l02487"></a>02487                                                                         <span class="keywordflow">if</span> ($img_watermark_resized = <a class="code" href="classphpthumb__functions.html#a02caac9e703a9c106e3fea3a6215130d">phpthumb_functions::ImageCreateFunction</a>($resized_x, $resized_y)) {
<a name="l02488"></a>02488                                                                                 ImageAlphaBlending($img_watermark_resized, <span class="keyword">false</span>);
<a name="l02489"></a>02489                                                                                 ImageSaveAlpha($img_watermark_resized, <span class="keyword">true</span>);
<a name="l02490"></a>02490                                                                                 $this-&gt;<a class="code" href="classphpthumb.html#a4282192b16e760c7a6f12036081e8c82">ImageResizeFunction</a>($img_watermark_resized, $img_watermark, 0, 0, 0, 0, ImageSX($img_watermark_resized), ImageSY($img_watermark_resized), ImageSX($img_watermark), ImageSY($img_watermark));
<a name="l02491"></a>02491                                                                                 $phpthumbFilters-&gt;WatermarkOverlay($this-&gt;gdimg_output, $img_watermark_resized, <span class="charliteral">&#39;C&#39;</span>, $opacity, $margin);
<a name="l02492"></a>02492                                                                                 ImageDestroy($img_watermark_resized);
<a name="l02493"></a>02493                                                                         } <span class="keywordflow">else</span> {
<a name="l02494"></a>02494                                                                                 $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;phpthumb_functions::ImageCreateFunction(&#39;</span>.$resized_x.<span class="stringliteral">&#39;, &#39;</span>.$resized_y.<span class="charliteral">&#39;)&#39;</span>, __FILE__, __LINE__);
<a name="l02495"></a>02495                                                                         }
<a name="l02496"></a>02496 
<a name="l02497"></a>02497                                                                 }
<a name="l02498"></a>02498                                                                 ImageDestroy($img_watermark);
<a name="l02499"></a>02499 
<a name="l02500"></a>02500                                                         } <span class="keywordflow">else</span> {
<a name="l02501"></a>02501                                                                 $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;ImageCreateFromStringReplacement() failed for &quot;&#39;</span>.<a class="code" href="actions_8php.html#a6b7de8d10c540db2f1631e68b2aa0538">$filename</a>.<span class="charliteral">&#39;&quot;&#39;</span>, __FILE__, __LINE__);
<a name="l02502"></a>02502                                                         }
<a name="l02503"></a>02503                                                 } <span class="keywordflow">else</span> {
<a name="l02504"></a>02504                                                         $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;Cannot open overlay file &quot;&#39;</span>.<a class="code" href="actions_8php.html#a6b7de8d10c540db2f1631e68b2aa0538">$filename</a>.<span class="charliteral">&#39;&quot;&#39;</span>, __FILE__, __LINE__);
<a name="l02505"></a>02505                                                 }
<a name="l02506"></a>02506                                                 <span class="keywordflow">break</span>;
<a name="l02507"></a>02507 
<a name="l02508"></a>02508                                         <span class="keywordflow">case</span> <span class="stringliteral">&#39;wmi&#39;</span>: <span class="comment">// WaterMarkImage</span>
<a name="l02509"></a>02509                                                 @list(<a class="code" href="actions_8php.html#a6b7de8d10c540db2f1631e68b2aa0538">$filename</a>, $alignment, $opacity, $margin[<span class="charliteral">&#39;x&#39;</span>], $margin[<span class="charliteral">&#39;y&#39;</span>], $rotate_angle) = explode(<span class="charliteral">&#39;|&#39;</span>, $parameter);
<a name="l02510"></a>02510                                                 <span class="comment">// $margin can be pixel margin or percent margin if $alignment is text, or max width/height if $alignment is position like &quot;50x75&quot;</span>
<a name="l02511"></a>02511                                                 $alignment    = ($alignment            ? $alignment            : <span class="stringliteral">&#39;BR&#39;</span>);
<a name="l02512"></a>02512                                                 $opacity      = (strlen($opacity)      ? intval($opacity)      : 50);
<a name="l02513"></a>02513                                                 $rotate_angle = (strlen($rotate_angle) ? intval($rotate_angle) : 0);
<a name="l02514"></a>02514                                                 <span class="keywordflow">if</span> (!eregi(<span class="stringliteral">&#39;^([0-9\\.\\-]*)x([0-9\\.\\-]*)$&#39;</span>, $alignment, $matches)) {
<a name="l02515"></a>02515                                                         $margins = array(<span class="charliteral">&#39;x&#39;</span>, <span class="charliteral">&#39;y&#39;</span>);
<a name="l02516"></a>02516                                                         <span class="keywordflow">foreach</span> ($margins as $xy) {
<a name="l02517"></a>02517                                                                 $margin[$xy] = (strlen($margin[$xy]) ? $margin[$xy] : 5);
<a name="l02518"></a>02518                                                                 <span class="keywordflow">if</span> (($margin[$xy] &gt; 0) &amp;&amp; ($margin[$xy] &lt; 1)) {
<a name="l02519"></a>02519                                                                         $margin[$xy] = min(0.499, $margin[$xy]);
<a name="l02520"></a>02520                                                                 } <a class="code" href="php_thumb_8demo_8check_8php.html#af92779326267616cd7c3cdaaa9484bc9">elseif</a> (($margin[$xy] &gt; -1) &amp;&amp; ($margin[$xy] &lt; 0)) {
<a name="l02521"></a>02521                                                                         $margin[$xy] = max(-0.499, $margin[$xy]);
<a name="l02522"></a>02522                                                                 }
<a name="l02523"></a>02523                                                         }
<a name="l02524"></a>02524                                                 }
<a name="l02525"></a>02525 
<a name="l02526"></a>02526                                                 <a class="code" href="actions_8php.html#a6b7de8d10c540db2f1631e68b2aa0538">$filename</a> = $this-&gt;<a class="code" href="classphpthumb.html#a49cc25fd831b2990b8f5743e8d6abe30">ResolveFilenameToAbsolute</a>(<a class="code" href="actions_8php.html#a6b7de8d10c540db2f1631e68b2aa0538">$filename</a>);
<a name="l02527"></a>02527                                                 <span class="keywordflow">if</span> (@is_readable(<a class="code" href="actions_8php.html#a6b7de8d10c540db2f1631e68b2aa0538">$filename</a>)) {
<a name="l02528"></a>02528                                                         <span class="keywordflow">if</span> ($img_watermark = $this-&gt;<a class="code" href="classphpthumb.html#ab25e890433143e4ebacf894a3dc00243">ImageCreateFromFilename</a>(<a class="code" href="actions_8php.html#a6b7de8d10c540db2f1631e68b2aa0538">$filename</a>)) {
<a name="l02529"></a>02529                                                                 <span class="keywordflow">if</span> ($rotate_angle !== 0) {
<a name="l02530"></a>02530                                                                         $phpthumbFilters-&gt;ImprovedImageRotate($img_watermark, $rotate_angle);
<a name="l02531"></a>02531                                                                 }
<a name="l02532"></a>02532                                                                 <span class="keywordflow">if</span> (eregi(<span class="stringliteral">&#39;^([0-9\\.\\-]*)x([0-9\\.\\-]*)$&#39;</span>, $alignment, $matches)) {
<a name="l02533"></a>02533                                                                         $watermark_max_width  = intval($margin[<span class="charliteral">&#39;x&#39;</span>] ? $margin[<span class="charliteral">&#39;x&#39;</span>] : ImageSX($img_watermark));
<a name="l02534"></a>02534                                                                         $watermark_max_height = intval($margin[<span class="charliteral">&#39;y&#39;</span>] ? $margin[<span class="charliteral">&#39;y&#39;</span>] : ImageSY($img_watermark));
<a name="l02535"></a>02535                                                                         $scale = <a class="code" href="classphpthumb__functions.html#a1a6a1a11796857dd739cc463c348192b">phpthumb_functions::ScaleToFitInBox</a>(ImageSX($img_watermark), ImageSY($img_watermark), $watermark_max_width, $watermark_max_height, <span class="keyword">true</span>, <span class="keyword">true</span>);
<a name="l02536"></a>02536                                                                         $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;Scaling watermark by a factor of &#39;</span>.number_format($scale, 4), __FILE__, __LINE__);
<a name="l02537"></a>02537                                                                         <span class="keywordflow">if</span> (($scale &gt; 1) || ($scale &lt; 1)) {
<a name="l02538"></a>02538                                                                                 <span class="keywordflow">if</span> ($img_watermark2 = <a class="code" href="classphpthumb__functions.html#a02caac9e703a9c106e3fea3a6215130d">phpthumb_functions::ImageCreateFunction</a>($scale * ImageSX($img_watermark), $scale * ImageSY($img_watermark))) {
<a name="l02539"></a>02539                                                                                         ImageAlphaBlending($img_watermark2, <span class="keyword">false</span>);
<a name="l02540"></a>02540                                                                                         ImageSaveAlpha($img_watermark2, <span class="keyword">true</span>);
<a name="l02541"></a>02541                                                                                         $this-&gt;<a class="code" href="classphpthumb.html#a4282192b16e760c7a6f12036081e8c82">ImageResizeFunction</a>($img_watermark2, $img_watermark, 0, 0, 0, 0, ImageSX($img_watermark2), ImageSY($img_watermark2), ImageSX($img_watermark), ImageSY($img_watermark));
<a name="l02542"></a>02542                                                                                         $img_watermark = $img_watermark2;
<a name="l02543"></a>02543                                                                                 } <span class="keywordflow">else</span> {
<a name="l02544"></a>02544                                                                                         $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;ImageCreateFunction(&#39;</span>.($scale * ImageSX($img_watermark)).<span class="stringliteral">&#39;, &#39;</span>.($scale * ImageSX($img_watermark)).<span class="stringliteral">&#39;) failed&#39;</span>, __FILE__, __LINE__);
<a name="l02545"></a>02545                                                                                 }
<a name="l02546"></a>02546                                                                         }
<a name="l02547"></a>02547                                                                         $watermark_dest_x = round($matches[1] - (ImageSX($img_watermark) / 2));
<a name="l02548"></a>02548                                                                         $watermark_dest_y = round($matches[2] - (ImageSY($img_watermark) / 2));
<a name="l02549"></a>02549                                                                         $alignment = $watermark_dest_x.<span class="charliteral">&#39;x&#39;</span>.$watermark_dest_y;
<a name="l02550"></a>02550                                                                 }
<a name="l02551"></a>02551                                                                 $phpthumbFilters-&gt;WatermarkOverlay($this-&gt;gdimg_output, $img_watermark, $alignment, $opacity, $margin[<span class="charliteral">&#39;x&#39;</span>], $margin[<span class="charliteral">&#39;y&#39;</span>]);
<a name="l02552"></a>02552                                                                 ImageDestroy($img_watermark);
<a name="l02553"></a>02553                                                                 <span class="keywordflow">if</span> (isset($img_watermark2) &amp;&amp; is_resource($img_watermark2)) {
<a name="l02554"></a>02554                                                                         ImageDestroy($img_watermark2);
<a name="l02555"></a>02555                                                                 }
<a name="l02556"></a>02556                                                         } <span class="keywordflow">else</span> {
<a name="l02557"></a>02557                                                                 $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;ImageCreateFromFilename() failed for &quot;&#39;</span>.<a class="code" href="actions_8php.html#a6b7de8d10c540db2f1631e68b2aa0538">$filename</a>.<span class="charliteral">&#39;&quot;&#39;</span>, __FILE__, __LINE__);
<a name="l02558"></a>02558                                                         }
<a name="l02559"></a>02559                                                 } <span class="keywordflow">else</span> {
<a name="l02560"></a>02560                                                         $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;!is_readable(&#39;</span>.<a class="code" href="actions_8php.html#a6b7de8d10c540db2f1631e68b2aa0538">$filename</a>.<span class="charliteral">&#39;)&#39;</span>, __FILE__, __LINE__);
<a name="l02561"></a>02561                                                 }
<a name="l02562"></a>02562                                                 <span class="keywordflow">break</span>;
<a name="l02563"></a>02563 
<a name="l02564"></a>02564                                         <span class="keywordflow">case</span> <span class="stringliteral">&#39;wmt&#39;</span>: <span class="comment">// WaterMarkText</span>
<a name="l02565"></a>02565                                                 @list($text, $size, $alignment, $hex_color, $ttffont, $opacity, $margin, $angle, $bg_color, $bg_opacity, $fillextend) = explode(<span class="charliteral">&#39;|&#39;</span>, $parameter);
<a name="l02566"></a>02566                                                 $text       = ($text            ? $text       : <span class="stringliteral">&#39;&#39;</span>);
<a name="l02567"></a>02567                                                 $size       = ($size            ? $size       : 3);
<a name="l02568"></a>02568                                                 $alignment  = ($alignment       ? $alignment  : <span class="stringliteral">&#39;BR&#39;</span>);
<a name="l02569"></a>02569                                                 $hex_color  = ($hex_color       ? $hex_color  : <span class="stringliteral">&#39;000000&#39;</span>);
<a name="l02570"></a>02570                                                 $ttffont    = ($ttffont         ? $ttffont    : <span class="stringliteral">&#39;&#39;</span>);
<a name="l02571"></a>02571                                                 $opacity    = (strlen($opacity) ? $opacity    : 50);
<a name="l02572"></a>02572                                                 $margin     = (strlen($margin)  ? $margin     : 5);
<a name="l02573"></a>02573                                                 $angle      = (strlen($angle)   ? $angle      : 0);
<a name="l02574"></a>02574                                                 $bg_color   = ($bg_color        ? $bg_color   : <span class="keyword">false</span>);
<a name="l02575"></a>02575                                                 $bg_opacity = ($bg_opacity      ? $bg_opacity : 0);
<a name="l02576"></a>02576                                                 $fillextend = ($fillextend      ? $fillextend : <span class="stringliteral">&#39;&#39;</span>);
<a name="l02577"></a>02577 
<a name="l02578"></a>02578                                                 <span class="keywordflow">if</span> (basename($ttffont) == $ttffont) {
<a name="l02579"></a>02579                                                         $ttffont = realpath($this-&gt;config_ttf_directory.DIRECTORY_SEPARATOR.$ttffont);
<a name="l02580"></a>02580                                                 } <span class="keywordflow">else</span> {
<a name="l02581"></a>02581                                                         $ttffont = $this-&gt;<a class="code" href="classphpthumb.html#a49cc25fd831b2990b8f5743e8d6abe30">ResolveFilenameToAbsolute</a>($ttffont);
<a name="l02582"></a>02582                                                 }
<a name="l02583"></a>02583                                                 $phpthumbFilters-&gt;WatermarkText($this-&gt;gdimg_output, $text, $size, $alignment, $hex_color, $ttffont, $opacity, $margin, $angle, $bg_color, $bg_opacity, $fillextend);
<a name="l02584"></a>02584                                                 <span class="keywordflow">break</span>;
<a name="l02585"></a>02585 
<a name="l02586"></a>02586                                         <span class="keywordflow">case</span> <span class="stringliteral">&#39;blur&#39;</span>: <span class="comment">// Blur</span>
<a name="l02587"></a>02587                                                 @list($radius) = explode(<span class="charliteral">&#39;|&#39;</span>, $parameter);
<a name="l02588"></a>02588                                                 $radius = ($radius ? $radius : 1);
<a name="l02589"></a>02589                                                 <span class="keywordflow">if</span> (<a class="code" href="classphpthumb__functions.html#aaaad487d4c5a61befc88ae061f8a64fe">phpthumb_functions::gd_version</a>() &gt;= 2) {
<a name="l02590"></a>02590                                                         $phpthumbFilters-&gt;Blur($this-&gt;gdimg_output, $radius);
<a name="l02591"></a>02591                                                 } <span class="keywordflow">else</span> {
<a name="l02592"></a>02592                                                         $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;Skipping Blur() because gd_version is &quot;&#39;</span>.<a class="code" href="classphpthumb__functions.html#aaaad487d4c5a61befc88ae061f8a64fe">phpthumb_functions::gd_version</a>().<span class="charliteral">&#39;&quot;&#39;</span>, __FILE__, __LINE__);
<a name="l02593"></a>02593                                                         <span class="comment">//return false;</span>
<a name="l02594"></a>02594                                                 }
<a name="l02595"></a>02595                                                 <span class="keywordflow">break</span>;
<a name="l02596"></a>02596 
<a name="l02597"></a>02597                                         <span class="keywordflow">case</span> <span class="stringliteral">&#39;size&#39;</span>: <span class="comment">// Resize</span>
<a name="l02598"></a>02598                                                 @list($newwidth, $newheight, $stretch) = explode(<span class="charliteral">&#39;|&#39;</span>, $parameter);
<a name="l02599"></a>02599                                                 $newwidth  = (!$newwidth  ? ImageSX($this-&gt;gdimg_output) : ((($newwidth  &gt; 0) &amp;&amp; ($newwidth  &lt; 1)) ? round($newwidth  * ImageSX($this-&gt;gdimg_output)) : round($newwidth)));
<a name="l02600"></a>02600                                                 $newheight = (!$newheight ? ImageSY($this-&gt;gdimg_output) : ((($newheight &gt; 0) &amp;&amp; ($newheight &lt; 1)) ? round($newheight * ImageSY($this-&gt;gdimg_output)) : round($newheight)));
<a name="l02601"></a>02601                                                 $stretch   = ($stretch ? <span class="keyword">true</span> : <span class="keyword">false</span>);
<a name="l02602"></a>02602                                                 <span class="keywordflow">if</span> ($stretch) {
<a name="l02603"></a>02603                                                         $scale_x = <a class="code" href="classphpthumb__functions.html#a1a6a1a11796857dd739cc463c348192b">phpthumb_functions::ScaleToFitInBox</a>(ImageSX($this-&gt;gdimg_output), ImageSX($this-&gt;gdimg_output), $newwidth,  $newwidth,  <span class="keyword">true</span>, <span class="keyword">true</span>);
<a name="l02604"></a>02604                                                         $scale_y = <a class="code" href="classphpthumb__functions.html#a1a6a1a11796857dd739cc463c348192b">phpthumb_functions::ScaleToFitInBox</a>(ImageSY($this-&gt;gdimg_output), ImageSY($this-&gt;gdimg_output), $newheight, $newheight, <span class="keyword">true</span>, <span class="keyword">true</span>);
<a name="l02605"></a>02605                                                 } <span class="keywordflow">else</span> {
<a name="l02606"></a>02606                                                         $scale_x = <a class="code" href="classphpthumb__functions.html#a1a6a1a11796857dd739cc463c348192b">phpthumb_functions::ScaleToFitInBox</a>(ImageSX($this-&gt;gdimg_output), ImageSY($this-&gt;gdimg_output), $newwidth, $newheight, <span class="keyword">true</span>, <span class="keyword">true</span>);
<a name="l02607"></a>02607                                                         $scale_y = $scale_x;
<a name="l02608"></a>02608                                                 }
<a name="l02609"></a>02609                                                 $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;Scaling watermark (&#39;</span>.($stretch ? <span class="stringliteral">&#39;with&#39;</span> : <span class="stringliteral">&#39;without&#39;</span>).<span class="stringliteral">&#39; stretch) by a factor of &quot;&#39;</span>.number_format($scale_x, 4).<span class="stringliteral">&#39; x &#39;</span>.number_format($scale_y, 4).<span class="charliteral">&#39;&quot;&#39;</span>, __FILE__, __LINE__);
<a name="l02610"></a>02610                                                 <span class="keywordflow">if</span> (($scale_x &gt; 1) || ($scale_x &lt; 1) || ($scale_y &gt; 1) || ($scale_y &lt; 1)) {
<a name="l02611"></a>02611                                                         <span class="keywordflow">if</span> ($img_temp = <a class="code" href="classphpthumb__functions.html#a02caac9e703a9c106e3fea3a6215130d">phpthumb_functions::ImageCreateFunction</a>(ImageSX($this-&gt;gdimg_output), ImageSY($this-&gt;gdimg_output))) {
<a name="l02612"></a>02612                                                                 ImageCopy($img_temp, $this-&gt;gdimg_output, 0, 0, 0, 0, ImageSX($this-&gt;gdimg_output), ImageSY($this-&gt;gdimg_output));
<a name="l02613"></a>02613                                                                 <span class="comment">//ImageDestroy($this-&gt;gdimg_output);</span>
<a name="l02614"></a>02614                                                                 <span class="keywordflow">if</span> ($this-&gt;gdimg_output = <a class="code" href="classphpthumb__functions.html#a02caac9e703a9c106e3fea3a6215130d">phpthumb_functions::ImageCreateFunction</a>($scale_x * ImageSX($img_temp), $scale_y * ImageSY($img_temp))) {
<a name="l02615"></a>02615                                                                         ImageAlphaBlending($this-&gt;gdimg_output, <span class="keyword">false</span>);
<a name="l02616"></a>02616                                                                         ImageSaveAlpha($this-&gt;gdimg_output, <span class="keyword">true</span>);
<a name="l02617"></a>02617                                                                         $this-&gt;<a class="code" href="classphpthumb.html#a4282192b16e760c7a6f12036081e8c82">ImageResizeFunction</a>($this-&gt;gdimg_output, $img_temp, 0, 0, 0, 0, ImageSX($this-&gt;gdimg_output), ImageSY($this-&gt;gdimg_output), ImageSX($img_temp), ImageSY($img_temp));
<a name="l02618"></a>02618                                                                 } <span class="keywordflow">else</span> {
<a name="l02619"></a>02619                                                                         $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;ImageCreateFunction(&#39;</span>.($scale_x * ImageSX($img_temp)).<span class="stringliteral">&#39;, &#39;</span>.($scale_y * ImageSY($img_temp)).<span class="stringliteral">&#39;) failed&#39;</span>, __FILE__, __LINE__);
<a name="l02620"></a>02620                                                                 }
<a name="l02621"></a>02621                                                                 ImageDestroy($img_temp);
<a name="l02622"></a>02622                                                         } <span class="keywordflow">else</span> {
<a name="l02623"></a>02623                                                                 $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;ImageCreateFunction(&#39;</span>.ImageSX($this-&gt;gdimg_output).<span class="stringliteral">&#39;, &#39;</span>.ImageSY($this-&gt;gdimg_output).<span class="stringliteral">&#39;) failed&#39;</span>, __FILE__, __LINE__);
<a name="l02624"></a>02624                                                         }
<a name="l02625"></a>02625                                                 }
<a name="l02626"></a>02626                                                 <span class="keywordflow">break</span>;
<a name="l02627"></a>02627 
<a name="l02628"></a>02628                                         <span class="keywordflow">case</span> <span class="stringliteral">&#39;gblr&#39;</span>: <span class="comment">// Gaussian Blur</span>
<a name="l02629"></a>02629                                                 $phpthumbFilters-&gt;BlurGaussian($this-&gt;gdimg_output);
<a name="l02630"></a>02630                                                 <span class="keywordflow">break</span>;
<a name="l02631"></a>02631 
<a name="l02632"></a>02632                                         <span class="keywordflow">case</span> <span class="stringliteral">&#39;sblr&#39;</span>: <span class="comment">// Selective Blur</span>
<a name="l02633"></a>02633                                                 $phpthumbFilters-&gt;BlurSelective($this-&gt;gdimg_output);
<a name="l02634"></a>02634                                                 <span class="keywordflow">break</span>;
<a name="l02635"></a>02635 
<a name="l02636"></a>02636                                         <span class="keywordflow">case</span> <span class="stringliteral">&#39;mean&#39;</span>: <span class="comment">// MeanRemoval blur</span>
<a name="l02637"></a>02637                                                 $phpthumbFilters-&gt;MeanRemoval($this-&gt;gdimg_output);
<a name="l02638"></a>02638                                                 <span class="keywordflow">break</span>;
<a name="l02639"></a>02639 
<a name="l02640"></a>02640                                         <span class="keywordflow">case</span> <span class="stringliteral">&#39;smth&#39;</span>: <span class="comment">// Smooth blur</span>
<a name="l02641"></a>02641                                                 $phpthumbFilters-&gt;Smooth($this-&gt;gdimg_output, $parameter);
<a name="l02642"></a>02642                                                 <span class="keywordflow">break</span>;
<a name="l02643"></a>02643 
<a name="l02644"></a>02644                                         <span class="keywordflow">case</span> <span class="stringliteral">&#39;usm&#39;</span>: <span class="comment">// UnSharpMask sharpening</span>
<a name="l02645"></a>02645                                                 @list($amount, $radius, $threshold) = explode(<span class="charliteral">&#39;|&#39;</span>, $parameter);
<a name="l02646"></a>02646                                                 $amount    = ($amount            ? $amount    : 80);
<a name="l02647"></a>02647                                                 $radius    = ($radius            ? $radius    : 0.5);
<a name="l02648"></a>02648                                                 $threshold = (strlen($threshold) ? $threshold : 3);
<a name="l02649"></a>02649                                                 <span class="keywordflow">if</span> (<a class="code" href="classphpthumb__functions.html#aaaad487d4c5a61befc88ae061f8a64fe">phpthumb_functions::gd_version</a>() &gt;= 2.0) {
<a name="l02650"></a>02650                                                         ob_start();
<a name="l02651"></a>02651                                                         <span class="keywordflow">if</span> (!@include_once(dirname(__FILE__).<span class="stringliteral">&#39;/phpthumb.unsharp.php&#39;</span>)) {
<a name="l02652"></a>02652                                                                 $include_error = ob_get_contents();
<a name="l02653"></a>02653                                                                 <span class="keywordflow">if</span> ($include_error) {
<a name="l02654"></a>02654                                                                         $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;include_once(&quot;&#39;</span>.dirname(__FILE__).<span class="stringliteral">&#39;/phpthumb.unsharp.php&quot;) generated message: &quot;&#39;</span>.$include_error.<span class="charliteral">&#39;&quot;&#39;</span>, __FILE__, __LINE__);
<a name="l02655"></a>02655                                                                 }
<a name="l02656"></a>02656                                                                 $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;Error including &quot;&#39;</span>.dirname(__FILE__).<span class="stringliteral">&#39;/phpthumb.unsharp.php&quot; which is required for unsharp masking&#39;</span>, __FILE__, __LINE__);
<a name="l02657"></a>02657                                                                 ob_end_clean();
<a name="l02658"></a>02658                                                                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02659"></a>02659                                                         }
<a name="l02660"></a>02660                                                         ob_end_clean();
<a name="l02661"></a>02661                                                         <a class="code" href="classphp_unsharp_mask.html#a15848cb84071121d2aae85a5dc0efa0e">phpUnsharpMask::applyUnsharpMask</a>($this-&gt;gdimg_output, $amount, $radius, $threshold);
<a name="l02662"></a>02662                                                 } <span class="keywordflow">else</span> {
<a name="l02663"></a>02663                                                         $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;Skipping unsharp mask because gd_version is &quot;&#39;</span>.<a class="code" href="classphpthumb__functions.html#aaaad487d4c5a61befc88ae061f8a64fe">phpthumb_functions::gd_version</a>().<span class="charliteral">&#39;&quot;&#39;</span>, __FILE__, __LINE__);
<a name="l02664"></a>02664                                                         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02665"></a>02665                                                 }
<a name="l02666"></a>02666                                                 <span class="keywordflow">break</span>;
<a name="l02667"></a>02667 
<a name="l02668"></a>02668                                         <span class="keywordflow">case</span> <span class="stringliteral">&#39;rot&#39;</span>: <span class="comment">// ROTate</span>
<a name="l02669"></a>02669                                                 @list($angle, $bgcolor) = explode(<span class="charliteral">&#39;|&#39;</span>, $parameter);
<a name="l02670"></a>02670                                                 $phpthumbFilters-&gt;ImprovedImageRotate($this-&gt;gdimg_output, $angle, $bgcolor);
<a name="l02671"></a>02671                                                 <span class="keywordflow">break</span>;
<a name="l02672"></a>02672 
<a name="l02673"></a>02673                                         <span class="keywordflow">case</span> <span class="stringliteral">&#39;stc&#39;</span>: <span class="comment">// Source Transparent Color</span>
<a name="l02674"></a>02674                                                 @list($hexcolor, $min_limit, $max_limit) = explode(<span class="charliteral">&#39;|&#39;</span>, $parameter);
<a name="l02675"></a>02675                                                 <span class="keywordflow">if</span> (!<a class="code" href="classphpthumb__functions.html#aa88047663adfed917d5fb0bece3913b8">phpthumb_functions::IsHexColor</a>($hexcolor)) {
<a name="l02676"></a>02676                                                         $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;Skipping SourceTransparentColor hex color is invalid (&#39;</span>.$hexcolor.<span class="charliteral">&#39;)&#39;</span>, __FILE__, __LINE__);
<a name="l02677"></a>02677                                                         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02678"></a>02678                                                 }
<a name="l02679"></a>02679                                                 $min_limit = (strlen($min_limit) ? $min_limit :  5);
<a name="l02680"></a>02680                                                 $max_limit = (strlen($max_limit) ? $max_limit : 10);
<a name="l02681"></a>02681                                                 <span class="keywordflow">if</span> ($gdimg_mask = $phpthumbFilters-&gt;SourceTransparentColorMask($this-&gt;gdimg_output, $hexcolor, $min_limit, $max_limit)) {
<a name="l02682"></a>02682                                                         $this-&gt;is_alpha = <span class="keyword">true</span>;
<a name="l02683"></a>02683                                                         $phpthumbFilters-&gt;ApplyMask($gdimg_mask, $this-&gt;gdimg_output);
<a name="l02684"></a>02684                                                         ImageDestroy($gdimg_mask);
<a name="l02685"></a>02685                                                 } <span class="keywordflow">else</span> {
<a name="l02686"></a>02686                                                         $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;SourceTransparentColorMask() failed for &quot;&#39;</span>.$mask_filename.<span class="charliteral">&#39;&quot;&#39;</span>, __FILE__, __LINE__);
<a name="l02687"></a>02687                                                 }
<a name="l02688"></a>02688                                                 <span class="keywordflow">break</span>;
<a name="l02689"></a>02689                                 }
<a name="l02690"></a>02690                                 $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;Finished processing filter command &quot;&#39;</span>.$command.<span class="charliteral">&#39;(&#39;</span>.$parameter.<span class="stringliteral">&#39;)&quot;&#39;</span>, __FILE__, __LINE__);
<a name="l02691"></a>02691                         }
<a name="l02692"></a>02692                 }
<a name="l02693"></a>02693                 <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l02694"></a>02694         }
<a name="l02695"></a>02695 
<a name="l02696"></a>02696 
<a name="l02697"></a><a class="code" href="classphpthumb.html#a97ff8a6aa5afe83ac1fcf0fae0cb03d3">02697</a>         <span class="keyword">function</span> <a class="code" href="classphpthumb.html#a97ff8a6aa5afe83ac1fcf0fae0cb03d3">MaxFileSize</a>() {
<a name="l02698"></a>02698                 <span class="keywordflow">if</span> (<a class="code" href="classphpthumb__functions.html#aaaad487d4c5a61befc88ae061f8a64fe">phpthumb_functions::gd_version</a>() &lt; 2) {
<a name="l02699"></a>02699                         $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;Skipping MaxFileSize() because gd_version is &quot;&#39;</span>.<a class="code" href="classphpthumb__functions.html#aaaad487d4c5a61befc88ae061f8a64fe">phpthumb_functions::gd_version</a>().<span class="charliteral">&#39;&quot;&#39;</span>, __FILE__, __LINE__);
<a name="l02700"></a>02700                         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02701"></a>02701                 }
<a name="l02702"></a>02702                 <span class="keywordflow">if</span> ($this-&gt;maxb &gt; 0) {
<a name="l02703"></a>02703                         <span class="keywordflow">switch</span> ($this-&gt;thumbnailFormat) {
<a name="l02704"></a>02704                                 <span class="keywordflow">case</span> <span class="stringliteral">&#39;png&#39;</span>:
<a name="l02705"></a>02705                                 <span class="keywordflow">case</span> <span class="stringliteral">&#39;gif&#39;</span>:
<a name="l02706"></a>02706                                         $imgRenderFunction = <span class="stringliteral">&#39;image&#39;</span>.$this-&gt;thumbnailFormat;
<a name="l02707"></a>02707 
<a name="l02708"></a>02708                                         ob_start();
<a name="l02709"></a>02709                                         $imgRenderFunction($this-&gt;gdimg_output);
<a name="l02710"></a>02710                                         $imgdata = ob_get_contents();
<a name="l02711"></a>02711                                         ob_end_clean();
<a name="l02712"></a>02712 
<a name="l02713"></a>02713                                         <span class="keywordflow">if</span> (strlen($imgdata) &gt; $this-&gt;maxb) {
<a name="l02714"></a>02714                                                 <span class="keywordflow">for</span> ($i = 8; $i &gt;= 1; $i--) {
<a name="l02715"></a>02715                                                         $tempIMG = ImageCreateTrueColor(ImageSX($this-&gt;gdimg_output), ImageSY($this-&gt;gdimg_output));
<a name="l02716"></a>02716                                                         ImageCopy($tempIMG, $this-&gt;gdimg_output, 0, 0, 0, 0, ImageSX($this-&gt;gdimg_output), ImageSY($this-&gt;gdimg_output));
<a name="l02717"></a>02717                                                         ImageTrueColorToPalette($tempIMG, <span class="keyword">true</span>, pow(2, $i));
<a name="l02718"></a>02718                                                         ob_start();
<a name="l02719"></a>02719                                                         $imgRenderFunction($tempIMG);
<a name="l02720"></a>02720                                                         $imgdata = ob_get_contents();
<a name="l02721"></a>02721                                                         ob_end_clean();
<a name="l02722"></a>02722 
<a name="l02723"></a>02723                                                         <span class="keywordflow">if</span> (strlen($imgdata) &lt;= $this-&gt;maxb) {
<a name="l02724"></a>02724                                                                 ImageTrueColorToPalette($this-&gt;gdimg_output, <span class="keyword">true</span>, pow(2, $i));
<a name="l02725"></a>02725                                                                 <span class="keywordflow">break</span>;
<a name="l02726"></a>02726                                                         }
<a name="l02727"></a>02727                                                 }
<a name="l02728"></a>02728                                         }
<a name="l02729"></a>02729                                         <span class="keywordflow">if</span> (strlen($imgdata) &gt; $this-&gt;maxb) {
<a name="l02730"></a>02730                                                 ImageTrueColorToPalette($this-&gt;gdimg_output, <span class="keyword">true</span>, pow(2, $i));
<a name="l02731"></a>02731                                                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02732"></a>02732                                         }
<a name="l02733"></a>02733                                         <span class="keywordflow">break</span>;
<a name="l02734"></a>02734 
<a name="l02735"></a>02735                                 <span class="keywordflow">case</span> <span class="stringliteral">&#39;jpeg&#39;</span>:
<a name="l02736"></a>02736                                         ob_start();
<a name="l02737"></a>02737                                         ImageJPEG($this-&gt;gdimg_output);
<a name="l02738"></a>02738                                         $imgdata = ob_get_contents();
<a name="l02739"></a>02739                                         ob_end_clean();
<a name="l02740"></a>02740 
<a name="l02741"></a>02741                                         $OriginalJPEGquality = $this-&gt;thumbnailQuality;
<a name="l02742"></a>02742                                         <span class="keywordflow">if</span> (strlen($imgdata) &gt; $this-&gt;maxb) {
<a name="l02743"></a>02743                                                 <span class="keywordflow">for</span> ($i = 3; $i &lt; 20; $i++) {
<a name="l02744"></a>02744                                                         <a class="code" href="classphpthumb.html#abb0f8f809252372e25f48d52b63ef29d">$q</a> = round(100 * (1 - log10($i / 2)));
<a name="l02745"></a>02745                                                         ob_start();
<a name="l02746"></a>02746                                                         ImageJPEG($this-&gt;gdimg_output, <span class="stringliteral">&#39;&#39;</span>, <a class="code" href="classphpthumb.html#abb0f8f809252372e25f48d52b63ef29d">$q</a>);
<a name="l02747"></a>02747                                                         $imgdata = ob_get_contents();
<a name="l02748"></a>02748                                                         ob_end_clean();
<a name="l02749"></a>02749 
<a name="l02750"></a>02750                                                         $this-&gt;thumbnailQuality = <a class="code" href="classphpthumb.html#abb0f8f809252372e25f48d52b63ef29d">$q</a>;
<a name="l02751"></a>02751                                                         <span class="keywordflow">if</span> (strlen($imgdata) &lt;= $this-&gt;maxb) {
<a name="l02752"></a>02752                                                                 <span class="keywordflow">break</span>;
<a name="l02753"></a>02753                                                         }
<a name="l02754"></a>02754                                                 }
<a name="l02755"></a>02755                                         }
<a name="l02756"></a>02756                                         <span class="keywordflow">if</span> (strlen($imgdata) &gt; $this-&gt;maxb) {
<a name="l02757"></a>02757                                                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02758"></a>02758                                         }
<a name="l02759"></a>02759                                         <span class="keywordflow">break</span>;
<a name="l02760"></a>02760 
<a name="l02761"></a>02761                                 <span class="keywordflow">default</span>:
<a name="l02762"></a>02762                                         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02763"></a>02763                                         <span class="keywordflow">break</span>;
<a name="l02764"></a>02764                         }
<a name="l02765"></a>02765                 }
<a name="l02766"></a>02766                 <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l02767"></a>02767         }
<a name="l02768"></a>02768 
<a name="l02769"></a>02769 
<a name="l02770"></a><a class="code" href="classphpthumb.html#a7da79974733c97d8ac2743b22c23ea74">02770</a>         <span class="keyword">function</span> <a class="code" href="classphpthumb.html#a7da79974733c97d8ac2743b22c23ea74">CalculateThumbnailDimensions</a>() {
<a name="l02771"></a>02771 <span class="comment">//echo $this-&gt;source_width.&#39;x&#39;.$this-&gt;source_height.&#39;&lt;hr&gt;&#39;;</span>
<a name="l02772"></a>02772                 $this-&gt;thumbnailCropX = ($this-&gt;sx ? (($this-&gt;sx &gt;= 1) ? $this-&gt;sx : round($this-&gt;sx * $this-&gt;source_width))  : 0);
<a name="l02773"></a>02773 <span class="comment">//echo $this-&gt;thumbnailCropX.&#39;&lt;br&gt;&#39;;</span>
<a name="l02774"></a>02774                 $this-&gt;thumbnailCropY = ($this-&gt;sy ? (($this-&gt;sy &gt;= 1) ? $this-&gt;sy : round($this-&gt;sy * $this-&gt;source_height)) : 0);
<a name="l02775"></a>02775 <span class="comment">//echo $this-&gt;thumbnailCropY.&#39;&lt;br&gt;&#39;;</span>
<a name="l02776"></a>02776                 $this-&gt;thumbnailCropW = ($this-&gt;sw ? (($this-&gt;sw &gt;= 1) ? $this-&gt;sw : round($this-&gt;sw * $this-&gt;source_width))  : $this-&gt;source_width);
<a name="l02777"></a>02777 <span class="comment">//echo $this-&gt;thumbnailCropW.&#39;&lt;br&gt;&#39;;</span>
<a name="l02778"></a>02778                 $this-&gt;thumbnailCropH = ($this-&gt;sh ? (($this-&gt;sh &gt;= 1) ? $this-&gt;sh : round($this-&gt;sh * $this-&gt;source_height)) : $this-&gt;source_height);
<a name="l02779"></a>02779 <span class="comment">//echo $this-&gt;thumbnailCropH.&#39;&lt;hr&gt;&#39;;</span>
<a name="l02780"></a>02780 
<a name="l02781"></a>02781                 <span class="comment">// limit source area to original image area</span>
<a name="l02782"></a>02782                 $this-&gt;thumbnailCropW = max(1, min($this-&gt;thumbnailCropW, $this-&gt;source_width  - $this-&gt;thumbnailCropX));
<a name="l02783"></a>02783                 $this-&gt;thumbnailCropH = max(1, min($this-&gt;thumbnailCropH, $this-&gt;source_height - $this-&gt;thumbnailCropY));
<a name="l02784"></a>02784 
<a name="l02785"></a>02785                 $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;CalculateThumbnailDimensions() [x,y,w,h] initially set to [&#39;</span>.$this-&gt;thumbnailCropX.<span class="charliteral">&#39;,&#39;</span>.$this-&gt;thumbnailCropY.<span class="charliteral">&#39;,&#39;</span>.$this-&gt;thumbnailCropW.<span class="charliteral">&#39;,&#39;</span>.$this-&gt;thumbnailCropH.<span class="charliteral">&#39;]&#39;</span>, __FILE__, __LINE__);
<a name="l02786"></a>02786 
<a name="l02787"></a>02787 
<a name="l02788"></a>02788                 <span class="keywordflow">if</span> ($this-&gt;zc &amp;&amp; $this-&gt;w &amp;&amp; $this-&gt;h) {
<a name="l02789"></a>02789                         <span class="comment">// Zoom Crop</span>
<a name="l02790"></a>02790                         <span class="comment">// retain proportional resizing we did above, but crop off larger dimension so smaller</span>
<a name="l02791"></a>02791                         <span class="comment">// dimension fully fits available space</span>
<a name="l02792"></a>02792 
<a name="l02793"></a>02793                         $scaling_X = $this-&gt;source_width  / $this-&gt;w;
<a name="l02794"></a>02794                         $scaling_Y = $this-&gt;source_height / $this-&gt;h;
<a name="l02795"></a>02795                         <span class="keywordflow">if</span> ($scaling_X &gt; $scaling_Y) {
<a name="l02796"></a>02796                                 <span class="comment">// some of the width will need to be cropped</span>
<a name="l02797"></a>02797                                 $allowable_width = $this-&gt;source_width / $scaling_X * $scaling_Y;
<a name="l02798"></a>02798                                 $this-&gt;thumbnailCropW = round($allowable_width);
<a name="l02799"></a>02799                                 $this-&gt;thumbnailCropX = round(($this-&gt;source_width - $allowable_width) / 2);
<a name="l02800"></a>02800 
<a name="l02801"></a>02801                         } <a class="code" href="php_thumb_8demo_8check_8php.html#af92779326267616cd7c3cdaaa9484bc9">elseif</a> ($scaling_Y &gt; $scaling_X) {
<a name="l02802"></a>02802                                 <span class="comment">// some of the height will need to be cropped</span>
<a name="l02803"></a>02803                                 $allowable_height = $this-&gt;source_height / $scaling_Y * $scaling_X;
<a name="l02804"></a>02804                                 $this-&gt;thumbnailCropH = round($allowable_height);
<a name="l02805"></a>02805                                 $this-&gt;thumbnailCropY = round(($this-&gt;source_height - $allowable_height) / 2);
<a name="l02806"></a>02806 
<a name="l02807"></a>02807                         } <span class="keywordflow">else</span> {
<a name="l02808"></a>02808                                 <span class="comment">// image fits perfectly, no cropping needed</span>
<a name="l02809"></a>02809                         }
<a name="l02810"></a>02810                         $this-&gt;thumbnail_width  = $this-&gt;w;
<a name="l02811"></a>02811                         $this-&gt;thumbnail_height = $this-&gt;h;
<a name="l02812"></a>02812                         $this-&gt;thumbnail_image_width  = $this-&gt;thumbnail_width;
<a name="l02813"></a>02813                         $this-&gt;thumbnail_image_height = $this-&gt;thumbnail_height;
<a name="l02814"></a>02814 
<a name="l02815"></a>02815                 } <a class="code" href="php_thumb_8demo_8check_8php.html#af92779326267616cd7c3cdaaa9484bc9">elseif</a> ($this-&gt;iar &amp;&amp; $this-&gt;w &amp;&amp; $this-&gt;h) {
<a name="l02816"></a>02816 
<a name="l02817"></a>02817                         <span class="comment">// Ignore Aspect Ratio</span>
<a name="l02818"></a>02818                         <span class="comment">// stretch image to fit exactly &#39;w&#39; x &#39;h&#39;</span>
<a name="l02819"></a>02819                         $this-&gt;thumbnail_width  = $this-&gt;w;
<a name="l02820"></a>02820                         $this-&gt;thumbnail_height = $this-&gt;h;
<a name="l02821"></a>02821                         $this-&gt;thumbnail_image_width  = $this-&gt;thumbnail_width;
<a name="l02822"></a>02822                         $this-&gt;thumbnail_image_height = $this-&gt;thumbnail_height;
<a name="l02823"></a>02823 
<a name="l02824"></a>02824                 } <span class="keywordflow">else</span> {
<a name="l02825"></a>02825 
<a name="l02826"></a>02826                         $original_aspect_ratio = $this-&gt;thumbnailCropW / $this-&gt;thumbnailCropH;
<a name="l02827"></a>02827                         <span class="keywordflow">if</span> ($this-&gt;aoe) {
<a name="l02828"></a>02828                                 <span class="keywordflow">if</span> ($this-&gt;w &amp;&amp; $this-&gt;h) {
<a name="l02829"></a>02829                                         $maxwidth  = min($this-&gt;w, $this-&gt;h * $original_aspect_ratio);
<a name="l02830"></a>02830                                         $maxheight = min($this-&gt;h, $this-&gt;w / $original_aspect_ratio);
<a name="l02831"></a>02831                                 } <a class="code" href="php_thumb_8demo_8check_8php.html#af92779326267616cd7c3cdaaa9484bc9">elseif</a> ($this-&gt;w) {
<a name="l02832"></a>02832                                         $maxwidth  = $this-&gt;w;
<a name="l02833"></a>02833                                         $maxheight = $this-&gt;w / $original_aspect_ratio;
<a name="l02834"></a>02834                                 } <a class="code" href="php_thumb_8demo_8check_8php.html#af92779326267616cd7c3cdaaa9484bc9">elseif</a> ($this-&gt;h) {
<a name="l02835"></a>02835                                         $maxwidth  = $this-&gt;h * $original_aspect_ratio;
<a name="l02836"></a>02836                                         $maxheight = $this-&gt;h;
<a name="l02837"></a>02837                                 } <span class="keywordflow">else</span> {
<a name="l02838"></a>02838                                         $maxwidth  = $this-&gt;thumbnailCropW;
<a name="l02839"></a>02839                                         $maxheight = $this-&gt;thumbnailCropH;
<a name="l02840"></a>02840                                 }
<a name="l02841"></a>02841                         } <span class="keywordflow">else</span> {
<a name="l02842"></a>02842                                 $maxwidth  = <a class="code" href="classphpthumb__functions.html#a0c2feb0df02b7a87435be3645fee8224">phpthumb_functions::nonempty_min</a>($this-&gt;w, $this-&gt;thumbnailCropW, $this-&gt;config_output_maxwidth);
<a name="l02843"></a>02843                                 $maxheight = <a class="code" href="classphpthumb__functions.html#a0c2feb0df02b7a87435be3645fee8224">phpthumb_functions::nonempty_min</a>($this-&gt;h, $this-&gt;thumbnailCropH, $this-&gt;config_output_maxheight);
<a name="l02844"></a>02844 <span class="comment">//echo $maxwidth.&#39;x&#39;.$maxheight.&#39;&lt;br&gt;&#39;;</span>
<a name="l02845"></a>02845                                 $maxwidth  = min($maxwidth, $maxheight * $original_aspect_ratio);
<a name="l02846"></a>02846                                 $maxheight = min($maxheight, $maxwidth / $original_aspect_ratio);
<a name="l02847"></a>02847 <span class="comment">//echo $maxwidth.&#39;x&#39;.$maxheight.&#39;&lt;hr&gt;&#39;;</span>
<a name="l02848"></a>02848                         }
<a name="l02849"></a>02849 
<a name="l02850"></a>02850                         $this-&gt;thumbnail_image_width  = $maxwidth;
<a name="l02851"></a>02851                         $this-&gt;thumbnail_image_height = $maxheight;
<a name="l02852"></a>02852                         $this-&gt;thumbnail_width  = $maxwidth;
<a name="l02853"></a>02853                         $this-&gt;thumbnail_height = $maxheight;
<a name="l02854"></a>02854 
<a name="l02855"></a>02855                         $this-&gt;<a class="code" href="classphpthumb.html#ad3682c3cf7d9119200d8a358a5907f68">FixedAspectRatio</a>();
<a name="l02856"></a>02856                 }
<a name="l02857"></a>02857 
<a name="l02858"></a>02858                 $this-&gt;thumbnail_width  = max(1, floor($this-&gt;thumbnail_width));
<a name="l02859"></a>02859                 $this-&gt;thumbnail_height = max(1, floor($this-&gt;thumbnail_height));
<a name="l02860"></a>02860                 <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l02861"></a>02861         }
<a name="l02862"></a>02862 
<a name="l02863"></a>02863 
<a name="l02864"></a><a class="code" href="classphpthumb.html#a83149fb942a8f8508f342f422f115947">02864</a>         <span class="keyword">function</span> <a class="code" href="classphpthumb.html#a83149fb942a8f8508f342f422f115947">CreateGDoutput</a>() {
<a name="l02865"></a>02865                 $this-&gt;<a class="code" href="classphpthumb.html#a7da79974733c97d8ac2743b22c23ea74">CalculateThumbnailDimensions</a>();
<a name="l02866"></a>02866 
<a name="l02867"></a>02867                 <span class="comment">// Create the GD image (either true-color or 256-color, depending on GD version)</span>
<a name="l02868"></a>02868                 $this-&gt;gdimg_output = <a class="code" href="classphpthumb__functions.html#a02caac9e703a9c106e3fea3a6215130d">phpthumb_functions::ImageCreateFunction</a>($this-&gt;thumbnail_width, $this-&gt;thumbnail_height);
<a name="l02869"></a>02869 
<a name="l02870"></a>02870                 <span class="comment">// Images that have transparency must have the background filled with the configured &#39;bg&#39; color</span>
<a name="l02871"></a>02871                 <span class="comment">// otherwise the transparent color will appear as black</span>
<a name="l02872"></a>02872                 ImageSaveAlpha($this-&gt;gdimg_output, <span class="keyword">true</span>);
<a name="l02873"></a>02873                 <span class="keywordflow">if</span> ($this-&gt;is_alpha &amp;&amp; <a class="code" href="classphpthumb__functions.html#aaaad487d4c5a61befc88ae061f8a64fe">phpthumb_functions::gd_version</a>() &gt;= 2) {
<a name="l02874"></a>02874 
<a name="l02875"></a>02875                         ImageAlphaBlending($this-&gt;gdimg_output, <span class="keyword">false</span>);
<a name="l02876"></a>02876                         $output_full_alpha = <a class="code" href="classphpthumb__functions.html#ab43fe1af0d0c46288c2ffcf3905a7b42">phpthumb_functions::ImageColorAllocateAlphaSafe</a>($this-&gt;gdimg_output, 255, 255, 255, 127);
<a name="l02877"></a>02877                         ImageFilledRectangle($this-&gt;gdimg_output, 0, 0, $this-&gt;thumbnail_width, $this-&gt;thumbnail_height, $output_full_alpha);
<a name="l02878"></a>02878 
<a name="l02879"></a>02879                 } <span class="keywordflow">else</span> {
<a name="l02880"></a>02880 
<a name="l02881"></a>02881                         $current_transparent_color = ImageColorTransparent($this-&gt;gdimg_source);
<a name="l02882"></a>02882                         <span class="keywordflow">if</span> ($this-&gt;bg || (@$current_transparent_color &gt;= 0)) {
<a name="l02883"></a>02883 
<a name="l02884"></a>02884                                 $this-&gt;config_background_hexcolor = ($this-&gt;bg ? $this-&gt;bg : $this-&gt;config_background_hexcolor);
<a name="l02885"></a>02885                                 <span class="keywordflow">if</span> (!<a class="code" href="classphpthumb__functions.html#aa88047663adfed917d5fb0bece3913b8">phpthumb_functions::IsHexColor</a>($this-&gt;config_background_hexcolor)) {
<a name="l02886"></a>02886                                         <span class="keywordflow">return</span> $this-&gt;<a class="code" href="classphpthumb.html#a6ff71b425894fd846790cedf9f9cc97d">ErrorImage</a>(<span class="stringliteral">&#39;Invalid hex color string &quot;&#39;</span>.$this-&gt;config_background_hexcolor.<span class="stringliteral">&#39;&quot; for parameter &quot;bg&quot;&#39;</span>);
<a name="l02887"></a>02887                                 }
<a name="l02888"></a>02888                                 $background_color = <a class="code" href="classphpthumb__functions.html#a9a63d0b70df4136de64ab0cd351e7ff3">phpthumb_functions::ImageHexColorAllocate</a>($this-&gt;gdimg_output, $this-&gt;config_background_hexcolor);
<a name="l02889"></a>02889                                 ImageFilledRectangle($this-&gt;gdimg_output, 0, 0, $this-&gt;thumbnail_width, $this-&gt;thumbnail_height, $background_color);
<a name="l02890"></a>02890 
<a name="l02891"></a>02891                         }
<a name="l02892"></a>02892 
<a name="l02893"></a>02893                 }
<a name="l02894"></a>02894                 $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;CreateGDoutput() returning canvas &quot;&#39;</span>.$this-&gt;thumbnail_width.<span class="charliteral">&#39;x&#39;</span>.$this-&gt;thumbnail_height.<span class="charliteral">&#39;&quot;&#39;</span>, __FILE__, __LINE__);
<a name="l02895"></a>02895                 <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l02896"></a>02896         }
<a name="l02897"></a>02897 
<a name="l02898"></a><a class="code" href="classphpthumb.html#aad0ac1ff143b9d6bb26210c98d94a2ac">02898</a>         <span class="keyword">function</span> <a class="code" href="classphpthumb.html#aad0ac1ff143b9d6bb26210c98d94a2ac">SetOrientationDependantWidthHeight</a>() {
<a name="l02899"></a>02899                 $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;SetOrientationDependantWidthHeight() starting with &quot;&#39;</span>.$this-&gt;source_width.<span class="stringliteral">&#39;&quot;x&quot;&#39;</span>.$this-&gt;source_height.<span class="charliteral">&#39;&quot;&#39;</span>, __FILE__, __LINE__);
<a name="l02900"></a>02900                 <span class="keywordflow">if</span> ($this-&gt;source_height &gt; $this-&gt;source_width) {
<a name="l02901"></a>02901                         <span class="comment">// portrait</span>
<a name="l02902"></a>02902                         $this-&gt;w = <a class="code" href="classphpthumb__functions.html#ada951f9ad225b459c5f4d5974aa82765">phpthumb_functions::OneOfThese</a>($this-&gt;wp, $this-&gt;w, $this-&gt;ws, $this-&gt;wl);
<a name="l02903"></a>02903                         $this-&gt;h = <a class="code" href="classphpthumb__functions.html#ada951f9ad225b459c5f4d5974aa82765">phpthumb_functions::OneOfThese</a>($this-&gt;hp, $this-&gt;h, $this-&gt;hs, $this-&gt;hl);
<a name="l02904"></a>02904                 } <a class="code" href="php_thumb_8demo_8check_8php.html#af92779326267616cd7c3cdaaa9484bc9">elseif</a> ($this-&gt;source_height &lt; $this-&gt;source_width) {
<a name="l02905"></a>02905                         <span class="comment">// landscape</span>
<a name="l02906"></a>02906                         $this-&gt;w = <a class="code" href="classphpthumb__functions.html#ada951f9ad225b459c5f4d5974aa82765">phpthumb_functions::OneOfThese</a>($this-&gt;wl, $this-&gt;w, $this-&gt;ws, $this-&gt;wp);
<a name="l02907"></a>02907                         $this-&gt;h = <a class="code" href="classphpthumb__functions.html#ada951f9ad225b459c5f4d5974aa82765">phpthumb_functions::OneOfThese</a>($this-&gt;hl, $this-&gt;h, $this-&gt;hs, $this-&gt;hp);
<a name="l02908"></a>02908                 } <span class="keywordflow">else</span> {
<a name="l02909"></a>02909                         <span class="comment">// square</span>
<a name="l02910"></a>02910                         $this-&gt;w = <a class="code" href="classphpthumb__functions.html#ada951f9ad225b459c5f4d5974aa82765">phpthumb_functions::OneOfThese</a>($this-&gt;ws, $this-&gt;w, $this-&gt;wl, $this-&gt;wp);
<a name="l02911"></a>02911                         $this-&gt;h = <a class="code" href="classphpthumb__functions.html#ada951f9ad225b459c5f4d5974aa82765">phpthumb_functions::OneOfThese</a>($this-&gt;hs, $this-&gt;h, $this-&gt;hl, $this-&gt;hp);
<a name="l02912"></a>02912                 }
<a name="l02913"></a>02913                 <span class="comment">//$this-&gt;w = round($this-&gt;w ? $this-&gt;w : (($this-&gt;h &amp;&amp; $this-&gt;source_height) ? $this-&gt;h * $this-&gt;source_width  / $this-&gt;source_height : $this-&gt;w));</span>
<a name="l02914"></a>02914                 <span class="comment">//$this-&gt;h = round($this-&gt;h ? $this-&gt;h : (($this-&gt;w &amp;&amp; $this-&gt;source_width)  ? $this-&gt;w * $this-&gt;source_height / $this-&gt;source_width  : $this-&gt;h));</span>
<a name="l02915"></a>02915                 $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;SetOrientationDependantWidthHeight() setting w=&quot;&#39;</span>.intval($this-&gt;w).<span class="stringliteral">&#39;&quot;, h=&quot;&#39;</span>.intval($this-&gt;h).<span class="charliteral">&#39;&quot;&#39;</span>, __FILE__, __LINE__);
<a name="l02916"></a>02916                 <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l02917"></a>02917         }
<a name="l02918"></a>02918 
<a name="l02919"></a><a class="code" href="classphpthumb.html#a49a5e90738a76b0ff5a4d2a5fc61339a">02919</a>         <span class="keyword">function</span> <a class="code" href="classphpthumb.html#a49a5e90738a76b0ff5a4d2a5fc61339a">ExtractEXIFgetImageSize</a>() {
<a name="l02920"></a>02920                 $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;starting ExtractEXIFgetImageSize()&#39;</span>, __FILE__, __LINE__);
<a name="l02921"></a>02921 
<a name="l02922"></a>02922                 <span class="keywordflow">if</span> (eregi(<span class="stringliteral">&#39;^http:&#39;</span>, $this-&gt;src) &amp;&amp; !$this-&gt;sourceFilename &amp;&amp; $this-&gt;<a class="code" href="php_thumb_8demo_8check_8php.html#a863670ff2c90a1dc616ebab121dbb296">rawImageData</a>) {
<a name="l02923"></a>02923                         !$this-&gt;<a class="code" href="classphpthumb.html#a09b35415a9d4a96970b13e5c29c841f0">SourceDataToTempFile</a>();
<a name="l02924"></a>02924                 }
<a name="l02925"></a>02925                 <span class="keywordflow">if</span> (is_null($this-&gt;getimagesizeinfo)) {
<a name="l02926"></a>02926                         <span class="keywordflow">if</span> ($this-&gt;sourceFilename) {
<a name="l02927"></a>02927                                 $this-&gt;getimagesizeinfo = @GetImageSize($this-&gt;sourceFilename);
<a name="l02928"></a>02928                                 $this-&gt;source_width  = $this-&gt;getimagesizeinfo[0];
<a name="l02929"></a>02929                                 $this-&gt;source_height = $this-&gt;getimagesizeinfo[1];
<a name="l02930"></a>02930                                 $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;GetImageSize(&#39;</span>.$this-&gt;sourceFilename.<span class="stringliteral">&#39;) says image is &#39;</span>.$this-&gt;source_width.<span class="charliteral">&#39;x&#39;</span>.$this-&gt;source_height, __FILE__, __LINE__);
<a name="l02931"></a>02931                         } <span class="keywordflow">else</span> {
<a name="l02932"></a>02932                                 $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;skipping GetImageSize() because $this-&gt;sourceFilename is empty&#39;</span>, __FILE__, __LINE__);
<a name="l02933"></a>02933                         }
<a name="l02934"></a>02934                 } <span class="keywordflow">else</span> {
<a name="l02935"></a>02935                         $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;skipping GetImageSize() because !is_null($this-&gt;getimagesizeinfo)&#39;</span>, __FILE__, __LINE__);
<a name="l02936"></a>02936                 }
<a name="l02937"></a>02937 
<a name="l02938"></a>02938                 <span class="keywordflow">if</span> (is_resource($this-&gt;gdimg_source)) {
<a name="l02939"></a>02939 
<a name="l02940"></a>02940                         $this-&gt;source_width  = ImageSX($this-&gt;gdimg_source);
<a name="l02941"></a>02941                         $this-&gt;source_height = ImageSY($this-&gt;gdimg_source);
<a name="l02942"></a>02942 
<a name="l02943"></a>02943                         $this-&gt;<a class="code" href="classphpthumb.html#aad0ac1ff143b9d6bb26210c98d94a2ac">SetOrientationDependantWidthHeight</a>();
<a name="l02944"></a>02944 
<a name="l02945"></a>02945                 } <a class="code" href="php_thumb_8demo_8check_8php.html#af92779326267616cd7c3cdaaa9484bc9">elseif</a> ($this-&gt;<a class="code" href="php_thumb_8demo_8check_8php.html#a863670ff2c90a1dc616ebab121dbb296">rawImageData</a> &amp;&amp; !$this-&gt;sourceFilename) {
<a name="l02946"></a>02946 
<a name="l02947"></a>02947                         <span class="keywordflow">if</span> ($this-&gt;<a class="code" href="classphpthumb.html#a9a86ca8e8ea31a81d2754aca1db0ccc3">SourceImageIsTooLarge</a>($this-&gt;source_width, $this-&gt;source_height)) {
<a name="l02948"></a>02948                                 $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;NOT bypassing EXIF and GetImageSize sections because source image is too large for GD (&#39;</span>.$this-&gt;source_width.<span class="charliteral">&#39;x&#39;</span>.$this-&gt;source_width.<span class="charliteral">&#39;=&#39;</span>.($this-&gt;source_width * $this-&gt;source_height * 5).<span class="stringliteral">&#39;MB)&#39;</span>, __FILE__, __LINE__);
<a name="l02949"></a>02949                         } <span class="keywordflow">else</span> {
<a name="l02950"></a>02950                                 $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;bypassing EXIF and GetImageSize sections because $this-&gt;rawImageData is set, and $this-&gt;sourceFilename is not set, and source image is not too large for GD (&#39;</span>.$this-&gt;source_width.<span class="charliteral">&#39;x&#39;</span>.$this-&gt;source_width.<span class="charliteral">&#39;=&#39;</span>.($this-&gt;source_width * $this-&gt;source_height * 5).<span class="stringliteral">&#39;MB)&#39;</span>, __FILE__, __LINE__);
<a name="l02951"></a>02951                         }
<a name="l02952"></a>02952 
<a name="l02953"></a>02953                 }
<a name="l02954"></a>02954 
<a name="l02955"></a>02955                 <span class="keywordflow">if</span> (!empty($this-&gt;getimagesizeinfo)) {
<a name="l02956"></a>02956                         <span class="comment">// great</span>
<a name="l02957"></a>02957                         $this-&gt;getimagesizeinfo[<span class="stringliteral">&#39;filesize&#39;</span>] = @filesize($this-&gt;sourceFilename);
<a name="l02958"></a>02958                 } <a class="code" href="php_thumb_8demo_8check_8php.html#af92779326267616cd7c3cdaaa9484bc9">elseif</a> (!$this-&gt;<a class="code" href="php_thumb_8demo_8check_8php.html#a863670ff2c90a1dc616ebab121dbb296">rawImageData</a>) {
<a name="l02959"></a>02959                         $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;GetImageSize(&quot;&#39;</span>.$this-&gt;sourceFilename.<span class="stringliteral">&#39;&quot;) failed&#39;</span>, __FILE__, __LINE__);
<a name="l02960"></a>02960                 }
<a name="l02961"></a>02961 
<a name="l02962"></a>02962                 <span class="keywordflow">if</span> ($this-&gt;config_prefer_imagemagick) {
<a name="l02963"></a>02963                         <span class="keywordflow">if</span> ($this-&gt;<a class="code" href="classphpthumb.html#a98b7a1c7536cc9dce401ae3d86ac26fc">ImageMagickThumbnailToGD</a>()) {
<a name="l02964"></a>02964                                 <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l02965"></a>02965                         }
<a name="l02966"></a>02966                         $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;ImageMagickThumbnailToGD() failed&#39;</span>, __FILE__, __LINE__);
<a name="l02967"></a>02967                 }
<a name="l02968"></a>02968 
<a name="l02969"></a>02969                 $this-&gt;<a class="code" href="classphpthumb.html#aad0ac1ff143b9d6bb26210c98d94a2ac">SetOrientationDependantWidthHeight</a>();
<a name="l02970"></a>02970 
<a name="l02971"></a>02971                 <span class="keywordflow">if</span> (<a class="code" href="classphpthumb__functions.html#af53f41b3482e6bed2082daa0ebfd96c0">phpthumb_functions::version_compare_replacement</a>(phpversion(), <span class="stringliteral">&#39;4.2.0&#39;</span>, <span class="stringliteral">&#39;&gt;=&#39;</span>) &amp;&amp; function_exists(<span class="stringliteral">&#39;exif_read_data&#39;</span>)) {
<a name="l02972"></a>02972                         $this-&gt;exif_raw_data = @exif_read_data($this-&gt;sourceFilename, 0, <span class="keyword">true</span>);
<a name="l02973"></a>02973                 }
<a name="l02974"></a>02974                 <span class="keywordflow">if</span> (function_exists(<span class="stringliteral">&#39;exif_thumbnail&#39;</span>) &amp;&amp; ($this-&gt;getimagesizeinfo[2] == 2)) {
<a name="l02975"></a>02975                         <span class="comment">// Extract EXIF info from JPEGs</span>
<a name="l02976"></a>02976 
<a name="l02977"></a>02977                         $this-&gt;exif_thumbnail_width  = <span class="stringliteral">&#39;&#39;</span>;
<a name="l02978"></a>02978                         $this-&gt;exif_thumbnail_height = <span class="stringliteral">&#39;&#39;</span>;
<a name="l02979"></a>02979                         $this-&gt;exif_thumbnail_type   = <span class="stringliteral">&#39;&#39;</span>;
<a name="l02980"></a>02980 
<a name="l02981"></a>02981                         <span class="comment">// The parameters width, height and imagetype are available since PHP v4.3.0</span>
<a name="l02982"></a>02982                         <span class="keywordflow">if</span> (<a class="code" href="classphpthumb__functions.html#af53f41b3482e6bed2082daa0ebfd96c0">phpthumb_functions::version_compare_replacement</a>(phpversion(), <span class="stringliteral">&#39;4.3.0&#39;</span>, <span class="stringliteral">&#39;&gt;=&#39;</span>)) {
<a name="l02983"></a>02983 
<a name="l02984"></a>02984                                 $this-&gt;exif_thumbnail_data = @exif_thumbnail($this-&gt;sourceFilename, $this-&gt;exif_thumbnail_width, $this-&gt;exif_thumbnail_height, $this-&gt;exif_thumbnail_type);
<a name="l02985"></a>02985 
<a name="l02986"></a>02986                         } <span class="keywordflow">else</span> {
<a name="l02987"></a>02987 
<a name="l02988"></a>02988                                 <span class="comment">// older versions of exif_thumbnail output an error message but NOT return false on failure</span>
<a name="l02989"></a>02989                                 ob_start();
<a name="l02990"></a>02990                                 $this-&gt;exif_thumbnail_data = exif_thumbnail($this-&gt;sourceFilename);
<a name="l02991"></a>02991                                 $exit_thumbnail_error = ob_get_contents();
<a name="l02992"></a>02992                                 ob_end_clean();
<a name="l02993"></a>02993                                 <span class="keywordflow">if</span> (!$exit_thumbnail_error &amp;&amp; $this-&gt;exif_thumbnail_data) {
<a name="l02994"></a>02994 
<a name="l02995"></a>02995                                         <span class="keywordflow">if</span> ($gdimg_exif_temp = $this-&gt;<a class="code" href="classphpthumb.html#a7a2d5f7e31c08dd71b834391cb7b1520">ImageCreateFromStringReplacement</a>($this-&gt;exif_thumbnail_data, <span class="keyword">false</span>)) {
<a name="l02996"></a>02996                                                 $this-&gt;exif_thumbnail_width  = ImageSX($gdimg_exif_temp);
<a name="l02997"></a>02997                                                 $this-&gt;exif_thumbnail_height = ImageSY($gdimg_exif_temp);
<a name="l02998"></a>02998                                                 $this-&gt;exif_thumbnail_type   = 2; <span class="comment">// (2 == JPEG) before PHP v4.3.0 only JPEG format EXIF thumbnails are returned</span>
<a name="l02999"></a>02999                                                 unset($gdimg_exif_temp);
<a name="l03000"></a>03000                                         } <span class="keywordflow">else</span> {
<a name="l03001"></a>03001                                                 <span class="keywordflow">return</span> $this-&gt;<a class="code" href="classphpthumb.html#a6ff71b425894fd846790cedf9f9cc97d">ErrorImage</a>(<span class="stringliteral">&#39;Failed - $this-&gt;ImageCreateFromStringReplacement($this-&gt;exif_thumbnail_data) in &#39;</span>.__FILE__.<span class="stringliteral">&#39; on line &#39;</span>.__LINE__);
<a name="l03002"></a>03002                                         }
<a name="l03003"></a>03003 
<a name="l03004"></a>03004                                 }
<a name="l03005"></a>03005 
<a name="l03006"></a>03006                         }
<a name="l03007"></a>03007 
<a name="l03008"></a>03008                 } <a class="code" href="php_thumb_8demo_8check_8php.html#af92779326267616cd7c3cdaaa9484bc9">elseif</a> (!function_exists(<span class="stringliteral">&#39;exif_thumbnail&#39;</span>)) {
<a name="l03009"></a>03009 
<a name="l03010"></a>03010                         $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;exif_thumbnail() does not exist, cannot extract EXIF thumbnail&#39;</span>, __FILE__, __LINE__);
<a name="l03011"></a>03011                         <span class="comment">//return false;</span>
<a name="l03012"></a>03012 
<a name="l03013"></a>03013                 }
<a name="l03014"></a>03014 
<a name="l03015"></a>03015                 $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;EXIF thumbnail extraction: (size=&#39;</span>.strlen($this-&gt;exif_thumbnail_data).<span class="stringliteral">&#39;; type=&quot;&#39;</span>.$this-&gt;exif_thumbnail_type.<span class="stringliteral">&#39;&quot;; &#39;</span>.intval($this-&gt;exif_thumbnail_width).<span class="charliteral">&#39;x&#39;</span>.intval($this-&gt;exif_thumbnail_height).<span class="charliteral">&#39;)&#39;</span>, __FILE__, __LINE__);
<a name="l03016"></a>03016 
<a name="l03017"></a>03017                 <span class="comment">// see if EXIF thumbnail can be used directly with no processing</span>
<a name="l03018"></a>03018                 <span class="keywordflow">if</span> ($this-&gt;config_use_exif_thumbnail_for_speed &amp;&amp; $this-&gt;exif_thumbnail_data) {
<a name="l03019"></a>03019                         <span class="keywordflow">while</span> (<span class="keyword">true</span>) {
<a name="l03020"></a>03020                                 <span class="keywordflow">if</span> (!$this-&gt;xto) {
<a name="l03021"></a>03021                                         $source_ar = $this-&gt;source_width / $this-&gt;source_height;
<a name="l03022"></a>03022                                         $exif_ar = $this-&gt;exif_thumbnail_width / $this-&gt;exif_thumbnail_height;
<a name="l03023"></a>03023                                         <span class="keywordflow">if</span> (number_format($source_ar, 2) != number_format($exif_ar, 2)) {
<a name="l03024"></a>03024                                                 $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;not using EXIF thumbnail because $source_ar != $exif_ar (&#39;</span>.$source_ar.<span class="stringliteral">&#39; != &#39;</span>.$exif_ar.<span class="charliteral">&#39;)&#39;</span>, __FILE__, __LINE__);
<a name="l03025"></a>03025                                                 <span class="keywordflow">break</span>;
<a name="l03026"></a>03026                                         }
<a name="l03027"></a>03027                                         <span class="keywordflow">if</span> ($this-&gt;w &amp;&amp; ($this-&gt;w != $this-&gt;exif_thumbnail_width)) {
<a name="l03028"></a>03028                                                 $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;not using EXIF thumbnail because $this-&gt;w != $this-&gt;exif_thumbnail_width (&#39;</span>.$this-&gt;w.<span class="stringliteral">&#39; != &#39;</span>.$this-&gt;exif_thumbnail_width.<span class="charliteral">&#39;)&#39;</span>, __FILE__, __LINE__);
<a name="l03029"></a>03029                                                 <span class="keywordflow">break</span>;
<a name="l03030"></a>03030                                         }
<a name="l03031"></a>03031                                         <span class="keywordflow">if</span> ($this-&gt;h &amp;&amp; ($this-&gt;h != $this-&gt;exif_thumbnail_height)) {
<a name="l03032"></a>03032                                                 $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;not using EXIF thumbnail because $this-&gt;h != $this-&gt;exif_thumbnail_height (&#39;</span>.$this-&gt;h.<span class="stringliteral">&#39; != &#39;</span>.$this-&gt;exif_thumbnail_height.<span class="charliteral">&#39;)&#39;</span>, __FILE__, __LINE__);
<a name="l03033"></a>03033                                                 <span class="keywordflow">break</span>;
<a name="l03034"></a>03034                                         }
<a name="l03035"></a>03035                                         $CannotBeSetParameters = array(<span class="stringliteral">&#39;sx&#39;</span>, <span class="stringliteral">&#39;sy&#39;</span>, <span class="stringliteral">&#39;sh&#39;</span>, <span class="stringliteral">&#39;sw&#39;</span>, <span class="stringliteral">&#39;far&#39;</span>, <span class="stringliteral">&#39;bg&#39;</span>, <span class="stringliteral">&#39;bc&#39;</span>, <span class="stringliteral">&#39;fltr&#39;</span>, <span class="stringliteral">&#39;phpThumbDebug&#39;</span>);
<a name="l03036"></a>03036                                         <span class="keywordflow">foreach</span> ($CannotBeSetParameters as $parameter) {
<a name="l03037"></a>03037                                                 <span class="keywordflow">if</span> ($this-&gt;$parameter) {
<a name="l03038"></a>03038                                                         <span class="keywordflow">break</span> 2;
<a name="l03039"></a>03039                                                 }
<a name="l03040"></a>03040                                         }
<a name="l03041"></a>03041                                 }
<a name="l03042"></a>03042 
<a name="l03043"></a>03043                                 $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;setting $this-&gt;gdimg_source = $this-&gt;ImageCreateFromStringReplacement($this-&gt;exif_thumbnail_data)&#39;</span>, __FILE__, __LINE__);
<a name="l03044"></a>03044                                 $this-&gt;gdimg_source = $this-&gt;<a class="code" href="classphpthumb.html#a7a2d5f7e31c08dd71b834391cb7b1520">ImageCreateFromStringReplacement</a>($this-&gt;exif_thumbnail_data);
<a name="l03045"></a>03045                                 $this-&gt;source_width  = ImageSX($this-&gt;gdimg_source);
<a name="l03046"></a>03046                                 $this-&gt;source_height = ImageSY($this-&gt;gdimg_source);
<a name="l03047"></a>03047                                 <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l03048"></a>03048                         }
<a name="l03049"></a>03049                 }
<a name="l03050"></a>03050 
<a name="l03051"></a>03051                 <span class="keywordflow">if</span> (($this-&gt;config_max_source_pixels &gt; 0) &amp;&amp; (($this-&gt;source_width * $this-&gt;source_height) &gt; $this-&gt;config_max_source_pixels)) {
<a name="l03052"></a>03052 
<a name="l03053"></a>03053                         <span class="comment">// Source image is larger than would fit in available PHP memory.</span>
<a name="l03054"></a>03054                         <span class="comment">// If ImageMagick is installed, use it to generate the thumbnail.</span>
<a name="l03055"></a>03055                         <span class="comment">// Else, if an EXIF thumbnail is available, use that as the source image.</span>
<a name="l03056"></a>03056                         <span class="comment">// Otherwise, no choice but to fail with an error message</span>
<a name="l03057"></a>03057                         $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;image is &#39;</span>.$this-&gt;source_width.<span class="charliteral">&#39;x&#39;</span>.$this-&gt;source_height.<span class="stringliteral">&#39; and therefore contains more pixels (&#39;</span>.($this-&gt;source_width * $this-&gt;source_height).<span class="stringliteral">&#39;) than $this-&gt;config_max_source_pixels setting (&#39;</span>.$this-&gt;config_max_source_pixels.<span class="charliteral">&#39;)&#39;</span>, __FILE__, __LINE__);
<a name="l03058"></a>03058                         <span class="keywordflow">if</span> (!$this-&gt;config_prefer_imagemagick &amp;&amp; $this-&gt;<a class="code" href="classphpthumb.html#a98b7a1c7536cc9dce401ae3d86ac26fc">ImageMagickThumbnailToGD</a>()) {
<a name="l03059"></a>03059                                 <span class="comment">// excellent, we have a thumbnailed source image</span>
<a name="l03060"></a>03060                                 <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l03061"></a>03061                         }
<a name="l03062"></a>03062 
<a name="l03063"></a>03063                 }
<a name="l03064"></a>03064                 <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l03065"></a>03065         }
<a name="l03066"></a>03066 
<a name="l03067"></a>03067 
<a name="l03068"></a><a class="code" href="classphpthumb.html#a5a0ad9153330752259ca0e350cc4fa44">03068</a>         <span class="keyword">function</span> <a class="code" href="classphpthumb.html#a5a0ad9153330752259ca0e350cc4fa44">SetCacheFilename</a>() {
<a name="l03069"></a>03069                 <span class="keywordflow">if</span> (!is_null($this-&gt;cache_filename)) {
<a name="l03070"></a>03070                         $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;$this-&gt;cache_filename already set, skipping SetCacheFilename()&#39;</span>, __FILE__, __LINE__);
<a name="l03071"></a>03071                         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l03072"></a>03072                 }
<a name="l03073"></a>03073                 $this-&gt;<a class="code" href="classphpthumb.html#a422bcfa5097eee6cd64570424c89a9d1">setOutputFormat</a>();
<a name="l03074"></a>03074                 $this-&gt;<a class="code" href="classphpthumb.html#aabeb053ae1be8517687e11f68955affd">setCacheDirectory</a>();
<a name="l03075"></a>03075                 <span class="keywordflow">if</span> (!$this-&gt;config_cache_directory) {
<a name="l03076"></a>03076                         $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;SetCacheFilename() failed because $this-&gt;config_cache_directory is empty&#39;</span>, __FILE__, __LINE__);
<a name="l03077"></a>03077                         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l03078"></a>03078                 }
<a name="l03079"></a>03079 
<a name="l03080"></a>03080                 <span class="keywordflow">if</span> (!$this-&gt;sourceFilename &amp;&amp; !$this-&gt;<a class="code" href="php_thumb_8demo_8check_8php.html#a863670ff2c90a1dc616ebab121dbb296">rawImageData</a> &amp;&amp; $this-&gt;src) {
<a name="l03081"></a>03081                         $this-&gt;sourceFilename = $this-&gt;<a class="code" href="classphpthumb.html#a49cc25fd831b2990b8f5743e8d6abe30">ResolveFilenameToAbsolute</a>($this-&gt;src);
<a name="l03082"></a>03082                 }
<a name="l03083"></a>03083 
<a name="l03084"></a>03084                 <span class="keywordflow">if</span> ($this-&gt;config_cache_default_only_suffix &amp;&amp; $this-&gt;sourceFilename) {
<a name="l03085"></a>03085                         <span class="comment">// simplified cache filenames:</span>
<a name="l03086"></a>03086                         <span class="comment">// only use default parameters in phpThumb.config.php</span>
<a name="l03087"></a>03087                         <span class="comment">// substitute source filename into * in $this-&gt;config_cache_default_only_suffix</span>
<a name="l03088"></a>03088                         <span class="comment">// (eg: &#39;*_thumb&#39; becomes &#39;picture_thumb.jpg&#39;)</span>
<a name="l03089"></a>03089                         <span class="keywordflow">if</span> (strpos($this-&gt;config_cache_default_only_suffix, <span class="charliteral">&#39;*&#39;</span>) === <span class="keyword">false</span>) {
<a name="l03090"></a>03090                                 $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;aborting simplified caching filename because no * in &quot;&#39;</span>.$this-&gt;config_cache_default_only_suffix.<span class="charliteral">&#39;&quot;&#39;</span>, __FILE__, __LINE__);
<a name="l03091"></a>03091                         } <span class="keywordflow">else</span> {
<a name="l03092"></a>03092                                 eregi(<span class="stringliteral">&#39;(.+)(\.[a-z0-9]+)?$&#39;</span>, basename($this-&gt;sourceFilename), $matches);
<a name="l03093"></a>03093                                 $this-&gt;cache_filename = $this-&gt;config_cache_directory.DIRECTORY_SEPARATOR.rawurlencode(str_replace(<span class="charliteral">&#39;*&#39;</span>, @$matches[1], $this-&gt;config_cache_default_only_suffix)).<span class="charliteral">&#39;.&#39;</span>.strtolower($this-&gt;thumbnailFormat);
<a name="l03094"></a>03094                                 <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l03095"></a>03095                         }
<a name="l03096"></a>03096                 }
<a name="l03097"></a>03097 
<a name="l03098"></a>03098                 $this-&gt;cache_filename = <span class="stringliteral">&#39;&#39;</span>;
<a name="l03099"></a>03099                 $broad_directory_name = <span class="stringliteral">&#39;&#39;</span>;
<a name="l03100"></a>03100                 <span class="keywordflow">if</span> ($this-&gt;<span class="keyword">new</span>) {
<a name="l03101"></a>03101                         $broad_directory_name = strtolower(md5($this-&gt;<span class="keyword">new</span>));
<a name="l03102"></a>03102                         $this-&gt;cache_filename .= <span class="stringliteral">&#39;_new&#39;</span>.$broad_directory_name;
<a name="l03103"></a>03103                 } <a class="code" href="php_thumb_8demo_8check_8php.html#af92779326267616cd7c3cdaaa9484bc9">elseif</a> ($this-&gt;md5s) {
<a name="l03104"></a>03104                         <span class="comment">// source image MD5 hash provided</span>
<a name="l03105"></a>03105                         $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;SetCacheFilename() _raw set from $this-&gt;md5s = &quot;&#39;</span>.$this-&gt;md5s.<span class="charliteral">&#39;&quot;&#39;</span>, __FILE__, __LINE__);
<a name="l03106"></a>03106                         $broad_directory_name = $this-&gt;md5s;
<a name="l03107"></a>03107                         $this-&gt;cache_filename .= <span class="stringliteral">&#39;_raw&#39;</span>.$this-&gt;md5s;
<a name="l03108"></a>03108                 } <a class="code" href="php_thumb_8demo_8check_8php.html#af92779326267616cd7c3cdaaa9484bc9">elseif</a> (!$this-&gt;src &amp;&amp; $this-&gt;<a class="code" href="php_thumb_8demo_8check_8php.html#a863670ff2c90a1dc616ebab121dbb296">rawImageData</a>) {
<a name="l03109"></a>03109                         $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;SetCacheFilename() _raw set from md5($this-&gt;rawImageData) = &quot;&#39;</span>.md5($this-&gt;<a class="code" href="php_thumb_8demo_8check_8php.html#a863670ff2c90a1dc616ebab121dbb296">rawImageData</a>).<span class="charliteral">&#39;&quot;&#39;</span>, __FILE__, __LINE__);
<a name="l03110"></a>03110                         $broad_directory_name = strtolower(md5($this-&gt;<a class="code" href="php_thumb_8demo_8check_8php.html#a863670ff2c90a1dc616ebab121dbb296">rawImageData</a>));
<a name="l03111"></a>03111                         $this-&gt;cache_filename .= <span class="stringliteral">&#39;_raw&#39;</span>.$broad_directory_name;
<a name="l03112"></a>03112                 } <span class="keywordflow">else</span> {
<a name="l03113"></a>03113                         $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;SetCacheFilename() _src set from md5($this-&gt;sourceFilename) &quot;&#39;</span>.$this-&gt;sourceFilename.<span class="stringliteral">&#39;&quot; = &quot;&#39;</span>.md5($this-&gt;sourceFilename).<span class="charliteral">&#39;&quot;&#39;</span>, __FILE__, __LINE__);
<a name="l03114"></a>03114                         $broad_directory_name = strtolower(md5($this-&gt;sourceFilename));
<a name="l03115"></a>03115                         $this-&gt;cache_filename .= <span class="stringliteral">&#39;_src&#39;</span>.$broad_directory_name;
<a name="l03116"></a>03116                 }
<a name="l03117"></a>03117                 <span class="keywordflow">if</span> (@$_SERVER[<span class="stringliteral">&#39;HTTP_REFERER&#39;</span>] &amp;&amp; $this-&gt;config_nooffsitelink_enabled) {
<a name="l03118"></a>03118                         $parsed_url1 = @<a class="code" href="classphpthumb__functions.html#ad7ede725cfcb053c5dbd50308deca6cd">phpthumb_functions::ParseURLbetter</a>(@$_SERVER[<span class="stringliteral">&#39;HTTP_REFERER&#39;</span>]);
<a name="l03119"></a>03119                         $parsed_url2 = @<a class="code" href="classphpthumb__functions.html#ad7ede725cfcb053c5dbd50308deca6cd">phpthumb_functions::ParseURLbetter</a>(<span class="stringliteral">&#39;http://&#39;</span>.@$_SERVER[<span class="stringliteral">&#39;HTTP_HOST&#39;</span>]);
<a name="l03120"></a>03120                         <span class="keywordflow">if</span> (@$parsed_url1[<span class="stringliteral">&#39;host&#39;</span>] &amp;&amp; @$parsed_url2[<span class="stringliteral">&#39;host&#39;</span>] &amp;&amp; ($parsed_url1[<span class="stringliteral">&#39;host&#39;</span>] != $parsed_url2[<span class="stringliteral">&#39;host&#39;</span>])) {
<a name="l03121"></a>03121                                 <span class="comment">// include &quot;_offsite&quot; only if nooffsitelink_enabled and if referrer doesn&#39;t match the domain of the current server</span>
<a name="l03122"></a>03122                                 $this-&gt;cache_filename .= <span class="stringliteral">&#39;_offsite&#39;</span>;
<a name="l03123"></a>03123                         }
<a name="l03124"></a>03124                 }
<a name="l03125"></a>03125 
<a name="l03126"></a>03126                 $ParametersString = <span class="stringliteral">&#39;&#39;</span>;
<a name="l03127"></a>03127                 <span class="keywordflow">if</span> ($this-&gt;fltr &amp;&amp; is_array($this-&gt;fltr)) {
<a name="l03128"></a>03128                         $ParametersString .= <span class="stringliteral">&#39;_fltr&#39;</span>.implode(<span class="stringliteral">&#39;_fltr&#39;</span>, $this-&gt;fltr);
<a name="l03129"></a>03129                 }
<a name="l03130"></a>03130                 $FilenameParameters1 = array(<span class="stringliteral">&#39;ar&#39;</span>, <span class="stringliteral">&#39;bg&#39;</span>, <span class="stringliteral">&#39;bc&#39;</span>, <span class="stringliteral">&#39;far&#39;</span>, <span class="stringliteral">&#39;sx&#39;</span>, <span class="stringliteral">&#39;sy&#39;</span>, <span class="stringliteral">&#39;sw&#39;</span>, <span class="stringliteral">&#39;sh&#39;</span>, <span class="stringliteral">&#39;zc&#39;</span>);
<a name="l03131"></a>03131                 <span class="keywordflow">foreach</span> ($FilenameParameters1 as $key) {
<a name="l03132"></a>03132                         <span class="keywordflow">if</span> ($this-&gt;$key) {
<a name="l03133"></a>03133                                 $ParametersString .= <span class="charliteral">&#39;_&#39;</span>.$key.$this-&gt;$key;
<a name="l03134"></a>03134                         }
<a name="l03135"></a>03135                 }
<a name="l03136"></a>03136                 $FilenameParameters2 = array(<span class="charliteral">&#39;h&#39;</span>, <span class="charliteral">&#39;w&#39;</span>, <span class="stringliteral">&#39;wl&#39;</span>, <span class="stringliteral">&#39;wp&#39;</span>, <span class="stringliteral">&#39;ws&#39;</span>, <span class="stringliteral">&#39;hp&#39;</span>, <span class="stringliteral">&#39;hs&#39;</span>, <span class="stringliteral">&#39;xto&#39;</span>, <span class="stringliteral">&#39;ra&#39;</span>, <span class="stringliteral">&#39;iar&#39;</span>, <span class="stringliteral">&#39;aoe&#39;</span>, <span class="stringliteral">&#39;maxb&#39;</span>, <span class="stringliteral">&#39;sfn&#39;</span>, <span class="stringliteral">&#39;dpi&#39;</span>);
<a name="l03137"></a>03137                 <span class="keywordflow">foreach</span> ($FilenameParameters2 as $key) {
<a name="l03138"></a>03138                         <span class="keywordflow">if</span> ($this-&gt;$key) {
<a name="l03139"></a>03139                                 $ParametersString .= <span class="charliteral">&#39;_&#39;</span>.$key.intval($this-&gt;$key);
<a name="l03140"></a>03140                         }
<a name="l03141"></a>03141                 }
<a name="l03142"></a>03142                 <span class="keywordflow">if</span> ($this-&gt;thumbnailFormat == <span class="stringliteral">&#39;jpeg&#39;</span>) {
<a name="l03143"></a>03143                         <span class="comment">// only JPEG output has variable quality option</span>
<a name="l03144"></a>03144                         $ParametersString .= <span class="stringliteral">&#39;_q&#39;</span>.intval($this-&gt;thumbnailQuality);
<a name="l03145"></a>03145                 }
<a name="l03146"></a>03146                 $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;SetCacheFilename() _par set from md5(&#39;</span>.$ParametersString.<span class="charliteral">&#39;)&#39;</span>, __FILE__, __LINE__);
<a name="l03147"></a>03147                 $this-&gt;cache_filename .= <span class="stringliteral">&#39;_par&#39;</span>.strtolower(md5($ParametersString));
<a name="l03148"></a>03148 
<a name="l03149"></a>03149                 <span class="keywordflow">if</span> ($this-&gt;md5s) {
<a name="l03150"></a>03150                         <span class="comment">// source image MD5 hash provided</span>
<a name="l03151"></a>03151                         <span class="comment">// do not source image modification date --</span>
<a name="l03152"></a>03152                         <span class="comment">// cached image will be used even if file was modified or removed</span>
<a name="l03153"></a>03153                 } <a class="code" href="php_thumb_8demo_8check_8php.html#af92779326267616cd7c3cdaaa9484bc9">elseif</a> (!$this-&gt;config_cache_source_filemtime_ignore_remote &amp;&amp; eregi(<span class="stringliteral">&#39;^(f|ht)tps?\://&#39;</span>, $this-&gt;src)) {
<a name="l03154"></a>03154                         $this-&gt;cache_filename .= <span class="stringliteral">&#39;_dat&#39;</span>.intval(<a class="code" href="classphpthumb__functions.html#aba89973c12394df012c7cf7ceb283cec">phpthumb_functions::filedate_remote</a>($this-&gt;src));
<a name="l03155"></a>03155                 } <a class="code" href="php_thumb_8demo_8check_8php.html#af92779326267616cd7c3cdaaa9484bc9">elseif</a> (!$this-&gt;config_cache_source_filemtime_ignore_local &amp;&amp; $this-&gt;src &amp;&amp; !$this-&gt;<a class="code" href="php_thumb_8demo_8check_8php.html#a863670ff2c90a1dc616ebab121dbb296">rawImageData</a>) {
<a name="l03156"></a>03156                         $this-&gt;cache_filename .= <span class="stringliteral">&#39;_dat&#39;</span>.intval(@filemtime($this-&gt;sourceFilename));
<a name="l03157"></a>03157                 }
<a name="l03158"></a>03158 
<a name="l03159"></a>03159                 $this-&gt;cache_filename .= <span class="charliteral">&#39;.&#39;</span>.strtolower($this-&gt;thumbnailFormat);
<a name="l03160"></a>03160                 $broad_directories = <span class="stringliteral">&#39;&#39;</span>;
<a name="l03161"></a>03161                 <span class="keywordflow">for</span> ($i = 0; $i &lt; $this-&gt;config_cache_directory_depth; $i++) {
<a name="l03162"></a>03162                         $broad_directories .= DIRECTORY_SEPARATOR.substr($broad_directory_name, 0, $i + 1);
<a name="l03163"></a>03163                 }
<a name="l03164"></a>03164 
<a name="l03165"></a>03165                 $this-&gt;cache_filename = $this-&gt;config_cache_directory.$broad_directories.DIRECTORY_SEPARATOR.$this-&gt;config_cache_prefix.rawurlencode($this-&gt;cache_filename);
<a name="l03166"></a>03166                 <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l03167"></a>03167         }
<a name="l03168"></a>03168 
<a name="l03169"></a>03169 
<a name="l03170"></a><a class="code" href="classphpthumb.html#a9a86ca8e8ea31a81d2754aca1db0ccc3">03170</a>         <span class="keyword">function</span> <a class="code" href="classphpthumb.html#a9a86ca8e8ea31a81d2754aca1db0ccc3">SourceImageIsTooLarge</a>($width, $height) {
<a name="l03171"></a>03171                 <span class="keywordflow">if</span> (!$this-&gt;config_max_source_pixels) {
<a name="l03172"></a>03172                         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l03173"></a>03173                 }
<a name="l03174"></a>03174                 <span class="keywordflow">if</span> (function_exists(<span class="stringliteral">&#39;memory_get_usage&#39;</span>)) {
<a name="l03175"></a>03175                         $available_memory = max(intval(ini_get(<span class="stringliteral">&#39;memory_limit&#39;</span>)), intval(get_cfg_var(<span class="stringliteral">&#39;memory_limit&#39;</span>))) * 1048576;
<a name="l03176"></a>03176                         $available_memory -= memory_get_usage();
<a name="l03177"></a>03177                         <span class="keywordflow">return</span> (<span class="keywordtype">bool</span>) (($width * $height * 5) &gt; $available_memory);
<a name="l03178"></a>03178                 }
<a name="l03179"></a>03179                 <span class="keywordflow">return</span> (<span class="keywordtype">bool</span>) (($width * $height) &gt; $this-&gt;config_max_source_pixels);
<a name="l03180"></a>03180         }
<a name="l03181"></a>03181 
<a name="l03182"></a><a class="code" href="classphpthumb.html#ab25e890433143e4ebacf894a3dc00243">03182</a>         <span class="keyword">function</span> <a class="code" href="classphpthumb.html#ab25e890433143e4ebacf894a3dc00243">ImageCreateFromFilename</a>(<a class="code" href="actions_8php.html#a6b7de8d10c540db2f1631e68b2aa0538">$filename</a>) {
<a name="l03183"></a>03183                 <span class="comment">// try to create GD image source directly via GD, if possible,</span>
<a name="l03184"></a>03184                 <span class="comment">// rather than buffering to memory and creating with ImageCreateFromString</span>
<a name="l03185"></a>03185                 $ImageCreateWasAttempted = <span class="keyword">false</span>;
<a name="l03186"></a>03186                 $gd_image = <span class="keyword">false</span>;
<a name="l03187"></a>03187 
<a name="l03188"></a>03188                 $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;starting ImageCreateFromFilename(&#39;</span>.<a class="code" href="actions_8php.html#a6b7de8d10c540db2f1631e68b2aa0538">$filename</a>.<span class="charliteral">&#39;)&#39;</span>, __FILE__, __LINE__);
<a name="l03189"></a>03189                 <span class="keywordflow">if</span> (<a class="code" href="actions_8php.html#a6b7de8d10c540db2f1631e68b2aa0538">$filename</a> &amp;&amp; (<a class="code" href="classphpthumb.html#ae792bec090643e366be48e28c3eced54">$getimagesizeinfo</a> = @GetImageSize(<a class="code" href="actions_8php.html#a6b7de8d10c540db2f1631e68b2aa0538">$filename</a>))) {
<a name="l03190"></a>03190                         <span class="keywordflow">if</span> (!$this-&gt;<a class="code" href="classphpthumb.html#a9a86ca8e8ea31a81d2754aca1db0ccc3">SourceImageIsTooLarge</a>(<a class="code" href="classphpthumb.html#ae792bec090643e366be48e28c3eced54">$getimagesizeinfo</a>[0], <a class="code" href="classphpthumb.html#ae792bec090643e366be48e28c3eced54">$getimagesizeinfo</a>[1])) {
<a name="l03191"></a>03191                                 $ImageCreateFromFunction = array(
<a name="l03192"></a>03192                                         1  =&gt; <span class="stringliteral">&#39;ImageCreateFromGIF&#39;</span>,
<a name="l03193"></a>03193                                         2  =&gt; <span class="stringliteral">&#39;ImageCreateFromJPEG&#39;</span>,
<a name="l03194"></a>03194                                         3  =&gt; <span class="stringliteral">&#39;ImageCreateFromPNG&#39;</span>,
<a name="l03195"></a>03195                                         15 =&gt; <span class="stringliteral">&#39;ImageCreateFromWBMP&#39;</span>,
<a name="l03196"></a>03196                                 );
<a name="l03197"></a>03197                                 $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;ImageCreateFromFilename found ($getimagesizeinfo[2]==&#39;</span>.@<a class="code" href="classphpthumb.html#ae792bec090643e366be48e28c3eced54">$getimagesizeinfo</a>[2].<span class="charliteral">&#39;)&#39;</span>, __FILE__, __LINE__);
<a name="l03198"></a>03198                                 <span class="keywordflow">switch</span> (@<a class="code" href="classphpthumb.html#ae792bec090643e366be48e28c3eced54">$getimagesizeinfo</a>[2]) {
<a name="l03199"></a>03199                                         <span class="keywordflow">case</span> 1:  <span class="comment">// GIF</span>
<a name="l03200"></a>03200                                         <span class="keywordflow">case</span> 2:  <span class="comment">// JPEG</span>
<a name="l03201"></a>03201                                         <span class="keywordflow">case</span> 3:  <span class="comment">// PNG</span>
<a name="l03202"></a>03202                                         <span class="keywordflow">case</span> 15: <span class="comment">// WBMP</span>
<a name="l03203"></a>03203                                                 $ImageCreateFromFunctionName = $ImageCreateFromFunction[<a class="code" href="classphpthumb.html#ae792bec090643e366be48e28c3eced54">$getimagesizeinfo</a>[2]];
<a name="l03204"></a>03204                                                 <span class="keywordflow">if</span> (function_exists($ImageCreateFromFunctionName)) {
<a name="l03205"></a>03205                                                         $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;Calling &#39;</span>.$ImageCreateFromFunctionName.<span class="charliteral">&#39;(&#39;</span>.<a class="code" href="actions_8php.html#a6b7de8d10c540db2f1631e68b2aa0538">$filename</a>.<span class="charliteral">&#39;)&#39;</span>, __FILE__, __LINE__);
<a name="l03206"></a>03206                                                         $ImageCreateWasAttempted = <span class="keyword">true</span>;
<a name="l03207"></a>03207                                                         $gd_image = $ImageCreateFromFunctionName(<a class="code" href="actions_8php.html#a6b7de8d10c540db2f1631e68b2aa0538">$filename</a>);
<a name="l03208"></a>03208                                                 } <span class="keywordflow">else</span> {
<a name="l03209"></a>03209                                                         $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;NOT calling &#39;</span>.$ImageCreateFromFunctionName.<span class="charliteral">&#39;(&#39;</span>.<a class="code" href="actions_8php.html#a6b7de8d10c540db2f1631e68b2aa0538">$filename</a>.<span class="stringliteral">&#39;) because !function_exists(&#39;</span>.$ImageCreateFromFunctionName.<span class="charliteral">&#39;)&#39;</span>, __FILE__, __LINE__);
<a name="l03210"></a>03210                                                 }
<a name="l03211"></a>03211                                                 <span class="keywordflow">break</span>;
<a name="l03212"></a>03212 
<a name="l03213"></a>03213                                         <span class="keywordflow">case</span> 4:  <span class="comment">// SWF</span>
<a name="l03214"></a>03214                                         <span class="keywordflow">case</span> 5:  <span class="comment">// PSD</span>
<a name="l03215"></a>03215                                         <span class="keywordflow">case</span> 6:  <span class="comment">// BMP</span>
<a name="l03216"></a>03216                                         <span class="keywordflow">case</span> 7:  <span class="comment">// TIFF (LE)</span>
<a name="l03217"></a>03217                                         <span class="keywordflow">case</span> 8:  <span class="comment">// TIFF (BE)</span>
<a name="l03218"></a>03218                                         <span class="keywordflow">case</span> 9:  <span class="comment">// JPC</span>
<a name="l03219"></a>03219                                         <span class="keywordflow">case</span> 10: <span class="comment">// JP2</span>
<a name="l03220"></a>03220                                         <span class="keywordflow">case</span> 11: <span class="comment">// JPX</span>
<a name="l03221"></a>03221                                         <span class="keywordflow">case</span> 12: <span class="comment">// JB2</span>
<a name="l03222"></a>03222                                         <span class="keywordflow">case</span> 13: <span class="comment">// SWC</span>
<a name="l03223"></a>03223                                         <span class="keywordflow">case</span> 14: <span class="comment">// IFF</span>
<a name="l03224"></a>03224                                         <span class="keywordflow">case</span> 16: <span class="comment">// XBM</span>
<a name="l03225"></a>03225                                                 $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;No built-in image creation function for image type &quot;&#39;</span>.@$getimagesizeinfo[2].<span class="stringliteral">&#39;&quot; ($getimagesizeinfo[2])&#39;</span>, __FILE__, __LINE__);
<a name="l03226"></a>03226                                                 <span class="keywordflow">break</span>;
<a name="l03227"></a>03227 
<a name="l03228"></a>03228                                         <span class="keywordflow">default</span>:
<a name="l03229"></a>03229                                                 $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;Unknown value for $getimagesizeinfo[2]: &quot;&#39;</span>.@$getimagesizeinfo[2].<span class="charliteral">&#39;&quot;&#39;</span>, __FILE__, __LINE__);
<a name="l03230"></a>03230                                                 <span class="keywordflow">break</span>;
<a name="l03231"></a>03231                                 }
<a name="l03232"></a>03232                         } <span class="keywordflow">else</span> {
<a name="l03233"></a>03233                                 $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;image is &#39;</span>.<a class="code" href="classphpthumb.html#ae792bec090643e366be48e28c3eced54">$getimagesizeinfo</a>[0].<span class="charliteral">&#39;x&#39;</span>.<a class="code" href="classphpthumb.html#ae792bec090643e366be48e28c3eced54">$getimagesizeinfo</a>[1].<span class="stringliteral">&#39; and therefore contains more pixels (&#39;</span>.(<a class="code" href="classphpthumb.html#ae792bec090643e366be48e28c3eced54">$getimagesizeinfo</a>[0] * <a class="code" href="classphpthumb.html#ae792bec090643e366be48e28c3eced54">$getimagesizeinfo</a>[1]).<span class="stringliteral">&#39;) than $this-&gt;config_max_source_pixels setting (&#39;</span>.$this-&gt;config_max_source_pixels.<span class="charliteral">&#39;)&#39;</span>, __FILE__, __LINE__);
<a name="l03234"></a>03234                                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l03235"></a>03235                         }
<a name="l03236"></a>03236                 } <span class="keywordflow">else</span> {
<a name="l03237"></a>03237                         $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;empty $filename or GetImageSize(&#39;</span>.<a class="code" href="actions_8php.html#a6b7de8d10c540db2f1631e68b2aa0538">$filename</a>.<span class="stringliteral">&#39;) failed&#39;</span>, __FILE__, __LINE__);
<a name="l03238"></a>03238                 }
<a name="l03239"></a>03239 
<a name="l03240"></a>03240                 <span class="keywordflow">if</span> (!$gd_image) {
<a name="l03241"></a>03241                         <span class="comment">// cannot create from filename, attempt to create source image with ImageCreateFromString, if possible</span>
<a name="l03242"></a>03242                         <span class="keywordflow">if</span> ($ImageCreateWasAttempted) {
<a name="l03243"></a>03243                                 $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(@$ImageCreateFromFunctionName.<span class="stringliteral">&#39;() was attempted but FAILED&#39;</span>, __FILE__, __LINE__);
<a name="l03244"></a>03244                         }
<a name="l03245"></a>03245                         $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;Populating $rawimagedata&#39;</span>, __FILE__, __LINE__);
<a name="l03246"></a>03246                         $rawimagedata = <span class="stringliteral">&#39;&#39;</span>;
<a name="l03247"></a>03247                         <span class="keywordflow">if</span> ($fp = @fopen(<a class="code" href="actions_8php.html#a6b7de8d10c540db2f1631e68b2aa0538">$filename</a>, <span class="stringliteral">&#39;rb&#39;</span>)) {
<a name="l03248"></a>03248                                 $filesize = filesize(<a class="code" href="actions_8php.html#a6b7de8d10c540db2f1631e68b2aa0538">$filename</a>);
<a name="l03249"></a>03249                                 $blocksize = 8192;
<a name="l03250"></a>03250                                 $blockreads = ceil($filesize / $blocksize);
<a name="l03251"></a>03251                                 <span class="keywordflow">for</span> ($i = 0; $i &lt; $blockreads; $i++) {
<a name="l03252"></a>03252                                         $rawimagedata .= fread($fp, $blocksize);
<a name="l03253"></a>03253                                 }
<a name="l03254"></a>03254                                 fclose($fp);
<a name="l03255"></a>03255                         } <span class="keywordflow">else</span> {
<a name="l03256"></a>03256                                 $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;cannot fopen(&#39;</span>.<a class="code" href="actions_8php.html#a6b7de8d10c540db2f1631e68b2aa0538">$filename</a>.<span class="charliteral">&#39;)&#39;</span>, __FILE__, __LINE__);
<a name="l03257"></a>03257                         }
<a name="l03258"></a>03258                         <span class="keywordflow">if</span> ($rawimagedata) {
<a name="l03259"></a>03259                                 $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;attempting ImageCreateFromStringReplacement($rawimagedata (&#39;</span>.strlen($rawimagedata).<span class="stringliteral">&#39; bytes), true)&#39;</span>, __FILE__, __LINE__);
<a name="l03260"></a>03260                                 $gd_image = $this-&gt;<a class="code" href="classphpthumb.html#a7a2d5f7e31c08dd71b834391cb7b1520">ImageCreateFromStringReplacement</a>($rawimagedata, <span class="keyword">true</span>);
<a name="l03261"></a>03261                         }
<a name="l03262"></a>03262                 }
<a name="l03263"></a>03263                 <span class="keywordflow">return</span> $gd_image;
<a name="l03264"></a>03264         }
<a name="l03265"></a>03265 
<a name="l03266"></a><a class="code" href="classphpthumb.html#a92f78bcb7f3b0018668b51be60821f9c">03266</a>         <span class="keyword">function</span> <a class="code" href="classphpthumb.html#a92f78bcb7f3b0018668b51be60821f9c">SourceImageToGD</a>() {
<a name="l03267"></a>03267                 <span class="keywordflow">if</span> (is_resource($this-&gt;gdimg_source)) {
<a name="l03268"></a>03268                         $this-&gt;source_width  = ImageSX($this-&gt;gdimg_source);
<a name="l03269"></a>03269                         $this-&gt;source_height = ImageSY($this-&gt;gdimg_source);
<a name="l03270"></a>03270                         $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;skipping SourceImageToGD() because $this-&gt;gdimg_source is already a resource (&#39;</span>.$this-&gt;source_width.<span class="charliteral">&#39;x&#39;</span>.$this-&gt;source_height.<span class="charliteral">&#39;)&#39;</span>, __FILE__, __LINE__);
<a name="l03271"></a>03271                         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l03272"></a>03272                 }
<a name="l03273"></a>03273                 $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;starting SourceImageToGD()&#39;</span>, __FILE__, __LINE__);
<a name="l03274"></a>03274 
<a name="l03275"></a>03275                 <span class="keywordflow">if</span> ($this-&gt;<a class="code" href="classphpthumb.html#a98b7a1c7536cc9dce401ae3d86ac26fc">ImageMagickThumbnailToGD</a>()) {
<a name="l03276"></a>03276 
<a name="l03277"></a>03277                         <span class="comment">// excellent, we have a thumbnailed source image</span>
<a name="l03278"></a>03278                         $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;ImageMagickThumbnailToGD() succeeded&#39;</span>, __FILE__, __LINE__);
<a name="l03279"></a>03279 
<a name="l03280"></a>03280                 } <a class="code" href="php_thumb_8demo_8check_8php.html#af92779326267616cd7c3cdaaa9484bc9">elseif</a> (!$this-&gt;gdimg_source &amp;&amp; $this-&gt;<a class="code" href="php_thumb_8demo_8check_8php.html#a863670ff2c90a1dc616ebab121dbb296">rawImageData</a>) {
<a name="l03281"></a>03281 
<a name="l03282"></a>03282                         <span class="keywordflow">if</span> ($this-&gt;<a class="code" href="classphpthumb.html#a9a86ca8e8ea31a81d2754aca1db0ccc3">SourceImageIsTooLarge</a>($this-&gt;source_width, $this-&gt;source_height)) {
<a name="l03283"></a>03283                                 $memory_get_usage = (function_exists(<span class="stringliteral">&#39;memory_get_usage&#39;</span>) ? memory_get_usage() : 0);
<a name="l03284"></a>03284                                 <span class="keywordflow">return</span> $this-&gt;<a class="code" href="classphpthumb.html#a6ff71b425894fd846790cedf9f9cc97d">ErrorImage</a>(<span class="stringliteral">&#39;Source image is too large (&#39;</span>.$this-&gt;source_width.<span class="charliteral">&#39;x&#39;</span>.$this-&gt;source_height.<span class="stringliteral">&#39; = &#39;</span>.number_format($this-&gt;source_width * $this-&gt;source_height / 1000000, 1).<span class="stringliteral">&#39;Mpx, max=&#39;</span>.number_format($this-&gt;config_max_source_pixels / 1000000, 1).<span class="stringliteral">&#39;Mpx) for GD creation (either install ImageMagick or increase PHP memory_limit to at least &#39;</span>.ceil(($memory_get_usage + (5 * $this-&gt;source_width * $this-&gt;source_height)) / 1048576).<span class="stringliteral">&#39;M).&#39;</span>);
<a name="l03285"></a>03285                         }
<a name="l03286"></a>03286                         <span class="keywordflow">if</span> ($this-&gt;md5s &amp;&amp; ($this-&gt;md5s != md5($this-&gt;<a class="code" href="php_thumb_8demo_8check_8php.html#a863670ff2c90a1dc616ebab121dbb296">rawImageData</a>))) {
<a name="l03287"></a>03287                                 <span class="keywordflow">return</span> $this-&gt;<a class="code" href="classphpthumb.html#a6ff71b425894fd846790cedf9f9cc97d">ErrorImage</a>(<span class="stringliteral">&#39;$this-&gt;md5s != md5($this-&gt;rawImageData)&#39;</span>.<span class="stringliteral">&quot;\n&quot;</span>.<span class="charliteral">&#39;&quot;&#39;</span>.$this-&gt;md5s.<span class="stringliteral">&#39;&quot; != &#39;</span>.<span class="stringliteral">&quot;\n&quot;</span>.<span class="charliteral">&#39;&quot;&#39;</span>.md5($this-&gt;<a class="code" href="php_thumb_8demo_8check_8php.html#a863670ff2c90a1dc616ebab121dbb296">rawImageData</a>).<span class="charliteral">&#39;&quot;&#39;</span>);
<a name="l03288"></a>03288                         }
<a name="l03289"></a>03289                         <span class="comment">//if (ini_get(&#39;safe_mode&#39;)) {</span>
<a name="l03290"></a>03290                         <span class="comment">//      return $this-&gt;ErrorImage(&#39;Cannot generate thumbnails from raw image data when PHP SAFE_MODE enabled&#39;);</span>
<a name="l03291"></a>03291                         <span class="comment">//}</span>
<a name="l03292"></a>03292                         $this-&gt;gdimg_source = $this-&gt;<a class="code" href="classphpthumb.html#a7a2d5f7e31c08dd71b834391cb7b1520">ImageCreateFromStringReplacement</a>($this-&gt;<a class="code" href="php_thumb_8demo_8check_8php.html#a863670ff2c90a1dc616ebab121dbb296">rawImageData</a>);
<a name="l03293"></a>03293                         <span class="keywordflow">if</span> (!$this-&gt;gdimg_source) {
<a name="l03294"></a>03294                                 <span class="keywordflow">if</span> (substr($this-&gt;<a class="code" href="php_thumb_8demo_8check_8php.html#a863670ff2c90a1dc616ebab121dbb296">rawImageData</a>, 0, 2) === <span class="stringliteral">&#39;BM&#39;</span>) {
<a name="l03295"></a>03295                                         $this-&gt;getimagesizeinfo[2] = 6; <span class="comment">// BMP</span>
<a name="l03296"></a>03296                                 } <a class="code" href="php_thumb_8demo_8check_8php.html#af92779326267616cd7c3cdaaa9484bc9">elseif</a> (substr($this-&gt;<a class="code" href="php_thumb_8demo_8check_8php.html#a863670ff2c90a1dc616ebab121dbb296">rawImageData</a>, 0, 4) === <span class="stringliteral">&#39;II&#39;</span>.<span class="stringliteral">&quot;\x2A\x00&quot;</span>) {
<a name="l03297"></a>03297                                         $this-&gt;getimagesizeinfo[2] = 7; <span class="comment">// TIFF (littlendian)</span>
<a name="l03298"></a>03298                                 } <a class="code" href="php_thumb_8demo_8check_8php.html#af92779326267616cd7c3cdaaa9484bc9">elseif</a> (substr($this-&gt;<a class="code" href="php_thumb_8demo_8check_8php.html#a863670ff2c90a1dc616ebab121dbb296">rawImageData</a>, 0, 4) === <span class="stringliteral">&#39;MM&#39;</span>.<span class="stringliteral">&quot;\x00\x2A&quot;</span>) {
<a name="l03299"></a>03299                                         $this-&gt;getimagesizeinfo[2] = 8; <span class="comment">// TIFF (bigendian)</span>
<a name="l03300"></a>03300                                 }
<a name="l03301"></a>03301                                 $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;SourceImageToGD.ImageCreateFromStringReplacement() failed with unknown image type &quot;&#39;</span>.substr($this-&gt;<a class="code" href="php_thumb_8demo_8check_8php.html#a863670ff2c90a1dc616ebab121dbb296">rawImageData</a>, 0, 4).<span class="stringliteral">&#39;&quot; (&#39;</span>.<a class="code" href="classphpthumb__functions.html#a990a73d0fe31b520e04251295aeded25">phpthumb_functions::HexCharDisplay</a>(substr($this-&gt;<a class="code" href="php_thumb_8demo_8check_8php.html#a863670ff2c90a1dc616ebab121dbb296">rawImageData</a>, 0, 4)).<span class="charliteral">&#39;)&#39;</span>, __FILE__, __LINE__);
<a name="l03302"></a>03302 <span class="comment">//                              return $this-&gt;ErrorImage(&#39;Unknown image type identified by &quot;&#39;.substr($this-&gt;rawImageData, 0, 4).&#39;&quot; (&#39;.phpthumb_functions::HexCharDisplay(substr($this-&gt;rawImageData, 0, 4)).&#39;) in SourceImageToGD()[&#39;.__LINE__.&#39;]&#39;);</span>
<a name="l03303"></a>03303                         }
<a name="l03304"></a>03304 
<a name="l03305"></a>03305                 } <a class="code" href="php_thumb_8demo_8check_8php.html#af92779326267616cd7c3cdaaa9484bc9">elseif</a> (!$this-&gt;gdimg_source &amp;&amp; $this-&gt;sourceFilename) {
<a name="l03306"></a>03306 
<a name="l03307"></a>03307                         <span class="keywordflow">if</span> ($this-&gt;md5s &amp;&amp; ($this-&gt;md5s != <a class="code" href="classphpthumb__functions.html#a992583009b07598f893b8b6773513926">phpthumb_functions::md5_file_safe</a>($this-&gt;sourceFilename))) {
<a name="l03308"></a>03308                                 <span class="keywordflow">return</span> $this-&gt;<a class="code" href="classphpthumb.html#a6ff71b425894fd846790cedf9f9cc97d">ErrorImage</a>(<span class="stringliteral">&#39;$this-&gt;md5s != md5(sourceFilename)&#39;</span>.<span class="stringliteral">&quot;\n&quot;</span>.<span class="charliteral">&#39;&quot;&#39;</span>.$this-&gt;md5s.<span class="stringliteral">&#39;&quot; != &#39;</span>.<span class="stringliteral">&quot;\n&quot;</span>.<span class="charliteral">&#39;&quot;&#39;</span>.<a class="code" href="classphpthumb__functions.html#a992583009b07598f893b8b6773513926">phpthumb_functions::md5_file_safe</a>($this-&gt;sourceFilename).<span class="charliteral">&#39;&quot;&#39;</span>);
<a name="l03309"></a>03309                         }
<a name="l03310"></a>03310                         <span class="keywordflow">switch</span> (@$this-&gt;getimagesizeinfo[2]) {
<a name="l03311"></a>03311                                 <span class="keywordflow">case</span> 1:
<a name="l03312"></a>03312                                 <span class="keywordflow">case</span> 3:
<a name="l03313"></a>03313                                         <span class="comment">// GIF or PNG input file may have transparency</span>
<a name="l03314"></a>03314                                         $this-&gt;is_alpha = <span class="keyword">true</span>;
<a name="l03315"></a>03315                                         <span class="keywordflow">break</span>;
<a name="l03316"></a>03316                         }
<a name="l03317"></a>03317                         <span class="keywordflow">if</span> (!$this-&gt;<a class="code" href="classphpthumb.html#a9a86ca8e8ea31a81d2754aca1db0ccc3">SourceImageIsTooLarge</a>($this-&gt;source_width, $this-&gt;source_height)) {
<a name="l03318"></a>03318                                 $this-&gt;gdimg_source = $this-&gt;<a class="code" href="classphpthumb.html#ab25e890433143e4ebacf894a3dc00243">ImageCreateFromFilename</a>($this-&gt;sourceFilename);
<a name="l03319"></a>03319                         }
<a name="l03320"></a>03320 
<a name="l03321"></a>03321                 }
<a name="l03322"></a>03322 
<a name="l03323"></a>03323                 <span class="keywordflow">while</span> (<span class="keyword">true</span>) {
<a name="l03324"></a>03324                         <span class="keywordflow">if</span> ($this-&gt;gdimg_source) {
<a name="l03325"></a>03325                                 $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;Not using EXIF thumbnail data because $this-&gt;gdimg_source is already set&#39;</span>, __FILE__, __LINE__);
<a name="l03326"></a>03326                                 <span class="keywordflow">break</span>;
<a name="l03327"></a>03327                         }
<a name="l03328"></a>03328                         <span class="keywordflow">if</span> (!$this-&gt;exif_thumbnail_data) {
<a name="l03329"></a>03329                                 $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;Not using EXIF thumbnail data because $this-&gt;exif_thumbnail_data is empty&#39;</span>, __FILE__, __LINE__);
<a name="l03330"></a>03330                                 <span class="keywordflow">break</span>;
<a name="l03331"></a>03331                         }
<a name="l03332"></a>03332                         <span class="keywordflow">if</span> (ini_get(<span class="stringliteral">&#39;safe_mode&#39;</span>)) {
<a name="l03333"></a>03333                                 <span class="keywordflow">if</span> (!$this-&gt;<a class="code" href="classphpthumb.html#a9a86ca8e8ea31a81d2754aca1db0ccc3">SourceImageIsTooLarge</a>($this-&gt;source_width, $this-&gt;source_height)) {
<a name="l03334"></a>03334                                         $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;Using EXIF thumbnail data because source image too large and safe_mode enabled&#39;</span>, __FILE__, __LINE__);
<a name="l03335"></a>03335                                         $this-&gt;aoe = <span class="keyword">true</span>;
<a name="l03336"></a>03336                                 } <span class="keywordflow">else</span> {
<a name="l03337"></a>03337                                         <span class="keywordflow">break</span>;
<a name="l03338"></a>03338                                 }
<a name="l03339"></a>03339                         } <span class="keywordflow">else</span> {
<a name="l03340"></a>03340                                 <span class="keywordflow">if</span> (!$this-&gt;config_use_exif_thumbnail_for_speed) {
<a name="l03341"></a>03341                                         $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;Not using EXIF thumbnail data because $this-&gt;config_use_exif_thumbnail_for_speed is FALSE&#39;</span>, __FILE__, __LINE__);
<a name="l03342"></a>03342                                         <span class="keywordflow">break</span>;
<a name="l03343"></a>03343                                 }
<a name="l03344"></a>03344                                 <span class="keywordflow">if</span> (($this-&gt;thumbnailCropX != 0) || ($this-&gt;thumbnailCropY != 0)) {
<a name="l03345"></a>03345                                         $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;Not using EXIF thumbnail data because source cropping is enabled (&#39;</span>.$this-&gt;thumbnailCropX.<span class="charliteral">&#39;,&#39;</span>.$this-&gt;thumbnailCropY.<span class="charliteral">&#39;)&#39;</span>, __FILE__, __LINE__);
<a name="l03346"></a>03346                                         <span class="keywordflow">break</span>;
<a name="l03347"></a>03347                                 }
<a name="l03348"></a>03348                                 <span class="keywordflow">if</span> (($this-&gt;w &gt; $this-&gt;exif_thumbnail_width) || ($this-&gt;h &gt; $this-&gt;exif_thumbnail_height)) {
<a name="l03349"></a>03349                                         $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;Not using EXIF thumbnail data because EXIF thumbnail is too small (&#39;</span>.$this-&gt;exif_thumbnail_width.<span class="charliteral">&#39;x&#39;</span>.$this-&gt;exif_thumbnail_height.<span class="stringliteral">&#39; vs &#39;</span>.$this-&gt;w.<span class="charliteral">&#39;x&#39;</span>.$this-&gt;h.<span class="charliteral">&#39;)&#39;</span>, __FILE__, __LINE__);
<a name="l03350"></a>03350                                         <span class="keywordflow">break</span>;
<a name="l03351"></a>03351                                 }
<a name="l03352"></a>03352                                 $source_ar = $this-&gt;source_width / $this-&gt;source_height;
<a name="l03353"></a>03353                                 $exif_ar   = $this-&gt;exif_thumbnail_width / $this-&gt;exif_thumbnail_height;
<a name="l03354"></a>03354                                 <span class="keywordflow">if</span> (number_format($source_ar, 2) != number_format($exif_ar, 2)) {
<a name="l03355"></a>03355                                         $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;not using EXIF thumbnail because $source_ar != $exif_ar (&#39;</span>.$source_ar.<span class="stringliteral">&#39; != &#39;</span>.$exif_ar.<span class="charliteral">&#39;)&#39;</span>, __FILE__, __LINE__);
<a name="l03356"></a>03356                                         <span class="keywordflow">break</span>;
<a name="l03357"></a>03357                                 }
<a name="l03358"></a>03358                         }
<a name="l03359"></a>03359 
<a name="l03360"></a>03360                         <span class="comment">// EXIF thumbnail exists, and is equal to or larger than destination thumbnail, and will be use as source image</span>
<a name="l03361"></a>03361                         $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;Trying to use EXIF thumbnail as source image&#39;</span>, __FILE__, __LINE__);
<a name="l03362"></a>03362 
<a name="l03363"></a>03363                         <span class="keywordflow">if</span> ($gdimg_exif_temp = $this-&gt;<a class="code" href="classphpthumb.html#a7a2d5f7e31c08dd71b834391cb7b1520">ImageCreateFromStringReplacement</a>($this-&gt;exif_thumbnail_data, <span class="keyword">false</span>)) {
<a name="l03364"></a>03364 
<a name="l03365"></a>03365                                 $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;Successfully using EXIF thumbnail as source image&#39;</span>, __FILE__, __LINE__);
<a name="l03366"></a>03366                                 $this-&gt;gdimg_source   = $gdimg_exif_temp;
<a name="l03367"></a>03367                                 $this-&gt;source_width   = $this-&gt;exif_thumbnail_width;
<a name="l03368"></a>03368                                 $this-&gt;source_height  = $this-&gt;exif_thumbnail_height;
<a name="l03369"></a>03369                                 $this-&gt;thumbnailCropW = $this-&gt;source_width;
<a name="l03370"></a>03370                                 $this-&gt;thumbnailCropH = $this-&gt;source_height;
<a name="l03371"></a>03371                                 <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l03372"></a>03372 
<a name="l03373"></a>03373                         } <span class="keywordflow">else</span> {
<a name="l03374"></a>03374                                 $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;$this-&gt;ImageCreateFromStringReplacement($this-&gt;exif_thumbnail_data, false) failed&#39;</span>, __FILE__, __LINE__);
<a name="l03375"></a>03375                         }
<a name="l03376"></a>03376 
<a name="l03377"></a>03377                         <span class="keywordflow">break</span>;
<a name="l03378"></a>03378                 }
<a name="l03379"></a>03379 
<a name="l03380"></a>03380                 <span class="keywordflow">if</span> (!$this-&gt;gdimg_source) {
<a name="l03381"></a>03381                         $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;$this-&gt;gdimg_source is still empty&#39;</span>, __FILE__, __LINE__);
<a name="l03382"></a>03382 
<a name="l03383"></a>03383                         $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;ImageMagickThumbnailToGD() failed&#39;</span>, __FILE__, __LINE__);
<a name="l03384"></a>03384 
<a name="l03385"></a>03385                         $imageHeader = <span class="stringliteral">&#39;&#39;</span>;
<a name="l03386"></a>03386                         <a class="code" href="php_thumb_8demo_8check_8php.html#af2c7b7086347d2db2cbba6ff28df96e7">$gd_info</a> = gd_info();
<a name="l03387"></a>03387                         $GDreadSupport = <span class="keyword">false</span>;
<a name="l03388"></a>03388                         <span class="keywordflow">switch</span> (@$this-&gt;getimagesizeinfo[2]) {
<a name="l03389"></a>03389                                 <span class="keywordflow">case</span> 1:
<a name="l03390"></a>03390                                         $imageHeader = <span class="stringliteral">&#39;Content-Type: image/gif&#39;</span>;
<a name="l03391"></a>03391                                         $GDreadSupport = (bool) @<a class="code" href="php_thumb_8demo_8check_8php.html#af2c7b7086347d2db2cbba6ff28df96e7">$gd_info</a>[<span class="stringliteral">&#39;GIF Read Support&#39;</span>];
<a name="l03392"></a>03392                                         <span class="keywordflow">break</span>;
<a name="l03393"></a>03393                                 <span class="keywordflow">case</span> 2:
<a name="l03394"></a>03394                                         $imageHeader = <span class="stringliteral">&#39;Content-Type: image/jpeg&#39;</span>;
<a name="l03395"></a>03395                                         $GDreadSupport = (bool) @<a class="code" href="php_thumb_8demo_8check_8php.html#af2c7b7086347d2db2cbba6ff28df96e7">$gd_info</a>[<span class="stringliteral">&#39;JPG Support&#39;</span>];
<a name="l03396"></a>03396                                         <span class="keywordflow">break</span>;
<a name="l03397"></a>03397                                 <span class="keywordflow">case</span> 3:
<a name="l03398"></a>03398                                         $imageHeader = <span class="stringliteral">&#39;Content-Type: image/png&#39;</span>;
<a name="l03399"></a>03399                                         $GDreadSupport = (bool) @<a class="code" href="php_thumb_8demo_8check_8php.html#af2c7b7086347d2db2cbba6ff28df96e7">$gd_info</a>[<span class="stringliteral">&#39;PNG Support&#39;</span>];
<a name="l03400"></a>03400                                         <span class="keywordflow">break</span>;
<a name="l03401"></a>03401                         }
<a name="l03402"></a>03402                         <span class="keywordflow">if</span> ($imageHeader) {
<a name="l03403"></a>03403                                 <span class="comment">// cannot create image for whatever reason (maybe ImageCreateFromJPEG et al are not available?)</span>
<a name="l03404"></a>03404                                 <span class="comment">// and ImageMagick is not available either, no choice but to output original (not resized/modified) data and exit</span>
<a name="l03405"></a>03405                                 <span class="keywordflow">if</span> ($this-&gt;config_error_die_on_source_failure) {
<a name="l03406"></a>03406                                         $errormessages = array();
<a name="l03407"></a>03407                                         $errormessages[] = <span class="stringliteral">&#39;All attempts to create GD image source failed.&#39;</span>;
<a name="l03408"></a>03408                                         <span class="keywordflow">if</span> ($this-&gt;fatalerror) {
<a name="l03409"></a>03409                                                 $errormessages[] = $this-&gt;fatalerror;
<a name="l03410"></a>03410                                         }
<a name="l03411"></a>03411                                         <span class="keywordflow">if</span> (ini_get(<span class="stringliteral">&#39;safe_mode&#39;</span>)) {
<a name="l03412"></a>03412                                                 $errormessages[] = <span class="stringliteral">&#39;Safe Mode enabled, therefore ImageMagick is unavailable. (disable Safe Mode if possible)&#39;</span>;
<a name="l03413"></a>03413                                         } <a class="code" href="php_thumb_8demo_8check_8php.html#af92779326267616cd7c3cdaaa9484bc9">elseif</a> (!$this-&gt;<a class="code" href="classphpthumb.html#a62b9ce7ae0bbe8bdef4820ba9f60c289">ImageMagickVersion</a>()) {
<a name="l03414"></a>03414                                                 $errormessages[] = <span class="stringliteral">&#39;ImageMagick is not installed (it is highly recommended that you install it).&#39;</span>;
<a name="l03415"></a>03415                                         }
<a name="l03416"></a>03416                                         <span class="keywordflow">if</span> ($this-&gt;<a class="code" href="classphpthumb.html#a9a86ca8e8ea31a81d2754aca1db0ccc3">SourceImageIsTooLarge</a>($this-&gt;getimagesizeinfo[0], $this-&gt;getimagesizeinfo[1])) {
<a name="l03417"></a>03417                                                 $memory_get_usage = (function_exists(<span class="stringliteral">&#39;memory_get_usage&#39;</span>) ? memory_get_usage() : 0);
<a name="l03418"></a>03418                                                 $errormessages[] = <span class="stringliteral">&#39;Source image is too large (&#39;</span>.$this-&gt;getimagesizeinfo[0].<span class="charliteral">&#39;x&#39;</span>.$this-&gt;getimagesizeinfo[1].<span class="stringliteral">&#39; = &#39;</span>.number_format($this-&gt;getimagesizeinfo[0] * $this-&gt;getimagesizeinfo[1] / 1000000, 1).<span class="stringliteral">&#39;Mpx, max=&#39;</span>.number_format($this-&gt;config_max_source_pixels / 1000000, 1).<span class="stringliteral">&#39;Mpx) for GD creation (either install ImageMagick or increase PHP memory_limit to at least &#39;</span>.ceil(($memory_get_usage + (5 * $this-&gt;getimagesizeinfo[0] * $this-&gt;getimagesizeinfo[1])) / 1048576).<span class="stringliteral">&#39;M).&#39;</span>;
<a name="l03419"></a>03419                                         } <a class="code" href="php_thumb_8demo_8check_8php.html#af92779326267616cd7c3cdaaa9484bc9">elseif</a> (!$GDreadSupport) {
<a name="l03420"></a>03420                                                 $errormessages[] = <span class="stringliteral">&#39;GD does not have read support for &quot;&#39;</span>.$imageHeader.<span class="stringliteral">&#39;&quot;.&#39;</span>;
<a name="l03421"></a>03421                                         } <span class="keywordflow">else</span> {
<a name="l03422"></a>03422                                                 $errormessages[] = <span class="stringliteral">&#39;Source image probably corrupt.&#39;</span>;
<a name="l03423"></a>03423                                         }
<a name="l03424"></a>03424                                         $this-&gt;<a class="code" href="classphpthumb.html#a6ff71b425894fd846790cedf9f9cc97d">ErrorImage</a>(implode(<span class="stringliteral">&quot;\n&quot;</span>, $errormessages));
<a name="l03425"></a>03425 
<a name="l03426"></a>03426                                 } <span class="keywordflow">else</span> {
<a name="l03427"></a>03427                                         $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;All attempts to create GD image source failed (&#39;</span>.(ini_get(<span class="stringliteral">&#39;safe_mode&#39;</span>) ? <span class="stringliteral">&#39;Safe Mode enabled, ImageMagick unavailable and source image probably too large for GD&#39;</span>: ($GDreadSupport ? <span class="stringliteral">&#39;source image probably corrupt&#39;</span> : <span class="stringliteral">&#39;GD does not have read support for &quot;&#39;</span>.$imageHeader.<span class="charliteral">&#39;&quot;&#39;</span>)).<span class="stringliteral">&#39;), cannot generate thumbnail&#39;</span>);
<a name="l03428"></a>03428                                         <span class="comment">//$this-&gt;DebugMessage(&#39;All attempts to create GD image source failed (&#39;.($GDreadSupport ? &#39;source image probably corrupt&#39; : &#39;GD does not have read support for &quot;&#39;.$imageHeader.&#39;&quot;&#39;).&#39;), outputing raw image&#39;, __FILE__, __LINE__);</span>
<a name="l03429"></a>03429                                         <span class="comment">//if (!$this-&gt;phpThumbDebug) {</span>
<a name="l03430"></a>03430                                         <span class="comment">//      header($imageHeader);</span>
<a name="l03431"></a>03431                                         <span class="comment">//      echo $this-&gt;rawImageData;</span>
<a name="l03432"></a>03432                                         <span class="comment">//      exit;</span>
<a name="l03433"></a>03433                                         <span class="comment">//}</span>
<a name="l03434"></a>03434                                         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l03435"></a>03435                                 }
<a name="l03436"></a>03436                         }
<a name="l03437"></a>03437 
<a name="l03438"></a>03438                         <span class="comment">//switch (substr($this-&gt;rawImageData, 0, 2)) {</span>
<a name="l03439"></a>03439                         <span class="comment">//      case &#39;BM&#39;:</span>
<a name="l03440"></a>03440                         <span class="keywordflow">switch</span> (@$this-&gt;getimagesizeinfo[2]) {
<a name="l03441"></a>03441                                 <span class="keywordflow">case</span> 6:
<a name="l03442"></a>03442                                         ob_start();
<a name="l03443"></a>03443                                         <span class="keywordflow">if</span> (!@include_once(dirname(__FILE__).<span class="stringliteral">&#39;/phpthumb.bmp.php&#39;</span>)) {
<a name="l03444"></a>03444                                                 ob_end_clean();
<a name="l03445"></a>03445                                                 <span class="keywordflow">return</span> $this-&gt;<a class="code" href="classphpthumb.html#a6ff71b425894fd846790cedf9f9cc97d">ErrorImage</a>(<span class="stringliteral">&#39;include_once(&#39;</span>.dirname(__FILE__).<span class="stringliteral">&#39;/phpthumb.bmp.php) failed&#39;</span>);
<a name="l03446"></a>03446                                         }
<a name="l03447"></a>03447                                         ob_end_clean();
<a name="l03448"></a>03448                                         <span class="keywordflow">if</span> ($fp = @fopen($this-&gt;sourceFilename, <span class="stringliteral">&#39;rb&#39;</span>)) {
<a name="l03449"></a>03449                                                 $this-&gt;<a class="code" href="php_thumb_8demo_8check_8php.html#a863670ff2c90a1dc616ebab121dbb296">rawImageData</a> = <span class="stringliteral">&#39;&#39;</span>;
<a name="l03450"></a>03450                                                 <span class="keywordflow">while</span> (!feof($fp)) {
<a name="l03451"></a>03451                                                         $this-&gt;<a class="code" href="php_thumb_8demo_8check_8php.html#a863670ff2c90a1dc616ebab121dbb296">rawImageData</a> .= fread($fp, 32768);
<a name="l03452"></a>03452                                                 }
<a name="l03453"></a>03453                                                 fclose($fp);
<a name="l03454"></a>03454                                         }
<a name="l03455"></a>03455                                         $phpthumb_bmp = <span class="keyword">new</span> <a class="code" href="classphpthumb__bmp.html">phpthumb_bmp</a>();
<a name="l03456"></a>03456                                         $this-&gt;gdimg_source = $phpthumb_bmp-&gt;phpthumb_bmp2gd($this-&gt;<a class="code" href="php_thumb_8demo_8check_8php.html#a863670ff2c90a1dc616ebab121dbb296">rawImageData</a>, (<a class="code" href="classphpthumb__functions.html#aaaad487d4c5a61befc88ae061f8a64fe">phpthumb_functions::gd_version</a>() &gt;= 2.0));
<a name="l03457"></a>03457                                         unset($phpthumb_bmp);
<a name="l03458"></a>03458                                         <span class="keywordflow">if</span> ($this-&gt;gdimg_source) {
<a name="l03459"></a>03459                                                 $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;$phpthumb_bmp-&gt;phpthumb_bmp2gd() succeeded&#39;</span>, __FILE__, __LINE__);
<a name="l03460"></a>03460                                         } <span class="keywordflow">else</span> {
<a name="l03461"></a>03461                                                 <span class="keywordflow">return</span> $this-&gt;<a class="code" href="classphpthumb.html#a6ff71b425894fd846790cedf9f9cc97d">ErrorImage</a>($this-&gt;<a class="code" href="classphpthumb.html#a62b9ce7ae0bbe8bdef4820ba9f60c289">ImageMagickVersion</a>() ? <span class="stringliteral">&#39;ImageMagick failed on BMP source conversion&#39;</span> : <span class="stringliteral">&#39;phpthumb_bmp2gd() failed&#39;</span>);
<a name="l03462"></a>03462                                         }
<a name="l03463"></a>03463                                         <span class="keywordflow">break</span>;
<a name="l03464"></a>03464                         <span class="comment">//}</span>
<a name="l03465"></a>03465                         <span class="comment">//switch (substr($this-&gt;rawImageData, 0, 4)) {</span>
<a name="l03466"></a>03466                         <span class="comment">//      case &#39;II&#39;.&quot;\x2A\x00&quot;:</span>
<a name="l03467"></a>03467                         <span class="comment">//      case &#39;MM&#39;.&quot;\x00\x2A&quot;:</span>
<a name="l03468"></a>03468                                 <span class="keywordflow">case</span> 7:
<a name="l03469"></a>03469                                 <span class="keywordflow">case</span> 8:
<a name="l03470"></a>03470                                         <span class="keywordflow">return</span> $this-&gt;<a class="code" href="classphpthumb.html#a6ff71b425894fd846790cedf9f9cc97d">ErrorImage</a>($this-&gt;<a class="code" href="classphpthumb.html#a62b9ce7ae0bbe8bdef4820ba9f60c289">ImageMagickVersion</a>() ? <span class="stringliteral">&#39;ImageMagick failed on TIFF source conversion&#39;</span> : <span class="stringliteral">&#39;ImageMagick is unavailable and phpThumb() does not support TIFF source images without it&#39;</span>);
<a name="l03471"></a>03471                                         <span class="keywordflow">break</span>;
<a name="l03472"></a>03472 
<a name="l03473"></a>03473                                 <span class="comment">//case &quot;\xD7\xCD\xC6\x9A&quot;:</span>
<a name="l03474"></a>03474                                 <span class="comment">//      return $this-&gt;ErrorImage($this-&gt;ImageMagickVersion() ? &#39;ImageMagick failed on WMF source conversion&#39; : &#39;ImageMagick is unavailable and phpThumb() does not support WMF source images without it&#39;);</span>
<a name="l03475"></a>03475                                 <span class="comment">//      break;</span>
<a name="l03476"></a>03476                         }
<a name="l03477"></a>03477 
<a name="l03478"></a>03478                         <span class="keywordflow">if</span> (!$this-&gt;gdimg_source) {
<a name="l03479"></a>03479                                 $HeaderFourBytes = <span class="stringliteral">&#39;&#39;</span>;
<a name="l03480"></a>03480                                 <span class="keywordflow">if</span> ($this-&gt;<a class="code" href="php_thumb_8demo_8check_8php.html#a863670ff2c90a1dc616ebab121dbb296">rawImageData</a>) {
<a name="l03481"></a>03481                                         $HeaderFourBytes = substr($this-&gt;<a class="code" href="php_thumb_8demo_8check_8php.html#a863670ff2c90a1dc616ebab121dbb296">rawImageData</a>, 0, 4);
<a name="l03482"></a>03482                                 } <a class="code" href="php_thumb_8demo_8check_8php.html#af92779326267616cd7c3cdaaa9484bc9">elseif</a> ($this-&gt;sourceFilename) {
<a name="l03483"></a>03483                                         <span class="keywordflow">if</span> ($fp = @fopen($this-&gt;sourceFilename, <span class="stringliteral">&#39;rb&#39;</span>)) {
<a name="l03484"></a>03484                                                 $HeaderFourBytes = fread($fp, 4);
<a name="l03485"></a>03485                                                 fclose($fp);
<a name="l03486"></a>03486                                         } <span class="keywordflow">else</span> {
<a name="l03487"></a>03487                                                 <span class="keywordflow">return</span> $this-&gt;<a class="code" href="classphpthumb.html#a6ff71b425894fd846790cedf9f9cc97d">ErrorImage</a>(<span class="stringliteral">&#39;failed to open &quot;&#39;</span>.$this-&gt;sourceFilename.<span class="stringliteral">&#39;&quot; SourceImageToGD() [&#39;</span>.__LINE__.<span class="charliteral">&#39;]&#39;</span>);
<a name="l03488"></a>03488                                         }
<a name="l03489"></a>03489                                 } <span class="keywordflow">else</span> {
<a name="l03490"></a>03490                                         <span class="keywordflow">return</span> $this-&gt;<a class="code" href="classphpthumb.html#a6ff71b425894fd846790cedf9f9cc97d">ErrorImage</a>(<span class="stringliteral">&#39;Unable to create image, neither filename nor image data suppplied in SourceImageToGD() [&#39;</span>.__LINE__.<span class="charliteral">&#39;]&#39;</span>);
<a name="l03491"></a>03491                                 }
<a name="l03492"></a>03492                                 <span class="keywordflow">if</span> (!$this-&gt;<a class="code" href="classphpthumb.html#a62b9ce7ae0bbe8bdef4820ba9f60c289">ImageMagickVersion</a>() &amp;&amp; !<a class="code" href="classphpthumb__functions.html#aaaad487d4c5a61befc88ae061f8a64fe">phpthumb_functions::gd_version</a>()) {
<a name="l03493"></a>03493                                         <span class="keywordflow">return</span> $this-&gt;<a class="code" href="classphpthumb.html#a6ff71b425894fd846790cedf9f9cc97d">ErrorImage</a>(<span class="stringliteral">&#39;Neither GD nor ImageMagick seem to be installed on this server. At least one (preferably GD), or better both, MUST be installed for phpThumb to work.&#39;</span>);
<a name="l03494"></a>03494                                 } <a class="code" href="php_thumb_8demo_8check_8php.html#af92779326267616cd7c3cdaaa9484bc9">elseif</a> ($HeaderFourBytes == <span class="stringliteral">&quot;\xD7\xCD\xC6\x9A&quot;</span>) { <span class="comment">// WMF</span>
<a name="l03495"></a>03495                                         <span class="keywordflow">return</span> $this-&gt;<a class="code" href="classphpthumb.html#a6ff71b425894fd846790cedf9f9cc97d">ErrorImage</a>($this-&gt;<a class="code" href="classphpthumb.html#a62b9ce7ae0bbe8bdef4820ba9f60c289">ImageMagickVersion</a>() ? <span class="stringliteral">&#39;ImageMagick failed on WMF source conversion&#39;</span> : <span class="stringliteral">&#39;ImageMagick is unavailable and phpThumb() does not support WMF source images without it&#39;</span>);
<a name="l03496"></a>03496                                 } <a class="code" href="php_thumb_8demo_8check_8php.html#af92779326267616cd7c3cdaaa9484bc9">elseif</a> ($HeaderFourBytes == <span class="stringliteral">&#39;%PDF&#39;</span>) { <span class="comment">// &quot;%PDF&quot;</span>
<a name="l03497"></a>03497                                         <span class="keywordflow">return</span> $this-&gt;<a class="code" href="classphpthumb.html#a6ff71b425894fd846790cedf9f9cc97d">ErrorImage</a>($this-&gt;<a class="code" href="classphpthumb.html#a62b9ce7ae0bbe8bdef4820ba9f60c289">ImageMagickVersion</a>() ? <span class="stringliteral">&#39;ImageMagick and GhostScript are both required for PDF source images; GhostScript may not be properly configured&#39;</span> : <span class="stringliteral">&#39;ImageMagick and/or GhostScript are unavailable and phpThumb() does not support PDF source images without them&#39;</span>);
<a name="l03498"></a>03498                                 } <a class="code" href="php_thumb_8demo_8check_8php.html#af92779326267616cd7c3cdaaa9484bc9">elseif</a> (substr($HeaderFourBytes, 0, 3) == <span class="stringliteral">&quot;\xFF\xD8\xFF&quot;</span>) { <span class="comment">// JPEG</span>
<a name="l03499"></a>03499                                         <span class="keywordflow">return</span> $this-&gt;<a class="code" href="classphpthumb.html#a6ff71b425894fd846790cedf9f9cc97d">ErrorImage</a>(<span class="stringliteral">&#39;Image (JPEG) is too large for PHP-GD memory_limit, please install ImageMagick or increase php.ini memory_limit setting&#39;</span>);
<a name="l03500"></a>03500                                 } <a class="code" href="php_thumb_8demo_8check_8php.html#af92779326267616cd7c3cdaaa9484bc9">elseif</a> ($HeaderFourBytes == <span class="stringliteral">&#39;%PNG&#39;</span>) { <span class="comment">// &quot;%PNG&quot;</span>
<a name="l03501"></a>03501                                         <span class="keywordflow">return</span> $this-&gt;<a class="code" href="classphpthumb.html#a6ff71b425894fd846790cedf9f9cc97d">ErrorImage</a>(<span class="stringliteral">&#39;Image (PNG) is too large for PHP-GD memory_limit, please install ImageMagick or increase php.ini memory_limit setting&#39;</span>);
<a name="l03502"></a>03502                                 } <a class="code" href="php_thumb_8demo_8check_8php.html#af92779326267616cd7c3cdaaa9484bc9">elseif</a> (substr($HeaderFourBytes, 0, 3) == <span class="stringliteral">&#39;GIF&#39;</span>) { <span class="comment">// GIF</span>
<a name="l03503"></a>03503                                         <span class="keywordflow">return</span> $this-&gt;<a class="code" href="classphpthumb.html#a6ff71b425894fd846790cedf9f9cc97d">ErrorImage</a>(<span class="stringliteral">&#39;Image (GIF) is too large for PHP-GD memory_limit, please install ImageMagick or increase php.ini memory_limit setting&#39;</span>);
<a name="l03504"></a>03504                                 }
<a name="l03505"></a>03505                                 <span class="keywordflow">return</span> $this-&gt;<a class="code" href="classphpthumb.html#a6ff71b425894fd846790cedf9f9cc97d">ErrorImage</a>(<span class="stringliteral">&#39;Unknown image type identified by &quot;&#39;</span>.$HeaderFourBytes.<span class="stringliteral">&#39;&quot; (&#39;</span>.<a class="code" href="classphpthumb__functions.html#a990a73d0fe31b520e04251295aeded25">phpthumb_functions::HexCharDisplay</a>($HeaderFourBytes).<span class="stringliteral">&#39;) in SourceImageToGD() [&#39;</span>.__LINE__.<span class="charliteral">&#39;]&#39;</span>);
<a name="l03506"></a>03506 
<a name="l03507"></a>03507                         }
<a name="l03508"></a>03508                 }
<a name="l03509"></a>03509 
<a name="l03510"></a>03510                 <span class="keywordflow">if</span> (!$this-&gt;gdimg_source) {
<a name="l03511"></a>03511                         <span class="keywordflow">if</span> ($gdimg_exif_temp = $this-&gt;<a class="code" href="classphpthumb.html#a7a2d5f7e31c08dd71b834391cb7b1520">ImageCreateFromStringReplacement</a>($this-&gt;exif_thumbnail_data, <span class="keyword">false</span>)) {
<a name="l03512"></a>03512                                 $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;All other attempts failed, but successfully using EXIF thumbnail as source image&#39;</span>, __FILE__, __LINE__);
<a name="l03513"></a>03513                                 $this-&gt;gdimg_source = $gdimg_exif_temp;
<a name="l03514"></a>03514                                 <span class="comment">// override allow-enlarging setting if EXIF thumbnail is the only source available</span>
<a name="l03515"></a>03515                                 <span class="comment">// otherwise thumbnails larger than the EXIF thumbnail will be created at EXIF size</span>
<a name="l03516"></a>03516                                 $this-&gt;aoe = <span class="keyword">true</span>;
<a name="l03517"></a>03517                                 <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l03518"></a>03518                         }
<a name="l03519"></a>03519                         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l03520"></a>03520                 }
<a name="l03521"></a>03521 
<a name="l03522"></a>03522                 $this-&gt;source_width  = ImageSX($this-&gt;gdimg_source);
<a name="l03523"></a>03523                 $this-&gt;source_height = ImageSY($this-&gt;gdimg_source);
<a name="l03524"></a>03524                 <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l03525"></a>03525         }
<a name="l03526"></a>03526 
<a name="l03527"></a>03527 
<a name="l03528"></a><a class="code" href="classphpthumb.html#ac6144c2648d4394fba9a1d3d75d442fc">03528</a>         <span class="keyword">function</span> <a class="code" href="classphpthumb.html#ac6144c2648d4394fba9a1d3d75d442fc">phpThumbDebugVarDump</a>($var) {
<a name="l03529"></a>03529                 <span class="keywordflow">if</span> (is_null($var)) {
<a name="l03530"></a>03530                         <span class="keywordflow">return</span> <span class="stringliteral">&#39;NULL&#39;</span>;
<a name="l03531"></a>03531                 } <a class="code" href="php_thumb_8demo_8check_8php.html#af92779326267616cd7c3cdaaa9484bc9">elseif</a> (is_bool($var)) {
<a name="l03532"></a>03532                         <span class="keywordflow">return</span> ($var ? <span class="stringliteral">&#39;TRUE&#39;</span> : <span class="stringliteral">&#39;FALSE&#39;</span>);
<a name="l03533"></a>03533                 } <a class="code" href="php_thumb_8demo_8check_8php.html#af92779326267616cd7c3cdaaa9484bc9">elseif</a> (is_string($var)) {
<a name="l03534"></a>03534                         <span class="keywordflow">return</span> <span class="stringliteral">&#39;string(&#39;</span>.strlen($var).<span class="charliteral">&#39;)&#39;</span>.str_repeat(<span class="charliteral">&#39; &#39;</span>, max(0, 3 - strlen(strlen($var)))).<span class="stringliteral">&#39; &quot;&#39;</span>.$var.<span class="charliteral">&#39;&quot;&#39;</span>;
<a name="l03535"></a>03535                 } <a class="code" href="php_thumb_8demo_8check_8php.html#af92779326267616cd7c3cdaaa9484bc9">elseif</a> (is_int($var)) {
<a name="l03536"></a>03536                         <span class="keywordflow">return</span> <span class="stringliteral">&#39;integer     &#39;</span>.$var;
<a name="l03537"></a>03537                 } <a class="code" href="php_thumb_8demo_8check_8php.html#af92779326267616cd7c3cdaaa9484bc9">elseif</a> (is_float($var)) {
<a name="l03538"></a>03538                         <span class="keywordflow">return</span> <span class="stringliteral">&#39;float       &#39;</span>.$var;
<a name="l03539"></a>03539                 } <a class="code" href="php_thumb_8demo_8check_8php.html#af92779326267616cd7c3cdaaa9484bc9">elseif</a> (is_array($var)) {
<a name="l03540"></a>03540                         ob_start();
<a name="l03541"></a>03541                         var_dump($var);
<a name="l03542"></a>03542                         $vardumpoutput = ob_get_contents();
<a name="l03543"></a>03543                         ob_end_clean();
<a name="l03544"></a>03544                         <span class="keywordflow">return</span> strtr($vardumpoutput, <span class="stringliteral">&quot;\n\r\t&quot;</span>, <span class="stringliteral">&#39;   &#39;</span>);
<a name="l03545"></a>03545                 }
<a name="l03546"></a>03546                 <span class="keywordflow">return</span> gettype($var);
<a name="l03547"></a>03547         }
<a name="l03548"></a>03548 
<a name="l03549"></a><a class="code" href="classphpthumb.html#a8329c63c143bd310899667d0b130ddcd">03549</a>         <span class="keyword">function</span> <a class="code" href="classphpthumb.html#a8329c63c143bd310899667d0b130ddcd">phpThumbDebug</a>($level=<span class="stringliteral">&#39;&#39;</span>) {
<a name="l03550"></a>03550                 <span class="keywordflow">if</span> ($level &amp;&amp; ($this-&gt;<a class="code" href="classphpthumb.html#a8329c63c143bd310899667d0b130ddcd">phpThumbDebug</a> !== $level)) {
<a name="l03551"></a>03551                         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l03552"></a>03552                 }
<a name="l03553"></a>03553                 <span class="keywordflow">if</span> ($this-&gt;config_disable_debug) {
<a name="l03554"></a>03554                         <span class="keywordflow">return</span> $this-&gt;<a class="code" href="classphpthumb.html#a6ff71b425894fd846790cedf9f9cc97d">ErrorImage</a>(<span class="stringliteral">&#39;phpThumbDebug disabled&#39;</span>);
<a name="l03555"></a>03555                 }
<a name="l03556"></a>03556 
<a name="l03557"></a>03557                 $FunctionsExistance  = array(<span class="stringliteral">&#39;exif_thumbnail&#39;</span>, <span class="stringliteral">&#39;gd_info&#39;</span>, <span class="stringliteral">&#39;image_type_to_mime_type&#39;</span>, <span class="stringliteral">&#39;GetImageSize&#39;</span>, <span class="stringliteral">&#39;ImageCopyResampled&#39;</span>, <span class="stringliteral">&#39;ImageCopyResized&#39;</span>, <span class="stringliteral">&#39;ImageCreate&#39;</span>, <span class="stringliteral">&#39;ImageCreateFromString&#39;</span>, <span class="stringliteral">&#39;ImageCreateTrueColor&#39;</span>, <span class="stringliteral">&#39;ImageIsTrueColor&#39;</span>, <span class="stringliteral">&#39;ImageRotate&#39;</span>, <span class="stringliteral">&#39;ImageTypes&#39;</span>, <span class="stringliteral">&#39;version_compare&#39;</span>, <span class="stringliteral">&#39;ImageCreateFromGIF&#39;</span>, <span class="stringliteral">&#39;ImageCreateFromJPEG&#39;</span>, <span class="stringliteral">&#39;ImageCreateFromPNG&#39;</span>, <span class="stringliteral">&#39;ImageCreateFromWBMP&#39;</span>, <span class="stringliteral">&#39;ImageCreateFromXBM&#39;</span>, <span class="stringliteral">&#39;ImageCreateFromXPM&#39;</span>, <span class="stringliteral">&#39;ImageCreateFromString&#39;</span>, <span class="stringliteral">&#39;ImageCreateFromGD&#39;</span>, <span class="stringliteral">&#39;ImageCreateFromGD2&#39;</span>, <span class="stringliteral">&#39;ImageCreateFromGD2Part&#39;</span>, <span class="stringliteral">&#39;ImageJPEG&#39;</span>, <span class="stringliteral">&#39;ImageGIF&#39;</span>, <span class="stringliteral">&#39;ImagePNG&#39;</span>, <span class="stringliteral">&#39;ImageWBMP&#39;</span>);
<a name="l03558"></a>03558                 $ParameterNames      = array(<span class="stringliteral">&#39;src&#39;</span>, <span class="stringliteral">&#39;new&#39;</span>, <span class="charliteral">&#39;w&#39;</span>, <span class="charliteral">&#39;h&#39;</span>, <span class="charliteral">&#39;f&#39;</span>, <span class="charliteral">&#39;q&#39;</span>, <span class="stringliteral">&#39;sx&#39;</span>, <span class="stringliteral">&#39;sy&#39;</span>, <span class="stringliteral">&#39;sw&#39;</span>, <span class="stringliteral">&#39;sh&#39;</span>, <span class="stringliteral">&#39;far&#39;</span>, <span class="stringliteral">&#39;bg&#39;</span>, <span class="stringliteral">&#39;bc&#39;</span>, <span class="stringliteral">&#39;file&#39;</span>, <span class="stringliteral">&#39;goto&#39;</span>, <span class="stringliteral">&#39;err&#39;</span>, <span class="stringliteral">&#39;xto&#39;</span>, <span class="stringliteral">&#39;ra&#39;</span>, <span class="stringliteral">&#39;ar&#39;</span>, <span class="stringliteral">&#39;aoe&#39;</span>, <span class="stringliteral">&#39;iar&#39;</span>, <span class="stringliteral">&#39;maxb&#39;</span>);
<a name="l03559"></a>03559                 $ConfigVariableNames = array(<span class="stringliteral">&#39;document_root&#39;</span>, <span class="stringliteral">&#39;temp_directory&#39;</span>, <span class="stringliteral">&#39;output_format&#39;</span>, <span class="stringliteral">&#39;output_maxwidth&#39;</span>, <span class="stringliteral">&#39;output_maxheight&#39;</span>, <span class="stringliteral">&#39;error_message_image_default&#39;</span>, <span class="stringliteral">&#39;error_bgcolor&#39;</span>, <span class="stringliteral">&#39;error_textcolor&#39;</span>, <span class="stringliteral">&#39;error_fontsize&#39;</span>, <span class="stringliteral">&#39;error_die_on_error&#39;</span>, <span class="stringliteral">&#39;error_silent_die_on_error&#39;</span>, <span class="stringliteral">&#39;error_die_on_source_failure&#39;</span>, <span class="stringliteral">&#39;nohotlink_enabled&#39;</span>, <span class="stringliteral">&#39;nohotlink_valid_domains&#39;</span>, <span class="stringliteral">&#39;nohotlink_erase_image&#39;</span>, <span class="stringliteral">&#39;nohotlink_text_message&#39;</span>, <span class="stringliteral">&#39;nooffsitelink_enabled&#39;</span>, <span class="stringliteral">&#39;nooffsitelink_valid_domains&#39;</span>, <span class="stringliteral">&#39;nooffsitelink_require_refer&#39;</span>, <span class="stringliteral">&#39;nooffsitelink_erase_image&#39;</span>, <span class="stringliteral">&#39;nooffsitelink_text_message&#39;</span>, <span class="stringliteral">&#39;high_security_enabled&#39;</span>, <span class="stringliteral">&#39;allow_src_above_docroot&#39;</span>, <span class="stringliteral">&#39;allow_src_above_phpthumb&#39;</span>, <span class="stringliteral">&#39;allow_parameter_file&#39;</span>, <span class="stringliteral">&#39;allow_parameter_goto&#39;</span>, <span class="stringliteral">&#39;max_source_pixels&#39;</span>, <span class="stringliteral">&#39;use_exif_thumbnail_for_speed&#39;</span>, <span class="stringliteral">&#39;border_hexcolor&#39;</span>, <span class="stringliteral">&#39;background_hexcolor&#39;</span>, <span class="stringliteral">&#39;ttf_directory&#39;</span>, <span class="stringliteral">&#39;disable_pathinfo_parsing&#39;</span>, <span class="stringliteral">&#39;disable_imagecopyresampled&#39;</span>);
<a name="l03560"></a>03560                 $OtherVariableNames  = array(<span class="stringliteral">&#39;phpThumbDebug&#39;</span>, <span class="stringliteral">&#39;thumbnailQuality&#39;</span>, <span class="stringliteral">&#39;thumbnailFormat&#39;</span>, <span class="stringliteral">&#39;gdimg_output&#39;</span>, <span class="stringliteral">&#39;gdimg_source&#39;</span>, <span class="stringliteral">&#39;sourceFilename&#39;</span>, <span class="stringliteral">&#39;source_width&#39;</span>, <span class="stringliteral">&#39;source_height&#39;</span>, <span class="stringliteral">&#39;thumbnailCropX&#39;</span>, <span class="stringliteral">&#39;thumbnailCropY&#39;</span>, <span class="stringliteral">&#39;thumbnailCropW&#39;</span>, <span class="stringliteral">&#39;thumbnailCropH&#39;</span>, <span class="stringliteral">&#39;exif_thumbnail_width&#39;</span>, <span class="stringliteral">&#39;exif_thumbnail_height&#39;</span>, <span class="stringliteral">&#39;exif_thumbnail_type&#39;</span>, <span class="stringliteral">&#39;thumbnail_width&#39;</span>, <span class="stringliteral">&#39;thumbnail_height&#39;</span>, <span class="stringliteral">&#39;thumbnail_image_width&#39;</span>, <span class="stringliteral">&#39;thumbnail_image_height&#39;</span>);
<a name="l03561"></a>03561 
<a name="l03562"></a>03562                 $DebugOutput = array();
<a name="l03563"></a>03563                 $DebugOutput[] = <span class="stringliteral">&#39;phpThumb() version          = &#39;</span>.$this-&gt;phpthumb_version;
<a name="l03564"></a>03564                 $DebugOutput[] = <span class="stringliteral">&#39;phpversion()                = &#39;</span>.@phpversion();
<a name="l03565"></a>03565                 $DebugOutput[] = <span class="stringliteral">&#39;PHP_OS                      = &#39;</span>.PHP_OS;
<a name="l03566"></a>03566                 $DebugOutput[] = <span class="stringliteral">&#39;$_SERVER[SERVER_SOFTWARE]   = &#39;</span>.@$_SERVER[<span class="stringliteral">&#39;SERVER_SOFTWARE&#39;</span>];
<a name="l03567"></a>03567                 $DebugOutput[] = <span class="stringliteral">&#39;__FILE__                    = &#39;</span>.__FILE__;
<a name="l03568"></a>03568                 $DebugOutput[] = <span class="stringliteral">&#39;realpath(.)                 = &#39;</span>.@realpath(<span class="charliteral">&#39;.&#39;</span>);
<a name="l03569"></a>03569                 $DebugOutput[] = <span class="stringliteral">&#39;$_SERVER[PHP_SELF]          = &#39;</span>.@$_SERVER[<span class="stringliteral">&#39;PHP_SELF&#39;</span>];
<a name="l03570"></a>03570                 $DebugOutput[] = <span class="stringliteral">&#39;$_SERVER[HOST_NAME]         = &#39;</span>.@$_SERVER[<span class="stringliteral">&#39;HOST_NAME&#39;</span>];
<a name="l03571"></a>03571                 $DebugOutput[] = <span class="stringliteral">&#39;$_SERVER[HTTP_REFERER]      = &#39;</span>.@$_SERVER[<span class="stringliteral">&#39;HTTP_REFERER&#39;</span>];
<a name="l03572"></a>03572                 $DebugOutput[] = <span class="stringliteral">&#39;$_SERVER[QUERY_STRING]      = &#39;</span>.@$_SERVER[<span class="stringliteral">&#39;QUERY_STRING&#39;</span>];
<a name="l03573"></a>03573                 $DebugOutput[] = <span class="stringliteral">&#39;$_SERVER[PATH_INFO]         = &#39;</span>.@$_SERVER[<span class="stringliteral">&#39;PATH_INFO&#39;</span>];
<a name="l03574"></a>03574                 $DebugOutput[] = <span class="stringliteral">&#39;$_SERVER[DOCUMENT_ROOT]     = &#39;</span>.@$_SERVER[<span class="stringliteral">&#39;DOCUMENT_ROOT&#39;</span>];
<a name="l03575"></a>03575                 $DebugOutput[] = <span class="stringliteral">&#39;getenv(DOCUMENT_ROOT)       = &#39;</span>.@getenv(<span class="stringliteral">&#39;DOCUMENT_ROOT&#39;</span>);
<a name="l03576"></a>03576                 $DebugOutput[] = <span class="stringliteral">&#39;&#39;</span>;
<a name="l03577"></a>03577 
<a name="l03578"></a>03578                 $DebugOutput[] = <span class="stringliteral">&#39;get_magic_quotes_gpc()         = &#39;</span>.$this-&gt;phpThumbDebugVarDump(@get_magic_quotes_gpc());
<a name="l03579"></a>03579                 $DebugOutput[] = <span class="stringliteral">&#39;get_magic_quotes_runtime()     = &#39;</span>.$this-&gt;phpThumbDebugVarDump(@get_magic_quotes_runtime());
<a name="l03580"></a>03580                 $DebugOutput[] = <span class="stringliteral">&#39;error_reporting()              = &#39;</span>.$this-&gt;phpThumbDebugVarDump(error_reporting());
<a name="l03581"></a>03581                 $DebugOutput[] = <span class="stringliteral">&#39;ini_get(error_reporting)       = &#39;</span>.$this-&gt;phpThumbDebugVarDump(@ini_get(<span class="stringliteral">&#39;error_reporting&#39;</span>));
<a name="l03582"></a>03582                 $DebugOutput[] = <span class="stringliteral">&#39;ini_get(display_errors)        = &#39;</span>.$this-&gt;phpThumbDebugVarDump(@ini_get(<span class="stringliteral">&#39;display_errors&#39;</span>));
<a name="l03583"></a>03583                 $DebugOutput[] = <span class="stringliteral">&#39;ini_get(allow_url_fopen)       = &#39;</span>.$this-&gt;phpThumbDebugVarDump(@ini_get(<span class="stringliteral">&#39;allow_url_fopen&#39;</span>));
<a name="l03584"></a>03584                 $DebugOutput[] = <span class="stringliteral">&#39;ini_get(disable_functions)     = &#39;</span>.$this-&gt;phpThumbDebugVarDump(@ini_get(<span class="stringliteral">&#39;disable_functions&#39;</span>));
<a name="l03585"></a>03585                 $DebugOutput[] = <span class="stringliteral">&#39;get_cfg_var(disable_functions) = &#39;</span>.$this-&gt;phpThumbDebugVarDump(@get_cfg_var(<span class="stringliteral">&#39;disable_functions&#39;</span>));
<a name="l03586"></a>03586                 $DebugOutput[] = <span class="stringliteral">&#39;ini_get(safe_mode)             = &#39;</span>.$this-&gt;phpThumbDebugVarDump(@ini_get(<span class="stringliteral">&#39;safe_mode&#39;</span>));
<a name="l03587"></a>03587                 $DebugOutput[] = <span class="stringliteral">&#39;ini_get(open_basedir)          = &#39;</span>.$this-&gt;phpThumbDebugVarDump(@ini_get(<span class="stringliteral">&#39;open_basedir&#39;</span>));
<a name="l03588"></a>03588                 $DebugOutput[] = <span class="stringliteral">&#39;ini_get(max_execution_time)    = &#39;</span>.$this-&gt;phpThumbDebugVarDump(@ini_get(<span class="stringliteral">&#39;max_execution_time&#39;</span>));
<a name="l03589"></a>03589                 $DebugOutput[] = <span class="stringliteral">&#39;ini_get(memory_limit)          = &#39;</span>.$this-&gt;phpThumbDebugVarDump(@ini_get(<span class="stringliteral">&#39;memory_limit&#39;</span>));
<a name="l03590"></a>03590                 $DebugOutput[] = <span class="stringliteral">&#39;get_cfg_var(memory_limit)      = &#39;</span>.$this-&gt;phpThumbDebugVarDump(@get_cfg_var(<span class="stringliteral">&#39;memory_limit&#39;</span>));
<a name="l03591"></a>03591                 $DebugOutput[] = <span class="stringliteral">&#39;memory_get_usage()             = &#39;</span>.(function_exists(<span class="stringliteral">&#39;memory_get_usage&#39;</span>) ? $this-&gt;<a class="code" href="classphpthumb.html#ac6144c2648d4394fba9a1d3d75d442fc">phpThumbDebugVarDump</a>(@memory_get_usage()) : <span class="stringliteral">&#39;n/a&#39;</span>);
<a name="l03592"></a>03592                 $DebugOutput[] = <span class="stringliteral">&#39;&#39;</span>;
<a name="l03593"></a>03593 
<a name="l03594"></a>03594                 $DebugOutput[] = <span class="stringliteral">&#39;$this-&gt;config_prefer_imagemagick            = &#39;</span>.$this-&gt;phpThumbDebugVarDump($this-&gt;config_prefer_imagemagick);
<a name="l03595"></a>03595                 $DebugOutput[] = <span class="stringliteral">&#39;$this-&gt;config_imagemagick_path              = &#39;</span>.$this-&gt;phpThumbDebugVarDump($this-&gt;config_imagemagick_path);
<a name="l03596"></a>03596                 $DebugOutput[] = <span class="stringliteral">&#39;$this-&gt;ImageMagickWhichConvert()            = &#39;</span>.$this-&gt;ImageMagickWhichConvert();
<a name="l03597"></a>03597                 $IMpathUsed = ($this-&gt;config_imagemagick_path ? $this-&gt;config_imagemagick_path : $this-&gt;<a class="code" href="classphpthumb.html#aabd06eff0633253ae0660306a3e5cb8e">ImageMagickWhichConvert</a>());
<a name="l03598"></a>03598                 $DebugOutput[] = <span class="stringliteral">&#39;[actual ImageMagick path used]              = &#39;</span>.$this-&gt;phpThumbDebugVarDump($IMpathUsed);
<a name="l03599"></a>03599                 $DebugOutput[] = <span class="stringliteral">&#39;file_exists([actual ImageMagick path used]) = &#39;</span>.$this-&gt;phpThumbDebugVarDump(@file_exists($IMpathUsed));
<a name="l03600"></a>03600                 $DebugOutput[] = <span class="stringliteral">&#39;ImageMagickVersion(false)                   = &#39;</span>.$this-&gt;ImageMagickVersion(<span class="keyword">false</span>);
<a name="l03601"></a>03601                 $DebugOutput[] = <span class="stringliteral">&#39;ImageMagickVersion(true)                    = &#39;</span>.$this-&gt;ImageMagickVersion(<span class="keyword">true</span>);
<a name="l03602"></a>03602                 $DebugOutput[] = <span class="stringliteral">&#39;&#39;</span>;
<a name="l03603"></a>03603 
<a name="l03604"></a>03604                 $DebugOutput[] = <span class="stringliteral">&#39;$this-&gt;config_cache_directory               = &#39;</span>.$this-&gt;phpThumbDebugVarDump($this-&gt;config_cache_directory);
<a name="l03605"></a>03605                 $DebugOutput[] = <span class="stringliteral">&#39;$this-&gt;config_cache_directory_depth         = &#39;</span>.$this-&gt;phpThumbDebugVarDump($this-&gt;config_cache_directory_depth);
<a name="l03606"></a>03606                 $DebugOutput[] = <span class="stringliteral">&#39;$this-&gt;config_cache_disable_warning         = &#39;</span>.$this-&gt;phpThumbDebugVarDump($this-&gt;config_cache_disable_warning);
<a name="l03607"></a>03607                 $DebugOutput[] = <span class="stringliteral">&#39;$this-&gt;config_cache_maxage                  = &#39;</span>.$this-&gt;phpThumbDebugVarDump($this-&gt;config_cache_maxage);
<a name="l03608"></a>03608                 $DebugOutput[] = <span class="stringliteral">&#39;$this-&gt;config_cache_maxsize                 = &#39;</span>.$this-&gt;phpThumbDebugVarDump($this-&gt;config_cache_maxsize);
<a name="l03609"></a>03609                 $DebugOutput[] = <span class="stringliteral">&#39;$this-&gt;config_cache_maxfiles                = &#39;</span>.$this-&gt;phpThumbDebugVarDump($this-&gt;config_cache_maxfiles);
<a name="l03610"></a>03610                 $DebugOutput[] = <span class="stringliteral">&#39;$this-&gt;config_cache_force_passthru          = &#39;</span>.$this-&gt;phpThumbDebugVarDump($this-&gt;config_cache_force_passthru);
<a name="l03611"></a>03611                 $DebugOutput[] = <span class="stringliteral">&#39;$this-&gt;cache_filename                       = &#39;</span>.$this-&gt;phpThumbDebugVarDump($this-&gt;cache_filename);
<a name="l03612"></a>03612                 $DebugOutput[] = <span class="stringliteral">&#39;is_readable($this-&gt;config_cache_directory)  = &#39;</span>.$this-&gt;phpThumbDebugVarDump(@is_readable($this-&gt;config_cache_directory));
<a name="l03613"></a>03613                 $DebugOutput[] = <span class="stringliteral">&#39;is_writable($this-&gt;config_cache_directory)  = &#39;</span>.$this-&gt;phpThumbDebugVarDump(@is_writable($this-&gt;config_cache_directory));
<a name="l03614"></a>03614                 $DebugOutput[] = <span class="stringliteral">&#39;is_readable($this-&gt;cache_filename)          = &#39;</span>.$this-&gt;phpThumbDebugVarDump(@is_readable($this-&gt;cache_filename));
<a name="l03615"></a>03615                 $DebugOutput[] = <span class="stringliteral">&#39;is_writable($this-&gt;cache_filename)          = &#39;</span>.(@file_exists($this-&gt;cache_filename) ? $this-&gt;<a class="code" href="classphpthumb.html#ac6144c2648d4394fba9a1d3d75d442fc">phpThumbDebugVarDump</a>(@is_writable($this-&gt;cache_filename)) : <span class="stringliteral">&#39;n/a&#39;</span>);
<a name="l03616"></a>03616                 $DebugOutput[] = <span class="stringliteral">&#39;&#39;</span>;
<a name="l03617"></a>03617 
<a name="l03618"></a>03618                 <span class="keywordflow">foreach</span> ($ConfigVariableNames as $varname) {
<a name="l03619"></a>03619                         $varname = <span class="stringliteral">&#39;config_&#39;</span>.$varname;
<a name="l03620"></a>03620                         $value = $this-&gt;$varname;
<a name="l03621"></a>03621                         $DebugOutput[] = <span class="stringliteral">&#39;$this-&gt;&#39;</span>.str_pad($varname, 37, <span class="charliteral">&#39; &#39;</span>, STR_PAD_RIGHT).<span class="stringliteral">&#39; = &#39;</span>.$this-&gt;<a class="code" href="classphpthumb.html#ac6144c2648d4394fba9a1d3d75d442fc">phpThumbDebugVarDump</a>($value);
<a name="l03622"></a>03622                 }
<a name="l03623"></a>03623                 $DebugOutput[] = <span class="stringliteral">&#39;&#39;</span>;
<a name="l03624"></a>03624                 <span class="keywordflow">foreach</span> ($OtherVariableNames as $varname) {
<a name="l03625"></a>03625                         $value = $this-&gt;$varname;
<a name="l03626"></a>03626                         $DebugOutput[] = <span class="stringliteral">&#39;$this-&gt;&#39;</span>.str_pad($varname, 27, <span class="charliteral">&#39; &#39;</span>, STR_PAD_RIGHT).<span class="stringliteral">&#39; = &#39;</span>.$this-&gt;<a class="code" href="classphpthumb.html#ac6144c2648d4394fba9a1d3d75d442fc">phpThumbDebugVarDump</a>($value);
<a name="l03627"></a>03627                 }
<a name="l03628"></a>03628                 $DebugOutput[] = <span class="stringliteral">&#39;strlen($this-&gt;rawImageData)        = &#39;</span>.strlen(@$this-&gt;<a class="code" href="php_thumb_8demo_8check_8php.html#a863670ff2c90a1dc616ebab121dbb296">rawImageData</a>);
<a name="l03629"></a>03629                 $DebugOutput[] = <span class="stringliteral">&#39;strlen($this-&gt;exif_thumbnail_data) = &#39;</span>.strlen(@$this-&gt;exif_thumbnail_data);
<a name="l03630"></a>03630                 $DebugOutput[] = <span class="stringliteral">&#39;&#39;</span>;
<a name="l03631"></a>03631 
<a name="l03632"></a>03632                 <span class="keywordflow">foreach</span> ($ParameterNames as $varname) {
<a name="l03633"></a>03633                         $value = $this-&gt;$varname;
<a name="l03634"></a>03634                         $DebugOutput[] = <span class="stringliteral">&#39;$this-&gt;&#39;</span>.str_pad($varname, 4, <span class="charliteral">&#39; &#39;</span>, STR_PAD_RIGHT).<span class="stringliteral">&#39; = &#39;</span>.$this-&gt;<a class="code" href="classphpthumb.html#ac6144c2648d4394fba9a1d3d75d442fc">phpThumbDebugVarDump</a>($value);
<a name="l03635"></a>03635                 }
<a name="l03636"></a>03636                 $DebugOutput[] = <span class="stringliteral">&#39;&#39;</span>;
<a name="l03637"></a>03637 
<a name="l03638"></a>03638                 <span class="keywordflow">foreach</span> ($FunctionsExistance as $functionname) {
<a name="l03639"></a>03639                         $DebugOutput[] = <span class="stringliteral">&#39;builtin_function_exists(&#39;</span>.$functionname.<span class="charliteral">&#39;)&#39;</span>.str_repeat(<span class="charliteral">&#39; &#39;</span>, 23 - strlen($functionname)).<span class="stringliteral">&#39; = &#39;</span>.$this-&gt;<a class="code" href="classphpthumb.html#ac6144c2648d4394fba9a1d3d75d442fc">phpThumbDebugVarDump</a>(<a class="code" href="classphpthumb__functions.html#af8479c23712b7ac1502d1d7fc76b7670">phpthumb_functions::builtin_function_exists</a>($functionname));
<a name="l03640"></a>03640                 }
<a name="l03641"></a>03641                 $DebugOutput[] = <span class="stringliteral">&#39;&#39;</span>;
<a name="l03642"></a>03642 
<a name="l03643"></a>03643                 <a class="code" href="php_thumb_8demo_8check_8php.html#af2c7b7086347d2db2cbba6ff28df96e7">$gd_info</a> = gd_info();
<a name="l03644"></a>03644                 <span class="keywordflow">foreach</span> (<a class="code" href="php_thumb_8demo_8check_8php.html#af2c7b7086347d2db2cbba6ff28df96e7">$gd_info</a> as $key =&gt; $value) {
<a name="l03645"></a>03645                         $DebugOutput[] = <span class="stringliteral">&#39;gd_info.&#39;</span>.str_pad($key, 34, <span class="charliteral">&#39; &#39;</span>, STR_PAD_RIGHT).<span class="stringliteral">&#39; = &#39;</span>.$this-&gt;<a class="code" href="classphpthumb.html#ac6144c2648d4394fba9a1d3d75d442fc">phpThumbDebugVarDump</a>($value);
<a name="l03646"></a>03646                 }
<a name="l03647"></a>03647                 $DebugOutput[] = <span class="stringliteral">&#39;&#39;</span>;
<a name="l03648"></a>03648 
<a name="l03649"></a>03649                 $exif_info = <a class="code" href="classphpthumb__functions.html#a6b7e8055a24dbfa6519a817282f5fedb">phpthumb_functions::exif_info</a>();
<a name="l03650"></a>03650                 <span class="keywordflow">foreach</span> ($exif_info as $key =&gt; $value) {
<a name="l03651"></a>03651                         $DebugOutput[] = <span class="stringliteral">&#39;exif_info.&#39;</span>.str_pad($key, 26, <span class="charliteral">&#39; &#39;</span>, STR_PAD_RIGHT).<span class="stringliteral">&#39; = &#39;</span>.$this-&gt;<a class="code" href="classphpthumb.html#ac6144c2648d4394fba9a1d3d75d442fc">phpThumbDebugVarDump</a>($value);
<a name="l03652"></a>03652                 }
<a name="l03653"></a>03653                 $DebugOutput[] = <span class="stringliteral">&#39;&#39;</span>;
<a name="l03654"></a>03654 
<a name="l03655"></a>03655                 <span class="keywordflow">if</span> ($ApacheLookupURIarray = <a class="code" href="classphpthumb__functions.html#acb4fb35a3540b66f2543550e25197a74">phpthumb_functions::ApacheLookupURIarray</a>(dirname(@$_SERVER[<span class="stringliteral">&#39;PHP_SELF&#39;</span>]))) {
<a name="l03656"></a>03656                         <span class="keywordflow">foreach</span> ($ApacheLookupURIarray as $key =&gt; $value) {
<a name="l03657"></a>03657                                 $DebugOutput[] = <span class="stringliteral">&#39;ApacheLookupURIarray.&#39;</span>.str_pad($key, 15, <span class="charliteral">&#39; &#39;</span>, STR_PAD_RIGHT).<span class="stringliteral">&#39; = &#39;</span>.$this-&gt;<a class="code" href="classphpthumb.html#ac6144c2648d4394fba9a1d3d75d442fc">phpThumbDebugVarDump</a>($value);
<a name="l03658"></a>03658                         }
<a name="l03659"></a>03659                 } <span class="keywordflow">else</span> {
<a name="l03660"></a>03660                                 $DebugOutput[] = <span class="stringliteral">&#39;ApacheLookupURIarray() -- FAILED&#39;</span>;
<a name="l03661"></a>03661                 }
<a name="l03662"></a>03662                 $DebugOutput[] = <span class="stringliteral">&#39;&#39;</span>;
<a name="l03663"></a>03663 
<a name="l03664"></a>03664                 <span class="keywordflow">if</span> (isset($_GET) &amp;&amp; is_array($_GET)) {
<a name="l03665"></a>03665                         <span class="keywordflow">foreach</span> ($_GET as $key =&gt; $value) {
<a name="l03666"></a>03666                                 $DebugOutput[] = <span class="stringliteral">&#39;$_GET[&#39;</span>.$key.<span class="charliteral">&#39;]&#39;</span>.str_repeat(<span class="charliteral">&#39; &#39;</span>, 30 - strlen($key)).<span class="stringliteral">&#39;= &#39;</span>.$this-&gt;<a class="code" href="classphpthumb.html#ac6144c2648d4394fba9a1d3d75d442fc">phpThumbDebugVarDump</a>($value);
<a name="l03667"></a>03667                         }
<a name="l03668"></a>03668                 }
<a name="l03669"></a>03669                 <span class="keywordflow">if</span> (isset($_POST) &amp;&amp; is_array($_POST)) {
<a name="l03670"></a>03670                         <span class="keywordflow">foreach</span> ($_POST as $key =&gt; $value) {
<a name="l03671"></a>03671                                 $DebugOutput[] = <span class="stringliteral">&#39;$_POST[&#39;</span>.$key.<span class="charliteral">&#39;]&#39;</span>.str_repeat(<span class="charliteral">&#39; &#39;</span>, 29 - strlen($key)).<span class="stringliteral">&#39;= &#39;</span>.$this-&gt;<a class="code" href="classphpthumb.html#ac6144c2648d4394fba9a1d3d75d442fc">phpThumbDebugVarDump</a>($value);
<a name="l03672"></a>03672                         }
<a name="l03673"></a>03673                 }
<a name="l03674"></a>03674                 $DebugOutput[] = <span class="stringliteral">&#39;&#39;</span>;
<a name="l03675"></a>03675 
<a name="l03676"></a>03676                 $DebugOutput[] = <span class="stringliteral">&#39;$this-&gt;debugmessages:&#39;</span>;
<a name="l03677"></a>03677                 <span class="keywordflow">foreach</span> ($this-&gt;debugmessages as $errorstring) {
<a name="l03678"></a>03678                         $DebugOutput[] = <span class="stringliteral">&#39;  * &#39;</span>.$errorstring;
<a name="l03679"></a>03679                 }
<a name="l03680"></a>03680                 $DebugOutput[] = <span class="stringliteral">&#39;&#39;</span>;
<a name="l03681"></a>03681 
<a name="l03682"></a>03682                 $DebugOutput[] = <span class="stringliteral">&#39;$this-&gt;debugtiming:&#39;</span>;
<a name="l03683"></a>03683                 <span class="keywordflow">foreach</span> ($this-&gt;debugtiming as $timestamp =&gt; $timingstring) {
<a name="l03684"></a>03684                         $DebugOutput[] = <span class="stringliteral">&#39;  * &#39;</span>.$timestamp.<span class="charliteral">&#39; &#39;</span>.$timingstring;
<a name="l03685"></a>03685                 }
<a name="l03686"></a>03686                 $DebugOutput[] = <span class="stringliteral">&#39;  * Total processing time: &#39;</span>.number_format(max(array_keys($this-&gt;debugtiming)) - min(array_keys($this-&gt;debugtiming)), 6);
<a name="l03687"></a>03687 
<a name="l03688"></a>03688                 $this-&gt;f = (isset($_GET[<span class="charliteral">&#39;f&#39;</span>]) ? $_GET[<span class="charliteral">&#39;f&#39;</span>] : $this-&gt;f); <span class="comment">// debug modes 0-2 don&#39;t recognize text mode otherwise</span>
<a name="l03689"></a>03689                 <span class="keywordflow">return</span> $this-&gt;<a class="code" href="classphpthumb.html#a6ff71b425894fd846790cedf9f9cc97d">ErrorImage</a>(implode(<span class="stringliteral">&quot;\n&quot;</span>, $DebugOutput), 700, 500, <span class="keyword">true</span>);
<a name="l03690"></a>03690         }
<a name="l03691"></a>03691 
<a name="l03692"></a><a class="code" href="classphpthumb.html#a884659e333b8e276d254035228d04050">03692</a>         <span class="keyword">function</span> <a class="code" href="classphpthumb.html#a884659e333b8e276d254035228d04050">FatalError</a>($text) {
<a name="l03693"></a>03693                 <span class="keywordflow">if</span> (is_null($this-&gt;fatalerror)) {
<a name="l03694"></a>03694                         $this-&gt;fatalerror = $text;
<a name="l03695"></a>03695                 }
<a name="l03696"></a>03696                 <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l03697"></a>03697         }
<a name="l03698"></a>03698 
<a name="l03699"></a><a class="code" href="classphpthumb.html#a6ff71b425894fd846790cedf9f9cc97d">03699</a>         <span class="keyword">function</span> <a class="code" href="classphpthumb.html#a6ff71b425894fd846790cedf9f9cc97d">ErrorImage</a>($text, $width=0, $height=0, $forcedisplay=<span class="keyword">false</span>) {
<a name="l03700"></a>03700                 $width  = ($width  ? $width  : $this-&gt;config_error_image_width);
<a name="l03701"></a>03701                 $height = ($height ? $height : $this-&gt;config_error_image_height);
<a name="l03702"></a>03702 
<a name="l03703"></a>03703                 $text = <span class="stringliteral">&#39;phpThumb() v&#39;</span>.$this-&gt;phpthumb_version.<span class="stringliteral">&quot;\n\n&quot;</span>.$text;
<a name="l03704"></a>03704                 <span class="keywordflow">if</span> ($this-&gt;config_disable_debug) {
<a name="l03705"></a>03705                         $text = <span class="stringliteral">&#39;Error messages disabled&#39;</span>;
<a name="l03706"></a>03706                 }
<a name="l03707"></a>03707 
<a name="l03708"></a>03708                 $this-&gt;<a class="code" href="classphpthumb.html#a884659e333b8e276d254035228d04050">FatalError</a>($text);
<a name="l03709"></a>03709                 $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>($text, __FILE__, __LINE__);
<a name="l03710"></a>03710                 <span class="keywordflow">if</span> ($this-&gt;<a class="code" href="classphpthumb.html#a8329c63c143bd310899667d0b130ddcd">phpThumbDebug</a> &amp;&amp; !$forcedisplay) {
<a name="l03711"></a>03711                         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l03712"></a>03712                 }
<a name="l03713"></a>03713                 <span class="keywordflow">if</span> (!$this-&gt;config_error_die_on_error &amp;&amp; !$forcedisplay) {
<a name="l03714"></a>03714                         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l03715"></a>03715                 }
<a name="l03716"></a>03716                 <span class="keywordflow">if</span> ($this-&gt;config_error_silent_die_on_error) {
<a name="l03717"></a>03717                         <a class="code" href="lib_2php_thumbs-1_87_89_2cache_2index_8php.html#a6733eb5f605d09eaede9845835d71c4e">exit</a>;
<a name="l03718"></a>03718                 }
<a name="l03719"></a>03719                 <span class="keywordflow">if</span> ($this-&gt;err || $this-&gt;config_error_message_image_default) {
<a name="l03720"></a>03720                         <span class="comment">// Show generic custom error image instead of error message</span>
<a name="l03721"></a>03721                         <span class="comment">// for use on production sites where you don&#39;t want debug messages</span>
<a name="l03722"></a>03722                         <span class="keywordflow">if</span> (($this-&gt;err == <span class="stringliteral">&#39;showerror&#39;</span>) || $this-&gt;<a class="code" href="classphpthumb.html#a8329c63c143bd310899667d0b130ddcd">phpThumbDebug</a>) {
<a name="l03723"></a>03723                                 <span class="comment">// fall through and actually show error message even if default error image is set</span>
<a name="l03724"></a>03724                         } <span class="keywordflow">else</span> {
<a name="l03725"></a>03725                                 header(<span class="stringliteral">&#39;Location: &#39;</span>.($this-&gt;err ? $this-&gt;err : $this-&gt;config_error_message_image_default));
<a name="l03726"></a>03726                                 <a class="code" href="lib_2php_thumbs-1_87_89_2cache_2index_8php.html#a6733eb5f605d09eaede9845835d71c4e">exit</a>;
<a name="l03727"></a>03727                         }
<a name="l03728"></a>03728                 }
<a name="l03729"></a>03729                 $this-&gt;<a class="code" href="classphpthumb.html#a422bcfa5097eee6cd64570424c89a9d1">setOutputFormat</a>();
<a name="l03730"></a>03730                 <span class="keywordflow">if</span> (!$this-&gt;thumbnailFormat || (<a class="code" href="classphpthumb__functions.html#aaaad487d4c5a61befc88ae061f8a64fe">phpthumb_functions::gd_version</a>() &lt; 1)) {
<a name="l03731"></a>03731                         $this-&gt;thumbnailFormat = <span class="stringliteral">&#39;text&#39;</span>;
<a name="l03732"></a>03732                 }
<a name="l03733"></a>03733                 <span class="keywordflow">if</span> (@$this-&gt;thumbnailFormat == <span class="stringliteral">&#39;text&#39;</span>) {
<a name="l03734"></a>03734                         <span class="comment">// bypass all GD functions and output text error message</span>
<a name="l03735"></a>03735                         <span class="keywordflow">if</span> (!headers_sent()) {
<a name="l03736"></a>03736                                 header(<span class="stringliteral">&#39;Content-type: text/plain&#39;</span>);
<a name="l03737"></a>03737                                 <a class="code" href="bug-eofquotes_8php.html#ac4fd59c9ee95bff469a7cd55e16f0449">echo</a> $text;
<a name="l03738"></a>03738                         } <span class="keywordflow">else</span> {
<a name="l03739"></a>03739                                 <a class="code" href="bug-eofquotes_8php.html#ac4fd59c9ee95bff469a7cd55e16f0449">echo</a> <span class="stringliteral">&#39;&lt;pre&gt;&#39;</span>.htmlspecialchars($text).<span class="stringliteral">&#39;&lt;/pre&gt;&#39;</span>;
<a name="l03740"></a>03740                         }
<a name="l03741"></a>03741                         <a class="code" href="lib_2php_thumbs-1_87_89_2cache_2index_8php.html#a6733eb5f605d09eaede9845835d71c4e">exit</a>;
<a name="l03742"></a>03742                 }
<a name="l03743"></a>03743 
<a name="l03744"></a>03744                 $FontWidth  = ImageFontWidth($this-&gt;config_error_fontsize);
<a name="l03745"></a>03745                 $FontHeight = ImageFontHeight($this-&gt;config_error_fontsize);
<a name="l03746"></a>03746 
<a name="l03747"></a>03747                 $LinesOfText = explode(<span class="stringliteral">&quot;\n&quot;</span>, @wordwrap($text, floor($width / $FontWidth), <span class="stringliteral">&quot;\n&quot;</span>, <span class="keyword">true</span>));
<a name="l03748"></a>03748                 $height = max($height, count($LinesOfText) * $FontHeight);
<a name="l03749"></a>03749 
<a name="l03750"></a>03750                 $headers_file = <span class="stringliteral">&#39;&#39;</span>;
<a name="l03751"></a>03751                 $headers_line = <span class="stringliteral">&#39;&#39;</span>;
<a name="l03752"></a>03752                 <span class="keywordflow">if</span> (<a class="code" href="classphpthumb__functions.html#af53f41b3482e6bed2082daa0ebfd96c0">phpthumb_functions::version_compare_replacement</a>(phpversion(), <span class="stringliteral">&#39;4.3.0&#39;</span>, <span class="stringliteral">&#39;&gt;=&#39;</span>) &amp;&amp; headers_sent($headers_file, $headers_line)) {
<a name="l03753"></a>03753 
<a name="l03754"></a>03754                         <a class="code" href="bug-eofquotes_8php.html#ac4fd59c9ee95bff469a7cd55e16f0449">echo</a> <span class="stringliteral">&quot;\n&quot;</span>.<span class="stringliteral">&#39;**Headers already sent in file &quot;&#39;</span>.$headers_file.<span class="stringliteral">&#39;&quot; on line &quot;&#39;</span>.$headers_line.<span class="stringliteral">&#39;&quot;, dumping error message as text:**&lt;br&gt;&lt;pre&gt;&#39;</span>.<span class="stringliteral">&quot;\n\n&quot;</span>.$text.<span class="stringliteral">&quot;\n&quot;</span>.<span class="stringliteral">&#39;&lt;/pre&gt;&#39;</span>;
<a name="l03755"></a>03755 
<a name="l03756"></a>03756                 } <a class="code" href="php_thumb_8demo_8check_8php.html#af92779326267616cd7c3cdaaa9484bc9">elseif</a> (headers_sent()) {
<a name="l03757"></a>03757 
<a name="l03758"></a>03758                         <a class="code" href="bug-eofquotes_8php.html#ac4fd59c9ee95bff469a7cd55e16f0449">echo</a> <span class="stringliteral">&quot;\n&quot;</span>.<span class="stringliteral">&#39;**Headers already sent, dumping error message as text:**&lt;br&gt;&lt;pre&gt;&#39;</span>.<span class="stringliteral">&quot;\n\n&quot;</span>.$text.<span class="stringliteral">&quot;\n&quot;</span>.<span class="stringliteral">&#39;&lt;/pre&gt;&#39;</span>;
<a name="l03759"></a>03759 
<a name="l03760"></a>03760                 } <a class="code" href="php_thumb_8demo_8check_8php.html#af92779326267616cd7c3cdaaa9484bc9">elseif</a> ($gdimg_error = ImageCreate($width, $height)) {
<a name="l03761"></a>03761 
<a name="l03762"></a>03762                         $background_color = <a class="code" href="classphpthumb__functions.html#a9a63d0b70df4136de64ab0cd351e7ff3">phpthumb_functions::ImageHexColorAllocate</a>($gdimg_error, $this-&gt;config_error_bgcolor,   <span class="keyword">true</span>);
<a name="l03763"></a>03763                         $text_color       = <a class="code" href="classphpthumb__functions.html#a9a63d0b70df4136de64ab0cd351e7ff3">phpthumb_functions::ImageHexColorAllocate</a>($gdimg_error, $this-&gt;config_error_textcolor, <span class="keyword">true</span>);
<a name="l03764"></a>03764                         ImageFilledRectangle($gdimg_error, 0, 0, $width, $height, $background_color);
<a name="l03765"></a>03765                         $lineYoffset = 0;
<a name="l03766"></a>03766                         <span class="keywordflow">foreach</span> ($LinesOfText as <a class="code" href="tokenizer__test_8php.html#a52f469b0182d9abac2d0f20548680c9c">$line</a>) {
<a name="l03767"></a>03767                                 ImageString($gdimg_error, $this-&gt;config_error_fontsize, 2, $lineYoffset, $line, $text_color);
<a name="l03768"></a>03768                                 $lineYoffset += $FontHeight;
<a name="l03769"></a>03769                         }
<a name="l03770"></a>03770                         <span class="keywordflow">if</span> (function_exists(<span class="stringliteral">&#39;ImageTypes&#39;</span>)) {
<a name="l03771"></a>03771                                 $imagetypes = ImageTypes();
<a name="l03772"></a>03772                                 <span class="keywordflow">if</span> ($imagetypes &amp; IMG_PNG) {
<a name="l03773"></a>03773                                         header(<span class="stringliteral">&#39;Content-Type: image/png&#39;</span>);
<a name="l03774"></a>03774                                         ImagePNG($gdimg_error);
<a name="l03775"></a>03775                                 } <a class="code" href="php_thumb_8demo_8check_8php.html#af92779326267616cd7c3cdaaa9484bc9">elseif</a> ($imagetypes &amp; IMG_GIF) {
<a name="l03776"></a>03776                                         header(<span class="stringliteral">&#39;Content-Type: image/gif&#39;</span>);
<a name="l03777"></a>03777                                         ImageGIF($gdimg_error);
<a name="l03778"></a>03778                                 } <a class="code" href="php_thumb_8demo_8check_8php.html#af92779326267616cd7c3cdaaa9484bc9">elseif</a> ($imagetypes &amp; IMG_JPG) {
<a name="l03779"></a>03779                                         header(<span class="stringliteral">&#39;Content-Type: image/jpeg&#39;</span>);
<a name="l03780"></a>03780                                         ImageJPEG($gdimg_error);
<a name="l03781"></a>03781                                 } <a class="code" href="php_thumb_8demo_8check_8php.html#af92779326267616cd7c3cdaaa9484bc9">elseif</a> ($imagetypes &amp; IMG_WBMP) {
<a name="l03782"></a>03782                                         header(<span class="stringliteral">&#39;Content-Type: image/vnd.wap.wbmp&#39;</span>);
<a name="l03783"></a>03783                                         ImageWBMP($gdimg_error);
<a name="l03784"></a>03784                                 }
<a name="l03785"></a>03785                         }
<a name="l03786"></a>03786                         ImageDestroy($gdimg_error);
<a name="l03787"></a>03787 
<a name="l03788"></a>03788                 }
<a name="l03789"></a>03789                 <span class="keywordflow">if</span> (!headers_sent()) {
<a name="l03790"></a>03790                         <a class="code" href="bug-eofquotes_8php.html#ac4fd59c9ee95bff469a7cd55e16f0449">echo</a> <span class="stringliteral">&quot;\n&quot;</span>.<span class="stringliteral">&#39;**Failed to send graphical error image, dumping error message as text:**&lt;br&gt;&#39;</span>.<span class="stringliteral">&quot;\n\n&quot;</span>.$text;
<a name="l03791"></a>03791                 }
<a name="l03792"></a>03792                 <a class="code" href="lib_2php_thumbs-1_87_89_2cache_2index_8php.html#a6733eb5f605d09eaede9845835d71c4e">exit</a>;
<a name="l03793"></a>03793                 <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l03794"></a>03794         }
<a name="l03795"></a>03795 
<a name="l03796"></a><a class="code" href="classphpthumb.html#a7a2d5f7e31c08dd71b834391cb7b1520">03796</a>         <span class="keyword">function</span> <a class="code" href="classphpthumb.html#a7a2d5f7e31c08dd71b834391cb7b1520">ImageCreateFromStringReplacement</a>(&amp;$RawImageData, $DieOnErrors=<span class="keyword">false</span>) {
<a name="l03797"></a>03797                 <span class="comment">// there are serious bugs in the non-bundled versions of GD which may cause</span>
<a name="l03798"></a>03798                 <span class="comment">// PHP to segfault when calling ImageCreateFromString() - avoid if at all possible</span>
<a name="l03799"></a>03799                 <span class="comment">// when not using a bundled version of GD2</span>
<a name="l03800"></a>03800                 <span class="keywordflow">if</span> (!<a class="code" href="classphpthumb__functions.html#aaaad487d4c5a61befc88ae061f8a64fe">phpthumb_functions::gd_version</a>()) {
<a name="l03801"></a>03801                         <span class="keywordflow">if</span> ($DieOnErrors) {
<a name="l03802"></a>03802                                 <span class="keywordflow">if</span> (!headers_sent()) {
<a name="l03803"></a>03803                                         <span class="comment">// base64-encoded error image in GIF format</span>
<a name="l03804"></a>03804                                         $ERROR_NOGD = <span class="stringliteral">&#39;R0lGODlhIAAgALMAAAAAABQUFCQkJDY2NkZGRldXV2ZmZnJycoaGhpSUlKWlpbe3t8XFxdXV1eTk5P7+/iwAAAAAIAAgAAAE/vDJSau9WILtTAACUinDNijZtAHfCojS4W5H+qxD8xibIDE9h0OwWaRWDIljJSkUJYsN4bihMB8th3IToAKs1VtYM75cyV8sZ8vygtOE5yMKmGbO4jRdICQCjHdlZzwzNW4qZSQmKDaNjhUMBX4BBAlmMywFSRWEmAI6b5gAlhNxokGhooAIK5o/pi9vEw4Lfj4OLTAUpj6IabMtCwlSFw0DCKBoFqwAB04AjI54PyZ+yY3TD0ss2YcVmN/gvpcu4TOyFivWqYJlbAHPpOntvxNAACcmGHjZzAZqzSzcq5fNjxFmAFw9iFRunD1epU6tsIPmFCAJnWYE0FURk7wJDA0MTKpEzoWAAskiAAA7&#39;</span>;
<a name="l03805"></a>03805                                         header(<span class="stringliteral">&#39;Content-Type: image/gif&#39;</span>);
<a name="l03806"></a>03806                                         <a class="code" href="bug-eofquotes_8php.html#ac4fd59c9ee95bff469a7cd55e16f0449">echo</a> base64_decode($ERROR_NOGD);
<a name="l03807"></a>03807                                 } <span class="keywordflow">else</span> {
<a name="l03808"></a>03808                                         <a class="code" href="bug-eofquotes_8php.html#ac4fd59c9ee95bff469a7cd55e16f0449">echo</a> <span class="stringliteral">&#39;*** ERROR: No PHP-GD support available ***&#39;</span>;
<a name="l03809"></a>03809                                 }
<a name="l03810"></a>03810                                 <a class="code" href="lib_2php_thumbs-1_87_89_2cache_2index_8php.html#a6733eb5f605d09eaede9845835d71c4e">exit</a>;
<a name="l03811"></a>03811                         } <span class="keywordflow">else</span> {
<a name="l03812"></a>03812                                 $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;ImageCreateFromStringReplacement() failed: gd_version says &quot;&#39;</span>.<a class="code" href="classphpthumb__functions.html#aaaad487d4c5a61befc88ae061f8a64fe">phpthumb_functions::gd_version</a>().<span class="charliteral">&#39;&quot;&#39;</span>, __FILE__, __LINE__);
<a name="l03813"></a>03813                                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l03814"></a>03814                         }
<a name="l03815"></a>03815                 }
<a name="l03816"></a>03816                 <span class="keywordflow">if</span> (<a class="code" href="classphpthumb__functions.html#adfd72c199df2f74f6daeda7c06a18cae">phpthumb_functions::gd_is_bundled</a>()) {
<a name="l03817"></a>03817                         $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;ImageCreateFromStringReplacement() calling built-in ImageCreateFromString()&#39;</span>, __FILE__, __LINE__);
<a name="l03818"></a>03818                         <span class="keywordflow">return</span> @ImageCreateFromString($RawImageData);
<a name="l03819"></a>03819                 }
<a name="l03820"></a>03820 
<a name="l03821"></a>03821                 <span class="keywordflow">switch</span> (substr($RawImageData, 0, 3)) {
<a name="l03822"></a>03822                         <span class="keywordflow">case</span> <span class="stringliteral">&#39;GIF&#39;</span>:
<a name="l03823"></a>03823                                 $ICFSreplacementFunctionName = <span class="stringliteral">&#39;ImageCreateFromGIF&#39;</span>;
<a name="l03824"></a>03824                                 <span class="keywordflow">break</span>;
<a name="l03825"></a>03825                         <span class="keywordflow">case</span> <span class="stringliteral">&quot;\xFF\xD8\xFF&quot;</span>:
<a name="l03826"></a>03826                                 $ICFSreplacementFunctionName = <span class="stringliteral">&#39;ImageCreateFromJPEG&#39;</span>;
<a name="l03827"></a>03827                                 <span class="keywordflow">break</span>;
<a name="l03828"></a>03828                         <span class="keywordflow">case</span> <span class="stringliteral">&quot;\x89&quot;</span>.<span class="stringliteral">&#39;PN&#39;</span>:
<a name="l03829"></a>03829                                 $ICFSreplacementFunctionName = <span class="stringliteral">&#39;ImageCreateFromPNG&#39;</span>;
<a name="l03830"></a>03830                                 <span class="keywordflow">break</span>;
<a name="l03831"></a>03831                         <span class="keywordflow">default</span>:
<a name="l03832"></a>03832                                 $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;ImageCreateFromStringReplacement() failed: unknown fileformat signature &quot;&#39;</span>.<a class="code" href="classphpthumb__functions.html#a990a73d0fe31b520e04251295aeded25">phpthumb_functions::HexCharDisplay</a>(substr($RawImageData, 0, 3)).<span class="charliteral">&#39;&quot;&#39;</span>, __FILE__, __LINE__);
<a name="l03833"></a>03833                                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l03834"></a>03834                                 <span class="keywordflow">break</span>;
<a name="l03835"></a>03835                 }
<a name="l03836"></a>03836                 <span class="keywordflow">if</span> ($tempnam = $this-&gt;<a class="code" href="classphpthumb.html#ad1351cd5e7f10718ff06ae752d23349c">phpThumb_tempnam</a>()) {
<a name="l03837"></a>03837                         <span class="keywordflow">if</span> ($fp_tempnam = @fopen($tempnam, <span class="stringliteral">&#39;wb&#39;</span>)) {
<a name="l03838"></a>03838                                 fwrite($fp_tempnam, $RawImageData);
<a name="l03839"></a>03839                                 fclose($fp_tempnam);
<a name="l03840"></a>03840                                 <span class="keywordflow">if</span> (($ICFSreplacementFunctionName == <span class="stringliteral">&#39;ImageCreateFromGIF&#39;</span>) &amp;&amp; !function_exists($ICFSreplacementFunctionName)) {
<a name="l03841"></a>03841 
<a name="l03842"></a>03842                                         <span class="comment">// Need to create from GIF file, but ImageCreateFromGIF does not exist</span>
<a name="l03843"></a>03843                                         ob_start();
<a name="l03844"></a>03844                                         <span class="keywordflow">if</span> (!@include_once(dirname(__FILE__).<span class="stringliteral">&#39;/phpthumb.gif.php&#39;</span>)) {
<a name="l03845"></a>03845                                                 $ErrorMessage = <span class="stringliteral">&#39;Failed to include required file &quot;&#39;</span>.dirname(__FILE__).<span class="stringliteral">&#39;/phpthumb.gif.php&quot; in &#39;</span>.__FILE__.<span class="stringliteral">&#39; on line &#39;</span>.__LINE__;
<a name="l03846"></a>03846                                                 $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>($ErrorMessage, __FILE__, __LINE__);
<a name="l03847"></a>03847                                         }
<a name="l03848"></a>03848                                         ob_end_clean();
<a name="l03849"></a>03849                                         <span class="comment">// gif_loadFileToGDimageResource() cannot read from raw data, write to file first</span>
<a name="l03850"></a>03850                                         <span class="keywordflow">if</span> ($tempfilename = $this-&gt;<a class="code" href="classphpthumb.html#ad1351cd5e7f10718ff06ae752d23349c">phpThumb_tempnam</a>()) {
<a name="l03851"></a>03851                                                 <span class="keywordflow">if</span> ($fp_tempfile = @fopen($tempfilename, <span class="stringliteral">&#39;wb&#39;</span>)) {
<a name="l03852"></a>03852                                                         fwrite($fp_tempfile, $RawImageData);
<a name="l03853"></a>03853                                                         fclose($fp_tempfile);
<a name="l03854"></a>03854                                                         <a class="code" href="classphpthumb.html#a71b025ba59af93b30b644fe62f4208cb">$gdimg_source</a> = <a class="code" href="phpthumb_8gif_8php.html#ae1af166bb60f9b34e2ca2bc41f2de307">gif_loadFileToGDimageResource</a>($tempfilename);
<a name="l03855"></a>03855                                                         $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;gif_loadFileToGDimageResource(&#39;</span>.$tempfilename.<span class="stringliteral">&#39;) completed&#39;</span>, __FILE__, __LINE__);
<a name="l03856"></a>03856                                                         $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;deleting &quot;&#39;</span>.$tempfilename.<span class="charliteral">&#39;&quot;&#39;</span>, __FILE__, __LINE__);
<a name="l03857"></a>03857                                                         unlink($tempfilename);
<a name="l03858"></a>03858                                                         <span class="keywordflow">return</span> <a class="code" href="classphpthumb.html#a71b025ba59af93b30b644fe62f4208cb">$gdimg_source</a>;
<a name="l03859"></a>03859                                                         <span class="keywordflow">break</span>;
<a name="l03860"></a>03860                                                 } <span class="keywordflow">else</span> {
<a name="l03861"></a>03861                                                         $ErrorMessage = <span class="stringliteral">&#39;Failed to open tempfile in &#39;</span>.__FILE__.<span class="stringliteral">&#39; on line &#39;</span>.__LINE__;
<a name="l03862"></a>03862                                                         $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>($ErrorMessage, __FILE__, __LINE__);
<a name="l03863"></a>03863                                                 }
<a name="l03864"></a>03864                                         } <span class="keywordflow">else</span> {
<a name="l03865"></a>03865                                                 $ErrorMessage = <span class="stringliteral">&#39;Failed to open generate tempfile name in &#39;</span>.__FILE__.<span class="stringliteral">&#39; on line &#39;</span>.__LINE__;
<a name="l03866"></a>03866                                                 $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>($ErrorMessage, __FILE__, __LINE__);
<a name="l03867"></a>03867                                         }
<a name="l03868"></a>03868 
<a name="l03869"></a>03869                                 } <a class="code" href="php_thumb_8demo_8check_8php.html#af92779326267616cd7c3cdaaa9484bc9">elseif</a> (function_exists($ICFSreplacementFunctionName) &amp;&amp; (<a class="code" href="classphpthumb.html#a71b025ba59af93b30b644fe62f4208cb">$gdimg_source</a> = @$ICFSreplacementFunctionName($tempnam))) {
<a name="l03870"></a>03870 
<a name="l03871"></a>03871                                         <span class="comment">// great</span>
<a name="l03872"></a>03872                                         $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>($ICFSreplacementFunctionName.<span class="charliteral">&#39;(&#39;</span>.$tempnam.<span class="stringliteral">&#39;) succeeded&#39;</span>, __FILE__, __LINE__);
<a name="l03873"></a>03873                                         $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;deleting &quot;&#39;</span>.$tempnam.<span class="charliteral">&#39;&quot;&#39;</span>, __FILE__, __LINE__);
<a name="l03874"></a>03874                                         unlink($tempnam);
<a name="l03875"></a>03875                                         <span class="keywordflow">return</span> <a class="code" href="classphpthumb.html#a71b025ba59af93b30b644fe62f4208cb">$gdimg_source</a>;
<a name="l03876"></a>03876 
<a name="l03877"></a>03877                                 } <span class="keywordflow">else</span> {
<a name="l03878"></a>03878 
<a name="l03879"></a>03879                                         <span class="comment">// GD functions not available, or failed to create image</span>
<a name="l03880"></a>03880                                         $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>($ICFSreplacementFunctionName.<span class="charliteral">&#39;(&#39;</span>.$tempnam.<span class="stringliteral">&#39;) &#39;</span>.(function_exists($ICFSreplacementFunctionName) ? <span class="stringliteral">&#39;failed&#39;</span> : <span class="stringliteral">&#39;does not exist&#39;</span>), __FILE__, __LINE__);
<a name="l03881"></a>03881                                         <span class="keywordflow">if</span> (isset($_GET[<span class="stringliteral">&#39;phpThumbDebug&#39;</span>])) {
<a name="l03882"></a>03882                                                 $this-&gt;<a class="code" href="classphpthumb.html#a8329c63c143bd310899667d0b130ddcd">phpThumbDebug</a>();
<a name="l03883"></a>03883                                         }
<a name="l03884"></a>03884 
<a name="l03885"></a>03885                                 }
<a name="l03886"></a>03886                         } <span class="keywordflow">else</span> {
<a name="l03887"></a>03887                                 $ErrorMessage = <span class="stringliteral">&#39;Failed to fopen(&#39;</span>.$tempnam.<span class="stringliteral">&#39;, &quot;wb&quot;) in &#39;</span>.__FILE__.<span class="stringliteral">&#39; on line &#39;</span>.__LINE__.<span class="stringliteral">&quot;\n&quot;</span>.<span class="stringliteral">&#39;You may need to set $PHPTHUMB_CONFIG[temp_directory] in phpThumb.config.php&#39;</span>;
<a name="l03888"></a>03888                                 <span class="keywordflow">if</span> (ini_get(<span class="stringliteral">&#39;safe_mode&#39;</span>)) {
<a name="l03889"></a>03889                                         $ErrorMessage = <span class="stringliteral">&#39;ImageCreateFromStringReplacement() failed in &#39;</span>.__FILE__.<span class="stringliteral">&#39; on line &#39;</span>.__LINE__.<span class="stringliteral">&#39;: cannot create temp file in SAFE_MODE&#39;</span>;
<a name="l03890"></a>03890                                 }
<a name="l03891"></a>03891                                 $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>($ErrorMessage, __FILE__, __LINE__);
<a name="l03892"></a>03892                         }
<a name="l03893"></a>03893                         $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;deleting &quot;&#39;</span>.$tempnam.<span class="charliteral">&#39;&quot;&#39;</span>, __FILE__, __LINE__);
<a name="l03894"></a>03894                         @unlink($tempnam);
<a name="l03895"></a>03895                 } <span class="keywordflow">else</span> {
<a name="l03896"></a>03896                         $ErrorMessage = <span class="stringliteral">&#39;Failed to generate phpThumb_tempnam() in &#39;</span>.__FILE__.<span class="stringliteral">&#39; on line &#39;</span>.__LINE__.<span class="stringliteral">&quot;\n&quot;</span>.<span class="stringliteral">&#39;You may need to set $PHPTHUMB_CONFIG[temp_directory] in phpThumb.config.php&#39;</span>;
<a name="l03897"></a>03897                         <span class="keywordflow">if</span> (ini_get(<span class="stringliteral">&#39;safe_mode&#39;</span>)) {
<a name="l03898"></a>03898                                 $ErrorMessage = <span class="stringliteral">&#39;ImageCreateFromStringReplacement() failed in &#39;</span>.__FILE__.<span class="stringliteral">&#39; on line &#39;</span>.__LINE__.<span class="stringliteral">&#39;: cannot create temp file in SAFE_MODE&#39;</span>;
<a name="l03899"></a>03899                         }
<a name="l03900"></a>03900                 }
<a name="l03901"></a>03901                 <span class="keywordflow">if</span> ($DieOnErrors &amp;&amp; $ErrorMessage) {
<a name="l03902"></a>03902                         <span class="keywordflow">return</span> $this-&gt;<a class="code" href="classphpthumb.html#a6ff71b425894fd846790cedf9f9cc97d">ErrorImage</a>($ErrorMessage);
<a name="l03903"></a>03903                 }
<a name="l03904"></a>03904                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l03905"></a>03905         }
<a name="l03906"></a>03906 
<a name="l03907"></a><a class="code" href="classphpthumb.html#a4282192b16e760c7a6f12036081e8c82">03907</a>         <span class="keyword">function</span> <a class="code" href="classphpthumb.html#a4282192b16e760c7a6f12036081e8c82">ImageResizeFunction</a>(&amp;$dst_im, &amp;$src_im, $dstX, $dstY, $srcX, $srcY, $dstW, $dstH, $srcW, $srcH) {
<a name="l03908"></a>03908                 $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;ImageResizeFunction($o, $s, &#39;</span>.$dstX.<span class="stringliteral">&#39;, &#39;</span>.$dstY.<span class="stringliteral">&#39;, &#39;</span>.$srcX.<span class="stringliteral">&#39;, &#39;</span>.$srcY.<span class="stringliteral">&#39;, &#39;</span>.$dstW.<span class="stringliteral">&#39;, &#39;</span>.$dstH.<span class="stringliteral">&#39;, &#39;</span>.$srcW.<span class="stringliteral">&#39;, &#39;</span>.$srcH.<span class="charliteral">&#39;)&#39;</span>, __FILE__, __LINE__);
<a name="l03909"></a>03909                 <span class="keywordflow">if</span> (($dstW == $srcW) &amp;&amp; ($dstH == $srcH)) {
<a name="l03910"></a>03910                         <span class="keywordflow">return</span> ImageCopy($dst_im, $src_im, $dstX, $dstY, $srcX, $srcY, $srcW, $srcH);
<a name="l03911"></a>03911                 }
<a name="l03912"></a>03912                 <span class="keywordflow">if</span> (<a class="code" href="classphpthumb__functions.html#aaaad487d4c5a61befc88ae061f8a64fe">phpthumb_functions::gd_version</a>() &gt;= 2.0) {
<a name="l03913"></a>03913                         <span class="keywordflow">if</span> ($this-&gt;config_disable_imagecopyresampled) {
<a name="l03914"></a>03914                                 <span class="keywordflow">return</span> <a class="code" href="classphpthumb__functions.html#ab359dab758fa1fe794f7ee77bcc6fa57">phpthumb_functions::ImageCopyResampleBicubic</a>($dst_im, $src_im, $dstX, $dstY, $srcX, $srcY, $dstW, $dstH, $srcW, $srcH);
<a name="l03915"></a>03915                         }
<a name="l03916"></a>03916                         <span class="keywordflow">return</span> ImageCopyResampled($dst_im, $src_im, $dstX, $dstY, $srcX, $srcY, $dstW, $dstH, $srcW, $srcH);
<a name="l03917"></a>03917                 }
<a name="l03918"></a>03918                 <span class="keywordflow">return</span> ImageCopyResized($dst_im, $src_im, $dstX, $dstY, $srcX, $srcY, $dstW, $dstH, $srcW, $srcH);
<a name="l03919"></a>03919         }
<a name="l03920"></a>03920 
<a name="l03921"></a><a class="code" href="classphpthumb.html#aea3eff175aef32d43f196e043ee98802">03921</a>         <span class="keyword">function</span> <a class="code" href="classphpthumb.html#aea3eff175aef32d43f196e043ee98802">InitializeTempDirSetting</a>() {
<a name="l03922"></a>03922                 $this-&gt;config_temp_directory = realpath($this-&gt;config_temp_directory ? $this-&gt;config_temp_directory : (getenv(<span class="stringliteral">&#39;TMPDIR&#39;</span>) ? getenv(<span class="stringliteral">&#39;TMPDIR&#39;</span>) : getenv(<span class="stringliteral">&#39;TMP&#39;</span>)));
<a name="l03923"></a>03923                 <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l03924"></a>03924         }
<a name="l03925"></a>03925 
<a name="l03926"></a><a class="code" href="classphpthumb.html#ad1351cd5e7f10718ff06ae752d23349c">03926</a>         <span class="keyword">function</span> <a class="code" href="classphpthumb.html#ad1351cd5e7f10718ff06ae752d23349c">phpThumb_tempnam</a>() {
<a name="l03927"></a>03927                 $this-&gt;<a class="code" href="classphpthumb.html#aea3eff175aef32d43f196e043ee98802">InitializeTempDirSetting</a>();
<a name="l03928"></a>03928                 $tempnam = realpath(tempnam($this-&gt;config_temp_directory, <span class="stringliteral">&#39;pThumb&#39;</span>));
<a name="l03929"></a>03929                 $this-&gt;<a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>(<span class="stringliteral">&#39;phpThumb_tempnam() returning &quot;&#39;</span>.$tempnam.<span class="charliteral">&#39;&quot;&#39;</span>, __FILE__, __LINE__);
<a name="l03930"></a>03930                 <span class="keywordflow">return</span> $tempnam;
<a name="l03931"></a>03931         }
<a name="l03932"></a>03932 
<a name="l03933"></a><a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">03933</a>         <span class="keyword">function</span> <a class="code" href="classphpthumb.html#a31094adc61bf77474247fff1bd98319a">DebugMessage</a>($message, <a class="code" href="classphpthumb.html#aa1bfbd27060176201b271918dff57e8f">$file</a>=<span class="stringliteral">&#39;&#39;</span>, <a class="code" href="tokenizer__test_8php.html#a52f469b0182d9abac2d0f20548680c9c">$line</a>=<span class="stringliteral">&#39;&#39;</span>) {
<a name="l03934"></a>03934                 $this-&gt;debugmessages[] = $message.($file ? <span class="stringliteral">&#39; in file &quot;&#39;</span>.(basename(<a class="code" href="classphpthumb.html#aa1bfbd27060176201b271918dff57e8f">$file</a>) ? basename(<a class="code" href="classphpthumb.html#aa1bfbd27060176201b271918dff57e8f">$file</a>) : <a class="code" href="classphpthumb.html#aa1bfbd27060176201b271918dff57e8f">$file</a>).<span class="charliteral">&#39;&quot;&#39;</span> : <span class="stringliteral">&#39;&#39;</span>).($line ? <span class="stringliteral">&#39; on line &#39;</span>.$line : <span class="stringliteral">&#39;&#39;</span>);
<a name="l03935"></a>03935                 <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l03936"></a>03936         }
<a name="l03937"></a>03937 
<a name="l03938"></a><a class="code" href="classphpthumb.html#a0c9f92029be66d1dc44672ebc1fa35c0">03938</a>         <span class="keyword">function</span> <a class="code" href="classphpthumb.html#a0c9f92029be66d1dc44672ebc1fa35c0">DebugTimingMessage</a>($message, <a class="code" href="classphpthumb.html#aa1bfbd27060176201b271918dff57e8f">$file</a>=<span class="stringliteral">&#39;&#39;</span>, <a class="code" href="tokenizer__test_8php.html#a52f469b0182d9abac2d0f20548680c9c">$line</a>=<span class="stringliteral">&#39;&#39;</span>, $timestamp=0) {
<a name="l03939"></a>03939                 <span class="keywordflow">if</span> (!$timestamp) {
<a name="l03940"></a>03940                         $timestamp = array_sum(explode(<span class="charliteral">&#39; &#39;</span>, microtime()));
<a name="l03941"></a>03941                 }
<a name="l03942"></a>03942                 $this-&gt;debugtiming[number_format($timestamp, 6, <span class="charliteral">&#39;.&#39;</span>, <span class="stringliteral">&#39;&#39;</span>)] = <span class="stringliteral">&#39;: &#39;</span>.$message.($file ? <span class="stringliteral">&#39; in file &quot;&#39;</span>.(basename(<a class="code" href="classphpthumb.html#aa1bfbd27060176201b271918dff57e8f">$file</a>) ? basename(<a class="code" href="classphpthumb.html#aa1bfbd27060176201b271918dff57e8f">$file</a>) : <a class="code" href="classphpthumb.html#aa1bfbd27060176201b271918dff57e8f">$file</a>).<span class="charliteral">&#39;&quot;&#39;</span> : <span class="stringliteral">&#39;&#39;</span>).($line ? <span class="stringliteral">&#39; on line &#39;</span>.$line : <span class="stringliteral">&#39;&#39;</span>);
<a name="l03943"></a>03943                 <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l03944"></a>03944         }
<a name="l03945"></a>03945 
<a name="l03946"></a>03946 }
<a name="l03947"></a>03947 
<a name="l03948"></a>03948 ?&gt;
</pre></div></div><!-- contents -->
</div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerations</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

  <div id="nav-path" class="navpath">
    <ul>
      <li class="navelem"><a class="el" href="phpthumb_8class_8php.html">phpthumb.class.php</a>      </li>

    <li class="footer">Generated on Mon Feb 6 2012 00:16:21 for MitosEHR by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.6.1 </li>
   </ul>
 </div>


</body>
</html>
